# CVE-2020-17523：Apache Shiro 身份认证绕过漏洞分析 - cHr1s_h - 博客园

> 原文：[`www.cnblogs.com/cHr1s/p/14374106.html`](https://www.cnblogs.com/cHr1s/p/14374106.html)

# 0x01 Apache Shiro

Apache Shiro 是一个强大且易用的 Java 安全框架，执行身份验证、授权、密码和会话管理。

# 0x02 漏洞简介

2021 年 2 月 1 日，Apache Shiro 官方发布漏洞通告，漏洞编号为：CVE-2020-17523。
当 Apache Shiro 与 Spring 框架结合使用时，攻击者可以通过构造特殊的 HTTP 请求数据包，绕过身份认证匹配规则。

# 0x03 漏洞复现

## 环境搭建

使用 tomcat 部署 shiro1.7.0.war 包。
![](img/bcadd82495f4f30c40c276ecbc9a9fc2.png)

**公众号回复`shiro`获取下载链接。**

## 复现过程

访问 admin 下面的资源`/admin/1`跳转到登录界面：
![](img/7474cf206ed53029b058e0eaa7ae024b.png)
![](img/1916c71bee68c99c0db9af0266069ab9.png)

使用 payload：`/admin/%20`绕过身份验证，成功访问 admin 页面:
![](img/d46503e88563db4d27c60ba6fc8b1a28.png)
![](img/281838990a4892e5f7f619a10c767d7b.png)

# 0x04 漏洞分析

## 漏洞成因

代码中，Shiro 会对请求的 uri 进行鉴权操作，Shiro 的校验 uri 的函数为`PathMatches`，当`PathMatches`返回`true`时才会进入鉴权。
![](img/4ad9b5523dee7a56989f86a79a47b3bb.png)

然而`PathMatches("/admin/*","/admin/ ")`返回结果为`false`，因此访问`/admin/` 这个 uri 时 Shiro 不会进行鉴权操作，
但是 Spring 接收到的 uri 则是`/admin/%20`，会正常返回响应`admin page`。
![](img/f6a5773fbf40cd9171590fb4f43ee113.png)

## 代码分析

代码执行过程中调用`tokenizeToStringArray`方法，而当调用此方法时`trimTokens`参数值为`true`：
![](img/83908baa45bac445c584d5b10189164b.png)

而在`tokenizeToStringArray`方法中，`trimTokens`为`true`时调用了`trim()`函数，去除了空格字符，导致未进行鉴权操作：
![](img/b2ed1422319a0c0e09310cc5da358bc4.png)

简单总结下，在存在漏洞 Shiro 版本中，执行`tokenizeToStringArray`方法时`trimTokens`值为`true`，导致 uri 中的空格字符被清除，因此代码并没有经过鉴权处理，然而 Spring 接受到的 uri:`/admin/%20`会正常返回响应，最终导致身份验证被绕过。
利用 Shiro 与 Spring 处理 uri 的不同规则绕过身份验证。

# 0x05 影响版本

Apache Shiro < 1.7.1

# 0x06 修复方案

官方修复方案中，将`tokenizeToStringArray`方法中的`trimTokens`置为`false`

建议升级到 Apache Shiro 1.7.1 版本

**公众号回复 shiro 获取漏洞环境**