# nginx文件名逻辑漏洞_CVE-2013-4547漏洞复现 - 雨中落叶 - 博客园

> 原文：[https://www.cnblogs.com/yuzly/p/11221564.html](https://www.cnblogs.com/yuzly/p/11221564.html)

nginx文件名逻辑漏洞_CVE-2013-4547漏洞复现

**一、漏洞描述**

这个漏洞其实和代码执行没有太大的关系,主要原因是错误地解析了请求的URL,错误地获取到用户请求的文件名,导致出现权限绕过、代码执行的连带影响。

二、漏洞原理

举个例子,比如,nginx匹配到.php结尾的请求,就发送给fastcgi进行解析,常见的写法如下:　

```
location ~ \.php$ {
    include        fastcgi_params;

    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
    fastcgi_param  DOCUMENT_ROOT /var/www/html;
}
```

正常情况下(关闭了pathinfo的情况下),只有.php后缀的文件才会被发送给fastcgi解析。

而存在CVE-2013-4547的情况下,我们请求1.gif[0x20][0x00].php,这个URI可以匹配上正则\.php$,可以进入这个Location块；但进入后,Nginx却错误地认为请求的文件是1.gif[0x20],就设置其为SCRIPT_FILENAME的值发送给fastcgi。

Fastcgi根据SCRIPT_FILENAME的值进行解析,最后造成了解析漏洞。

所以,我们只需要上传一个空格结尾的文件,即可使PHP解析之。

再举个例子,比如很多网站限制了允许访问后台的IP:　

```
location /admin/ {
    allow 127.0.0.1;
    deny all;
}
```

我们可以请求如下URI:/test[0x20]/../admin/index.php,这个URI不会匹配上location后面的/admin/,也就绕过了其中的IP验证;但最后请求的是/test[0x20]/../admin/index.php文件,也就是/admin/index.php,成功访问到后台。(这个前提是需要有一个目录test:这是Linux系统的特点,如果有一个不存在的目录,则即使跳转到上一层,也会爆文件不存在的错误,Windows下没有这个限制)

**三、漏洞影响版本**

Nginx 0.8.41~1.4.3

Nginx 1.5.0~1.5.7

**四、漏洞环境搭建和复现**

1、使用docker搭建vulhub漏洞环境,启动漏洞环境

docker-compose build

docker-compose up -d

2、浏览器访问http://172.17.0.1:8080/,测试环境是否搭建成功

　　![](../Images/8f743cd8c11555a772ea62ced50a3dc9.png)

3、 看一下后端过滤

　　![](../Images/a4e6e65ed9e951f46322d31c2014f992.png)

4、上传一个mu.jpg,里面的内容还是<?php phpinfo();?>，注意后面的空格,发现上传成功

　　![](../Images/b4ec14ec80b25dd1301ba7d2b3a257fd.png)

5、构造mu.jpg[0x20][0x00].php来造成Nginx解析漏洞，使我们的mu.jpg被解析成php

在burp抓取的数据包中把mu.jpg后面的两个空格 [0x20][0x20] ---> [0x20][0x00] ,发现成功上传

　　![](../Images/50163c453a9a9dc7fbda769a26f3a5b1.png)

　　![](../Images/6e92207865269e0c6f57e5e5510bcb30.png)

6、访问http://172.17.0.1:8080/uploadfiles/1.gif[0x20][0x00].php，即可发现PHP已被解析

　　![](../Images/a12af54ca8cee9298bdc901cf90095f9.png)

**五、漏洞防御**

1、升级版本

--------------------------------------------------------------------------------------------------

参考资料: https://github.com/vulhub/vulhub/tree/master/nginx/CVE-2013-4547