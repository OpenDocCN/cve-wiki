# nginx 文件名逻辑漏洞 _CVE-2013-4547 漏洞复现 - 雨中落叶 - 博客园

> 原文：[`www.cnblogs.com/yuzly/p/11221564.html`](https://www.cnblogs.com/yuzly/p/11221564.html)

nginx 文件名逻辑漏洞 _CVE-2013-4547 漏洞复现

**一、漏洞描述**

这个漏洞其实和代码执行没有太大的关系,主要原因是错误地解析了请求的 URL,错误地获取到用户请求的文件名,导致出现权限绕过、代码执行的连带影响。

二、漏洞原理

举个例子,比如,nginx 匹配到.php 结尾的请求,就发送给 fastcgi 进行解析,常见的写法如下:　

```
location ~ \.php$ {
    include        fastcgi_params;

    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
    fastcgi_param  DOCUMENT_ROOT /var/www/html;
}
```

正常情况下(关闭了 pathinfo 的情况下),只有.php 后缀的文件才会被发送给 fastcgi 解析。

而存在 CVE-2013-4547 的情况下,我们请求 1.gif[0x20][0x00].php,这个 URI 可以匹配上正则\.php$,可以进入这个 Location 块；但进入后,Nginx 却错误地认为请求的文件是 1.gif[0x20],就设置其为 SCRIPT_FILENAME 的值发送给 fastcgi。

Fastcgi 根据 SCRIPT_FILENAME 的值进行解析,最后造成了解析漏洞。

所以,我们只需要上传一个空格结尾的文件,即可使 PHP 解析之。

再举个例子,比如很多网站限制了允许访问后台的 IP:　

```
location /admin/ {
    allow 127.0.0.1;
    deny all;
}
```

我们可以请求如下 URI:/test[0x20]/../admin/index.php,这个 URI 不会匹配上 location 后面的/admin/,也就绕过了其中的 IP 验证;但最后请求的是/test[0x20]/../admin/index.php 文件,也就是/admin/index.php,成功访问到后台。(这个前提是需要有一个目录 test:这是 Linux 系统的特点,如果有一个不存在的目录,则即使跳转到上一层,也会爆文件不存在的错误,Windows 下没有这个限制)

**三、漏洞影响版本**

Nginx 0.8.41~1.4.3

Nginx 1.5.0~1.5.7

**四、漏洞环境搭建和复现**

1、使用 docker 搭建 vulhub 漏洞环境,启动漏洞环境

docker-compose build

docker-compose up -d

2、浏览器访问 http://172.17.0.1:8080/,测试环境是否搭建成功

　　![](img/8f743cd8c11555a772ea62ced50a3dc9.png)

3、 看一下后端过滤

　　![](img/a4e6e65ed9e951f46322d31c2014f992.png)

4、上传一个 mu.jpg,里面的内容还是<?php phpinfo();?>，注意后面的空格,发现上传成功

　　![](img/b4ec14ec80b25dd1301ba7d2b3a257fd.png)

5、构造 mu.jpg[0x20][0x00].php 来造成 Nginx 解析漏洞，使我们的 mu.jpg 被解析成 php

在 burp 抓取的数据包中把 mu.jpg 后面的两个空格 [0x20][0x20] ---> [0x20][0x00] ,发现成功上传

　　![](img/50163c453a9a9dc7fbda769a26f3a5b1.png)

　　![](img/6e92207865269e0c6f57e5e5510bcb30.png)

6、访问 http://172.17.0.1:8080/uploadfiles/1.gif[0x20][0x00].php，即可发现 PHP 已被解析

　　![](img/a12af54ca8cee9298bdc901cf90095f9.png)

**五、漏洞防御**

1、升级版本

--------------------------------------------------------------------------------------------------

参考资料: https://github.com/vulhub/vulhub/tree/master/nginx/CVE-2013-4547