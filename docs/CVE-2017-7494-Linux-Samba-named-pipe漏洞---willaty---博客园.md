# CVE-2017-7494：Linux Samba named pipe 漏洞 - willaty - 博客园

> 原文：[`www.cnblogs.com/willaty/p/8274613.html`](https://www.cnblogs.com/willaty/p/8274613.html)

## 描述：

漏洞是由于代码中一个管道申请命令的判断导致的，可以通过构造特定请求执行上传的 so 文件。

漏洞影响了 Samba 3.5.0 之后到 4.6.4/4.5.10/4.4.14 中间的所有版本。

## 测试：

靶机：CentOS6.5 server

攻击机：kali 2017.2

samba 版本：3.5.22 源码编译

### 步骤：

配置 samba 可匿名访问（需要有读写的权限）

可以直接使用 metasploiet framework，执行：

```
use exploit/linux/samba/is_known_pipename
set rhost ip
exploit

```

　即可获取 shell。

## 原理：

通过官方发布的补丁来看， source3/rpc_server/srv_pipe.c 的 is_known_pipename 函数对 pipename 校验不充分，

导致含有’/’路径符号的 pipename 可触发漏洞：

![](img/0d6ad985338bae4215b9d9105fc44b39.png)

更严格的话应该是判断首个字符串是不是'/'来判断是否需要过滤。

这就可以通过恶意伪造管道命令，执行上传的 so，反弹 shell。

参考：[`bbs.pediy.com/thread-218114.htm`](https://bbs.pediy.com/thread-218114.htm)

## 应对方法：

临时方法：在 global 下设置 nt pipesupport = no

最好是更新 samba。

更多参考：

[`www.mamicode.com/info-detail-1830651.html`](http://www.mamicode.com/info-detail-1830651.html)

[`www.freebuf.com/news/137110.html`](http://www.freebuf.com/news/137110.html)