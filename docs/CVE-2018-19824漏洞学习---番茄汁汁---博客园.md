# CVE-2018-19824 漏洞学习 - 番茄汁汁 - 博客园

> 原文：[`www.cnblogs.com/likaiming/p/10890867.html`](https://www.cnblogs.com/likaiming/p/10890867.html)

# 简介

在 Linux 内核 4.19.6 之前，本地用户可以通过在 Sound / USB /card.c.的 usb_audio_probe 中错误处理一个恶意 USB 声音设备(没有接口)来利用 ALSA 驱动程序中的一个 UAF。如果 USB 声卡报告 0 个接口，将触发一个错误条件，函数 usb_audio_probe 错误输出。在错误路径中，存在一个在空闲后使用的漏洞，即首先释放卡的内存对象，然后减少活动芯片的数量。将减量移动到 atomic_dec 之上可以修复 UAF。

# 补丁分析

补丁在这里：[`git.kernel.org/pub/scm/linux/kernel/git/tiwai/sound.git/commit/?id=5f8cf712582617d523120df67d392059eaf2fc4b`](https://git.kernel.org/pub/scm/linux/kernel/git/tiwai/sound.git/commit/?id=5f8cf712582617d523120df67d392059eaf2fc4b)

```
diff --git a/sound/usb/card.c b/sound/usb/card.c
index 2bfe4e8..a105947 100644
--- a/sound/usb/card.c +++ b/sound/usb/card.c
@@ -682,9 +682,12 @@ static int usb_audio_probe(struct usb_interface *intf,

  __error: if (chip) { +        /* chip->active is inside the chip->card object,
+         * decrement before memory is possibly returned.
+ */
+        atomic_dec(&chip->active); if (!chip->num_interfaces)
             snd_card_free(chip->card); -        atomic_dec(&chip->active);
     }
     mutex_unlock(&register_mutex); return err;
```

只是将 atomic_dec(&chip->active)这个函数移动了一个位置。UAF 出在 snd_card_free 之中。这个漏洞貌似还是比较容易理解，通常我们编写程序的时候都会注意到，退出路径中，先减少索引，如果索引为 0 则释放对象。但是这里却可以直接进入释放阶段，只要 chip->num_interfaces 为 0。根据这个函数的注释，在音频设备中如果有过个控制接口这个函数会被调用多次。那这个意思就是应该看成 USB 总线上连接多个不同的设备