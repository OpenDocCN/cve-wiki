# CVE-2018-7600 Drupal 核心远程代码执行漏洞分析 - Ivan1ee - 博客园

> 原文：[`www.cnblogs.com/Ivan1ee/p/10187131.html`](https://www.cnblogs.com/Ivan1ee/p/10187131.html)

# 0x01 漏洞介绍

Drupal 是一个开源内容管理系统（CMS），全球超过 100 万个网站（包括政府，电子零售，企业组织，金融机构等）使用。**两周前，Drupal 安全团队披露了一个非常关键的漏洞，编号 CVE-2018-7600 Drupal 对表单请求内容未做严格过滤，因此，这使得攻击者可能将恶意注入表单内容，此漏洞允许未经身份验证的攻击者在默认或常见的 Drupal 安装上执行远程代码执行。**

# 0x02 漏洞分析

Drupal 渲染数组的情况有页面加载和 Ajax 表单发出的请求，在这里 Ajax API 调用是攻击者最佳的选择。那么作为用户注册表单的一部分，图片字段使用 Ajax API 将图片上传到服务器，并且生成缩略图

 ![](img/60eb24f2a069b10a1ef9aa9d6b0829b9.png)

查阅了相关文档资料现在，我们所要做的就是注入一个恶意渲染数组，该数组使用 Drupal 的渲染回调方法在系统上执行代码。有几个属性我们可以注入：

![](img/04d029a55120c3fcb1e909cd1679d878.png)

#access_callback 标签虽然 callback 回调函数可控，但需要回调处理的字符串不可控，导致无法利用。以下场景以 post_render 和 lazy_builder 为例

## 2.1、漏洞场景 1：引入#post_render

**#post_render**

这个 API 标签可以被所有的元素和表单使用，它是在 drupal_render()方法中调用，可以渲染当前元素和子元素，也可对内容进行修改。

![](img/01167dc142be52acd1f158005896d8bb.png)

例子中$ element 通过调用 admin_form_html_cleanup 函数处理返回处理后的结果。再来看可以触发攻击载荷的代码，在渲染的过程中调用了 call_user_func 进行回调处理，但$callable 回调函数通过表单伪造，$elements 的子元素同样也是通过表单可控

![](img/03a1fea7f162748792ec185f90ed9752.png)

攻击者利用攻击载荷 mail[#post_render][]=passthru&mail[#type]=markup&mail[#markup]=whoami ，这里的#markup 是当前元素#type 的子元素，通过数组的方式传入值，执行过程如图

![](img/31de5ac82de89fe2489c3683dc0bb7dd.png)

魔术方法 __toString 得到$this->string 等于 whoami ，带入到 call_user_func 中交给 passthru 函数执行，导致漏洞触发

![](img/b9938e70a4e9e1c8761948f1bd3762cd.png)

PHP 内置函数 pasthru 执行后会回显结果

![](img/47499c1589a53782548f149ae281ee2b.png)

## 2.2、漏洞场景 2：引入#lazy_builder

#lazy_builder 可选，数组值，必须有且只有两个元素，一个是回调函数名，一个回调的参数，参数只能是 NULL 或者标量类型

![](img/0a472fc2f7d6c1f7eec4c5207f87e44b.png)

$callable 变量取#lazy_builder 元素标签数组下标 0 的值作为回调函数名，取数组下标 1 的值当回调方法的参数， 下面攻击载荷调用 PowerShell 远程下载文件到本地保存为 php 网页后门，代码如下图

![](img/a9303ed39c61dcaacaff532d9f705260.png)

![](img/b7f27b13cddd80a97f0cbf733c8ac88f.png)

我们传入的 lazy_builder[0]和 lazy_builder[1]的值在渲染的时候用 call_user_func_array 完成整个攻击过程

![](img/9dbbfe7af54f9eea14dbdb6b52d0d2ab.png)

整个漏洞的产生过程都是因为 call_user_func 或者 call_user_func_array 等回调函数导致的任意代码执行，API 元素标签中可能还会触发漏洞的标签有#theme 、#create_placeholder、#theme_wrappers 等等。

# 0x04 缓解措施

官方在最新版本 8.5.1 中增加了下图方法

![](img/cb934b29355bc512a0ed108c1eb52d36.png)

对请求的 GET、POST、COOKIE 进行过滤处理

![](img/beb7044b990cb5ea6779341466dea926.png)

希望广大用户尽快升级到最新版本 Drupal 8.5.1 ， 下载地址：[`www.drupal.org/project/drupal/releases/8.5.1`](https://www.drupal.org/project/drupal/releases/8.5.1)

# 0x05 Reference

[`research.checkpoint.com/uncovering-drupalgeddon-2/`](https://research.checkpoint.com/uncovering-drupalgeddon-2/)

[`github.com/g0rx/CVE-2018-7600-Drupal-RCE/blob/master/exploit.py`](https://github.com/g0rx/CVE-2018-7600-Drupal-RCE/blob/master/exploit.py)