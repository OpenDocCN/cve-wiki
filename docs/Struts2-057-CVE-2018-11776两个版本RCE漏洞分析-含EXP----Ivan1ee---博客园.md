# Struts2-057/CVE-2018-11776 两个版本 RCE 漏洞分析（含 EXP） - Ivan1ee - 博客园

> 原文：[`www.cnblogs.com/Ivan1ee/p/10202016.html`](https://www.cnblogs.com/Ivan1ee/p/10202016.html)

# 0x01 前言

2018 年 8 月 22 日，Apache Strust2 发布最新安全公告，Apache Struts2 存在远程代码执行的高危漏洞（S2-057/CVE-2018-11776），该漏洞由 Semmle Security Research team 的安全研究员 Man YueMo 发现。该漏洞是由于在 Struts2 开发框架中使用 namespace 功能定义 XML 配置时，namespace 值未被设置且在上层动作配置（Action Configuration）中未设置或用通配符 namespace，可能导致远程代码执行。同理，url 标签未设置 value 和 action 值且上层动作未设置或用通配符 namespace 时也可能导致远程代码执行，经过笔者自建环境成功复现漏洞且可以执行命令回显，文末有你们想要的 !

# 0x02 漏洞利用

**笔者搭的环境分别是 Strust2 2.3.20 版本和 Strust2 2.3.34 版本，漏洞利用大致分为三种方式：数值计算、弹出计算器、 命令回显。**

## 2.1、数值计算

数值计算相对最简单，在 URL 上指定 %{100+200} 就可以发生跳转，得到计算的结果

![](img/f761fc6506e6e9a1bcbc59e9a58d2e4a.png)

## 2.2、弹出计算器

2.3.20 版本的 POC 如下：

![](img/2fe40f9fcd04877936bf2df70e3f2619.png)

![](img/a5b5f4ddd17c7fc304f1336451768e3f.png)

2.3.34 版本参考的 POC 如下：

![](img/e5392af7163f65dcefe22a10ce1668e0.png)

![](img/6653d081eed3333f2f419e1a6f48c792.png)

## 2.3、命令回显

两个版本都是利用 com.opensymphony.xwork2.dispatcher.HttpServletResponse 对象去打印命令执行后的回显数据

2.3.20 版本的 POC 如下：

![](img/e0de7c9490b5544c0da8c22953ad1277.png)

![](img/6e1ed7a4d2d2d093a2d967b1f3a4eb0e.png)

攻击后效果如下图

![](img/3e2abe4ff7ab5434652eaac268a71afc.png)

# 0X03 漏洞分析

在分析漏洞之前，需要配置 struts.xml 文件，这个文件就是 struts2 的核心配置文件，大多数的时候增减配置都需要操控这里；

![](img/53f14a11a6ae4fde3c0f5950587d091f.png)

总共两处需要注意，第一处一定要配置 struts.mapper.alwaysSelectFullNamespace  = true ，否则不能触发漏洞，这个配置的目的是设定是否一直在最后一个斜线之前的任何位置选定 NameSpace；第二处 result 标签返回的类型选择 “ redirectAction 或 chain“ , 只有这两个配置选项的值是可以将 action 转发或者重定向；关于 type 具体可以参考下图

![](img/812232ce82bfe8d48463662a4db93b5c.png)

说完了配置，开始动态分析。漏洞位于 struts2-core.jar!/org/apache/struts2/dispatcher/ServletActionRedirectResult.class

![](img/3aa8f6bd90ef34f4e90cc99809af0b54.png)

This.namespace 这个成员的值来自于 getNamespace()方法，再通过 getUriFromActionMapping()返回 URI 字符串；

![](img/d562d791f797078047ea5ae465fc3590.png)

通过 getUriFromActionMapping 获取的值赋给了 tmpLocation 变量，接着表达式进入 setLocation 方法

![](img/538210136d387bc34fb74d3c8117ad03.png)

再通过 super.execute 方法调用了 ServletActionResult ， 而在 execute 方法体内跟进了 conditionalParse 方法，在这个方法内调用了 ONGL 执行的关键方法 translateVariables。

![](img/bbf8e06c8ec47734ccd863abec7301ad.png)

获得的 param 值传入到 translateVariables()方法内，最终在 OnglTextPaser 里导致了 OGNL 表达式执行。

![](img/04be0eca5fa72520c3590494efb9d101.png)

![](img/1975f3e22935982c79d03162adfab5d7.png)

再弹出计算器后获得 lastFinalLocation 的值为当前执行后的句柄，这个值作为响应跳转的 action 地址 ，也就是在浏览器中弹出计算器后在地址栏中出现的 URI

![](img/9a2e7a389ac8a3dc18d0a80ca458d6d8.png)

到这里弹出计算器的分析到此为止，接下来看下基于命令执行回显结果的分析，基本上流程和上述一样，唯一不同之处 lastFinalLocation 返回的值是 NULL，这也就引发出提交后没有做 302 的跳转，依旧是当前的 action，并且返回的值是 200

![](img/78286a125ba9ae8e646c365861958985.png)

![](img/a361cf57f2b6043bcd4be1d5195ff2c6.png)

知道了原理后小同事用 python 实现了自动化利用工具，此工具用途仅供学习研究；

![](img/7cfe137dcd69e4743ce86b4729133b73.png)

# 0x04 防御措施

将框架版本升级到官方最新版本；对于 Web 应用来说，尽量保证代码的安全性；对于 IDS 规则层面来说，数值计算和弹计算器返回的状态码都是 302，并且 Location 跳转字段含有特征句柄字符串；如果是命令回显返回的 200 状态码，且有命令结果输出；

# 0x05 小结

文章中提及的 python EXP 下载地址： [`github.com/Ivan1ee`](https://github.com/Ivan1ee) ；

# 0x06 参考链接

[`cwiki.apache.org/confluence/display/WW/S2-057`](https://cwiki.apache.org/confluence/display/WW/S2-057)

[`lgtm.com/blog/apache_struts_CVE-2018-11776`](https://lgtm.com/blog/apache_struts_CVE-2018-11776)

[`blog.csdn.net/madison__/article/details/55671426`](https://blog.csdn.net/madison__/article/details/55671426)