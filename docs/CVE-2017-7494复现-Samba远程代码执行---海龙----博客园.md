# CVE-2017-7494 复现 Samba 远程代码执行 - 海龙。 - 博客园

> 原文：[`www.cnblogs.com/hai-long/p/11939967.html`](https://www.cnblogs.com/hai-long/p/11939967.html)

 Samba 是在 Linux 和 Unix 系统上实现 Smb 协议的一个免费软件，由服务器及客户端程序构成，Samba 服务对应的 TCP 端口有 139、445 等。Smb 一般作为文件共享服务器，专门提供 Linux 与 Windows 之间的传送文件服务。
 Samba 3.5 之后到 4.4.14、4.5.10、4.6.4 中间的所有版本存在严重的远程代码执行漏洞，攻击者可以利用该漏洞在目标服务器上执行任意代码。

 首先查看被攻击系统的 samba 版本为 3.6.9-151 说明存在远程代码执行漏洞

  ![](img/c829df3b22af501dffc771dbefde2e57.png)

  在/etc/ld.so.conf 文件添加 samba 动态链接库，保存退出

  ![](img/4a9fb0ce8f6f06662c38bed815725998.png)

  加载动态链接库：# ldconfig

  看看是否成功

![](img/9630cbd1cea3d5ff6d26ab6c4b54e019.png)

  在 smb 配置文件/etc/samba/smb.conf 结尾加入，保存退出

 ![](img/4120e46f8842286294c0c098dce5898f.png)

 关闭防火墙运行 samba 服务

![](img/aef8a86d8f27f600c84cd9115abbb34f.png)

![](img/f49c0377ab2c899c7636ce07d630d602.png)

 漏洞形成是在/source3/rpc_server/srv_pipe.c 的 is_known_pipename 函数中。只要通过拥有可写入权限的 Samba 用户，就可以提权到 Samba 所在服务器的 root 权限。

下面开始实验

1、使用 nmap 扫描实验机 10.1.1.100 开放端口发现 139、445 端口，samba 服务需要开启 445 端口而 139 端口作为获取 smb 服务

![](img/01eda27c46ec75cab41fbc94a7e0b239.png)

 查看 exp 文件

**![](img/ea6cbd49cfa0b7493d060fc965adb724.png)**

打开 MSF

![](img/530a15463241bb1b460648111d06b76e.png)

   查找 is_known_pipename 模块

![](img/948a4726e079415503c95e3151238ffe.png)

  使用模块 use exploit/linux/samba/is_known_pipename

![](img/7ddb29f8ccb83078ec6db4ef81e48d41.png)

查看配置

![](img/2e24277da3f75d58e84a951a378f2202.png)

 设置目标主机 IP

![](img/0af848396ca06d587afa9a1d6d393214.png)

 查看

  ![](img/ec04751cd135279e864758b9e36f4d5c.png)

 run 开始攻击

![](img/c00efeff37fe3c5bda040430551b06a1.png)

 查看 shadow 文件

![](img/c86481de82477138f28abbd3e1624f0e.png)

 回到目标主机查看是否一致

![](img/8be96a4aca14087a409f1d25c28cc77e.png)

 加固措施

1、使用 samba 最新版本；

2、在 smb.conf 的[global]阶段下增加 nt pipe support = no，重启 samba 服务。

vim /etc/samba/smb.conf 添加

![](img/b7869322ff6f70daad0ef721481d0acf.png)

 重启

![](img/6962cc2c73f2068ab6e63c77c4f23eba.png)

继续攻击，发现行不通了

![](img/3a64bd67c971cf78653833f95f868b1d.png)

 3、官方补丁[`github.com/samba-team/samba/commit/04a3ba4dbcc4be0ffc706ccc0b586d151d360015`](https://github.com/samba-team/samba/commit/04a3ba4dbcc4be0ffc706ccc0b586d151d360015)