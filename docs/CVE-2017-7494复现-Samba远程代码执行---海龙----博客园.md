# CVE-2017-7494复现 Samba远程代码执行 - 海龙。 - 博客园

> 原文：[https://www.cnblogs.com/hai-long/p/11939967.html](https://www.cnblogs.com/hai-long/p/11939967.html)

 Samba是在Linux和Unix系统上实现Smb协议的一个免费软件，由服务器及客户端程序构成，Samba服务对应的TCP端口有139、445等。Smb一般作为文件共享服务器，专门提供Linux与Windows之间的传送文件服务。
 Samba 3.5之后到4.4.14、4.5.10、4.6.4中间的所有版本存在严重的远程代码执行漏洞，攻击者可以利用该漏洞在目标服务器上执行任意代码。

 首先查看被攻击系统的samba版本为3.6.9-151说明存在远程代码执行漏洞

  ![](../Images/c829df3b22af501dffc771dbefde2e57.png)

  在/etc/ld.so.conf文件添加samba动态链接库，保存退出

  ![](../Images/4a9fb0ce8f6f06662c38bed815725998.png)

  加载动态链接库：# ldconfig

  看看是否成功

![](../Images/9630cbd1cea3d5ff6d26ab6c4b54e019.png)

  在smb配置文件/etc/samba/smb.conf结尾加入，保存退出

 ![](../Images/4120e46f8842286294c0c098dce5898f.png)

 关闭防火墙运行samba服务

![](../Images/aef8a86d8f27f600c84cd9115abbb34f.png)

![](../Images/f49c0377ab2c899c7636ce07d630d602.png)

 漏洞形成是在/source3/rpc_server/srv_pipe.c的is_known_pipename函数中。只要通过拥有可写入权限的Samba用户，就可以提权到Samba所在服务器的root权限。

下面开始实验

1、使用nmap扫描实验机10.1.1.100开放端口发现139、445端口，samba服务需要开启445端口而139端口作为获取smb服务

![](../Images/01eda27c46ec75cab41fbc94a7e0b239.png)

 查看exp文件

**![](../Images/ea6cbd49cfa0b7493d060fc965adb724.png)**

打开MSF

![](../Images/530a15463241bb1b460648111d06b76e.png)

   查找is_known_pipename模块

![](../Images/948a4726e079415503c95e3151238ffe.png)

  使用模块 use exploit/linux/samba/is_known_pipename

![](../Images/7ddb29f8ccb83078ec6db4ef81e48d41.png)

查看配置

![](../Images/2e24277da3f75d58e84a951a378f2202.png)

 设置目标主机IP

![](../Images/0af848396ca06d587afa9a1d6d393214.png)

 查看

  ![](../Images/ec04751cd135279e864758b9e36f4d5c.png)

 run开始攻击

![](../Images/c00efeff37fe3c5bda040430551b06a1.png)

 查看shadow文件

![](../Images/c86481de82477138f28abbd3e1624f0e.png)

 回到目标主机查看是否一致

![](../Images/8be96a4aca14087a409f1d25c28cc77e.png)

 加固措施

1、使用samba最新版本；

2、在smb.conf的[global]阶段下增加nt pipe support = no，重启samba服务。

vim /etc/samba/smb.conf 添加

![](../Images/b7869322ff6f70daad0ef721481d0acf.png)

 重启

![](../Images/6962cc2c73f2068ab6e63c77c4f23eba.png)

继续攻击，发现行不通了

![](../Images/3a64bd67c971cf78653833f95f868b1d.png)

 3、官方补丁[https://github.com/samba-team/samba/commit/04a3ba4dbcc4be0ffc706ccc0b586d151d360015](https://github.com/samba-team/samba/commit/04a3ba4dbcc4be0ffc706ccc0b586d151d360015)