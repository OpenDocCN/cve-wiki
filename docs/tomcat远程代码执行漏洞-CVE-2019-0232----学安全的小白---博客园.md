# tomcat 远程代码执行漏洞（CVE-2019-0232） - 学安全的小白 - 博客园

> 原文：[`www.cnblogs.com/pursue-security/p/17030575.html`](https://www.cnblogs.com/pursue-security/p/17030575.html)

# 漏洞原理

漏洞相关的代码在 tomcat\java\org\apache\catalina\servlets\CGIServlet.java 中，CGIServlet 提供了一个 cgi 的调用接口，在启用 enableCmdLineArguments 参数时，会根据 RFC 3875 来从 Url 参数中生成命令行参数，并把参数传递至 Java 的 Runtime 执行。这个漏洞是因为 Runtime.getRuntime().exec 在 Windows 中和 Linux 中底层实现不同导致的

Java 的 `Runtime.getRuntime().exec` 在 CGI 调用这种情况下很难有命令注入。而 Windows 中创建进程使用的是 `CreateProcess` ，会将参数合并成字符串，作为 `lpComandLine` 传入 `CreateProcess` 。程序启动后调用 `GetCommandLine` 获取参数，并调用 `CommandLineToArgvW` 传至 argv。在 Windows 中，当 `CreateProcess` 中的参数为 bat 文件或是 cmd 文件时，会调用 `cmd.exe` , 故最后会变成 `cmd.exe /c "arg.bat & dir"`，而 Java 的调用过程并没有做任何的转义，所以在 Windows 下会存在漏洞

# 漏洞复现

启动 tomcat

![](img/e58927b682ad3cde79f5517d7395e03d.png)

 访问一下已经启动成功

![](img/a5e6e414c2556099db706499be8e85fc.png)

 Tomcat 的 CGI_Servlet 组件默认是关闭的，在`conf/web.xml`中找到注释的 CGIServlet 部分，去掉注释，并配置 enableCmdLineArguments 和 executable

![](img/01cb921ba478a58adf5e2d445fa67bb7.png)

 这里注意一下，去掉注释并添加以下代码

```
enableCmdLineArguments 启用后才会将 Url 中的参数传递到命令行 executable 指定了执行的二进制文件，默认是 perl，需要置为空才会执行文件本身。 <init-param>        <param-name>enableCmdLineArguments</param-name>        <param-value>true</param-value>    </init-param>    <init-param>        <param-name>executable</param-name>        <param-value></param-value>    </init-param>
```

![](img/8c59af8e7a86743cd0069f6c9e9e6f71.png)

 然后在 conf/web.xml 中启用 cgi 的 servlet-mapping

![](img/75e2cccf61ec06d34c06116733f9009e.png)

 修改 conf/context.xml 的添加 privileged="true"属性，否则会没有权限

![](img/756cdbeb3d1b7889e0b3aaf2042ee8a8.png)

 添加 true

```
<Context privileged="true">
```

![](img/5318b0d4b28dd717b55f51a1d7aa0eaa.png)

 在`C:\Tomcat\webapps\ROOT\WEB-INF`下创建`cgi-bin`目录

![](img/83a8f162a3751a5d7f7e51fec1d6a169.png)

 在该目录下创建一个 hello.bat

![](img/79cc1be1fc98e8c7632aed3cdc1d8d39.png)

 然后重启 tomcat 环境

![](img/0e4462207270ae1c524bcba3f4d8ae57.png)

 访问`http://localhost:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Ccalc.exe`即可弹出计算器，这里构造系统命令即可

![](img/23eba1fbf167966b01a65063748dda97.png)

 转载于:https://paper.seebug.org/1677/#cve-2019-0232