# 【CVE-2020-1957】shiro搭配spring时身份验证绕过漏洞分析 - 水泡泡 - 博客园

> 原文：[https://www.cnblogs.com/r00tuser/p/12575934.html](https://www.cnblogs.com/r00tuser/p/12575934.html)

**0x00 漏洞简介**

**[https://www.openwall.com/lists/oss-security/2020/03/23/2](https://www.openwall.com/lists/oss-security/2020/03/23/2)**

**![](../Images/8bb4f0118b8ea89939b0fc61797745cd.png)**

****0x01 漏洞分析****

翻查官方commit，在commit [https://github.com/apache/shiro/commit/9762f97926ba99ac0d958e088cae3be8b657948d](https://github.com/apache/shiro/commit/9762f97926ba99ac0d958e088cae3be8b657948d) 中找到相关信息

 ![](../Images/de4cd5e269bb028945f07e2d608051c3.png)

 大致理解为Spring web在匹配url的时候会容错后面多余的/，而shiro匹配不上导致绕过，由国人tomsun28提交pull request

**0x02 漏洞环境搭建**

使用springboot+shiro搭建一个简单的demo，代码参考至[https://segmentfault.com/a/1190000019440231](https://segmentfault.com/a/1190000019440231)（使用java原生的整合方式）其中shiro使用的是1.4.0版本在shiro-config中配置一个对url "/test/secret"的过滤，此url需要登录才能访问![](../Images/0064f03bcb382f3070c793e1e3e36265.png)

 同时在LoginController中配置以下代码，用于返回一个需要认证的信息

```
1 @GetMapping("/test/secret") 2     public String secret(){ 3         return "secret"; 4     }
```

直接访问/test/secret，跳转到登录页面

![](../Images/e231c6d93dd80ff7fe3f37ced13363f8.png)

 访问/test/secret/，返回了secret

![](../Images/cac726c31f0ecb2c67b2048c04d92da5.png)

官方修复也很简单就是把url后面的/也考虑进去了再进行匹配顺便一提，使用maven拉取包的时候发现1.5.1版源码已经修复了，而1.5.0，1.4.2的源码却拉取不到**0x03 更新** shiro的匹配符知识![](../Images/dfac6d844c24226c02cc8af14d579323.png)看freebuf的分析（[https://www.freebuf.com/vuls/231909.html](https://www.freebuf.com/vuls/231909.html)），才发现自己看漏了。。。后续还有一个绕过，具体commit看这里 [https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce](https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce)由于shiro先获取的url，然后会判断分号是否存在，如果存在就会把后面的删除，进入shiro匹配，匹配不上默认放行，之后Spring web对路径进行规范化从而访问到了相应的控制器比如：

```
/fdsf;/../test/secret

```

![](../Images/b2a1fec1da861ce742ca46be710efa50.png)

**0x04 实际攻击**当shiroFilter这么写![](../Images/bcbce8f5636af2d2b5898b595b508ea9.png)

 与及这么写

![](../Images/9950c335460749342cfb1c0c8fa0e932.png)

都存在绕过，也就是说当配置在二级目录下面的身份验证都存在被绕过的风险

只有这么写的时候，才不存在问题

![](../Images/ffe4bf7b2766a9b2ca7ede5aecfefe27.png)

 本人技术水平有限，如有不妥之处还望谅解