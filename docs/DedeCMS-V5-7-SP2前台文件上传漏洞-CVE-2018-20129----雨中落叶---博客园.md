# DedeCMS V5.7 SP2 前台文件上传漏洞(CVE-2018-20129) - 雨中落叶 - 博客园

> 原文：[`www.cnblogs.com/yuzly/p/11326591.html`](https://www.cnblogs.com/yuzly/p/11326591.html)

DedeCMS V5.7 SP2 前台文件上传漏洞(CVE-2018-20129)

**一、漏洞描述**

织梦内容管理系统(Dedecms)是一款 PHP 开源网站管理系统。Dedecms V5.7 SP2 版本中的 uploads/include/dialog/select_images_post.php 文件存在文件上传漏洞,远程攻击者可以利用该漏洞上传并执行任意 PHP 代码。

该漏洞利用条件:1、需要开发会员注册功能 2、权限必须是管理员，普通用户无法写入文件

**二、漏洞环境搭建**

1、官方下载 DeDeCMS V5.7 SP2(UTF-8),下载地址: http://www.dedecms.com/products/dedecms/downloads/

2、使用 phpstudy 搭建 web 环境

3、把下载好的源码放到网站根目录下(www),然后开启 phpstudy, 浏览器访问 http://192.168.10.171/dedecms/uploads/install/index.php

　　![](img/c64cec41529ba1f5e71398a2aed65e69.png)

4、点击我已阅读并继续。然后是环境检测，保存默认即可

　　![](img/b1a3359e6f11afcaac2d71792268df2a.png)

5、接下来是参数配置，需要设置的只有数据库密码，把自己的密码填上去就行了

　　![](img/edeb894871edb0d5a68581a9f00a9fc4.png)

6、然后就把环境搭好了

　　![](img/159eeb8ccfd3b60b99c8520acb70ea50.png)

7、登录后台,开启会员功能

　　![](img/890e17fb8f2eae24ccf59343b3cb51b6.png)

**三、漏洞复现**

1、首先进入会员中心,必须是管理员的权限,因为后面上传文件有权限限制。进入会员中心后进入内容中心模块

　　![](img/f3683aafe838b8c4567f9fbcee3c089c.png)

2、发布一个文章,点击下面的编辑器的上传图片按钮。

　　![](img/990767951d0ac74ce37959280aff5c90.png)

3、测试上传一个 test.jpg 的图片但是内容只有 php 一句话,下图返回可以看到上传失败

　　![](img/27bae48e4fce3b07f8a88a5020745eb1.png)

4、测试上传一个 test.jpg 的图片但是内容只有 php 一句话和图片的标识头

　　![](img/e958479bf084e5738b43081a5a78f0fe.png)

5、查看代码,在 dedecms\include\dialog\select_images_post.php 中的 36 行，过滤了一些看起来不正常的字符,可以通过以.p*hp 后缀来绕过这行代码

　　![](img/c80445656beb4a10ddae68f34c4a13b6.png)

6、在 38 行处判断了文件名是否包含了$cfg_imgtype 的字符。查看 cfg_imgtype 所在的位置 dedecms\install\config.cache.inc.php,可以构造 abc.p*hp 可以绕过 36 和 38 行代码

　　![](img/dcb339cfc8f62711b5a5ae16bc09c7a4.png)

7、从上面的正则表达式中可以看到,*、%、?、<>可以绕过限制,这里以”*”为例,构造 payload 绕过

7.1、点击上传，选择准备好的一句话图片木马文件(一个 test.jpg 的图片但是内容只有 php 一句话和图片的标识头)

　　![](img/61f758ce4c80de520441b6257b08a0b5.png)

　　![](img/b750af06f46a5b97177e19ce0e1c1b83.png)

7.2、用 burp 工具抓包,将 test.jpg 改为 test.jpg.p*hp,下图可以看到成功上传,但是不知道上传的路径

　　![](img/b28fa3a94afe1228f9757a4290904838.png)

7.3 制作一个隐藏度高点的图片马(图片不损坏),然后上传

　　![](img/f47a3f1f8995eea4f0f0091cb2b088bf.png)

7.4 下图可以看到成功上传并且返回了上传的地址

　　![](img/3203ff72895bfc066c5574e433ec6ff2.png)

8、菜刀连接访问,解析失败,无法连接,可能是图片和一句话制作的图片马影响了解析

9、通过上传图片马获得的上传地址,浏览器访问 http://192.168.10.171/dedecms/uploads/uploads/allimg/190808

　　![](img/e2463dabd02344d6f2da68feb123cbe4.png)

10、点击上图的位置,可以看到如下图所示,说明这个是之前上传的那个没有返回上传地址一句话木马

　　![](img/02c8689152ba1768e9bb8b059d333bb7.png)

11、菜刀连接

　　![](img/73a9916f940ce9b6c25b3e3f8f57612b.png)

**四、漏洞防御**

1、 在服务器端使用”白名单”的方式检查上传文件的类型

2、 强制将所上传的图片的后缀修改”.jpg”,”.png”,”.gif”等格式

3、 升级版本