# Tomcat AJP 文件包含漏洞复现(CVE-2020-1938) - renblog - 博客园

> 原文：[`www.cnblogs.com/renhaoblog/p/13033734.html`](https://www.cnblogs.com/renhaoblog/p/13033734.html)

# 漏洞原理

Tomcat 配置了两个[Connecto](https://blog.csdn.net/gchd19921992/article/details/79076926)，它们分别是 HTTP 和 AJP。
HTTP 默认端口为 8080，处理 http 请求；AJP 默认端口 8009，用于处理 AJP 协议的请求。
AJP 比 http 更加优化，多用于反向、集群等，漏洞由于 Tomcat AJP 协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器 webapp 下的任意文件以及可以包含任意文件，如果有某上传点，上传图片马等等，即可以获取 shell。

## AJP Connector

Apache Tomcat 服务器通过 Connector 连接器组件与客户端程序建立连接，Connector 表示接收请求并返回响应的端点，即 Connector 组件负责接收客户的请求，以及把 Tomcat 服务器的响应结果发送给客户。
在 Apache Tomcat 服务器中我们平时用的最多的 8080 端口，就是所谓的 Http Connector，使用 Http（HTTP/1.1）协议，在 conf/server.xml 文件里 Ajp 协议对应的配置为

```
<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /> 
```

Tomcat 服务器默认对外网开启该端口，Web 客户访问 Tomcat 服务器的两种方式：
![](img/545d72cb05a2ae120b71733cbfc3f80b.png)

# 漏洞环境搭建

进入 vulhub-master/tomcat/CVE-2020-1938 目录下，docker 环境启动

```
docker-compose up -d 
```

*   使用 nmap，扫描目标指定 8009 端口，表示漏洞环境搭建成功

```
nmap -p 8009 192.168.2.147 
```

![](img/759346d2ecf0e38d13637cd7da87ac75.png)

# 漏洞环境复现

## webapp 任意文件读取

可以成功读取 web.xml 文件内容

```
python2 CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.2.147 -p 8009 -f WEB-INF/web.xml 
```

![](img/0b5fcf83e2cb6697cfc1850c7c3056c9.png)

## 任意文件包含

[文件包含漏洞复现](https://xz.aliyun.com/t/7325)

# 漏洞攻击流量分析

1、Wireshark 抓取 poc 获取 web.xml 内容流量
![](img/9d838f2491da6c172614dbbbdbf6df72.png)
2、跟踪流，服务器返回结果如下
![](img/386e2835cdf681b9dee9cfac08b6db25.png)

# 漏洞影响版本

Apache Tomcat 6
Apache Tomcat 7 < 7.0.100
Apache Tomcat 8 < 8.5.51
Apache Tomcat 9 < 9.0.31

# 漏洞修复措施

1、在 servce.xml 中注释 AJP，或者绑定到 localhost
2、升级无漏洞版本
3、Tomcat 7 和 Tomcat 9 可为 AJP Connector 配置 secret 来设置 AJP 协议的认证凭证。
4、Tomcat 8 的可为 AJP Connector 配置 requiredSecret 来设置 AJP 协议的认证凭证。

# EXP

[EXP 下载](https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi)

# 参考链接

[CSDN-Tomcat AJP 文件包含漏洞（CVE-2020-1938）](https://blog.csdn.net/csacs/article/details/104427197)
[CSDN-Tomcat AJP 文件包含漏洞解析](https://blog.csdn.net/yongshou614423/article/details/104578017)
[Tomcat AJP 文件包含漏洞（CVE-2020-1938） 修复方案 （含 Apache2 ajp 负载如何修复）](https://blog.csdn.net/zhaoguoshuai91/article/details/104508539/)
[先知社区-Tomcat Ajp 协议文件包含漏洞分析](https://xz.aliyun.com/t/7325)

# 声明

严禁读者利用以上介绍知识点对网站进行非法操作 , 本文仅用于技术交流和学习 , 如果您利用文章中介绍的知识对他人造成损失 , 后果由您自行承担 , 如果您不能同意该约定 , 请您务必不要阅读该文章 , 感谢您的配合 !