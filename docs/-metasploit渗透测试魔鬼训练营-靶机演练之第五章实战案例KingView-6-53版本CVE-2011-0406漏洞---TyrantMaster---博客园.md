# 《metasploit 渗透测试魔鬼训练营》靶机演练之第五章实战案例 KingView 6.53 版本 CVE-2011-0406 漏洞 - TyrantMaster - 博客园

> 原文：[`www.cnblogs.com/student-programmer/p/6729176.html`](https://www.cnblogs.com/student-programmer/p/6729176.html)

在一个笔记本上开两个虚拟机有点卡，而且太麻烦，就把 metasploit 的目标靶机放在别的机器上了，ip 自己配置了一下，目标主机：192.168.137.254 入侵机:192.168.137.253 目标机上存在漏洞：KingView 6.53 版本 CVE-2011-0406 漏洞，系统 win2003 SP0 下面进入正题：在信息搜集中得知，目标主机开放了 777 端口，百度发现，这个端口运行着 KingView 的服务，并且存在着漏洞。直接在 msf 在 search 这个漏洞的利用模块。。。没有啊于是，上网搜了一个 exp,放到 /exploits/windows/scada 中，查看了一下源代码，发现里边 target 没有 win2003 SP0。![](img/ab6b9b6807fdb5682fb28d5742791c6b.png)没办法，先试试 winXP SP3 看看能否同用吧。配置过程：![](img/97f2e370703abd2bfda0731a04d2655d.png)看看能反弹连接吗:![](img/acfef537e4222f07d80a0f256d6b5785.png)好吧。。。果断不行。。回到目标主机上去调试吧，通过刚才的一次攻击，发现 HistorySvr.exe 停止了运行，说明漏洞被触发了，但是没有执行 shellcode，那么，应该就是跳转指向的地址不是 shellcode 的地址，最终调用了系统默认的异常处理函数。打开 OllyDBG,在 option 菜单中选择 “Just-in-time debugging”,在选“Make ollydbg just-in-time debugger”,之后退出。重新启动 HistorySvr 服务，并再次进行攻击，Ollydbg 截断了异常处理，程序终止在了异常的指令处。![](img/f5d2e9255cdb88b400571d129b1e672d.png)![](img/357a022d435c2a0b9c5c35ae189e103d.png)原因是 call 调用的 eax+0x0C 地址没有被分配使用，触发了异常。回到该模块的源代码，找到 target,发现针对目标 win XP SP3 EN 返回地址 Ret 正是 EAX 寄存器的值 0x00A1FB84,显然，溢出发生之后，数据包的 Ret 覆盖了 EAX，但是并没有成功指向 shellcode 的地址，接下来，只需要修改 Ret 的值就可以了。需要定位 shellcode 的位置，在该渗透模块添加了一个新的 target，Ret 随意写，在构造 exploit 函数的溢出数据包时，加上特殊的定位字符，但要保持总长度不变。关闭 Ollydbg，重启服务，再次进行攻击：![](img/bb5f44b1ac29407b4a7dbff073233b45.png)回到目标靶机上，ollydbg 再次拦截到异常，直接在 Memory 中定位字符“ABAC”,在 0x00B404C0 搜索到了字符，相应的找到了 shellcode 的地址 0x00B404C4![](img/584de18c29049f26d133b046b27fda3a.png)接下来，就修改 Ret 和 exploit 函数就可以了：![](img/70f898e557c8eb9db725f1bd1f946a3c.png)![](img/e8d40df0c4a23627a0fb4bff1d062909.png)重新加载，再次攻击，成功。