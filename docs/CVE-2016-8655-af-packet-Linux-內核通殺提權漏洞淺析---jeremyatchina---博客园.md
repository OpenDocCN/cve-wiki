# CVE-2016-8655,af_packet Linux 內核通殺提權漏洞淺析 - jeremyatchina - 博客园

> 原文：[`www.cnblogs.com/bittorrent/p/6209681.html`](https://www.cnblogs.com/bittorrent/p/6209681.html)

簡單寫一下思路 這個東西需要 namespace 方面的支援,
首先 open socket , 一連串路徑(packet_set_ring()->init_prb_bdqc()->
prb_setup_retire_blk_timer()->prb_init_blk_timer()->
prb_init_blk_timer()->init_timer())後產生 timer object, 搶著在 socket close.
之前控制 po->tp_version 使其走其他路徑搶先 free timer object.
這時候用 add_key 來 heap sprey 覆蓋 被 free 的 time object.
內核攻擊老司機都懂, 被蓋掉的 time object 裡面已經放了 我們事先準備好的
time object 其內部 function pointer 已經被我們 hijacked.
從 user mode 調用 hijacked function in time object.
這時候可以從 user mode call hijacked function 得到 root.

summary :
0x0\. race condition -> UAF. 在這牛逼的時代, 不算新。
0X1\. vsyscall 的利用 (跟 vDSO 差不多), and set_memory_rx().
0X2\. 改用 add_key()來做 heap spraying. 有別於以往科恩(Keen Team)用 sendmmsg 來 heap spraying.
0x3\. 安卓上可利用 gid=3004/AID_NET_RAW 建立 AF_PACKET sockets
(mediaserver) and can trigger the bug.

Ref:
http://seclists.org/oss-sec/2016/q4/607

寫的倉促 歡迎討論指教.