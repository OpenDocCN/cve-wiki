# Apache HTTPD 换行解析漏洞(CVE-2017-15715) - kalibb - 博客园

> 原文：[`www.cnblogs.com/lzkalislw/p/17023784.html`](https://www.cnblogs.com/lzkalislw/p/17023784.html)

#### 1.漏洞原理

Apache HTTPD 是一款 HTTP 服务器，它可以通过 mod_php 来运行 PHP 网页。其 2.4.0~2.4.29 版本中存在 一个解析漏洞，在解析 PHP 时，a.php\x0a 将被按照 PHP 后缀进行解析，导致绕过一些服务器的安全策略。

可以看到这里获取文件名是需要单独 post 一个 name 的，因为如果通过 $*FILES'file' 获 取文件名的话，会把\x0a 自动去除，所以 $*FILES'file' 这种方式获取文件名就不会造成 这个漏洞.

#### 2.影响版本范围

apache ：2.4.0~2.4.29 版本

#### 3.漏洞复现

在这里我自己搭建了 Vulfocus 漏洞复现平台

3.1 前提:会使用 docker 的基本命令(哔站上的教程的挺多的)

3.2 拉取 vulfocus 镜像:docker pull vulfocus/vulfocus:latest

3.3 运行拉下来的镜像:docker run -d -p 80:80 -v /var/run/docker.sock:/var/run/docker.sock -e VUL_IP=0.0.0.0 8e55f85571c8

![](img/2c450d72b365f67ad8b2e7e2d5342970.png)

 3.4 访问页面

![](img/c96b2d549c6b1fe8180812aa9dff66f9.png)

 3.5 开启靶场

![](img/044c35ee7689ea1a38904ad204943055.png)

3.6 设置 burp 代理，将浏览器的流量代理到 burp 上,进行拦截(在这里我使用的是 SwitchyOmega 火狐插件)

 ![](img/2f6becc5dca204acf973be48e67cbebf.png)

 ![](img/939af6dde61cbd96b24de4643aa46cd8.png)

 自己写个表单,用来向服务器上传 webshell

![](img/5cac9fa70f99ceadf95def54c9bdf916.png)

 3.7 访问该静态网页,这里上传如下 webshell,对流量进行抓包

![](img/a4b06b07786f11cd4b467a2e6e02c3d1.png)

 <?php phpinfo();?>

![](img/313558b22241f74431f80cf5d20fc8d2.png)

3.8 后台源码进行分析

<?php if(isset($*FILES['file'])){ #1.php php $name =basename($*POST['name']); $ext = pathinfo($name,PATHINFO_EXTENSION); $array=array('php','php3','php4','php5','phtml','pht'); if(in_array($ext,$array)){ exit('bad file'); } move_uploaded_file($_FILES'file','./'.$name); } ?>

后台是通过黑名单方式过滤了 php 后缀的文件，根据最开始的知识，什么样的文件算是 php 文件呢？在 有定义，这句话的意思是以 php 结尾的文件都算 php 文件，在正则中表示匹配输入字符串的结尾位置。 如果设置了 RegExp 对象的 Multiline 属性，则也匹配 \n 或 \r 恰好，我们在文件末尾加了 0x0a（n），所以被匹配成功了。

a.0x0d \r CR 这三者代表是回车，是同一个东西，回车的作用只是移动光标至该行的起始位置

b.0x0a \n CL 这三者代表换行，是同一个东西，换行至下一行行首起始位置；

3.9 发送到 repeater 进行修改重发

![](img/9d624b8d0c4e5f09d97542da62a094c3.png)

 直接访问:[`192.168.4.157:31071/a.php%0a`](http://192.168.4.157:31071/a.php%0a) 上传上去的 webshell 执行成功

![](img/f014dc3584cac71e91cbba851dd4648d.png)

 ctrl+F 查找 flag

![](img/22234fb05e2c6af96708e2cd393e71b4.png)

#### 4.修复的建议

1.升级到最新版本

2.或将上传的文件重命名为为时间戳+随机数+.jpg 的格式并禁用上传文件目录执行

#### 5.闲谈

2022 年已经过去了，在 2022 年经历了很多事情，虽然过得不算如意，但都挺过来了，一路走来，从没放弃过对安全的追求，安全是我最痴迷的。那段记忆既让我留恋，又使我害怕，不要活在过去，大步向前，没有什么可以难倒我的，大学生涯也快结束了，有时真的感叹时间的飞逝啊，愿你我安好。拿出魄力去做自己热爱的事情，去追求自己的安全，好好安排好 2023 的计划，2023 静心让自己的安全技术再突破，为以后的发展做好准备。时刻准备着，网安人，你绝对不平凡，相信自己，加油!