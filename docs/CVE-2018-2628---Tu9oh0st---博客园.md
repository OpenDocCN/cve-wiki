# CVE-2018-2628 - Tu9oh0st - 博客园

> 原文：[`www.cnblogs.com/Tu9oh0st/p/8877669.html`](https://www.cnblogs.com/Tu9oh0st/p/8877669.html)

哈哈哈，终于等到我复现一个 CVE 漏洞了。![Open-mouthed smile](img/271835b4033fc1e11dc2b3937e3128ad.png)

**漏洞描述**

Oracle Fusion Middleware（Oracle 融合中间件）是美国甲骨文（Oracle）公司的一套面向企业和云环境的业务创新平台。该平台提供了中间件、软件集合等功能。Oracle WebLogic Server 是其中的一个适用于云环境和传统环境的应用服务器组件。

攻击者可以在未授权的情况下，通过 T3 协议在 WebLogic Server 中执行反序列化操作，最终造成远程代码执行漏洞。
Oracle 官方将该漏洞等级定义为“高危”

**CVE-2018-2628 漏洞影响范围**

**受影响的版本：**

*   Weblogic 10.3.6.0
*   Weblogic 12.1.3.0
*   Weblogic 12.2.1.2
*   Weblogic 12.2.1.3

**受影响的区域**

根据 NTI（绿盟威胁情报中心）统计结果，在全球范围内对互联网开放 Weblogic 服务的资产数量多达 19,229，其中归属中国地区的受影响资产数量为 1,787。

由于此漏洞产生于 Weblogic T3 服务，当开放 Weblogic 控制台端口（默认为 7001 端口）时，T3 服务会默认开启，因此会造成较大影响，结合曾经爆出的 Weblogic WLS 组件漏洞（CVE-2017-10271），不排除会有攻击者利用挖矿的可能，因此，建议受影响企业用户尽快部署防护措施。

漏洞复现

第一步发送测试 PoC，PoC 中远程连接的服务器地址就是第二步中所使用的服务器，攻击的 ip 是 192.168.3.103 的 7001 端口上的 T3 服务，该服务会解包 Object 结构，通过一步步的 readObject 去第二步服务器上的 1099 端口请求恶意封装的代码，然后在本地弹出计算器。

![image](https://images2018.cnblogs.com/blog/1330447/201804/1330447-20180418212158615-66237057.png)

第二步在远程服务器上启用 ysoserial.exploit.JRMPListener，JRMPListener 会将含有恶意代码的 payload 发送回请求方。

![image](https://images2018.cnblogs.com/blog/1330447/201804/1330447-20180418212159726-1201699169.png)

查看 weblogic 的日志，可以看到如下错误，此时已经弹出计算器：

![image](https://images2018.cnblogs.com/blog/1330447/201804/1330447-20180418212201322-47150140.png)

**分析：**

Weblogic 已经将互联网暴露的 PoC 都已经加入了黑名单，如果要绕过他的黑名单的限制就只能自己动手构造。来看看 InboundMsgAbbrev 中 resolveProxyClass 的实现，resolveProxyClass 是处理 rmi 接口类型的，只判断了 java.rmi.registry.Registry，其实随便找一个 rmi 接口即可绕过。

其实核心部分就是 JRMP（Java Remote Method protocol），在这个 PoC 中会序列化一个 RemoteObjectInvocationHandler，它会利用 UnicastRef 建立到远端的 tcp 连接获取 RMI registry，加载回来再利用 readObject 解析，从而造成反序列化远程代码执行。

**参考资料:**

**[【高危漏洞】Weblogic 反序列化远程代码执行漏洞](https://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652847498&idx=1&sn=a89d0b8a8033631ca3c443e99f065b78&chksm=bd5941478a2ec8517db54b7784e90af300432277984932bd7a300f59acb9ca20c6ef03e75b45&mpshare=1&scene=23&srcid=0418uMqZN8gH23CecGqYWrja#rd)**

**[【处置建议】Oracle WebLogic 反序列化漏洞（CVE-2018-2628）安全处置建议](http://blog.nsfocus.net/cve-2018-2628-solution/)**