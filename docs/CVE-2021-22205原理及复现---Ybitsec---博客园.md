# CVE-2021-22205原理及复现 - Ybitsec - 博客园

> 原文：[https://www.cnblogs.com/ybit/p/14918949.html](https://www.cnblogs.com/ybit/p/14918949.html)

# CVE-2021-22205

> `RCE` on `Gitlab` `version < 13.10.3`

## 一、根本原因

*   当上传图片文件时，`Gitlab Workhorse`将扩展名为`jpg|jpeg|tiff`的文件通过`ExifTool`删除任何非白名单标记。
*   其中一个支持的格式是`DjVu`。当解析`DjVu`注释时，标记被赋值为`convert C escape sequences`。
*   作者的文章：`https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html` *（详情请看此处）*

```
#convert C escape sequences 出现以下代码
$tok = eval qq{"$tok"}; 
```

## 二、漏洞复现

1.  首先需要一个`Gitlab`平台的一个账户及密码（有些公司的Gitlab平台是允许注册的）
    ![register](../Images/18322c3f668ffc479332cf3b0a9909c1.png)

2.  登录后到个人主页，找到`Snippets`

    ![1](../Images/aae6d2a093afb1601c6e41d86eab8246.png)

    ![](../Images/2a203fe1af303156ae75a5f194c20fb5.png)

    ![](../Images/f5addecdd8c534263097dc43b2a89642.png)

3.  此处需要上传`DjVu`格式图片（即Exp）

    *   `DjVu`格式图片制作方式如下

        1.  下载安装`DjVuLibre` 地址`http://djvu.sourceforge.net/`

        2.  准备好将要压缩图片的文本

            ![](../Images/82d3f4fac4c7ed5db883f9a8a131dbde.png)

            ![](../Images/88fcfe5137aa519b2b7eaa9105b5cd5e.png)

        3.  使用命令`djvumake rce.djvu INFO=0,0 BGjp=/dev/null ANTa=rce.txt && mv rce.djvu rce.jpg` 生成Exp

            ![](../Images/52e7da2afd5ed6d925a17b031f798856.png)

4.  上传`Exp`

    ![](../Images/46a04f81a692f5258400b994211a61f4.png)

5.  成功执行

    ![](../Images/1d2f86ceac670346ef70184996d2926f.png)