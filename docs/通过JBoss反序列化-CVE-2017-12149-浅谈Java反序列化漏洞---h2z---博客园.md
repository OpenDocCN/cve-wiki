# 通过 JBoss 反序列化（CVE-2017-12149）浅谈 Java 反序列化漏洞 - h2z - 博客园

> 原文：[`www.cnblogs.com/h2zZhou/p/8623113.html`](https://www.cnblogs.com/h2zZhou/p/8623113.html)

前段时间学校学习 J2EE，用到了 jboss，顺便看了下 jboss 的反序列化，再浅谈下反序列化漏洞。

![Clipboard Image.png](http://image.3001.net/images/20180313/15209154598921.png)

Java 序列化，简而言之就是把 java 对象转化为字节序列的过程。而反序列话则是再把字节序列恢复为 java 对象的过程，然而就在这一转一变得过程中，程序员的过滤不严格，就可以导致攻击者恶意构造的代码的实现。

举个简单的例子，jboss 的反序列化漏洞出现在 jboss\server\all\deploy\httpha-invoker.sar\invoker.war\WEB-INF\classes\org\jboss\invocation\http\servlet 目录下的 ReadOnlyAccessFilter.class 文件中的 doFilter 中。

```
public void doFilter(ServletRequest request,ServletResponse response,FilterChain chain)
  throw IOException,ServletException
{
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  Principal user=httpRequest.getUserPrincipal();
  if((user=null)&&(this.readOnlyContext!=null))
  { 
    ServletInputStream sis=request.getInputStream();
    ObjectInputStream ois=new ObjectInputStream(sis);
    MarshalledInvocation mi=null;
    try
    {
      mi=(MarshalledInvocation)ois.readObject();
    } 
    catch(ClassNotFountException e)
    {
      throw new ServletException("Failed to read MarshalledInvocation",e);
    }
    request.serAttribute("MarshalledInvocation",mi);

    mi.setMethodMap(this.namingMethodMap);
    Method m=mi.getMethod();
    if(m!=null){
      validateAccess(m,mi)
    }
  }
  chain.doFilter(request,response);
}
```

程序获取 http 数据保存到了 httpRequest 中，序列化后保存到了 ois 中，然后没有进行过滤操作，直接使用了 readObject（）进行了反序列化操作保存到了 mi 变量中，这其实就是一个典型的 java 反序列化漏洞。

复现 jboss 反序列化漏洞（CVE-2017-12149）

靶机 xp_sp3 10.10.1.34

CVE-2017-12149 的主要影响范围是 jbossas 5.x 和 6.x，下载 jboss5.1.0 GA 并安装（需要有 java 环境）。运行时如果发现只能通过 localhost 或者 127.0.0.1 进行访问，可以通过运行时增加命令 run.bat -b 0.0.0.0 ，或新建 start.bat 内容 run.bat -b 0.0.0.0

![Clipboard Image.png](http://image.3001.net/images/20180313/15209049971293.png)

当出现这个的时候说明已经部署好了，可以进行访问了

![Clipboard Image.png](http://image.3001.net/images/20180313/15209050239513.png)

可以访问到页面，

访问 10.10.1.134:8080/invoker/readonly

![Clipboard Image.png](http://image.3001.net/images/20180313/15209050298823.png)

出现此页面则可以判断含有 java 反序列化漏洞

进行漏洞利用，我使用的是香草反序列化工具，网上还有很多工具，包括 ysoserial，都可以进行漏洞利用

![Clipboard Image.png](http://image.3001.net/images/20180313/1520905037794.png)

![Clipboard Image.png](http://image.3001.net/images/20180313/15209050402908.png)

列出了文件目录

关于修复漏洞，建议如果不使用此组件，可以删除。或添加代码，进行监控。