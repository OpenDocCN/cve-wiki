# # CVE-2019-2725反序列化漏洞补丁绕过分析 - Afant1 - 博客园

> 原文：[https://www.cnblogs.com/afanti/p/11079638.html](https://www.cnblogs.com/afanti/p/11079638.html)

## 一、CVE-2019-2725几种poc构造

CVE-2019-2725几种poc构造看我博客链接，解压密码都是afanti_
[CVE-2019-2725 二次反序列化jdk7u21 gadgets](https://www.cnblogs.com/afanti/p/10792982.html)
[CVE-2019-2725 二次反序列化jndi注入分析](https://www.cnblogs.com/afanti/p/10802022.html)
[CVE-2019-2725 二次反序列化FileSystemXmlApplicationContext Gadget POC](https://www.cnblogs.com/afanti/p/10815728.html)
[CVE-2019-2725二次反序列化EventData Gadget POC/JdbcRowSetImpl POC构造](https://www.cnblogs.com/afanti/p/10816028.html)

## 二、补丁信息

看下CVE-2019-2725补丁信息，与上次补丁过滤了class标签，主要的目标是找个标签代替class标签绕过补丁
![Alt text](../Images/829cbc1671d327111f494fb848ac3e0e.png)

## 三、复现分析

### 复现环境：jdk1.6.0_31+weblogic 10.3.6

通过`<array method="forName">` ，Class.forName(classname) 反射方法获取类，先把回显的poc怼出来，回显参考我写的这篇文章[https://www.cnblogs.com/afanti/p/10887381.html](https://www.cnblogs.com/afanti/p/10887381.html)，使用jdk7u21 gadgets，具体poc直接贴在最下方。
直接定位到处理xml标签的类：com.sun.beans.ObjectHandler类的startElement方法：
在处理array标签时跟入，this.isString为false来到else分支。
![Alt text](../Images/f0f86cbd2c131563b7bf95c4eea47f41.png)
194行会实例化MutableExpression，看下这个类的方法，
![Alt text](../Images/836f1f3f5b80b22f1ff44d9167bcdc08.png)
查阅[java手册](https://docs.oracle.com/javase/7/docs/api/java/beans/Expression.html)
，可以用表达式的形式来调用构造方法、实例化对象、调用方法
![Alt text](../Images/6939fcb78ee4ca419fb14a5809e9ecdd.png)
这里方法名赋值为forName
![Alt text](../Images/e67be56c1db62c6495b2032e19aa3d9b.png)
跟到具体处理array标签的代码，因为array标签没有设置length属性，来到else分支，Expression的Target设置为一个Object对象
![Alt text](../Images/8e00e9ea89672d57bea35ccec352eb01.png)
最终本函数会将调用Class.forName的Expression对象压入表达式栈中
![Alt text](../Images/49e816eb60fbb7309bd4344c5baa8b04.png)
再看一下endElement实例化恶意类的地方，将Class.forName从栈顶弹出，调用getValue的方法实例化UnitOfWorkChangeSet类
![Alt text](../Images/ab35daead38f746e92571af1f7c9999c.png)
最终来到漏洞触发点，传入jdk7u21的gadgets触发漏洞。
![Alt text](../Images/14140dd5c51c95b8ba4ff23e1c95a989.png)
调用栈信息：
![Alt text](../Images/4e50b5861ed3afca9e0024bc18ab4d1c.png)
复现情况：
![Alt text](../Images/eef7f73d5393c8878de0ea097baa7963.png)

### 复现环境：jdk1.7.0_21+weblogic 10.3.6

当jdk版本改为jdk1.7.0_21发现之前的payload不能用了，下断跟下原因，这里发现jdk1.7版本处理xml时跟jdk1.6不一样，是由一个一个Handler来处理。
![Alt text](../Images/d3f8d5f7fc637db1b065f5991e064ba7.png)
来到处理array的Handler，这个类的成员变量只有length属性，没有method属性
![Alt text](../Images/d0b683f557fa5a62b625c64d19b3acfd.png)
看其父类的属性，有class属性，在向上找的话也没发现method属性，知道报错的原因了，具体跟一下
![Alt text](../Images/b18f2d3aacbef5af9f5a0b0b93dd312c.png)
跟入父类的addAttribute
![Alt text](../Images/33ad3ef35699ebcd1b113886f45d2534.png)
这里'method'!=class返回false
![Alt text](../Images/fea78e1546b3284a0efd9d47eed1fc40.png)
这里抛出异常
![Alt text](../Images/05f24e48a9e0d012fbc643c76aed639b.png)
![Alt text](../Images/5f3d9df708cd070a7904715f6864ce71.png)

### 复现环境：jdk1.6.0_31+weblogic 12.1.3

在jdk1.6.0_31版本Weblogic 12服务器都不能启动，查阅资料要求weblogic 12.1.3要求jdk需要1.7以上，所以weblogic12不存在绕过。

## 总结

利用环境jdk1.6以下，weblogic版本10.3.6。
通过`<array method="forName">`绕过。
POC：链接：[https://pan.baidu.com/s/1Pa8_Bpl7XpDC6U12r1IWUw](https://pan.baidu.com/s/1Pa8_Bpl7XpDC6U12r1IWUw)
提取码：rpkb