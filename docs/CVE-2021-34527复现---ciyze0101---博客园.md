# CVE-2021-34527 复现 - ciyze0101 - 博客园

> 原文：[`www.cnblogs.com/ciyze0101/p/15306787.html`](https://www.cnblogs.com/ciyze0101/p/15306787.html)

一、背景

　　CVE-2021-1675 和 CVE-2021-34527 两个都是通过加载 DLL 的方式实现代码执行的 windows 打印服务中的漏洞，攻击者可以利用该漏洞使用低权限用户加载恶意 DLL，实现远程代码执行，在网上已经有不少的复现博客，这里记录下自己复现该漏洞以及 RPC 相关知识的总结。

二、CVE-2021-1675 复现

　　复现用例参考：

　　C++用例：[`github.com/hayasec/PrintNightmare`](https://github.com/hayasec/PrintNightmare)

　　python 用例：[`github.com/cube0x0/CVE-2021-167`](https://github.com/cube0x0/CVE-2021-1675)5

　　该漏洞发生在 AddPrinterDriverEx 函数，当第三参数传入 APD_INSTALL_WARNED_DRIVER = 0x00008000 时，会绕过 Access 的检查，成功调用 InternalAddPrinterDriverEx 进行 DLL 加载，该函数可以通过 rpc 的 MS-RPRN 协议的[RpcAddPrinterDriverEx](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b)函数进行调用，MS-RPRN 的 guid 为 12345678-1234-ABCD-EF00- 0123456789AB，使用通过管道\pipe\spoolss 进行 rpc 传输，其中例子 1 使用 tcpip 协议，例子 2 使用 smb 协议进行 rpc 调用

　　测试如下：

　　例子 1：

　　![](img/a13d3ef01a06b04331e60a27ad3eab8c.png)

 　　流量如下：

　　![](img/ede852a9aae07616ae09ef480423b74b.png)

　　例子 2：

　　![](img/ae9779bff7f897f6d0ca170bddb71170.png)

　　使用的 SMB3 加密流量，无法从流量观察到攻击信息

 　　![](img/96eb045ea73b68579ffeb5fecab96384.png)

三、CVE-2021-34527（PrintNightmare）复现

　　该漏洞的 POC 使用 Mimikatz 中的 RpcAsyncAddPrinterDriver 进行复现，该 API 同样可以设置 APD_INSTALL_WARNED_DRIVER，绕过权限检查，实现恶意 DLL 加载和代码执行，[RpcAsyncAddPrinterDriver](https://docs.microsoft.com/zh-tw/openspecs/windows_protocols/ms-par/5d864e3e-5d8b-4337-89ce-cb0258ab97cd)为 MS-PAR 协议的 RPC 调用，GUID 为[76F03F96-CDFD-44FC-A22C-64950A001209](https://docs.microsoft.com/zh-tw/openspecs/windows_protocols/ms-par/8405f9fc-556b-4bb4-b9bb-08b1e96802f3)。

　　测试用例：[mimikatz](https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20210709)

　　![](img/95f7b5ce0806133b5c3d972d364031c0.png)

 　　![](img/fc0f8b0ee3e58b2961f46d57d79b541f.png)

　　其中流量如下：

　　![](img/10f30b2a2e3afc2d446867cdac4ca719.png)

 四、参考：

　　[`www.freebuf.com/vuls/279876.html`](https://www.freebuf.com/vuls/279876.html)

　　[`422926799.github.io/posts/c257aa46.html`](https://422926799.github.io/posts/c257aa46.html)