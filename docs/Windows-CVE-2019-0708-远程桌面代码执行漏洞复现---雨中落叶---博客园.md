# Windows CVE-2019-0708 远程桌面代码执行漏洞复现 - 雨中落叶 - 博客园

> 原文：[https://www.cnblogs.com/yuzly/p/11485316.html](https://www.cnblogs.com/yuzly/p/11485316.html)

Windows CVE-2019-0708 远程桌面代码执行漏洞复现

**一、漏洞说明**

2019年5月15日微软发布安全补丁修复了CVE编号为CVE-2019-0708的Windows远程桌面服务（RDP）远程代码执行漏洞,该漏洞在不需身份认证的情况下即可远程触发,危害与影响面极大。

目前,9月7日EXP代码已被公开发布至metasploit-framework的Pull requests中,经测试已经可以远程代码执行。

**二、漏洞影响版本**

*   Windows 7 for 32-bit Systems Service Pack 1
*   Windows 7 for x64-based Systems Service Pack 1
*   Windows Server 2008 for 32-bit Systems Service Pack 2
*   Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
*   Windows Server 2008 for Itanium-Based Systems Service Pack 2
*   Windows Server 2008 for x64-based Systems Service Pack 2
*   Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
*   Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1
*   Windows Server 2008 R2 for x64-based Systems Service Pack 1
*   Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
*   Windows XP SP3 x86
*   Windows XP Professional x64 Edition SP2
*   Windows XP Embedded SP3 x86
*   Windows Server 2003 SP2 x86
*   Windows Server 2003 x64 Edition SP2

注:Windows 8和windows10以及之后的版本不受此漏洞影响

**三、漏洞环境搭建**

攻击机:kali 2018.2

靶机:win7 sp1 7061

　　![](../Images/ee94100c8daafb1d7fe7b5b2efdf0148.png)

**四、漏洞复现**

1、更新msf

apt-get update

apt-get install metasploit-framework

　　![](../Images/eb82fe8c01d123b57749d14d8e7f0ca4.png)

2、下载攻击套件

```
wget https://raw.githubusercontent.com/rapid7/metasploit-framework/edb7e20221e2088497d1f61132db3a56f81b8ce9/lib/msf/core/exploit/rdp.rb
wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/rdp_scanner.rb
wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb
wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb
```

3、替换msf中相应的文件　

```
cve_2019_0708_bluekeep_rce.rb 添加 /usr/share/metasploit-framework/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb

rdp.rb 替换 /usr/share/metasploit-framework/lib/msf/core/exploit/rdp.rb

rdp_scanner.rb 替换 /usr/share//metasploit-framework/modules/auxiliary/scanner/rdp/rdp_scanner.rb
 cve_2019_0708_bluekeep.rb 替换 /usr/share/metasploit-framework/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb
```

4、启动msf,加载文件

　　![](../Images/cf21d5d39f8f334145081c26e16cb18b.png)

5、搜索0708,可以看到文件成功加载

　　![](../Images/a2978e37997933096164ad124a7c733f.png)

6、利用漏洞,设置rhosts、target、payload

　　![](../Images/ef2d3b282b98ebebcabf73fb5b7650ea.png)

 　　![](../Images/ac9e7c9a766a8240d1f89ae73ae8341f.png)

 　　![](../Images/231c631ac8ac5f0117aae1307b62a361.png)

 　　![](../Images/0c2d321f9fcec749af53da6d53a55b7f.png)

7、开始执行exp,成功获得shell

 　　![](../Images/a51cdc805fc926ee1c99fac0fbac6217.png)

 　　![](../Images/e0c675f1272fd46540716f0683bf73cf.png)

**五、漏洞防御**

1、热补丁修复工具下载,下载地址: https://www.qianxin.com/other/CVE-2019-0708

注: CVE-2019-0708热补丁工具”是针对“Windows远程桌面服务的远程代码执行漏洞CVE-2019-0708”推出的热补丁修复工具，可以针对不能直接打补丁环境，提供的临时解决漏洞问题的方案。　

```
1、 下载文件进行解压。 2、 使用win+R快捷键或开始菜单选择“运行”，输入cmd。调起命令行工具。 3、 在命令行工具，执行命令到工具所在文件夹 4、 输入命令对应功能，启用热补丁命令：QKShield.exe /enable ；禁用热补丁命令：QKShield.exe/disable 。 5、 重启系统后，需要重新运行命令行来启用热补丁
```

2、启用热补丁

　　![](../Images/8a87a7600749da64b45a7a7c87a6d2d2.png)

3、再次检测是否存在漏洞,可以看到打完热补丁之后,不存在漏洞了

　　![](../Images/9532a5984014af760a6107951dc4ace7.png)

4、打补丁,漏洞修复工具下载,下载地址: https://www.qianxin.com/other/CVE-2019-0708

　　![](../Images/0683fed51f8f83ef401aff2979f308a9.png)

5、点击”立即修复”,完成安装之后,重启电脑

　　![](../Images/964de4b38259e76707281872d280961a.png)

 　　![](../Images/443ab9d1ffcea774134145b08e4a0aa3.png)

6、使用漏洞扫描工具检测是否存在漏洞,扫描工具下载地址: https://www.qianxin.com/other/CVE-2019-0708

 　　![](../Images/81861cb2b3422836a0b1f6f5e046036a.png)

7、 官方补丁:[https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708)

8、临时措施

　　1、若用户不需要用到远程桌面服务，建议禁用该服务。

       2、开启网络级别身份验证（NLA），此方案适用于Windows 7, Windows Server 2008, Windows Server 2008 R2。

　　![](../Images/481934333d9b1a0c4d0a33c21234249c.png)

 9、开启"网络级别身份验证"之后,再次漏洞扫描,发现不存在漏洞　![](../Images/1de8e795aa79ba5b98726c3a59b9f832.png)

-------------------------------------------------------------------------------------------------------

官方补丁:[https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708)