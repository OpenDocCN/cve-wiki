# vmware 漏洞之三——Vmware 虚拟机逃逸漏洞（CVE-2017-4901）Exploit 代码分析与利用 - studyskill - 博客园

> 原文：[`www.cnblogs.com/studyskill/p/7279970.html`](https://www.cnblogs.com/studyskill/p/7279970.html)

本文简单分析了代码的结构。有助于理解。

转：http://www.freebuf.com/news/141442.html

## 0×01 事件分析

2017 年 7 月 19 unamer 在其[github](https://github.com/unamer/vmware_escape)上发布了一个针对 Vmware 的虚拟机逃逸的 exploit 源码，使用 C++编写。据称影响了 Vmware Workstation 12.5.5 以前的版本，并给出了演示过程，实现了从虚拟机到宿主机器的代码执行，弹出了熟悉的计算器。该代码开源后，只需要将执行计算器部分的 shellcode 替换成其他具有恶意攻击的代码，可以造成很大的危害。

通过代码梳理，发现该 exploit 针对的漏洞就是三月份被曝光的 CVE-2017-4901。关于该漏洞，长亭安全研究实验室（Chaitin Security Research Lab）发布了其 2017 年 3 月参加 Pwn2Own 黑客大赛[关于这个 Vmware 漏洞的挖掘与利用的很多细节](https://zhuanlan.zhihu.com/p/27733895?utm_medium=social&utm_source=wechat_timeline&from=timeline&isappinstalled=1) 。

而该漏洞的原理与 2016 年 11 月在 360PwnFest 中展示的 CVE-2016-7461 这个漏洞的原理也是一致的，均是出在 drag-and-drop 函数和 copy-and-paste 函数中，只不过该漏洞是出现在 version4 中，而当前 CVE-2017-4901 出现在 Version 3 这个版本中。Vmware 给了关于其的公告：[`www.vmware.com/security/advisories/VMSA-2016-0019.html`](https://www.vmware.com/security/advisories/VMSA-2016-0019.html) 。

## 0×02 exploit 代码分析

根据 exploit 的代码，按照步骤分析漏洞的整个利用过程。

### （1）设置 version 3.0 版本

因为该漏洞存在于 DnD 和 CnP 机制的 Version 3 中，故设置 DnD 与 CnP 均为 version3 的版本。使用的命令分别“tool.capability.dnd_version 3“和 tools.capability.copypaste_version 3“。

![设置版本](http://image.3001.net/images/20170724/15008787264601.png) 

### （2）溢出堆

为了达到代码执行，需要溢出堆中对象函数指针或者虚表指针。

![溢出堆](http://image.3001.net/images/20170724/15008787378133.png)

![溢出堆](http://image.3001.net/images/20170724/1500878770103.png)

### （3）创建 Version 3 的 DnD 和 CnP 对象

需要通过查询 DnD 和 CnP 的版本才能使设置生效，需要发送的命令分别为：vmx.capability.dnd_version 和 vmx.capability.copypaste_version，这两个命令均会检查 DnD/CnP 机制的版本,同时根据版本会创建两个对象，DnD 和 CnP，其中 version3 对应的 C++对象大小为 0xA8。

![创建 Version 3 的 DnD 和 CnP 对象](http://image.3001.net/images/20170724/15008787799005.png) 

### （4）覆盖 c++对象虚表地址

根据 C++对象的大小进行多次越界写内存。

![覆盖 c++对象虚表地址](http://image.3001.net/images/20170724/15008788379522.png)

![覆盖 c++对象虚表地址](http://image.3001.net/images/20170724/15008788486817.png) 

### （5）通过信息泄露绕过 ASLR

通过命令 info-set guestinfo.KEY VALUE 和 info-get guestinfo.KEY 来设置和获取数据，通过这两个命令后面的值来泄露堆上的对象，从而获取对象的虚表地址，从而得到 vmware-vmx 的地址。

 ![通过信息泄露绕过 ASLR](http://image.3001.net/images/20170724/15008788614136.png)

### （6）实现代码执行

根据信息泄露判断溢出的是哪一种 C++对象，DnD 还是 CnP。根据判断类型，分别利用 ROP 绕过 DEP，拼接 shellcode 后完成 exploit 的构造。

CnP 类型对象溢出利用构造：

覆盖对象虚表地址，指向伪造的虚表，然后发送 CP 命令，触发虚函数调用。

![CnP 类型对象溢出利用构造](http://image.3001.net/images/20170724/15008790254070.png) 

其中 SetGlobalPointer 函数发送 unity.window.contents.start 命令，通过在命令中指定参数的宽度和高度，写入一个 64 位的堆栈迁移 gadget 地址。

 ![CnP 类型对象溢出利用构造](http://image.3001.net/images/20170724/15008790428445.png)

DnD 类型对象溢出利用构造：

 ![DnD 类型对象溢出利用构造](http://image.3001.net/images/20170724/1500879056276.png)

发送 payload 完成构造

![发送 payload 完成构造](http://image.3001.net/images/20170724/15008790688156.png) 

## 0x03 exploit 利用

作者在其 github 上提到，因为没有对 Windows LFH 随机化处理好，所以并没有实现完美的利用。在测试过程中虚拟机确实出现了利用不稳定的情况：直接崩溃或者弹出计算机后虚拟机退出。测试版本：Vmware Workstation Pro 12.5.1 Build build-4542065。

### （1）弹出计算器后闪退

![弹出计算器后闪退](http://image.3001.net/images/20170724/15008790856854.png) 

 ![弹出计算器后闪退](http://image.3001.net/images/20170724/15008791134004.png)

### （2）直接崩溃

![直接崩溃](http://image.3001.net/images/20170724/15008791298251.png) 

### （3）利用成功

![利用成功](http://image.3001.net/images/20170724/15008791436059.png) 

对于作者开源的 exploit 代码来看，结构还是很清晰的，对于要修改后利用，主要是两个方面，增加 exploit 的稳定性以及 shellcode 功能部分的修改。

## 0×04 缓解措施

目前很多的企业、政府都使用了 Vmware 的产品，在虚拟机与宿主机之间的这一“虚拟与现实”之间的安全隔离也不再坚不可摧了，目前该漏洞影响 Vmware Workstation Pro/Player 和 Vmware Fusion Pro/Fusion 的较低版本，在高版本中已经修复。对于使用 Vmware 的用户可以通过【帮助】->【关于 Vmware Workstation】来查看版本信息，若是版本低于 12.5.5，请及时升级；建议升级到当前最新的版本 12.5.7。

## 0x05 参考文献

[`github.com/unamer/vmware_escape`](https://github.com/unamer/vmware_escape)

[`zhuanlan.zhihu.com/p/27733895?utm_medium=social&utm_source=wechat_timeline&from=timeline&isappinstalled=1`](https://zhuanlan.zhihu.com/p/27733895?utm_medium=social&utm_source=wechat_timeline&from=timeline&isappinstalled=1)