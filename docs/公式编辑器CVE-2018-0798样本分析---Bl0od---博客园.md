# 公式编辑器 CVE-2018-0798 样本分析 - Bl0od - 博客园

> 原文：[`www.cnblogs.com/zUotTe0/p/15265221.html`](https://www.cnblogs.com/zUotTe0/p/15265221.html)

  当前样本是一个 RTF 文档，内嵌一个公式编辑器对象，该对象利用 Office 编辑器漏洞 CVE-2018-0798 执行 shellcode，对 EQNEDT32.exe 进行代码注入，执行恶意代码。
  使用 rtfobj 查看文档结构，可以看到携带了 3 个 OLE 对象，但是 id 为 1 的对象并未被使用。
  第二个是一个 package 对象，原路径为” C:\Users\n3o\AppData\Local\Microsoft\Windows\INetCache\Content.Word\wd32PrvSE.wmf”，实际是一个经过加密的 exe 文件，在漏洞触发后，被 Shellcode 解密并注入新起的 EQNEDT32.exe 进程中；
  第三个为公式编辑器对象，其中 {0002CE02-0000-0000-C000-000000000046}即为 Equation Editor 3.0 关联 CLSID，该对象会触发 CVE-2019-0798 漏洞，从而执行 Shellcode。
![image](img/ec064f91dff72d9efaaf1a300897ee54.png)
  在 EQNEDT32.exe 中 CVE-2018-0798 漏洞函数 sub_443E34 处下断点，打开 RTF 文档，程序将中断于断点。
  在 sub_443E34 中，会对公式编辑器对象进行处理。其中 sub_416352 用于获取控制数据，之后在 sub_443F6C 函数中会进行数据复制操作，而之前获取的偏移 0x1E、0x1F 处的字节将被用于控制数据复制的长度。
![image](img/6b4c4ae6b4321d3148a3aded479d8245.png)
  sub_443F6C 中，参数 a1 即为控制长度的字节，计算值”(2*a1+9)>>3”，结果作为复制数据的长度值，该函数被连续调用两次，完成目标的覆盖。
![image](img/d4b6c2ce7dc8db8727479a30f1a6a7d7.png)

  覆盖前的栈：
![image](img/a17461fd141f26acf77b6e85893c81ab.png)

  覆盖后的栈：
![image](img/a8345a40c463a23a2215d8abc11b819e.png)

  接着调用 sub_4428F0，利用之前覆盖的数据，构建一个 Trampoline Shellcode 片段，用于跳转执行 RTF 本身携带的 Shellcode。
![image](img/5185e3ca486311ecbdc21e3d93ac6490.png)

  在 sub_43A78F 中控制程序再次调用漏洞函数 sub_443E34，最终覆盖函数 sub_443E34 的返回地址。通过构造并覆盖成功的 ROP 链跳转到 Trampoline Shellcode 处，最终成功跳转并执行自身携带的 Shellcode。
![image](img/c28e889f3e5a8f1a59aa85863b630547.png)

  Shellcode 进行异或自解密，并继续执行解密后的代码。
![image](img/2a07bd977fefc0aea6d224be288840d0.png)

  读取被释放到<temp>目录下的 package 对象 wd32PrvSE.wmf，进行异或解密，得到一个 EXE 文件。
![image](img/f6126d99d8a77286b9ea2e8791793d6d.png)</temp>

  使用 Process Hollowing 技术将解密后的 EXE 隐藏于 EQNEDT32.exe 进程中执行。
![image](img/74175c53452105209c0a5171535e5701.png)

![image](img/27e4aa578f89ebde606a6f1aae9c841a.png)

![image](img/352a7896d82aba6531b81020924d9f7c.png)

  解密出的 EXE 将会复制自身的执行文件（即 EQNEDT32.exe）到<appdata>目录，并以当前时间创建文件名。接着访问 URL：[`internetcasinoweblog.com/wp-admin/js/xfn/joel.exe（已失效），下载资源，写入`](https://internetcasinoweblog.com/wp-admin/js/xfn/joel.exe%EF%BC%88%E5%B7%B2%E5%A4%B1%E6%95%88%EF%BC%89%EF%BC%8C%E4%B8%8B%E8%BD%BD%E8%B5%84%E6%BA%90%EF%BC%8C%E5%86%99%E5%85%A5)<appdata>下被创建的时间命名的文件，最终执行程序。</appdata></appdata>

  如果下载失败，执行的将是一开始复制过来的 EQNEDT32.exe，只是名字被更改。
![image](img/39f9954b73ea63db1a6dd4f651b28b9f.png)