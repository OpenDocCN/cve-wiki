# PHP 任意文件上传漏洞 CVE-2015-2348 浅析 - cyjay5un - 博客园

> 原文：[`www.cnblogs.com/cyjaysun/p/4390930.html`](https://www.cnblogs.com/cyjaysun/p/4390930.html)

昨晚安全新闻爆出一个“PHP 任意文件上传漏洞”，CVE 编号为：CVE-2015-2348。

当时楼主正准备收拾东西回家，看到这个新闻心里一惊：失传江湖多年的 0 字符截断上传漏洞又重现了？而且还影响这么多版本！如果漏洞属实，看来今晚又要通宵打补丁了啊。

不过经过简单分析后，发现漏洞的利用条件相当苛刻（很多人好奇到底有多苛刻），楼主简单记录自己的分析过程和大家分享一下，如有不当，请多多指正。

**一、漏洞概述**

漏洞报告者说 php 的上传函数 move_uploaded_file 的目的路径参数可以使用空字符截断，绕过 jpg，png 上传类型的检测，从而导致任意文件上传。报告者给出的测试 EXP：

move_uploaded_file($_FILES['x']['tmp_name'],"/tmp/test.php\x00.jpg")

按照漏洞报告者的描述 5.3 以后版本都受影响（https://bugs.php.net/bug.php?id=69207）

![](img/8e17fbead55c75f2c1d627a6548d6496.png)

**二、漏洞测试**

为验证漏洞有效性楼主搭建一个测试环境，版本 5.3.6，构造测试代码如下：

上传前台页面 upload.htm:

![](img/377b86063a649c2237de2c99510017f8.png)

 上传处理脚本 upload.php

![](img/04dad79d8a46b5f9a9e4e7989c91594c.png)

 测试上传 upload.php 始终返回失败 false

![](img/65e21b9a2110fdee04da7d629e8d43ba.png)

于是换了一个版本 5.3.29，依旧未测试成功，难道是我测试的方法不对，那就看一下源码吧。

**三、漏洞调试**

move_uploaded_file 的代码实现在 ext/standard/basic_functions.c 文件，关键代码：

![](img/7a69dc1da33f911be23a72d0d0b461e5.png)

代码中有几处 return false 的逻辑，那么测试不成功肯定是命中了其中的一个逻辑。

楼主使用最原始的打 log 方法来调试，确认测试代码被上述标红代码过滤了，于是查看打印出来 strlen(new_path) 和 new_path_len 的值  —— 分别是 19 和 23。

new_path 是路径名字符串“/tmp/whoisdashuaige\x00jpg”的长度，由于 strlen 计算到空字符处\x00 结束，因此长度 19 可以理解。

那么为什么 new_path_len 是 23 呢？

PHP 语言中所有的变量类型都保存在一个如下的结构体中，new_path_len 对应标红的 len。这里的 len 是一个二进制长度，不会遇到空字符结束所以长度为 23。所以测试 demo 使用\0 在这里长度不等一直返回失败。

![](img/3f473d511f13ce30d6144e25a4148a0f.png)

那测试成功的又是什么情况呢，组里另外一位同事发来消息说在 5.6.6 版本可测试成功，打开 5.6.6 漏洞代码处一看震惊了，5.6.6 代码如下：

![](img/1a5f0094954cecbe0f0d49cdf753e02b.png) 

原来在高版本（受影响版本中），**PHP 把长度比较的安全检查逻辑给去掉了，**导致了漏洞的发生，不知道这段代码是哪个开发者更新的，什么仇什么怨。

**四、漏洞利用条件**

漏洞利用需要控制第二个参数（目标路径），比如：

![](img/94fb30c87cf11bb335120e4a6e788e1e.png) 

但是，实际在开发场景中，目标路径一般是程序自己生成的（避免同名文件覆盖的情况），就算退一步，程序猿同学想取原来的文件名，往往也习惯用$_FILES 变量取文件名。

而$_FILES 变量中如果加入\0 字符截断，却又不影响程序逻辑：

提交 a.php\0jpg 和 a.php 是等价的。

测试方法如下：

![](img/8ddf1a011fd6465129ce66d429f044a1.png) 

上传抓包修改 name 为 a.php\0jpg（\0 是 nul 字符），可以看到$_FILES['xx']['name']存储的字符串是 a.php，不会包含\0 截断之后的字符，因此并不影响代码的验证逻辑。

但是如果通过$_REQUEST 方式获取的，则可能出现**扩展名期望值不一致的情况**，造成“任意文件上传”。

**五、总结**

1、漏洞影响版本必须在 5.4.x<= 5.4.39, 5.5.x<= 5.5.23, 5.6.x <= 5.6.7，详见 CVE 公告：https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348

2、漏洞利用条件苛刻，与实际业务书写代码习惯有较大的差异，因此风险较低

行为仓促，如有不当请指正。

摘自：TSRC