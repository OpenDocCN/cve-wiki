# 20181330-王茜-CVE-2019-0803 提权漏洞复现 - 王茜 - 博客园

> 原文：[`www.cnblogs.com/wangqianhey/p/14710633.html`](https://www.cnblogs.com/wangqianhey/p/14710633.html)

CVE 编号：2019-0803

影响版本：Windows7

代码链接：https://github.com/ExpLife0011/CVE-2019-0803

## Step1：下载代码

![](img/1dbe8f34d943cf6b6fe26f58def140d7.png)

## Step2：使用 vscode 编译运行后，即可达到 system 权限

![](img/78240176973d0615f2b6554328a1005f.png)

权限为 administrator

## Step3：运行生成的文件

将生成的 exe 文件粘贴到 win7 虚拟机里

在运行前，可以输入 whoami 查看当前权限

![](img/b10e7191fd0f59e92280b609a492dc04.png)

如下图所示，当前为 administrator 用户。

打开 cmd，输入 pos_test.exe 运行

![](img/5a6adca0a83db93e4afc7f4358d6f8c6.png)

## Step4：提权成功！

![](img/94cd541822dda27be6a4e364c6f350d4.png)

之后，在命令行中输入 whoami 查看权限

![](img/a673323e2ae6297605e1ae75337766d6.png)

可以看到，当前权限为 system。

![](img/fee6cbd2820eb642079c8a7f5612ac3e.png)

如果不成功多运行几次就可以啦！

# 漏洞成因：

DDE 通信时，client 向 server 请求数据后，sever 返回数据时，首先会调用用户层函数 _clientCopyDDEIn1（usr32.dll 中），该函数是将一些数据填充至 tagINTDDEINFO 结构，然后再调用 hmgSetOwner 函数（win32k.sys 中），该函数会将 tagINTDDEINFO 中的成员 hIndirect（GDI 句柄）返回给 client。

因此，利用思路是，先新建一个 A 进程并创建得到一个对象句柄 X，然后修改用户层函数 _clientCopyDDEIn1，将 tagINTDDEINFO 的成员 hIndirect 修改为 X，这样返回给 client 的对象就是一个外部对象 X。

Client 结束后会释放 X，然后再用事先构造好的 Y 占用该内存区域，那么 A 进程可以用控制 X 的函数（此处为 SetDIBColorTable 函数）修改 Y。

UAF 漏洞的利用，雷同 double-free 漏洞（之前分析的 cve-2018-8639），这里也运用了简单的 fengshui 布局。此外，采用了任意地址读写技术，利用了 tagWND 结构中 cbWNDExtra 成员、strName 成员、成员 spwndParent。

*   DDE 通信：DDE 通讯协议是一种动态数据交换协议，在 Microsoft Windows 运行环境下客户机应用程序向当前所激活的服务器应用程序发送一条消息请求信息，服务器应用程序根据该信息作出应答，从而实现两个程序之间的[数据交换](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2/1586256)。
*   UAF (Use After Free)漏洞是一种内存破坏漏洞。