# PHP-CGI 远程任意代码执行漏洞(CVE-2012-1823)修复方案 - virgree - 博客园

> 原文：[`www.cnblogs.com/virgree/p/5411582.html`](https://www.cnblogs.com/virgree/p/5411582.html)

　　首先介绍一下这个漏洞，其实是在 apache 调用 php 解释器解释.php 文件时，会将 url 参数传我给 php 解释器，如果在 url 后加传命令行开关（例如-s、-d 、-c 或

 -dauto_prepend_file%3d/etc/passwd+-n）等参数时，会导致源代码泄露和任意代码执行。　　这个漏洞影响 php-5.3.12 以前的版本，mod 方式、fpm 方式不受影响。　　既然出现了，那就补吧，以下都是自己亲身经验，本着开源精神，做个分享，欢迎留言！　　三种方案：　　　　1.升级 php 版本；（php-5.3.12 以上版本）;　　　　2.在 apache 上做文章，开启 url 过滤，把危险的命令行参数给过滤掉，由于这种方法修补比较简单，采用比较多吧。　　　　具体做法：　　　　　　修改 http.conf 文件，找到<Directory/>增加以下三行　　　　　　　　RewriteEngine on　　　　　　　　RewriteCond %{QUERY_STRING} ^(%2d|-)[^=]+$ [NC]　　　　　　　　***RewriteRule ^(.*) $1? [L]***

　重启一下 apache 即可，但是要考虑到，相当于每次 request 就要进行一次 url 过滤，如果访问量大的话，可能会增加 apache 的负担。

　　　　3.打上 php 补丁，我个人也比较倾向这一点。

　　　　　补丁下载地址:https://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/

　　　　　补丁作用：其实就是增加了一个判断，如果是普通的 cgi 方式，命令行-s 等参数就不再处理，遗憾的是验证的时候，补丁和我当时的 php 版本不一致，所以补丁一直打不上。

　　　　  后来索性改源码吧，把补丁手动打上，涉及到 sapi/cgi/cgi_main.c 这个文件。在 main 函数中，搜索 php_getopt 用下面这行替换，一共有两处。

　　　　　if (!cgi) while ((c = php_getopt(argc, argv, OPTIONS, &php_optarg, &php_optind, 0)) != -1) 

　　　　　替换后就是重新编译安装，经我验证完美解决。

　　　　   最后上传 cgi_main.c 文件，有需要的可以直接下载覆盖。

　　　　　下载地址:https://files.cnblogs.com/files/virgree/cgi_main.rar