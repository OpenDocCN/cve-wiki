# Nginx 文件名逻辑漏洞(CVE-2013-4547) - Hel10 - 博客园

> 原文：[https://www.cnblogs.com/HelloCTF/p/14096314.html](https://www.cnblogs.com/HelloCTF/p/14096314.html)

### 影响版本

Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7

### 漏洞成因

这个漏洞其实和代码执行没有太大关系，其主要原因是错误地解析了请求的URI，错误地获取到用户请求的文件名，导致出现权限绕过、代码执行的连带影响。
举个例子，比如，Nginx匹配到.php结尾的请求，就发送给fastcgi进行解析，常见的写法如下：

```
location ~ \.php$ {
    include        fastcgi_params;

    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  /var/www/html$fastcgi_script_name;
    fastcgi_param  DOCUMENT_ROOT /var/www/html;
} 
```

正常情况下（关闭pathinfo的情况下），只有.php后缀的文件才会被发送给fastcgi解析。
而存在CVE-2013-4547的情况下，我们请求1.gif[0x20][0x00].php，这个URI可以匹配上正则.php$，可以进入这个Location块；但进入后，Nginx却错误地认为请求的文件是1.gif[0x20]，就设置其为SCRIPT_FILENAME的值发送给fastcgi。
fastcgi根据SCRIPT_FILENAME的值进行解析，经过精心构造的文件名可以造成了解析漏洞。

### 漏洞复现

![](../Images/495366cd2108b2cf6ff7e82068145eda.png)

可以看到上传2.gif[空格]文件可以成功。并且给我们返回了路径。访问返回的路径，我们直接访问/uploadfiles/2.gif[空格][空格].php(因为我访问/uploadfiles/2.gif[空格]没有抓到包)，然后抓包，因为浏览器解析url的原因，图中在抓包之后空格被解析成了%20，将包中的%20手动修改成[空格]。
![](../Images/d0a30f2efb5b314bf8bc54518684b969.png)

修改完之后别急着放包，我们还需要修改Hex。
![](../Images/f86827ce0c40b57eafc5c623019f348d.png)

成功回显了phpinfo页面
![](../Images/6fff4d01d827674aeca7b0688e06d360.png)