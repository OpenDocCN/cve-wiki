# CVE-2020-1472 NetLogon 特权提升漏洞 - zw1sh - 博客园

> 原文：[`www.cnblogs.com/zw1sh/p/13849192.html`](https://www.cnblogs.com/zw1sh/p/13849192.html)

漏洞名称：Netlogon 特权提升漏洞
漏洞编号：CVE-2020-1472
漏洞描述：Netlogon 协议认证的加密模块存在缺陷，当使用 Netlogon 远程协议建立与域控制器连接的易受攻击的 Netlogon 安全通道时，存在特权提升漏洞，导致攻击者可以在没有凭证的情况下通过认证。通过调用 Netlogon 中 RPC 函数 NetrServerPasswordSet2 来重置域控的密码，以域控的身份进行 Dcsync（域渗透常用技术，可利用 Dcsync 导出域内所有用户 hash，在域内维持权限等），获取域管权限。

Netlogon 组件是 Windows 上一项重要的功能组件，用于用户和机器在域内网络上的认证，以及复制数据库以进行域控备份，还用于维护域成员与域之间、域与域控之间、域 DC 与跨域 DC 之间的关系。
Netlogon 远程协议是一个可用的在 Windows 域控制器上的 RPC（remote procedure call protocol，远程过程调用协议，允许像调用本地服务一样调用远程服务）接口，用于对域中的用户和其他服务进行身份验证，最常见的是方便用户使用 NTLM（NTLAN Manager，问询/应答身份验证协议，telnet 的一种验证身份方式）登录服务器协议，让计算机更新其域内的密码。其他机器与域控的 Netlogon 通讯使用 RPC 协议 MS-NRPC（指定了 Netlogon 远程协议，基于域的网络上的用户和计算机进行身份验证）。
Netlogon 协议不会使用与其他 RPC 服务相同的身份验证方案，而是使用自定义的加密协议，让客户端（加入域的计算机）和服务器（域管理员）互相证明它们都知道共享的机密（客户端计算机的哈希值密码）。

![](img/1ab1f72ec6c1cc0e58133a8005d55a4c.png)
1）客户端调用 NetrServerReqChallenge，向服务端发送一个 client challenge；
2）服务端向客户端返回一个 Server Challenge；
3）双方利用 client 的 hash、clientchallenge、server challenge 计算一个 session_key；
4）客户端利用 session_key 和 client challenge 计算一个 client credential，并发送给服务端进行校验；
5）服务端也利用 session_key 和 client challenge 计算一个 client credential，如果其值和客户端发送过来的一致，就让客户端通过认证。
这里的 client challenge 使用 ComputeNetlogonCredential 函数计算，有两种算法，分别是 DES_ECB 和 AES_CFB，双方可以通过协商 flag 来选择使用哪种加密方式。
攻击者可控的因素是 client challenge，攻击者将其设置为 0，serverchallenge 在每一轮认证过程中都会变化，secret 则对应用户密码的 hash，加密过程采用的是 AES-CFB8（一种高级加密标准），运算过程详见[`www.anquanke.com/post/id/217475`](https://www.anquanke.com/post/id/217475)
这里存在问题的就是 AES-CFB8，在 AES-CFB8 算法中，IV 是’\x00’*16，明文密码是 clientchallenge，key 是 session_key，计算后的密文是 client credential。如果 IV 为零，只要我们能控制明文内容为 XYXYXYXY 这种格式（X 和 Y 可以一样，即每个字节的值都是一样的），那么一定存在一个 key，使得 clientcredential 为 00000000000000。我们就可以向服务端发送一个 client challenge 为 00000000000000（满足 XYXYXYXY 格式即可），然后循环向服务端发送 client credential 为 00000000000000，直到出现一个 session_key，使得服务端生成的 client challenge 也为 00000000000000。
简单来说，Netlogon 协议身份认证采用挑战-响应机制，其加密算法是 AES-CFB8，并且 IV 默认全零，导致漏洞产生。而且没有对认证次数进行限制，签名功能客户端默认可选，使得漏洞被成功利用。

工具:
检验是否存在该漏洞：[CVE-2020-1472-master.zip](https://www.yuque.com/attachments/yuque/0/2020/zip/2401138/1603122247518-5761fa5d-c11e-46cd-a326-9483c48271db.zip?_lake_card=%7B%22uid%22%3A%221603122247427-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fzip%2F2401138%2F1603122247518-5761fa5d-c11e-46cd-a326-9483c48271db.zip%22%2C%22name%22%3A%22CVE-2020-1472-master.zip%22%2C%22size%22%3A3860%2C%22type%22%3A%22application%2Fx-zip-compressed%22%2C%22ext%22%3A%22zip%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22osHms%22%2C%22card%22%3A%22file%22%7D)
[`github.com/SecuraBV/CVE-2020-1472`](https://github.com/SecuraBV/CVE-2020-1472)
导出域内的 hash，横向移动等：[impacket-master.zip](https://www.yuque.com/attachments/yuque/0/2020/zip/2401138/1603122296209-92adfc4e-1566-483d-93e2-00fa45ac02a6.zip?_lake_card=%7B%22uid%22%3A%221603122295053-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fzip%2F2401138%2F1603122296209-92adfc4e-1566-483d-93e2-00fa45ac02a6.zip%22%2C%22name%22%3A%22impacket-master.zip%22%2C%22size%22%3A1553986%2C%22type%22%3A%22application%2Fx-zip-compressed%22%2C%22ext%22%3A%22zip%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22dA87H%22%2C%22card%22%3A%22file%22%7D)
[`www.freebuf.com/sectool/175208.html`](https://www.freebuf.com/sectool/175208.html)
[`github.com/SecureAuthCorp/impacket`](https://github.com/SecureAuthCorp/impacket)
将域控密码置空，并后面进行还原：[zerologon-master.zip](https://www.yuque.com/attachments/yuque/0/2020/zip/2401138/1603122330173-f2323c4e-c5e8-4ec1-8f54-6202ed4bf9a0.zip?_lake_card=%7B%22uid%22%3A%221603122330100-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fzip%2F2401138%2F1603122330173-f2323c4e-c5e8-4ec1-8f54-6202ed4bf9a0.zip%22%2C%22name%22%3A%22zerologon-master.zip%22%2C%22size%22%3A7101%2C%22type%22%3A%22application%2Fx-zip-compressed%22%2C%22ext%22%3A%22zip%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22rtI50%22%2C%22card%22%3A%22file%22%7D) 
[`github.com/risksense/zerologon`](https://github.com/risksense/zerologon)

靶机:
192.168.1.145
testdc

定位域控：扫描 389 端口
389 端口的服务：LDAP（LightweightDirectory Access Protocol，轻型目录访问协议）和 ILS（NetMeeting Internet Locator Server，Internet 定位服务器），LDAP 是基于 X.500 标准的轻量级目录访问协议，通过 IP 协议提供访问控制和维护分布式信息的目录信息。由美国密西根大学发明，目前已有多家公司采用，如 Netscape 将其包含在最新的 Communicator 套装产品中，也被微软加入 Active Directory 中。
![扫描.png](img/fe83f2a1086972c88d8575c50e4d5b01.png)

![testdc.png](img/c1ea2b67e0b2febc2d4ce168abae1ff5.png)
如果该机器同时开放 135（主要用于使用 RPC（remote procedure call，远程过程调用）协议并提供 DCOM（分布式组件对象模型）服务）、445（共享文件夹或共享打印机）、53（DNS，域名服务器）端口，很大可能就是域控：

Impacket：一个 Python 类库，用于对 SMB1-3 或 IPv4/IPv6 上的 TCP、UDP、ICMP、ARP、NTLM、LDAP 等协议进行低级编程访问。GitHub 地址：[`github.com/SecureAuthCorp/impacket`](https://github.com/SecureAuthCorp/impacket)
安装 impacket 路径下的 setup.py 即可：
python3 setup.py install

漏洞验证：[`github.com/SecuraBV/CVE-2020-1472`](https://github.com/SecuraBV/CVE-2020-1472)
![](img/7a91e864bf6da29c4167a6939e2adbed.png)
DC 名称为其 NetBIOS 计算机名称，如果此名称不正确，脚本可能会失败并显示 STATUS_INVALID_COMPUTER_NAME 错误。
![检测.png](img/e05729de2f671fc682a1913a6135b307.png)
漏洞复现：[`github.com/risksense/zerologon`](https://github.com/risksense/zerologon)

1）查看域控所在机器账户（testdc$）的 hash
注：利用 CVE-2020-1472 重置的是域控所在机器用户的密码。机器用户跟域用户一样，都是域内的成员，机器用户在域内的用户名是机器用户+$，如 testdc$。
![读取 hash.png](img/a9a2cb01dc692707edf85da49267ee9d.png)
无法获取域内用户凭据信息。
2）使用 zerologon 工具将域控所在机器账户的 hash 置换成空密码的 hash
![设置空密码.png](img/7bc0b796bc34fe578c772aec716834f9.png)
置空后，再次获取域内凭证信息：
![域内 hash.png](img/f1bc98db551076c90c149ea7dc2e6e93.png)
通过在线加解密网站 [`www.cmd5.com`](https://www.cmd5.com/) 查询：
![](img/ca68b6b64f03b60791bcbcfa13ee3b82.png)
发现 testdc$的 hash 已经被改成空密码。
使用 administrator 的 hash 横向连接：
![横向连接.png](img/47ae1699107c4f9a67c6bc20c54dc666.png)
3）还原域控机器账户的 hash
在上面的攻击过程中，我们将机器的密码置为空，会导致域控脱域，原因是机器用户在 AD 中的密码（存储在 ntds.dic）与本地注册表里面的不一致。还原域控机器账户的 hash，只要将 AD 中的密码与注册表里面的密码保持一致即可。
获取计算机账户原始 hash：

```
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save

get system.save
get sam.save
get security.save

del /f system.save
del /f sam.save
del /f security.save 
```

![恢复 1.png](img/80705bf977daf7837e4ee6d90948b945.png)
使用 reg save 命令将注册表里的信息拿回本地，再通过 secretdump 提取出里面的 hash：

```
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL 
```

![恢复 2.png](img/e4c4242bb7207a580858a5c323e2db24.png)
使用 zerologon 工具将原始计算机账户哈希还原：
![恢复 4.png](img/1b7f43adb036d8abcc787f2d6b01daac.png)
查看 testdc$账户的 hash，已成功还原：
![](img/6ee669219cc9aa79d5b0c42fd790329b.png)
注：password 即客户机密码

漏洞修复
下载并安装漏洞官方补丁：[`portal.msrc.microsoft.com/zh-CN/security-guidance/advisory/CVE-2020-1472`](https://portal.msrc.microsoft.com/zh-CN/security-guidance/advisory/CVE-2020-1472)
及时进行 Microsoft Windows 版本更新并且保持 Windows 自动更新开启。